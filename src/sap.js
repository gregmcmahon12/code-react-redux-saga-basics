
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src
SAPServer.sln
7795
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio 14
VisualStudioVersion = 14.0.25420.1
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SAPServer.Web", "SAPServer.Web\SAPServer.Web.csproj", "{08869686-03B6-46D8-B7A4-F00EED4D849E}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SAPServer.RFCService", "SAPServer.RFCService\SAPServer.RFCService.csproj", "{CB4D8799-0380-4E22-A168-8F8062FCDB2D}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SAPServer.Test", "SAPServer.RFCServiceTest\SAPServer.Test.csproj", "{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}"
EndProject
Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "Solution Items", "Solution Items", "{74818FB2-DDFB-4593-BD9D-04D09E129CC9}"
	ProjectSection(SolutionItems) = preProject
		Local.testsettings = Local.testsettings
	EndProjectSection
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SAPServer.Service.SAP", "SAPServer.Service.SAP\SAPServer.Service.SAP.csproj", "{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SAPServer.Core", "SAPServer.Core\SAPServer.Core.csproj", "{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SAPServer.Data.FSR", "SAPServer.Data.FSR\SAPServer.Data.FSR.csproj", "{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "SAPServer.Service.FSR", "SAPServer.Service.FSR\SAPServer.Service.FSR.csproj", "{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Debug|x64 = Debug|x64
		Release|Any CPU = Release|Any CPU
		Release|x64 = Release|x64
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Debug|x64.ActiveCfg = Debug|x64
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Debug|x64.Build.0 = Debug|x64
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Release|Any CPU.Build.0 = Release|Any CPU
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Release|x64.ActiveCfg = Release|x64
		{08869686-03B6-46D8-B7A4-F00EED4D849E}.Release|x64.Build.0 = Release|x64
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Debug|x64.ActiveCfg = Debug|x64
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Debug|x64.Build.0 = Debug|x64
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Release|Any CPU.Build.0 = Release|Any CPU
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Release|x64.ActiveCfg = Release|x64
		{CB4D8799-0380-4E22-A168-8F8062FCDB2D}.Release|x64.Build.0 = Release|x64
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Debug|x64.ActiveCfg = Debug|x64
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Debug|x64.Build.0 = Debug|x64
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Release|Any CPU.Build.0 = Release|Any CPU
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Release|x64.ActiveCfg = Release|x64
		{70690DCD-02EA-48CD-A0C1-76C4DA7BDD8C}.Release|x64.Build.0 = Release|x64
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Debug|x64.ActiveCfg = Debug|x64
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Debug|x64.Build.0 = Debug|x64
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Release|Any CPU.Build.0 = Release|Any CPU
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Release|x64.ActiveCfg = Release|x64
		{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}.Release|x64.Build.0 = Release|x64
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Debug|x64.ActiveCfg = Debug|x64
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Debug|x64.Build.0 = Debug|x64
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Release|Any CPU.Build.0 = Release|Any CPU
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Release|x64.ActiveCfg = Release|x64
		{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}.Release|x64.Build.0 = Release|x64
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Debug|x64.ActiveCfg = Debug|x64
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Debug|x64.Build.0 = Debug|x64
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Release|Any CPU.Build.0 = Release|Any CPU
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Release|x64.ActiveCfg = Release|x64
		{80D1F2DE-8C32-46B5-9701-B7E7857EF8DE}.Release|x64.Build.0 = Release|x64
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Debug|x64.ActiveCfg = Debug|x64
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Debug|x64.Build.0 = Debug|x64
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Release|Any CPU.Build.0 = Release|Any CPU
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Release|x64.ActiveCfg = Release|x64
		{2A0BF21E-F2FE-4D98-9CBB-5EA73533B327}.Release|x64.Build.0 = Release|x64
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(TeamFoundationVersionControl) = preSolution
		SccNumberOfProjects = 8
		SccEnterpriseProvider = {4CA58AB2-18FA-4F8D-95D4-32DDF27D184C}
		SccTeamFoundationServer = http://tfs.titan.satin.lo/tfs/applications
		SccLocalPath0 = .
		SccProjectUniqueName1 = SAPServer.Web\\SAPServer.Web.csproj
		SccProjectName1 = SAPServer.Web
		SccLocalPath1 = SAPServer.Web
		SccProjectUniqueName2 = SAPServer.RFCService\\SAPServer.RFCService.csproj
		SccProjectName2 = SAPServer.RFCService
		SccLocalPath2 = SAPServer.RFCService
		SccProjectUniqueName3 = SAPServer.Core\\SAPServer.Core.csproj
		SccProjectName3 = SAPServer.Core
		SccLocalPath3 = SAPServer.Core
		SccProjectUniqueName4 = SAPServer.Service.SAP\\SAPServer.Service.SAP.csproj
		SccProjectName4 = SAPServer.Service.SAP
		SccLocalPath4 = SAPServer.Service.SAP
		SccProjectUniqueName5 = SAPServer.Data.FSR\\SAPServer.Data.FSR.csproj
		SccProjectName5 = SAPServer.Data.FSR
		SccLocalPath5 = SAPServer.Data.FSR
		SccProjectUniqueName6 = SAPServer.Service.FSR\\SAPServer.Service.FSR.csproj
		SccProjectName6 = SAPServer.Service.FSR
		SccLocalPath6 = SAPServer.Service.FSR
		SccProjectUniqueName7 = SAPServer.RFCServiceTest\\SAPServer.Test.csproj
		SccProjectName7 = SAPServer.RFCServiceTest
		SccLocalPath7 = SAPServer.RFCServiceTest
	EndGlobalSection
EndGlobal

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\.vs\config
applicationhost.config
86242
<?xml version="1.0" encoding="UTF-8"?>
<!--

    IIS configuration sections.

    For schema documentation, see
    %IIS_BIN%\config\schema\IIS_schema.xml.
    
    Please make a backup of this file before making any changes to it.

    NOTE: The following environment variables are available to be used
          within this file and are understood by the IIS Express.

          %IIS_USER_HOME% - The IIS Express home directory for the user
          %IIS_SITES_HOME% - The default home directory for sites
          %IIS_BIN% - The location of the IIS Express binaries
          %SYSTEMDRIVE% - The drive letter of %IIS_BIN%

-->

<configuration>

    <!--

        The <configSections> section controls the registration of sections.
        Section is the basic unit of deployment, locking, searching and
        containment for configuration settings.
        
        Every section belongs to one section group.
        A section group is a container of logically-related sections.
        
        Sections cannot be nested.
        Section groups may be nested.
        
        <section
            name=""  [Required, Collection Key] [XML name of the section]
            allowDefinition="Everywhere" [MachineOnly|MachineToApplication|AppHostOnly|Everywhere] [Level where it can be set]
            overrideModeDefault="Allow"  [Allow|Deny] [Default delegation mode]
            allowLocation="true"  [true|false] [Allowed in location tags]
        />
        
        The recommended way to unlock sections is by using a location tag:
        <location path="Default Web Site" overrideMode="Allow">
            <system.webServer>
                <asp />
            </system.webServer>
        </location>

    -->
    <configSections>
        <sectionGroup name="system.applicationHost">
            <section name="applicationPools" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="configHistory" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="customMetadata" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="listenerAdapters" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="log" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="serviceAutoStartProviders" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="sites" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="webLimits" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
        </sectionGroup>

        <sectionGroup name="system.webServer">
            <section name="asp" overrideModeDefault="Deny" />
            <section name="caching" overrideModeDefault="Allow" />
            <section name="cgi" overrideModeDefault="Deny" />
            <section name="defaultDocument" overrideModeDefault="Allow" />
            <section name="directoryBrowse" overrideModeDefault="Allow" />
            <section name="fastCgi" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="globalModules" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
            <section name="handlers" overrideModeDefault="Deny" />
            <section name="httpCompression" overrideModeDefault="Allow" />
            <section name="httpErrors" overrideModeDefault="Allow" />
            <section name="httpLogging" overrideModeDefault="Deny" />
            <section name="httpProtocol" overrideModeDefault="Allow" />
            <section name="httpRedirect" overrideModeDefault="Allow" />
            <section name="httpTracing" overrideModeDefault="Deny" />
            <section name="isapiFilters" allowDefinition="MachineToApplication" overrideModeDefault="Deny" />
            <section name="modules" allowDefinition="MachineToApplication" overrideModeDefault="Deny" />
            <section name="applicationInitialization" allowDefinition="MachineToApplication" overrideModeDefault="Allow" />
            <section name="odbcLogging" overrideModeDefault="Deny" />
            <sectionGroup name="security">
                <section name="access" overrideModeDefault="Deny" />
                <section name="applicationDependencies" overrideModeDefault="Deny" />
                <sectionGroup name="authentication">
                    <section name="anonymousAuthentication" overrideModeDefault="Deny" />
                    <section name="basicAuthentication" overrideModeDefault="Deny" />
                    <section name="clientCertificateMappingAuthentication" overrideModeDefault="Deny" />
                    <section name="digestAuthentication" overrideModeDefault="Deny" />
                    <section name="iisClientCertificateMappingAuthentication" overrideModeDefault="Deny" />
                    <section name="windowsAuthentication" overrideModeDefault="Deny" />
                </sectionGroup>
                <section name="authorization" overrideModeDefault="Allow" />
                <section name="ipSecurity" overrideModeDefault="Deny" />
                <section name="dynamicIpSecurity" overrideModeDefault="Deny" />
                <section name="isapiCgiRestriction" allowDefinition="AppHostOnly" overrideModeDefault="Deny" />
                <section name="requestFiltering" overrideModeDefault="Allow" />
            </sectionGroup>
            <section name="serverRuntime" overrideModeDefault="Deny" />
            <section name="serverSideInclude" overrideModeDefault="Deny" />
            <section name="staticContent" overrideModeDefault="Allow" />
            <sectionGroup name="tracing">
                <section name="traceFailedRequests" overrideModeDefault="Allow" />
                <section name="traceProviderDefinitions" overrideModeDefault="Deny" />
            </sectionGroup>
            <section name="urlCompression" overrideModeDefault="Allow" />
            <section name="validation" overrideModeDefault="Allow" />
            <sectionGroup name="webdav">
                <section name="globalSettings" overrideModeDefault="Deny" />
                <section name="authoring" overrideModeDefault="Deny" />
                <section name="authoringRules" overrideModeDefault="Deny" />
            </sectionGroup>
            <sectionGroup name="rewrite">
                <section name="allowedServerVariables" overrideModeDefault="Deny" />
                <section name="rules" overrideModeDefault="Allow" />
                <section name="outboundRules" overrideModeDefault="Allow" />
                <section name="globalRules" overrideModeDefault="Deny" allowDefinition="AppHostOnly" />
                <section name="providers" overrideModeDefault="Allow" />
                <section name="rewriteMaps" overrideModeDefault="Allow" />
            </sectionGroup>
            <section name="webSocket" overrideModeDefault="Deny" />
        </sectionGroup>
    </configSections>

    <configProtectedData>
        <providers>
            <add name="IISWASOnlyRsaProvider" type="" description="Uses RsaCryptoServiceProvider to encrypt and decrypt" keyContainerName="iisWasKey" cspProviderName="" useMachineContainer="true" useOAEP="false" />
            <add name="AesProvider" type="Microsoft.ApplicationHost.AesProtectedConfigurationProvider" description="Uses an AES session key to encrypt and decrypt" keyContainerName="iisConfigurationKey" cspProviderName="" useOAEP="false" useMachineContainer="true" sessionKey="AQIAAA5mAAAApAAAKmFQvWHDEETRz8l2bjZlRxIkwcqTFaCUnCLljn3Q1OkesrhEO9YyLyx4bUhsj1/DyShAv7OAFFhXlrlomaornnk5PLeyO4lIXxaiT33yOFUUgxDx4GSaygkqghVV0tO5yQ/XguUBp2juMfZyztnsNa4pLcz7ZNZQ6p4yn9hxwNs=" />
            <add name="IISWASOnlyAesProvider" type="Microsoft.ApplicationHost.AesProtectedConfigurationProvider" description="Uses an AES session key to encrypt and decrypt" keyContainerName="iisWasKey" cspProviderName="" useOAEP="false" useMachineContainer="true" sessionKey="AQIAAA5mAAAApAAA4WoiRJ8KHwzAG8AgejPxEOO4/2Vhkolbwo/8gZeNdUDSD36m55hWv4uC9tr/MlKdnwRLL0NhT50Gccyftqz5xTZ0dg5FtvQhTw/he1NwexTKbV+I4Zrd+sZUqHZTsr7JiEr6OHGXL70qoISW5G2m9U8wKT3caPiDPNj2aAaYPLo=" />
        </providers>
    </configProtectedData>

    <system.applicationHost>

        <applicationPools>
            <add name="Clr4IntegratedAppPool" managedRuntimeVersion="v4.0" managedPipelineMode="Integrated" CLRConfigFile="%IIS_USER_HOME%\config\aspnet.config" autoStart="true" />
            <add name="Clr4ClassicAppPool" managedRuntimeVersion="v4.0" managedPipelineMode="Classic" CLRConfigFile="%IIS_USER_HOME%\config\aspnet.config" autoStart="true" />
            <add name="Clr2IntegratedAppPool" managedRuntimeVersion="v2.0" managedPipelineMode="Integrated" CLRConfigFile="%IIS_USER_HOME%\config\aspnet.config" autoStart="true" />
            <add name="Clr2ClassicAppPool" managedRuntimeVersion="v2.0" managedPipelineMode="Classic" CLRConfigFile="%IIS_USER_HOME%\config\aspnet.config" autoStart="true" />
            <add name="UnmanagedClassicAppPool" managedRuntimeVersion="" managedPipelineMode="Classic" autoStart="true" />
            <applicationPoolDefaults managedRuntimeLoader="v4.0">
                <processModel />
            </applicationPoolDefaults>
        </applicationPools>

        <!--

          The <listenerAdapters> section defines the protocols with which the
          Windows Process Activation Service (WAS) binds.

        -->
        <listenerAdapters>
            <add name="http" />
        </listenerAdapters>

        <sites>
            <site name="WebSite1" id="1" serverAutoStart="true">
                <application path="/">
                    <virtualDirectory path="/" physicalPath="%IIS_SITES_HOME%\WebSite1" />
                </application>
                <bindings>
                    <binding protocol="http" bindingInformation=":8080:localhost" />
                </bindings>
            </site>
            <site name="SAPServer.Web" id="2">
                <application path="/" applicationPool="Clr4IntegratedAppPool">
                    <virtualDirectory path="/" physicalPath="D:\TFS\Apps\SAPInterface\Main\Src\SAPServer.Web" />
                </application>
                <bindings>
                    <binding protocol="http" bindingInformation="*:41240:localhost" />
                </bindings>
            </site>
            <siteDefaults>
                <logFile logFormat="W3C" directory="%IIS_USER_HOME%\Logs" />
                <traceFailedRequestsLogging directory="%IIS_USER_HOME%\TraceLogFiles" enabled="true" maxLogFileSizeKB="1024" />
            </siteDefaults>
            <applicationDefaults applicationPool="Clr4IntegratedAppPool" />
            <virtualDirectoryDefaults allowSubDirConfig="true" />
        </sites>

        <webLimits />

    </system.applicationHost>

    <system.webServer>

        <serverRuntime />

        <asp scriptErrorSentToBrowser="true">
            <cache diskTemplateCacheDirectory="%TEMP%\iisexpress\ASP Compiled Templates" />
            <limits />
        </asp>

        <caching enabled="true" enableKernelCache="true">
        </caching>

        <cgi />

        <defaultDocument enabled="true">
            <files>
                <add value="Default.htm" />
                <add value="Default.asp" />
                <add value="index.htm" />
                <add value="index.html" />
                <add value="iisstart.htm" />
                <add value="default.aspx" />
            </files>
        </defaultDocument>

        <directoryBrowse enabled="false" />

        <fastCgi />

        <!--

          The <globalModules> section defines all native-code modules.
          To enable a module, specify it in the <modules> section.

        -->
        <globalModules>
            <add name="HttpLoggingModule" image="%IIS_BIN%\loghttp.dll" />
            <add name="UriCacheModule" image="%IIS_BIN%\cachuri.dll" />
<!--            <add name="FileCacheModule" image="%IIS_BIN%\cachfile.dll" />  -->
            <add name="TokenCacheModule" image="%IIS_BIN%\cachtokn.dll" />
<!--            <add name="HttpCacheModule" image="%IIS_BIN%\cachhttp.dll" /> -->
            <add name="DynamicCompressionModule" image="%IIS_BIN%\compdyn.dll" />
            <add name="StaticCompressionModule" image="%IIS_BIN%\compstat.dll" />
            <add name="DefaultDocumentModule" image="%IIS_BIN%\defdoc.dll" />
            <add name="DirectoryListingModule" image="%IIS_BIN%\dirlist.dll" />
            <add name="ProtocolSupportModule" image="%IIS_BIN%\protsup.dll" />
            <add name="HttpRedirectionModule" image="%IIS_BIN%\redirect.dll" />
            <add name="ServerSideIncludeModule" image="%IIS_BIN%\iis_ssi.dll" />
            <add name="StaticFileModule" image="%IIS_BIN%\static.dll" />
            <add name="AnonymousAuthenticationModule" image="%IIS_BIN%\authanon.dll" />
            <add name="CertificateMappingAuthenticationModule" image="%IIS_BIN%\authcert.dll" />
            <add name="UrlAuthorizationModule" image="%IIS_BIN%\urlauthz.dll" />
            <add name="BasicAuthenticationModule" image="%IIS_BIN%\authbas.dll" />
            <add name="WindowsAuthenticationModule" image="%IIS_BIN%\authsspi.dll" />
<!--            <add name="DigestAuthenticationModule" image="%IIS_BIN%\authmd5.dll" /> -->
            <add name="IISCertificateMappingAuthenticationModule" image="%IIS_BIN%\authmap.dll" />
            <add name="IpRestrictionModule" image="%IIS_BIN%\iprestr.dll" />
            <add name="DynamicIpRestrictionModule" image="%IIS_BIN%\diprestr.dll" />
            <add name="RequestFilteringModule" image="%IIS_BIN%\modrqflt.dll" />
            <add name="CustomLoggingModule" image="%IIS_BIN%\logcust.dll" />
            <add name="CustomErrorModule" image="%IIS_BIN%\custerr.dll" />
<!--            <add name="TracingModule" image="%IIS_BIN%\iisetw.dll" /> -->
            <add name="FailedRequestsTracingModule" image="%IIS_BIN%\iisfreb.dll" />
            <add name="RequestMonitorModule" image="%IIS_BIN%\iisreqs.dll" />
            <add name="IsapiModule" image="%IIS_BIN%\isapi.dll" />
            <add name="IsapiFilterModule" image="%IIS_BIN%\filter.dll" />
            <add name="CgiModule" image="%IIS_BIN%\cgi.dll" />
            <add name="FastCgiModule" image="%IIS_BIN%\iisfcgi.dll" />
<!--            <add name="WebDAVModule" image="%IIS_BIN%\webdav.dll" /> -->
            <add name="RewriteModule" image="%IIS_BIN%\rewrite.dll" />
            <add name="ConfigurationValidationModule" image="%IIS_BIN%\validcfg.dll" />
            <add name="WebSocketModule" image="%IIS_BIN%\iiswsock.dll" />
            <add name="WebMatrixSupportModule" image="%IIS_BIN%\webmatrixsup.dll" />
            <add name="ManagedEngine" image="%windir%\Microsoft.NET\Framework\v2.0.50727\webengine.dll" preCondition="integratedMode,runtimeVersionv2.0,bitness32" />
            <add name="ManagedEngine64" image="%windir%\Microsoft.NET\Framework64\v2.0.50727\webengine.dll" preCondition="integratedMode,runtimeVersionv2.0,bitness64" />
            <add name="ManagedEngineV4.0_32bit" image="%windir%\Microsoft.NET\Framework\v4.0.30319\webengine4.dll" preCondition="integratedMode,runtimeVersionv4.0,bitness32" />
            <add name="ManagedEngineV4.0_64bit" image="%windir%\Microsoft.NET\Framework64\v4.0.30319\webengine4.dll" preCondition="integratedMode,runtimeVersionv4.0,bitness64" />
            <add name="ApplicationInitializationModule" image="%IIS_BIN%\warmup.dll" />
        </globalModules>

        <httpCompression directory="%TEMP%\iisexpress\IIS Temporary Compressed Files">
            <scheme name="gzip" dll="%IIS_BIN%\gzip.dll" />
            <dynamicTypes>
                <add mimeType="text/*" enabled="true" />
                <add mimeType="message/*" enabled="true" />
                <add mimeType="application/javascript" enabled="true" />
                <add mimeType="application/atom+xml" enabled="true" />
                <add mimeType="application/xaml+xml" enabled="true" />
                <add mimeType="*/*" enabled="false" />
            </dynamicTypes>
            <staticTypes>
                <add mimeType="text/*" enabled="true" />
                <add mimeType="message/*" enabled="true" />
                <add mimeType="image/svg+xml" enabled="true" />
                <add mimeType="application/javascript" enabled="true" />
                <add mimeType="application/atom+xml" enabled="true" />
                <add mimeType="application/xaml+xml" enabled="true" />
                <add mimeType="*/*" enabled="false" />
            </staticTypes>
        </httpCompression>

        <httpErrors lockAttributes="allowAbsolutePathsWhenDelegated,defaultPath">
            <error statusCode="401" prefixLanguageFilePath="%IIS_BIN%\custerr" path="401.htm" />
            <error statusCode="403" prefixLanguageFilePath="%IIS_BIN%\custerr" path="403.htm" />
            <error statusCode="404" prefixLanguageFilePath="%IIS_BIN%\custerr" path="404.htm" />
            <error statusCode="405" prefixLanguageFilePath="%IIS_BIN%\custerr" path="405.htm" />
            <error statusCode="406" prefixLanguageFilePath="%IIS_BIN%\custerr" path="406.htm" />
            <error statusCode="412" prefixLanguageFilePath="%IIS_BIN%\custerr" path="412.htm" />
            <error statusCode="500" prefixLanguageFilePath="%IIS_BIN%\custerr" path="500.htm" />
            <error statusCode="501" prefixLanguageFilePath="%IIS_BIN%\custerr" path="501.htm" />
            <error statusCode="502" prefixLanguageFilePath="%IIS_BIN%\custerr" path="502.htm" />
        </httpErrors>

        <httpLogging dontLog="false" />

        <httpProtocol>
            <customHeaders>
                <clear />
                <add name="X-Powered-By" value="ASP.NET" />
            </customHeaders>
            <redirectHeaders>
                <clear />
            </redirectHeaders>
        </httpProtocol>

        <httpRedirect enabled="false" />

        <httpTracing>
        </httpTracing>

        <isapiFilters>
            <filter name="ASP.Net_2.0.50727-64" path="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_filter.dll" enableCache="true" preCondition="bitness64,runtimeVersionv2.0" />
            <filter name="ASP.Net_2.0.50727.0" path="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_filter.dll" enableCache="true" preCondition="bitness32,runtimeVersionv2.0" />
            <filter name="ASP.Net_2.0_for_v1.1" path="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_filter.dll" enableCache="true" preCondition="runtimeVersionv1.1" />
            <filter name="ASP.Net_4.0_32bit" path="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_filter.dll" enableCache="true" preCondition="bitness32,runtimeVersionv4.0" />
            <filter name="ASP.Net_4.0_64bit" path="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_filter.dll" enableCache="true" preCondition="bitness64,runtimeVersionv4.0" />
        </isapiFilters>

        <odbcLogging />

        <security>

            <access sslFlags="None" />

            <applicationDependencies>
                <application name="Active Server Pages" groupId="ASP" />
            </applicationDependencies>

            <authentication>

                <anonymousAuthentication enabled="true" userName="" />

                <basicAuthentication enabled="false" />

                <clientCertificateMappingAuthentication enabled="false" />

                <digestAuthentication enabled="false" />

                <iisClientCertificateMappingAuthentication enabled="false">
                </iisClientCertificateMappingAuthentication>

                <windowsAuthentication enabled="false">
                    <providers>
                        <add value="Negotiate" />
                        <add value="NTLM" />
                    </providers>
                </windowsAuthentication>

            </authentication>

            <authorization>
                <add accessType="Allow" users="*" />
            </authorization>

            <ipSecurity allowUnlisted="true" />

            <isapiCgiRestriction notListedIsapisAllowed="true" notListedCgisAllowed="true">
                <add path="%windir%\Microsoft.NET\Framework64\v4.0.30319\webengine4.dll" allowed="true" groupId="ASP.NET_v4.0" description="ASP.NET_v4.0" />
                <add path="%windir%\Microsoft.NET\Framework\v4.0.30319\webengine4.dll" allowed="true" groupId="ASP.NET_v4.0" description="ASP.NET_v4.0" />
                <add path="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" allowed="true" groupId="ASP.NET v2.0.50727" description="ASP.NET v2.0.50727" />
                <add path="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" allowed="true" groupId="ASP.NET v2.0.50727" description="ASP.NET v2.0.50727" />
            </isapiCgiRestriction>

            <requestFiltering>
                <fileExtensions allowUnlisted="true" applyToWebDAV="true">
                    <add fileExtension=".asa" allowed="false" />
                    <add fileExtension=".asax" allowed="false" />
                    <add fileExtension=".ascx" allowed="false" />
                    <add fileExtension=".master" allowed="false" />
                    <add fileExtension=".skin" allowed="false" />
                    <add fileExtension=".browser" allowed="false" />
                    <add fileExtension=".sitemap" allowed="false" />
                    <add fileExtension=".config" allowed="false" />
                    <add fileExtension=".cs" allowed="false" />
                    <add fileExtension=".csproj" allowed="false" />
                    <add fileExtension=".vb" allowed="false" />
                    <add fileExtension=".vbproj" allowed="false" />
                    <add fileExtension=".webinfo" allowed="false" />
                    <add fileExtension=".licx" allowed="false" />
                    <add fileExtension=".resx" allowed="false" />
                    <add fileExtension=".resources" allowed="false" />
                    <add fileExtension=".mdb" allowed="false" />
                    <add fileExtension=".vjsproj" allowed="false" />
                    <add fileExtension=".java" allowed="false" />
                    <add fileExtension=".jsl" allowed="false" />
                    <add fileExtension=".ldb" allowed="false" />
                    <add fileExtension=".dsdgm" allowed="false" />
                    <add fileExtension=".ssdgm" allowed="false" />
                    <add fileExtension=".lsad" allowed="false" />
                    <add fileExtension=".ssmap" allowed="false" />
                    <add fileExtension=".cd" allowed="false" />
                    <add fileExtension=".dsprototype" allowed="false" />
                    <add fileExtension=".lsaprototype" allowed="false" />
                    <add fileExtension=".sdm" allowed="false" />
                    <add fileExtension=".sdmDocument" allowed="false" />
                    <add fileExtension=".mdf" allowed="false" />
                    <add fileExtension=".ldf" allowed="false" />
                    <add fileExtension=".ad" allowed="false" />
                    <add fileExtension=".dd" allowed="false" />
                    <add fileExtension=".ldd" allowed="false" />
                    <add fileExtension=".sd" allowed="false" />
                    <add fileExtension=".adprototype" allowed="false" />
                    <add fileExtension=".lddprototype" allowed="false" />
                    <add fileExtension=".exclude" allowed="false" />
                    <add fileExtension=".refresh" allowed="false" />
                    <add fileExtension=".compiled" allowed="false" />
                    <add fileExtension=".msgx" allowed="false" />
                    <add fileExtension=".vsdisco" allowed="false" />
                    <add fileExtension=".rules" allowed="false" />
                </fileExtensions>
                <verbs allowUnlisted="true" applyToWebDAV="true" />
                <hiddenSegments applyToWebDAV="true">
                    <add segment="web.config" />
                    <add segment="bin" />
                    <add segment="App_code" />
                    <add segment="App_GlobalResources" />
                    <add segment="App_LocalResources" />
                    <add segment="App_WebReferences" />
                    <add segment="App_Data" />
                    <add segment="App_Browsers" />
                </hiddenSegments>
            </requestFiltering>

        </security>

        <serverSideInclude ssiExecDisable="false" />

        <staticContent lockAttributes="isDocFooterFileName">
            <mimeMap fileExtension=".323" mimeType="text/h323" />
            <mimeMap fileExtension=".3g2" mimeType="video/3gpp2" />
            <mimeMap fileExtension=".3gp2" mimeType="video/3gpp2" />
            <mimeMap fileExtension=".3gp" mimeType="video/3gpp" />
            <mimeMap fileExtension=".3gpp" mimeType="video/3gpp" />
            <mimeMap fileExtension=".aac" mimeType="audio/aac" />
            <mimeMap fileExtension=".aaf" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".aca" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".accdb" mimeType="application/msaccess" />
            <mimeMap fileExtension=".accde" mimeType="application/msaccess" />
            <mimeMap fileExtension=".accdt" mimeType="application/msaccess" />
            <mimeMap fileExtension=".acx" mimeType="application/internet-property-stream" />
            <mimeMap fileExtension=".adt" mimeType="audio/vnd.dlna.adts" />
            <mimeMap fileExtension=".adts" mimeType="audio/vnd.dlna.adts" />
            <mimeMap fileExtension=".afm" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".ai" mimeType="application/postscript" />
            <mimeMap fileExtension=".aif" mimeType="audio/x-aiff" />
            <mimeMap fileExtension=".aifc" mimeType="audio/aiff" />
            <mimeMap fileExtension=".aiff" mimeType="audio/aiff" />
            <mimeMap fileExtension=".appcache" mimeType="text/cache-manifest" />
            <mimeMap fileExtension=".application" mimeType="application/x-ms-application" />
            <mimeMap fileExtension=".art" mimeType="image/x-jg" />
            <mimeMap fileExtension=".asd" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".asf" mimeType="video/x-ms-asf" />
            <mimeMap fileExtension=".asi" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".asm" mimeType="text/plain" />
            <mimeMap fileExtension=".asr" mimeType="video/x-ms-asf" />
            <mimeMap fileExtension=".asx" mimeType="video/x-ms-asf" />
            <mimeMap fileExtension=".atom" mimeType="application/atom+xml" />
            <mimeMap fileExtension=".au" mimeType="audio/basic" />
            <mimeMap fileExtension=".avi" mimeType="video/msvideo" />
            <mimeMap fileExtension=".axs" mimeType="application/olescript" />
            <mimeMap fileExtension=".bas" mimeType="text/plain" />
            <mimeMap fileExtension=".bcpio" mimeType="application/x-bcpio" />
            <mimeMap fileExtension=".bin" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".bmp" mimeType="image/bmp" />
            <mimeMap fileExtension=".c" mimeType="text/plain" />
            <mimeMap fileExtension=".cab" mimeType="application/vnd.ms-cab-compressed" />
            <mimeMap fileExtension=".calx" mimeType="application/vnd.ms-office.calx" />
            <mimeMap fileExtension=".cat" mimeType="application/vnd.ms-pki.seccat" />
            <mimeMap fileExtension=".cdf" mimeType="application/x-cdf" />
            <mimeMap fileExtension=".chm" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".class" mimeType="application/x-java-applet" />
            <mimeMap fileExtension=".clp" mimeType="application/x-msclip" />
            <mimeMap fileExtension=".cmx" mimeType="image/x-cmx" />
            <mimeMap fileExtension=".cnf" mimeType="text/plain" />
            <mimeMap fileExtension=".cod" mimeType="image/cis-cod" />
            <mimeMap fileExtension=".cpio" mimeType="application/x-cpio" />
            <mimeMap fileExtension=".cpp" mimeType="text/plain" />
            <mimeMap fileExtension=".crd" mimeType="application/x-mscardfile" />
            <mimeMap fileExtension=".crl" mimeType="application/pkix-crl" />
            <mimeMap fileExtension=".crt" mimeType="application/x-x509-ca-cert" />
            <mimeMap fileExtension=".csh" mimeType="application/x-csh" />
            <mimeMap fileExtension=".css" mimeType="text/css" />
            <mimeMap fileExtension=".csv" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".cur" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".dcr" mimeType="application/x-director" />
            <mimeMap fileExtension=".deploy" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".der" mimeType="application/x-x509-ca-cert" />
            <mimeMap fileExtension=".dib" mimeType="image/bmp" />
            <mimeMap fileExtension=".dir" mimeType="application/x-director" />
            <mimeMap fileExtension=".disco" mimeType="text/xml" />
            <mimeMap fileExtension=".dll" mimeType="application/x-msdownload" />
            <mimeMap fileExtension=".dll.config" mimeType="text/xml" />
            <mimeMap fileExtension=".dlm" mimeType="text/dlm" />
            <mimeMap fileExtension=".doc" mimeType="application/msword" />
            <mimeMap fileExtension=".docm" mimeType="application/vnd.ms-word.document.macroEnabled.12" />
            <mimeMap fileExtension=".docx" mimeType="application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
            <mimeMap fileExtension=".dot" mimeType="application/msword" />
            <mimeMap fileExtension=".dotm" mimeType="application/vnd.ms-word.template.macroEnabled.12" />
            <mimeMap fileExtension=".dotx" mimeType="application/vnd.openxmlformats-officedocument.wordprocessingml.template" />
            <mimeMap fileExtension=".dsp" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".dtd" mimeType="text/xml" />
            <mimeMap fileExtension=".dvi" mimeType="application/x-dvi" />
            <mimeMap fileExtension=".dvr-ms" mimeType="video/x-ms-dvr" />
            <mimeMap fileExtension=".dwf" mimeType="drawing/x-dwf" />
            <mimeMap fileExtension=".dwp" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".dxr" mimeType="application/x-director" />
            <mimeMap fileExtension=".eml" mimeType="message/rfc822" />
            <mimeMap fileExtension=".emz" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".eot" mimeType="application/vnd.ms-fontobject" />
            <mimeMap fileExtension=".eps" mimeType="application/postscript" />
            <mimeMap fileExtension=".etx" mimeType="text/x-setext" />
            <mimeMap fileExtension=".evy" mimeType="application/envoy" />
            <mimeMap fileExtension=".exe" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".exe.config" mimeType="text/xml" />
            <mimeMap fileExtension=".fdf" mimeType="application/vnd.fdf" />
            <mimeMap fileExtension=".fif" mimeType="application/fractals" />
            <mimeMap fileExtension=".fla" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".flr" mimeType="x-world/x-vrml" />
            <mimeMap fileExtension=".flv" mimeType="video/x-flv" />
            <mimeMap fileExtension=".gif" mimeType="image/gif" />
            <mimeMap fileExtension=".gtar" mimeType="application/x-gtar" />
            <mimeMap fileExtension=".gz" mimeType="application/x-gzip" />
            <mimeMap fileExtension=".h" mimeType="text/plain" />
            <mimeMap fileExtension=".hdf" mimeType="application/x-hdf" />
            <mimeMap fileExtension=".hdml" mimeType="text/x-hdml" />
            <mimeMap fileExtension=".hhc" mimeType="application/x-oleobject" />
            <mimeMap fileExtension=".hhk" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".hhp" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".hlp" mimeType="application/winhlp" />
            <mimeMap fileExtension=".hqx" mimeType="application/mac-binhex40" />
            <mimeMap fileExtension=".hta" mimeType="application/hta" />
            <mimeMap fileExtension=".htc" mimeType="text/x-component" />
            <mimeMap fileExtension=".htm" mimeType="text/html" />
            <mimeMap fileExtension=".html" mimeType="text/html" />
            <mimeMap fileExtension=".htt" mimeType="text/webviewhtml" />
            <mimeMap fileExtension=".hxt" mimeType="text/html" />
            <mimeMap fileExtension=".ico" mimeType="image/x-icon" />
            <mimeMap fileExtension=".ics" mimeType="text/calendar" />
            <mimeMap fileExtension=".ief" mimeType="image/ief" />
            <mimeMap fileExtension=".iii" mimeType="application/x-iphone" />
            <mimeMap fileExtension=".inf" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".ins" mimeType="application/x-internet-signup" />
            <mimeMap fileExtension=".isp" mimeType="application/x-internet-signup" />
            <mimeMap fileExtension=".IVF" mimeType="video/x-ivf" />
            <mimeMap fileExtension=".jar" mimeType="application/java-archive" />
            <mimeMap fileExtension=".java" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".jck" mimeType="application/liquidmotion" />
            <mimeMap fileExtension=".jcz" mimeType="application/liquidmotion" />
            <mimeMap fileExtension=".jfif" mimeType="image/pjpeg" />
            <mimeMap fileExtension=".jpb" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".jpe" mimeType="image/jpeg" />
            <mimeMap fileExtension=".jpeg" mimeType="image/jpeg" />
            <mimeMap fileExtension=".jpg" mimeType="image/jpeg" />
            <mimeMap fileExtension=".js" mimeType="application/javascript" />
            <mimeMap fileExtension=".json" mimeType="application/json" />
            <mimeMap fileExtension=".jsonld" mimeType="application/ld+json" />
            <mimeMap fileExtension=".jsx" mimeType="text/jscript" />
            <mimeMap fileExtension=".latex" mimeType="application/x-latex" />
            <mimeMap fileExtension=".less" mimeType="text/css" />
            <mimeMap fileExtension=".lit" mimeType="application/x-ms-reader" />
            <mimeMap fileExtension=".lpk" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".lsf" mimeType="video/x-la-asf" />
            <mimeMap fileExtension=".lsx" mimeType="video/x-la-asf" />
            <mimeMap fileExtension=".lzh" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".m13" mimeType="application/x-msmediaview" />
            <mimeMap fileExtension=".m14" mimeType="application/x-msmediaview" />
            <mimeMap fileExtension=".m1v" mimeType="video/mpeg" />
            <mimeMap fileExtension=".m2ts" mimeType="video/vnd.dlna.mpeg-tts" />
            <mimeMap fileExtension=".m3u" mimeType="audio/x-mpegurl" />
            <mimeMap fileExtension=".m4a" mimeType="audio/mp4" />
            <mimeMap fileExtension=".m4v" mimeType="video/mp4" />
            <mimeMap fileExtension=".man" mimeType="application/x-troff-man" />
            <mimeMap fileExtension=".manifest" mimeType="application/x-ms-manifest" />
            <mimeMap fileExtension=".map" mimeType="text/plain" />
            <mimeMap fileExtension=".mdb" mimeType="application/x-msaccess" />
            <mimeMap fileExtension=".mdp" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".me" mimeType="application/x-troff-me" />
            <mimeMap fileExtension=".mht" mimeType="message/rfc822" />
            <mimeMap fileExtension=".mhtml" mimeType="message/rfc822" />
            <mimeMap fileExtension=".mid" mimeType="audio/mid" />
            <mimeMap fileExtension=".midi" mimeType="audio/mid" />
            <mimeMap fileExtension=".mix" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".mmf" mimeType="application/x-smaf" />
            <mimeMap fileExtension=".mno" mimeType="text/xml" />
            <mimeMap fileExtension=".mny" mimeType="application/x-msmoney" />
            <mimeMap fileExtension=".mov" mimeType="video/quicktime" />
            <mimeMap fileExtension=".movie" mimeType="video/x-sgi-movie" />
            <mimeMap fileExtension=".mp2" mimeType="video/mpeg" />
            <mimeMap fileExtension=".mp3" mimeType="audio/mpeg" />
            <mimeMap fileExtension=".mp4" mimeType="video/mp4" />
            <mimeMap fileExtension=".mp4v" mimeType="video/mp4" />
            <mimeMap fileExtension=".mpa" mimeType="video/mpeg" />
            <mimeMap fileExtension=".mpe" mimeType="video/mpeg" />
            <mimeMap fileExtension=".mpeg" mimeType="video/mpeg" />
            <mimeMap fileExtension=".mpg" mimeType="video/mpeg" />
            <mimeMap fileExtension=".mpp" mimeType="application/vnd.ms-project" />
            <mimeMap fileExtension=".mpv2" mimeType="video/mpeg" />
            <mimeMap fileExtension=".ms" mimeType="application/x-troff-ms" />
            <mimeMap fileExtension=".msi" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".mso" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".mvb" mimeType="application/x-msmediaview" />
            <mimeMap fileExtension=".mvc" mimeType="application/x-miva-compiled" />
            <mimeMap fileExtension=".nc" mimeType="application/x-netcdf" />
            <mimeMap fileExtension=".nsc" mimeType="video/x-ms-asf" />
            <mimeMap fileExtension=".nws" mimeType="message/rfc822" />
            <mimeMap fileExtension=".ocx" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".oda" mimeType="application/oda" />
            <mimeMap fileExtension=".odc" mimeType="text/x-ms-odc" />
            <mimeMap fileExtension=".ods" mimeType="application/oleobject" />
            <mimeMap fileExtension=".oga" mimeType="audio/ogg" />
            <mimeMap fileExtension=".ogg" mimeType="video/ogg" />
            <mimeMap fileExtension=".ogv" mimeType="video/ogg" />
            <mimeMap fileExtension=".one" mimeType="application/onenote" />
            <mimeMap fileExtension=".onea" mimeType="application/onenote" />
            <mimeMap fileExtension=".onetoc" mimeType="application/onenote" />
            <mimeMap fileExtension=".onetoc2" mimeType="application/onenote" />
            <mimeMap fileExtension=".onetmp" mimeType="application/onenote" />
            <mimeMap fileExtension=".onepkg" mimeType="application/onenote" />
            <mimeMap fileExtension=".osdx" mimeType="application/opensearchdescription+xml" />
            <mimeMap fileExtension=".otf" mimeType="font/otf" />
            <mimeMap fileExtension=".p10" mimeType="application/pkcs10" />
            <mimeMap fileExtension=".p12" mimeType="application/x-pkcs12" />
            <mimeMap fileExtension=".p7b" mimeType="application/x-pkcs7-certificates" />
            <mimeMap fileExtension=".p7c" mimeType="application/pkcs7-mime" />
            <mimeMap fileExtension=".p7m" mimeType="application/pkcs7-mime" />
            <mimeMap fileExtension=".p7r" mimeType="application/x-pkcs7-certreqresp" />
            <mimeMap fileExtension=".p7s" mimeType="application/pkcs7-signature" />
            <mimeMap fileExtension=".pbm" mimeType="image/x-portable-bitmap" />
            <mimeMap fileExtension=".pcx" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".pcz" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".pdf" mimeType="application/pdf" />
            <mimeMap fileExtension=".pfb" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".pfm" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".pfx" mimeType="application/x-pkcs12" />
            <mimeMap fileExtension=".pgm" mimeType="image/x-portable-graymap" />
            <mimeMap fileExtension=".pko" mimeType="application/vnd.ms-pki.pko" />
            <mimeMap fileExtension=".pma" mimeType="application/x-perfmon" />
            <mimeMap fileExtension=".pmc" mimeType="application/x-perfmon" />
            <mimeMap fileExtension=".pml" mimeType="application/x-perfmon" />
            <mimeMap fileExtension=".pmr" mimeType="application/x-perfmon" />
            <mimeMap fileExtension=".pmw" mimeType="application/x-perfmon" />
            <mimeMap fileExtension=".png" mimeType="image/png" />
            <mimeMap fileExtension=".pnm" mimeType="image/x-portable-anymap" />
            <mimeMap fileExtension=".pnz" mimeType="image/png" />
            <mimeMap fileExtension=".pot" mimeType="application/vnd.ms-powerpoint" />
            <mimeMap fileExtension=".potm" mimeType="application/vnd.ms-powerpoint.template.macroEnabled.12" />
            <mimeMap fileExtension=".potx" mimeType="application/vnd.openxmlformats-officedocument.presentationml.template" />
            <mimeMap fileExtension=".ppam" mimeType="application/vnd.ms-powerpoint.addin.macroEnabled.12" />
            <mimeMap fileExtension=".ppm" mimeType="image/x-portable-pixmap" />
            <mimeMap fileExtension=".pps" mimeType="application/vnd.ms-powerpoint" />
            <mimeMap fileExtension=".ppsm" mimeType="application/vnd.ms-powerpoint.slideshow.macroEnabled.12" />
            <mimeMap fileExtension=".ppsx" mimeType="application/vnd.openxmlformats-officedocument.presentationml.slideshow" />
            <mimeMap fileExtension=".ppt" mimeType="application/vnd.ms-powerpoint" />
            <mimeMap fileExtension=".pptm" mimeType="application/vnd.ms-powerpoint.presentation.macroEnabled.12" />
            <mimeMap fileExtension=".pptx" mimeType="application/vnd.openxmlformats-officedocument.presentationml.presentation" />
            <mimeMap fileExtension=".prf" mimeType="application/pics-rules" />
            <mimeMap fileExtension=".prm" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".prx" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".ps" mimeType="application/postscript" />
            <mimeMap fileExtension=".psd" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".psm" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".psp" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".pub" mimeType="application/x-mspublisher" />
            <mimeMap fileExtension=".qt" mimeType="video/quicktime" />
            <mimeMap fileExtension=".qtl" mimeType="application/x-quicktimeplayer" />
            <mimeMap fileExtension=".qxd" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".ra" mimeType="audio/x-pn-realaudio" />
            <mimeMap fileExtension=".ram" mimeType="audio/x-pn-realaudio" />
            <mimeMap fileExtension=".rar" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".ras" mimeType="image/x-cmu-raster" />
            <mimeMap fileExtension=".rf" mimeType="image/vnd.rn-realflash" />
            <mimeMap fileExtension=".rgb" mimeType="image/x-rgb" />
            <mimeMap fileExtension=".rm" mimeType="application/vnd.rn-realmedia" />
            <mimeMap fileExtension=".rmi" mimeType="audio/mid" />
            <mimeMap fileExtension=".roff" mimeType="application/x-troff" />
            <mimeMap fileExtension=".rpm" mimeType="audio/x-pn-realaudio-plugin" />
            <mimeMap fileExtension=".rtf" mimeType="application/rtf" />
            <mimeMap fileExtension=".rtx" mimeType="text/richtext" />
            <mimeMap fileExtension=".scd" mimeType="application/x-msschedule" />
            <mimeMap fileExtension=".sct" mimeType="text/scriptlet" />
            <mimeMap fileExtension=".sea" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".setpay" mimeType="application/set-payment-initiation" />
            <mimeMap fileExtension=".setreg" mimeType="application/set-registration-initiation" />
            <mimeMap fileExtension=".sgml" mimeType="text/sgml" />
            <mimeMap fileExtension=".sh" mimeType="application/x-sh" />
            <mimeMap fileExtension=".shar" mimeType="application/x-shar" />
            <mimeMap fileExtension=".sit" mimeType="application/x-stuffit" />
            <mimeMap fileExtension=".sldm" mimeType="application/vnd.ms-powerpoint.slide.macroEnabled.12" />
            <mimeMap fileExtension=".sldx" mimeType="application/vnd.openxmlformats-officedocument.presentationml.slide" />
            <mimeMap fileExtension=".smd" mimeType="audio/x-smd" />
            <mimeMap fileExtension=".smi" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".smx" mimeType="audio/x-smd" />
            <mimeMap fileExtension=".smz" mimeType="audio/x-smd" />
            <mimeMap fileExtension=".snd" mimeType="audio/basic" />
            <mimeMap fileExtension=".snp" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".spc" mimeType="application/x-pkcs7-certificates" />
            <mimeMap fileExtension=".spl" mimeType="application/futuresplash" />
            <mimeMap fileExtension=".spx" mimeType="audio/ogg" />
            <mimeMap fileExtension=".src" mimeType="application/x-wais-source" />
            <mimeMap fileExtension=".ssm" mimeType="application/streamingmedia" />
            <mimeMap fileExtension=".sst" mimeType="application/vnd.ms-pki.certstore" />
            <mimeMap fileExtension=".stl" mimeType="application/vnd.ms-pki.stl" />
            <mimeMap fileExtension=".sv4cpio" mimeType="application/x-sv4cpio" />
            <mimeMap fileExtension=".sv4crc" mimeType="application/x-sv4crc" />
            <mimeMap fileExtension=".svg" mimeType="image/svg+xml" />
            <mimeMap fileExtension=".svgz" mimeType="image/svg+xml" />
            <mimeMap fileExtension=".swf" mimeType="application/x-shockwave-flash" />
            <mimeMap fileExtension=".t" mimeType="application/x-troff" />
            <mimeMap fileExtension=".tar" mimeType="application/x-tar" />
            <mimeMap fileExtension=".tcl" mimeType="application/x-tcl" />
            <mimeMap fileExtension=".tex" mimeType="application/x-tex" />
            <mimeMap fileExtension=".texi" mimeType="application/x-texinfo" />
            <mimeMap fileExtension=".texinfo" mimeType="application/x-texinfo" />
            <mimeMap fileExtension=".tgz" mimeType="application/x-compressed" />
            <mimeMap fileExtension=".thmx" mimeType="application/vnd.ms-officetheme" />
            <mimeMap fileExtension=".thn" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".tif" mimeType="image/tiff" />
            <mimeMap fileExtension=".tiff" mimeType="image/tiff" />
            <mimeMap fileExtension=".toc" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".tr" mimeType="application/x-troff" />
            <mimeMap fileExtension=".trm" mimeType="application/x-msterminal" />
            <mimeMap fileExtension=".ts" mimeType="video/vnd.dlna.mpeg-tts" />
            <mimeMap fileExtension=".tsv" mimeType="text/tab-separated-values" />
            <mimeMap fileExtension=".ttf" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".tts" mimeType="video/vnd.dlna.mpeg-tts" />
            <mimeMap fileExtension=".txt" mimeType="text/plain" />
            <mimeMap fileExtension=".u32" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".uls" mimeType="text/iuls" />
            <mimeMap fileExtension=".ustar" mimeType="application/x-ustar" />
            <mimeMap fileExtension=".vbs" mimeType="text/vbscript" />
            <mimeMap fileExtension=".vcf" mimeType="text/x-vcard" />
            <mimeMap fileExtension=".vcs" mimeType="text/plain" />
            <mimeMap fileExtension=".vdx" mimeType="application/vnd.ms-visio.viewer" />
            <mimeMap fileExtension=".vml" mimeType="text/xml" />
            <mimeMap fileExtension=".vsd" mimeType="application/vnd.visio" />
            <mimeMap fileExtension=".vss" mimeType="application/vnd.visio" />
            <mimeMap fileExtension=".vst" mimeType="application/vnd.visio" />
            <mimeMap fileExtension=".vsto" mimeType="application/x-ms-vsto" />
            <mimeMap fileExtension=".vsw" mimeType="application/vnd.visio" />
            <mimeMap fileExtension=".vsx" mimeType="application/vnd.visio" />
            <mimeMap fileExtension=".vtx" mimeType="application/vnd.visio" />
            <mimeMap fileExtension=".wav" mimeType="audio/wav" />
            <mimeMap fileExtension=".wax" mimeType="audio/x-ms-wax" />
            <mimeMap fileExtension=".wbmp" mimeType="image/vnd.wap.wbmp" />
            <mimeMap fileExtension=".wcm" mimeType="application/vnd.ms-works" />
            <mimeMap fileExtension=".wdb" mimeType="application/vnd.ms-works" />
            <mimeMap fileExtension=".webm" mimeType="video/webm" />
            <mimeMap fileExtension=".wks" mimeType="application/vnd.ms-works" />
            <mimeMap fileExtension=".wm" mimeType="video/x-ms-wm" />
            <mimeMap fileExtension=".wma" mimeType="audio/x-ms-wma" />
            <mimeMap fileExtension=".wmd" mimeType="application/x-ms-wmd" />
            <mimeMap fileExtension=".wmf" mimeType="application/x-msmetafile" />
            <mimeMap fileExtension=".wml" mimeType="text/vnd.wap.wml" />
            <mimeMap fileExtension=".wmlc" mimeType="application/vnd.wap.wmlc" />
            <mimeMap fileExtension=".wmls" mimeType="text/vnd.wap.wmlscript" />
            <mimeMap fileExtension=".wmlsc" mimeType="application/vnd.wap.wmlscriptc" />
            <mimeMap fileExtension=".wmp" mimeType="video/x-ms-wmp" />
            <mimeMap fileExtension=".wmv" mimeType="video/x-ms-wmv" />
            <mimeMap fileExtension=".wmx" mimeType="video/x-ms-wmx" />
            <mimeMap fileExtension=".wmz" mimeType="application/x-ms-wmz" />
            <mimeMap fileExtension=".woff" mimeType="font/x-woff" />
            <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
            <mimeMap fileExtension=".wps" mimeType="application/vnd.ms-works" />
            <mimeMap fileExtension=".wri" mimeType="application/x-mswrite" />
            <mimeMap fileExtension=".wrl" mimeType="x-world/x-vrml" />
            <mimeMap fileExtension=".wrz" mimeType="x-world/x-vrml" />
            <mimeMap fileExtension=".wsdl" mimeType="text/xml" />
            <mimeMap fileExtension=".wtv" mimeType="video/x-ms-wtv" />
            <mimeMap fileExtension=".wvx" mimeType="video/x-ms-wvx" />
            <mimeMap fileExtension=".x" mimeType="application/directx" />
            <mimeMap fileExtension=".xaf" mimeType="x-world/x-vrml" />
            <mimeMap fileExtension=".xaml" mimeType="application/xaml+xml" />
            <mimeMap fileExtension=".xap" mimeType="application/x-silverlight-app" />
            <mimeMap fileExtension=".xbap" mimeType="application/x-ms-xbap" />
            <mimeMap fileExtension=".xbm" mimeType="image/x-xbitmap" />
            <mimeMap fileExtension=".xdr" mimeType="text/plain" />
            <mimeMap fileExtension=".xht" mimeType="application/xhtml+xml" />
            <mimeMap fileExtension=".xhtml" mimeType="application/xhtml+xml" />
            <mimeMap fileExtension=".xla" mimeType="application/vnd.ms-excel" />
            <mimeMap fileExtension=".xlam" mimeType="application/vnd.ms-excel.addin.macroEnabled.12" />
            <mimeMap fileExtension=".xlc" mimeType="application/vnd.ms-excel" />
            <mimeMap fileExtension=".xlm" mimeType="application/vnd.ms-excel" />
            <mimeMap fileExtension=".xls" mimeType="application/vnd.ms-excel" />
            <mimeMap fileExtension=".xlsb" mimeType="application/vnd.ms-excel.sheet.binary.macroEnabled.12" />
            <mimeMap fileExtension=".xlsm" mimeType="application/vnd.ms-excel.sheet.macroEnabled.12" />
            <mimeMap fileExtension=".xlsx" mimeType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
            <mimeMap fileExtension=".xlt" mimeType="application/vnd.ms-excel" />
            <mimeMap fileExtension=".xltm" mimeType="application/vnd.ms-excel.template.macroEnabled.12" />
            <mimeMap fileExtension=".xltx" mimeType="application/vnd.openxmlformats-officedocument.spreadsheetml.template" />
            <mimeMap fileExtension=".xlw" mimeType="application/vnd.ms-excel" />
            <mimeMap fileExtension=".xml" mimeType="text/xml" />
            <mimeMap fileExtension=".xof" mimeType="x-world/x-vrml" />
            <mimeMap fileExtension=".xpm" mimeType="image/x-xpixmap" />
            <mimeMap fileExtension=".xps" mimeType="application/vnd.ms-xpsdocument" />
            <mimeMap fileExtension=".xsd" mimeType="text/xml" />
            <mimeMap fileExtension=".xsf" mimeType="text/xml" />
            <mimeMap fileExtension=".xsl" mimeType="text/xml" />
            <mimeMap fileExtension=".xslt" mimeType="text/xml" />
            <mimeMap fileExtension=".xsn" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".xtp" mimeType="application/octet-stream" />
            <mimeMap fileExtension=".xwd" mimeType="image/x-xwindowdump" />
            <mimeMap fileExtension=".z" mimeType="application/x-compress" />
            <mimeMap fileExtension=".zip" mimeType="application/x-zip-compressed" />
        </staticContent>

        <tracing>

             <traceProviderDefinitions>
                <add name="WWW Server" guid="{3a2a4e84-4c21-4981-ae10-3fda0d9b0f83}">
                    <areas>
                        <clear />
                        <add name="Authentication" value="2" />
                        <add name="Security" value="4" />
                        <add name="Filter" value="8" />
                        <add name="StaticFile" value="16" />
                        <add name="CGI" value="32" />
                        <add name="Compression" value="64" />
                        <add name="Cache" value="128" />
                        <add name="RequestNotifications" value="256" />
                        <add name="Module" value="512" />
                        <add name="Rewrite" value="1024" />
                        <add name="FastCGI" value="4096" />
                        <add name="WebSocket" value="16384" />
                    </areas>
                </add>
                <add name="ASP" guid="{06b94d9a-b15e-456e-a4ef-37c984a2cb4b}">
                    <areas>
                        <clear />
                    </areas>
                </add>
                <add name="ISAPI Extension" guid="{a1c2040e-8840-4c31-ba11-9871031a19ea}">
                    <areas>
                        <clear />
                    </areas>
                </add>
                <add name="ASPNET" guid="{AFF081FE-0247-4275-9C4E-021F3DC1DA35}">
                    <areas>
                        <add name="Infrastructure" value="1" />
                        <add name="Module" value="2" />
                        <add name="Page" value="4" />
                        <add name="AppServices" value="8" />
                    </areas>
                </add>
            </traceProviderDefinitions>

            <traceFailedRequests>
                <add path="*">
                    <traceAreas>
                        <add provider="ASP" verbosity="Verbose" />
                        <add provider="ASPNET" areas="Infrastructure,Module,Page,AppServices" verbosity="Verbose" />
                        <add provider="ISAPI Extension" verbosity="Verbose" />
                        <add provider="WWW Server" areas="Authentication,Security,Filter,StaticFile,CGI,Compression,Cache,RequestNotifications,Module,Rewrite,WebSocket" verbosity="Verbose" />
                    </traceAreas>
                    <failureDefinitions statusCodes="200-999" />
                </add>
            </traceFailedRequests>

        </tracing>

        <urlCompression />

        <validation />
        <webdav>
            <globalSettings>
                <propertyStores>
                    <add name="webdav_simple_prop" image="%IIS_BIN%\webdav_simple_prop.dll" image32="%IIS_BIN%\webdav_simple_prop.dll" />
                </propertyStores>
                <lockStores>
                    <add name="webdav_simple_lock" image="%IIS_BIN%\webdav_simple_lock.dll" image32="%IIS_BIN%\webdav_simple_lock.dll" />
                </lockStores>

            </globalSettings>
            <authoring>
                <locks enabled="true" lockStore="webdav_simple_lock" />
            </authoring>
            <authoringRules />
        </webdav>
        <webSocket />
        <applicationInitialization />

    </system.webServer>
    <location path="" overrideMode="Allow">
        <system.webServer>
            <modules>
                <add name="IsapiFilterModule" lockItem="true" />
                <add name="BasicAuthenticationModule" lockItem="true" />
                <add name="IsapiModule" lockItem="true" />
                <add name="HttpLoggingModule" lockItem="true" />
                <!--
                <add name="HttpCacheModule" lockItem="true" />
-->
                <add name="DynamicCompressionModule" lockItem="true" />
                <add name="StaticCompressionModule" lockItem="true" />
                <add name="DefaultDocumentModule" lockItem="true" />
                <add name="DirectoryListingModule" lockItem="true" />

                <add name="ProtocolSupportModule" lockItem="true" />
                <add name="HttpRedirectionModule" lockItem="true" />
                <add name="ServerSideIncludeModule" lockItem="true" />
                <add name="StaticFileModule" lockItem="true" />
                <add name="AnonymousAuthenticationModule" lockItem="true" />
                <add name="CertificateMappingAuthenticationModule" lockItem="true" />
                <add name="UrlAuthorizationModule" lockItem="true" />
                <add name="WindowsAuthenticationModule" lockItem="true" />
                <!--
                <add name="DigestAuthenticationModule" lockItem="true" />
-->
                <add name="IISCertificateMappingAuthenticationModule" lockItem="true" />
                <add name="WebMatrixSupportModule" lockItem="true" />
                <add name="IpRestrictionModule" lockItem="true" />
                <add name="DynamicIpRestrictionModule" lockItem="true" />
                <add name="RequestFilteringModule" lockItem="true" />
                <add name="CustomLoggingModule" lockItem="true" />
                <add name="CustomErrorModule" lockItem="true" />
                <add name="FailedRequestsTracingModule" lockItem="true" />
                <add name="CgiModule" lockItem="true" />
                <add name="FastCgiModule" lockItem="true" />
                <!--                <add name="WebDAVModule" /> -->
                <add name="RewriteModule" />
                <add name="OutputCache" type="System.Web.Caching.OutputCacheModule" preCondition="managedHandler" />
                <add name="Session" type="System.Web.SessionState.SessionStateModule" preCondition="managedHandler" />
                <add name="WindowsAuthentication" type="System.Web.Security.WindowsAuthenticationModule" preCondition="managedHandler" />
                <add name="FormsAuthentication" type="System.Web.Security.FormsAuthenticationModule" preCondition="managedHandler" />
                <add name="DefaultAuthentication" type="System.Web.Security.DefaultAuthenticationModule" preCondition="managedHandler" />
                <add name="RoleManager" type="System.Web.Security.RoleManagerModule" preCondition="managedHandler" />
                <add name="UrlAuthorization" type="System.Web.Security.UrlAuthorizationModule" preCondition="managedHandler" />
                <add name="FileAuthorization" type="System.Web.Security.FileAuthorizationModule" preCondition="managedHandler" />
                <add name="AnonymousIdentification" type="System.Web.Security.AnonymousIdentificationModule" preCondition="managedHandler" />
                <add name="Profile" type="System.Web.Profile.ProfileModule" preCondition="managedHandler" />
                <add name="UrlMappingsModule" type="System.Web.UrlMappingsModule" preCondition="managedHandler" />
                <add name="ConfigurationValidationModule" lockItem="true" />
                <add name="WebSocketModule" lockItem="true" />
                <add name="ServiceModel-4.0" type="System.ServiceModel.Activation.ServiceHttpModule,System.ServiceModel.Activation,Version=4.0.0.0,Culture=neutral,PublicKeyToken=31bf3856ad364e35" preCondition="managedHandler,runtimeVersionv4.0" />
                <add name="UrlRoutingModule-4.0" type="System.Web.Routing.UrlRoutingModule" preCondition="managedHandler,runtimeVersionv4.0" />
                <add name="ScriptModule-4.0" type="System.Web.Handlers.ScriptModule, System.Web.Extensions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" preCondition="managedHandler,runtimeVersionv4.0" />
                <add name="ServiceModel" type="System.ServiceModel.Activation.HttpModule, System.ServiceModel, Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="managedHandler,runtimeVersionv2.0" />
                <add name="ApplicationInitializationModule" lockItem="true" />
            </modules>
            <handlers accessPolicy="Read, Script">
                <!--                <add name="WebDAV" path="*" verb="PROPFIND,PROPPATCH,MKCOL,PUT,COPY,DELETE,MOVE,LOCK,UNLOCK" modules="WebDAVModule" resourceType="Unspecified" requireAccess="None" /> -->
                <add name="AXD-ISAPI-4.0_64bit" path="*.axd" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="PageHandlerFactory-ISAPI-4.0_64bit" path="*.aspx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="SimpleHandlerFactory-ISAPI-4.0_64bit" path="*.ashx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="WebServiceHandlerFactory-ISAPI-4.0_64bit" path="*.asmx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-rem-ISAPI-4.0_64bit" path="*.rem" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-soap-ISAPI-4.0_64bit" path="*.soap" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="svc-ISAPI-4.0_64bit" path="*.svc" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" />
                <add name="rules-ISAPI-4.0_64bit" path="*.rules" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" />
                <add name="xoml-ISAPI-4.0_64bit" path="*.xoml" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" />
                <add name="xamlx-ISAPI-4.0_64bit" path="*.xamlx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" />
                <add name="aspq-ISAPI-4.0_64bit" path="*.aspq" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="cshtm-ISAPI-4.0_64bit" path="*.cshtm" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="cshtml-ISAPI-4.0_64bit" path="*.cshtml" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="vbhtm-ISAPI-4.0_64bit" path="*.vbhtm" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="vbhtml-ISAPI-4.0_64bit" path="*.vbhtml" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="svc-Integrated" path="*.svc" verb="*" type="System.ServiceModel.Activation.HttpHandler, System.ServiceModel, Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="svc-ISAPI-2.0" path="*.svc" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" />
                <add name="xoml-Integrated" path="*.xoml" verb="*" type="System.ServiceModel.Activation.HttpHandler, System.ServiceModel, Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="xoml-ISAPI-2.0" path="*.xoml" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" />
                <add name="rules-Integrated" path="*.rules" verb="*" type="System.ServiceModel.Activation.HttpHandler, System.ServiceModel, Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="rules-ISAPI-2.0" path="*.rules" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" />
                <add name="AXD-ISAPI-4.0_32bit" path="*.axd" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="PageHandlerFactory-ISAPI-4.0_32bit" path="*.aspx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="SimpleHandlerFactory-ISAPI-4.0_32bit" path="*.ashx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="WebServiceHandlerFactory-ISAPI-4.0_32bit" path="*.asmx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-rem-ISAPI-4.0_32bit" path="*.rem" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-soap-ISAPI-4.0_32bit" path="*.soap" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="svc-ISAPI-4.0_32bit" path="*.svc" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" />
                <add name="rules-ISAPI-4.0_32bit" path="*.rules" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" />
                <add name="xoml-ISAPI-4.0_32bit" path="*.xoml" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" />
                <add name="xamlx-ISAPI-4.0_32bit" path="*.xamlx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" />
                <add name="aspq-ISAPI-4.0_32bit" path="*.aspq" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="cshtm-ISAPI-4.0_32bit" path="*.cshtm" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="cshtml-ISAPI-4.0_32bit" path="*.cshtml" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="vbhtm-ISAPI-4.0_32bit" path="*.vbhtm" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="vbhtml-ISAPI-4.0_32bit" path="*.vbhtml" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="TraceHandler-Integrated-4.0" path="trace.axd" verb="GET,HEAD,POST,DEBUG" type="System.Web.Handlers.TraceHandler" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="WebAdminHandler-Integrated-4.0" path="WebAdmin.axd" verb="GET,DEBUG" type="System.Web.Handlers.WebAdminHandler" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="AssemblyResourceLoader-Integrated-4.0" path="WebResource.axd" verb="GET,DEBUG" type="System.Web.Handlers.AssemblyResourceLoader" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="PageHandlerFactory-Integrated-4.0" path="*.aspx" verb="GET,HEAD,POST,DEBUG" type="System.Web.UI.PageHandlerFactory" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="SimpleHandlerFactory-Integrated-4.0" path="*.ashx" verb="GET,HEAD,POST,DEBUG" type="System.Web.UI.SimpleHandlerFactory" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="WebServiceHandlerFactory-Integrated-4.0" path="*.asmx" verb="GET,HEAD,POST,DEBUG" type="System.Web.Script.Services.ScriptHandlerFactory, System.Web.Extensions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="HttpRemotingHandlerFactory-rem-Integrated-4.0" path="*.rem" verb="GET,HEAD,POST,DEBUG" type="System.Runtime.Remoting.Channels.Http.HttpRemotingHandlerFactory, System.Runtime.Remoting, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="HttpRemotingHandlerFactory-soap-Integrated-4.0" path="*.soap" verb="GET,HEAD,POST,DEBUG" type="System.Runtime.Remoting.Channels.Http.HttpRemotingHandlerFactory, System.Runtime.Remoting, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="svc-Integrated-4.0" path="*.svc" verb="*" type="System.ServiceModel.Activation.ServiceHttpHandlerFactory, System.ServiceModel.Activation, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="rules-Integrated-4.0" path="*.rules" verb="*" type="System.ServiceModel.Activation.ServiceHttpHandlerFactory, System.ServiceModel.Activation, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="xoml-Integrated-4.0" path="*.xoml" verb="*" type="System.ServiceModel.Activation.ServiceHttpHandlerFactory, System.ServiceModel.Activation, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="xamlx-Integrated-4.0" path="*.xamlx" verb="GET,HEAD,POST,DEBUG" type="System.Xaml.Hosting.XamlHttpHandlerFactory, System.Xaml.Hosting, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="aspq-Integrated-4.0" path="*.aspq" verb="GET,HEAD,POST,DEBUG" type="System.Web.HttpForbiddenHandler" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="cshtm-Integrated-4.0" path="*.cshtm" verb="GET,HEAD,POST,DEBUG" type="System.Web.HttpForbiddenHandler" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="cshtml-Integrated-4.0" path="*.cshtml" verb="GET,HEAD,POST,DEBUG" type="System.Web.HttpForbiddenHandler" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="vbhtm-Integrated-4.0" path="*.vbhtm" verb="GET,HEAD,POST,DEBUG" type="System.Web.HttpForbiddenHandler" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="vbhtml-Integrated-4.0" path="*.vbhtml" verb="GET,HEAD,POST,DEBUG" type="System.Web.HttpForbiddenHandler" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="ScriptHandlerFactoryAppServices-Integrated-4.0" path="*_AppService.axd" verb="*" type="System.Web.Script.Services.ScriptHandlerFactory, System.Web.Extensions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="ScriptResourceIntegrated-4.0" path="*ScriptResource.axd" verb="GET,HEAD" type="System.Web.Handlers.ScriptResourceHandler, System.Web.Extensions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35" preCondition="integratedMode,runtimeVersionv4.0" />
                <add name="ASPClassic" path="*.asp" verb="GET,HEAD,POST" modules="IsapiModule" scriptProcessor="%IIS_BIN%\asp.dll" resourceType="File" />
                <add name="SecurityCertificate" path="*.cer" verb="GET,HEAD,POST" modules="IsapiModule" scriptProcessor="%IIS_BIN%\asp.dll" resourceType="File" />
                <add name="ISAPI-dll" path="*.dll" verb="*" modules="IsapiModule" resourceType="File" requireAccess="Execute" allowPathInfo="true" />
                <add name="TraceHandler-Integrated" path="trace.axd" verb="GET,HEAD,POST,DEBUG" type="System.Web.Handlers.TraceHandler" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="WebAdminHandler-Integrated" path="WebAdmin.axd" verb="GET,DEBUG" type="System.Web.Handlers.WebAdminHandler" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="AssemblyResourceLoader-Integrated" path="WebResource.axd" verb="GET,DEBUG" type="System.Web.Handlers.AssemblyResourceLoader" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="PageHandlerFactory-Integrated" path="*.aspx" verb="GET,HEAD,POST,DEBUG" type="System.Web.UI.PageHandlerFactory" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="SimpleHandlerFactory-Integrated" path="*.ashx" verb="GET,HEAD,POST,DEBUG" type="System.Web.UI.SimpleHandlerFactory" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="WebServiceHandlerFactory-Integrated" path="*.asmx" verb="GET,HEAD,POST,DEBUG" type="System.Web.Services.Protocols.WebServiceHandlerFactory,System.Web.Services,Version=2.0.0.0,Culture=neutral,PublicKeyToken=b03f5f7f11d50a3a" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="HttpRemotingHandlerFactory-rem-Integrated" path="*.rem" verb="GET,HEAD,POST,DEBUG" type="System.Runtime.Remoting.Channels.Http.HttpRemotingHandlerFactory,System.Runtime.Remoting,Version=2.0.0.0,Culture=neutral,PublicKeyToken=b77a5c561934e089" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="HttpRemotingHandlerFactory-soap-Integrated" path="*.soap" verb="GET,HEAD,POST,DEBUG" type="System.Runtime.Remoting.Channels.Http.HttpRemotingHandlerFactory,System.Runtime.Remoting,Version=2.0.0.0,Culture=neutral,PublicKeyToken=b77a5c561934e089" preCondition="integratedMode,runtimeVersionv2.0" />
                <add name="AXD-ISAPI-2.0" path="*.axd" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" responseBufferLimit="0" />
                <add name="PageHandlerFactory-ISAPI-2.0" path="*.aspx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" responseBufferLimit="0" />
                <add name="SimpleHandlerFactory-ISAPI-2.0" path="*.ashx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" responseBufferLimit="0" />
                <add name="WebServiceHandlerFactory-ISAPI-2.0" path="*.asmx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-rem-ISAPI-2.0" path="*.rem" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-soap-ISAPI-2.0" path="*.soap" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness32" responseBufferLimit="0" />
                <add name="svc-ISAPI-2.0-64" path="*.svc" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" />
                <add name="AXD-ISAPI-2.0-64" path="*.axd" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" responseBufferLimit="0" />
                <add name="PageHandlerFactory-ISAPI-2.0-64" path="*.aspx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" responseBufferLimit="0" />
                <add name="SimpleHandlerFactory-ISAPI-2.0-64" path="*.ashx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" responseBufferLimit="0" />
                <add name="WebServiceHandlerFactory-ISAPI-2.0-64" path="*.asmx" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-rem-ISAPI-2.0-64" path="*.rem" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" responseBufferLimit="0" />
                <add name="HttpRemotingHandlerFactory-soap-ISAPI-2.0-64" path="*.soap" verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" responseBufferLimit="0" />
                <add name="rules-64-ISAPI-2.0" path="*.rules" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" />
                <add name="xoml-64-ISAPI-2.0" path="*.xoml" verb="*" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v2.0.50727\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv2.0,bitness64" />
                <add name="CGI-exe" path="*.exe" verb="*" modules="CgiModule" resourceType="File" requireAccess="Execute" allowPathInfo="true" />
                <add name="SSINC-stm" path="*.stm" verb="GET,HEAD,POST" modules="ServerSideIncludeModule" resourceType="File" />
                <add name="SSINC-shtm" path="*.shtm" verb="GET,HEAD,POST" modules="ServerSideIncludeModule" resourceType="File" />
                <add name="SSINC-shtml" path="*.shtml" verb="GET,HEAD,POST" modules="ServerSideIncludeModule" resourceType="File" />
                <add name="TRACEVerbHandler" path="*" verb="TRACE" modules="ProtocolSupportModule" requireAccess="None" />
                <add name="OPTIONSVerbHandler" path="*" verb="OPTIONS" modules="ProtocolSupportModule" requireAccess="None" />
                <add name="ExtensionlessUrl-ISAPI-4.0_32bit" path="*." verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness32" responseBufferLimit="0" />
                <add name="ExtensionlessUrlHandler-ISAPI-4.0_64bit" path="*." verb="GET,HEAD,POST,DEBUG" modules="IsapiModule" scriptProcessor="%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet_isapi.dll" preCondition="classicMode,runtimeVersionv4.0,bitness64" responseBufferLimit="0" />
                <add name="ExtensionlessUrl-Integrated-4.0" path="*." verb="GET,HEAD,POST,DEBUG" type="System.Web.Handlers.TransferRequestHandler" preCondition="integratedMode,runtimeVersionv4.0" responseBufferLimit="0" />
                <add name="StaticFile" path="*" verb="*" modules="StaticFileModule,DefaultDocumentModule,DirectoryListingModule" resourceType="Either" requireAccess="Read" />
            </handlers>
        </system.webServer>
    </location>
    <location path="SAPServer.Web">
        <system.webServer>
            <security>
                <authentication>
                    <anonymousAuthentication enabled="true" />
                    <windowsAuthentication enabled="true" />
                </authentication>
            </security>
        </system.webServer>
    </location>
</configuration>

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
ClassFactory.cs
14672
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;
using Microsoft.Practices.Unity;
using Microsoft.Practices.Unity.Configuration;

namespace SAPServer.Core
{
    public interface IClassFactory : IDisposable
    {
        T Create<T>() where T : class;
        T Create<T>(object arguments) where T : class;
        T Create<T>(string key) where T : class;
        T Create<T>(string key, object arguments) where T : class;
        object Create(Type type);
        object Create(Type type, object arguments);
        object Create(Type type, string key, object arguments);
        bool IsRegistered<T>(string key);
        bool IsRegistered(Type type, string key);
    }

    public sealed class ClassFactory : IClassFactory, IDisposable
    {
        #region Fields

        readonly IUnityContainer unityContainer;

        bool disposed = false;

        #endregion

        #region Constructor

        public ClassFactory(IUnityContainer unityContainer)
        {
            if (unityContainer == null)
            {
                throw new ArgumentNullException("unityContainer");
            }

            this.unityContainer = unityContainer;

            this.unityContainer.RegisterInstance<IClassFactory>(this, new ExternallyControlledLifetimeManager());

            Class.RegisterClassFactory(this);
        }

        ~ClassFactory()
        {
            if (!disposed)
            {
                Dispose();
            }
        }

        #endregion

        #region IClassFactory implementation

        public T Create<T>() where T : class
        {
            return (T)Create(typeof(T));
        }

        public T Create<T>(object arguments) where T : class
        {
            return (T)Create(typeof(T), arguments);
        }

        public T Create<T>(string key) where T : class
        {
            return (T)Create(typeof(T), key, null);
        }

        public T Create<T>(string key, object arguments) where T : class
        {
            return (T)Create(typeof(T), key, arguments);
        }

        public object Create(Type type)
        {
            return Create(type, null);
        }

        public object Create(Type type, object arguments)
        {
            return Create(type, null, arguments);
        }

        public object Create(Type type, string key)
        {
            return Create(type, key, null);
        }

        public object Create(Type type, string key, object arguments)
        {
            if (type == null)
            {
                throw new ArgumentNullException("type");
            }

            ResolverOverride[] resolverOverrides = ClassFactoryStatics.MakeResolverOverrides(arguments);

            return unityContainer.Resolve(type, key, resolverOverrides);
        }

        public bool IsRegistered<T>(string key)
        {
            return unityContainer.IsRegistered<T>(key);
        }

        public bool IsRegistered(Type type, string key)
        {
            return unityContainer.IsRegistered(type, key);
        }

        #endregion

        #region IDisposable implementation

        public void Dispose()
        {
            Dispose(true);
        }

        #endregion

        #region Private members

        void Dispose(bool suppressFinalize = false)
        {
            if (disposed)
            {
                throw new ObjectDisposedException(GetType().ToString());
            }

            disposed = true;

            unityContainer.Dispose();

            if (suppressFinalize)
            {
                GC.SuppressFinalize(this);
            }

            Class.factory = null;
        }

        #endregion
    }

    public sealed class DynamicClassFactory : IClassFactory
    {
        #region Fields

        static readonly IUnityContainer container = new UnityContainer();

        #endregion

        #region IClassFactory implementation

        public T Create<T>() where T : class
        {
            return Create<T>(null);
        }

        public T Create<T>(object arguments) where T : class
        {
            if (!container.IsRegistered<T>())
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(typeof(T), dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", typeof(T)));
                }

                container.RegisterType(typeof(T), t, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve<T>(ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public T Create<T>(string key) where T : class
        {
            return Create<T>(key, null);
        }

        public T Create<T>(string key, object arguments) where T : class
        {
            if (!container.IsRegistered<T>(key))
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(typeof(T), dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", typeof(T)));
                }

                container.RegisterType(typeof(T), t, key, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve<T>(key, ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public object Create(Type type)
        {
            return Create(type, null);
        }

        public object Create(Type type, object arguments)
        {
            if (!container.IsRegistered(type))
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(type, dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", type));
                }

                container.RegisterType(type, t, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve(type, ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public object Create(Type type, string key, object arguments)
        {
            if (!container.IsRegistered(type, key))
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(type, dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", type));
                }

                container.RegisterType(type, t, key, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve(type, key, ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public bool IsRegistered<T>(string key)
        {
            return container.IsRegistered<T>(key);
        }

        public bool IsRegistered(Type type, string key)
        {
            return container.IsRegistered(type, key);
        }

        #endregion

        #region IDisposable implementation

        public void Dispose()
        {
            container.Dispose();
        }

        #endregion
    }

    public static class ClassFactoryStatics
    {
        #region Public methods

        public static ResolverOverride[] MakeResolverOverrides(object anonymous)
        {
            ParameterOverrides parameterOverrides = new ParameterOverrides();

            if (anonymous != null)
            {
                TypeDescriptor.GetProperties(anonymous)
                    .Cast<PropertyDescriptor>()
                    .Select(x => new { name = x.Name, value = x.GetValue(anonymous) })
                    .Where(x => x.value != null)
                    .ToList()
                    .ForEach(x => parameterOverrides.Add(x.name, x.value));
            }

            return parameterOverrides.ToArray();
        }

        public static Dictionary<string, Type> MakeConstructionArguments(object anonymous)
        {
            if (anonymous == null)
            {
                return new Dictionary<string, Type>();
            }

            return TypeDescriptor.GetProperties(anonymous)
                .Cast<PropertyDescriptor>()
                .ToDictionary(x => x.Name, x => x.PropertyType);
        }

        public static Type FindImplementationOf(Type type, Dictionary<string, Type> constructorArguments)
        {
            Func<Type, bool> inheritanceTest;
            if (type.IsInterface)
            {
                inheritanceTest = t => t.GetInterfaces().Contains(type);
            }
            else
            {
                inheritanceTest = t => t.IsSubclassOf(type);
            }

            Func<Type, bool> constructionTest;
            if (constructorArguments == null || constructorArguments.Count == 0)
            {
                constructionTest = t => true;
            }
            else
            {
                constructionTest = t => t.GetConstructors().Any(c => AreSame(
                    c.GetParameters().ToDictionary(p => p.Name, parameter => parameter.ParameterType),
                    constructorArguments));
            }

            // Find a type that is not an interface or abstract, inherits from the given "type" and
            // has a constructor matching dictionary of construction arguments
            return AppDomain.CurrentDomain.GetAssemblies()
                .SelectMany(assembly => assembly.GetTypes())
                .FirstOrDefault(t =>
                    !(t.IsInterface || t.IsAbstract) &&
                    inheritanceTest(t) &&
                    constructionTest(t));
        }

        public static string GenerateRegistrationKey(object anonymous)
        {
            return MakeConstructionArguments(anonymous)
                .Select(x => string.Format("{0} {1}", x.Value, x.Key))
                .Aggregate((x, y) => string.Format("{0}, {1}", x, y));
        }

        #endregion

        #region Private members

        static bool AreSame(Dictionary<string, Type> first, Dictionary<string, Type> second)
        {
            if (first == null)
            {
                throw new ArgumentNullException("first");
            }

            if (second == null)
            {
                throw new ArgumentNullException("second");
            }

            return first.Keys.All(x => second.ContainsKey(x) && second[x] == first[x]);
        }

        #endregion
    }

    public static class Class
    {
        #region Fields

        internal static IClassFactory factory = null;

        #endregion

        #region Public methods

        [MethodImpl(MethodImplOptions.Synchronized)]
        internal static void RegisterClassFactory(IClassFactory factory)
        {
            // We may face racing condition when the factory gets registered
            // possibly from multiple threads.

            // At any one time only one factory class manages instance creations thus
            // when different threads are trying to register factory allow the winner
            // to register and ignore registration requests from loosers if their factories
            // are of the same type, otherwise throw exception.

            if (factory == null)
            {
                throw new ArgumentNullException("factory");
            }

            if (Class.factory == null)
            {
                Class.factory = factory;
            }
            else if (Class.factory.GetType() != factory.GetType())
            {
                throw new InvalidOperationException("factory has already been registered");
            }
        }

        public static T New<T>() where T : class
        {
            EnsureFactory();

            return factory.Create<T>();
        }

        public static T New<T>(object arguments) where T : class
        {
            EnsureFactory();

            return factory.Create<T>(arguments);
        }

        public static T New<T>(string key) where T : class
        {
            EnsureFactory();

            return factory.Create<T>(key, null);
        }

        public static T New<T>(string key, object arguments) where T : class
        {
            EnsureFactory();

            return factory.Create<T>(key, arguments);
        }

        public static object New(this Type type)
        {
            EnsureFactory();

            return factory.Create(type);
        }

        public static object New(this Type type, object arguments)
        {
            EnsureFactory();

            return factory.Create(type, arguments);
        }

        public static object New(this Type type, string key, object arguments)
        {
            EnsureFactory();

            return factory.Create(type, key, arguments);
        }

        public static bool IsRegistered(Type type, string key)
        {
            EnsureFactory();

            return factory.IsRegistered(type, key);
        }

        public static bool IsRegistered<T>(string key)
        {
            EnsureFactory();

            return factory.IsRegistered<T>(key);
        }

        #endregion

        #region Private members

        static void EnsureFactory()
        {
            if (factory != null)
            {
                return;
            }

            IUnityContainer container = new UnityContainer().LoadConfiguration();

            IClassFactory classFactory = container.Resolve<IClassFactory>(new ParameterOverride("container", container));

            RegisterClassFactory(classFactory);
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
Diagnostics.cs
9223
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;
using System.Reflection;
using System.Threading;
using Microsoft.Practices.EnterpriseLibrary.Common.Configuration;
using Microsoft.Practices.EnterpriseLibrary.ExceptionHandling;
using Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging;
using Microsoft.Practices.EnterpriseLibrary.Logging;
using System.Security.Principal;
using System.Threading.Tasks;
using System.Transactions;

namespace SAPServer.Core
{
    public interface IDiagnostics
    {
        void Debug(string format, params object[] args);
        void Trace(string format, params object[] args);
        void Email(bool asynchronous, string format, params object[] args);
        void Error(string format, params object[] args);
        void Inform(string format, params object[] args);
        bool Handle(Exception exception, out Exception rethrow, string policy = null);
        bool Handle(Exception exception, string policy = null);
    }

    public class EnterpriseLibraryDiagnostics : IDiagnostics
    {
        #region Fields

        public const string coreExceptionPolicy = "Global Policy";

        public const string logError = "Error";
        public const string logDiagnostics = "Diagnostics";
        public const string logEmail = "AppSupport";

        static readonly object[] noFormatArgs = { };

        readonly LogWriter logWriter;
        readonly ExceptionManager exceptionManager;

        #endregion

        #region Constructors

        internal EnterpriseLibraryDiagnostics(LogWriter logWriter, ExceptionManager exceptionManager)
        {
            if (logWriter == null)
            {
                throw new ArgumentNullException("logWriter");
            }

            if (exceptionManager == null)
            {
                throw new ArgumentNullException("exceptionManager");
            }

            this.logWriter = logWriter;

            this.exceptionManager = exceptionManager;
        }

        #endregion

        #region IDiagnostics implementation

        public void Debug(string format, params object[] args)
        {
            System.Diagnostics.Debug.Write(Format(format, args ?? noFormatArgs));
        }

        public void Trace(string format, params object[] args)
        {
            Log(TraceLogEntry(Format(format, args ?? noFormatArgs)));
        }

        public void Email(bool asynchronous, string format, params object[] args)
        {
            LogEntry logEntry = EmailLogEntry(Format(format, args ?? noFormatArgs));

            if (asynchronous)
            {
                Task.Factory.StartNew(() => Log(logEntry));
            }
            else
            {
                Log(logEntry);
            }
        }

        public void Error(string format, params object[] args)
        {
            Log(ErrorLogEntry(string.Format(format, args ?? noFormatArgs)));
        }

        public void Inform(string format, params object[] args)
        {
            Debug(format, args);

            if (logWriter.IsTracingEnabled())
            {
                Trace(format, args);
            }
        }

        /// <summary>
        /// Outputs given exception description to Debug or Trace log and handles it as per given 
        /// exception policy. If policy is not provided, the default policy is used.
        /// If returns true, caller should do "throw rethrow"
        /// </summary>
        public bool Handle(Exception exception, out Exception rethrow, string policy = null)
        {
            rethrow = null;

            if (exception == null)
            {
                exception = new ArgumentNullException("exception");
            }

            Inform("{0}", exception);

            if (exceptionManager.HandleException(
                exception,
                string.IsNullOrWhiteSpace(policy) ? coreExceptionPolicy : policy,
                out rethrow) && rethrow == null)
            {
                rethrow = exception;
            }

            return rethrow != null;
        }

        /// <summary>
        /// Outputs given exception description to Debug or Trace log and handles it as per given 
        /// exception policy. If policy is not provided, the default policy is used.
        /// If returns true, caller should do "throw"
        /// </summary>
        public bool Handle(Exception exception, string policy = null)
        {
            if (exception == null)
            {
                exception = new ArgumentNullException("exception");
            }

            Inform("{0}", exception);

            return exceptionManager.HandleException(exception, string.IsNullOrWhiteSpace(policy) ? coreExceptionPolicy : policy);
        }

        #endregion

        #region Private members

        LogEntry TraceLogEntry(string message)
        {
            return new LogEntry(message, logDiagnostics, 0, 400, TraceEventType.Verbose,
                logDiagnostics, null);
        }

        LogEntry EmailLogEntry(string message)
        {
            return new LogEntry(message, logEmail, 0, 300, TraceEventType.Information,
                TraceEventType.Information.ToString(), null);
        }

        LogEntry ErrorLogEntry(string message)
        {
            return new LogEntry(message, logError, 0, 200, TraceEventType.Error,
                TraceEventType.Error.ToString(), null);
        }

        void Log(LogEntry logEntry)
        {
            logWriter.Write(logEntry);
        }

        static string Format(string format, params object[] args)
        {
            MethodBase method = GetCallingMethod();

            return string.Format("{0}# {1}.{2}. ManagedThreadId=\"{3}\" Credentials=\"{4}\"{0} {5}{0}",
                Environment.NewLine,
                method.DeclaringType.Name,
                method.Name,
                Thread.CurrentThread.ManagedThreadId,
                Who(),
                string.Format(format, args ?? noFormatArgs));
        }

        static MethodBase GetCallingMethod()
        {
            StackFrame stackFrame = null;

            MethodBase method = null;

            int frame = 0;

            while (method == null || method.DeclaringType == typeof(EnterpriseLibraryDiagnostics))
            {
                stackFrame = new StackFrame(++frame);

                method = stackFrame.GetMethod();
            }

            return method;
        }

        static string Who()
        {
            return string.Format("{0} (thread), {1} (process)",
                Thread.CurrentPrincipal == null ?
                    "< Principal: null>" :
                    GetIdentityName(Thread.CurrentPrincipal.Identity),
                GetIdentityName(WindowsIdentity.GetCurrent()));
        }

        static string GetIdentityName(IIdentity identity)
        {
            if (identity == null)
            {
                return "< Identity: null >";
            }

            try
            {
                string text = identity.Name;

                if (string.IsNullOrEmpty(text))
                {
                    return string.Format("{0} has an empty name", identity.GetType().Name);
                }

                return text;
            }
            catch (Exception e)
            {
                return string.Format("[{0}.Name. Exception is thrown {1}]",
                    identity.GetType().Name,
                    e.Message);
            }
        }

        #endregion
    }

    public static class Diagnostics
    {
        public static readonly IDiagnostics Current = new EnterpriseLibraryDiagnostics(
            EnterpriseLibraryContainer.Current.GetInstance<LogWriter>(),
            EnterpriseLibraryContainer.Current.GetInstance<ExceptionManager>());

        public static T Exception<T>(string format, params object[] args) where T : Exception
        {
            return Exception<T>(null, format, args);
        }

        public static T Exception<T>(Exception inner, string format, params object[] args) where T : Exception
        {
            return (T)typeof(T).GetConstructor(new Type[]
            {
                typeof(string), 
                typeof(Exception)
            })
            .Invoke(new object[]
            { 
                args == null ? format : string.Format(format, args), 
                inner
            });
        }

        public static void InformTransaction()
        {
            Transaction transaction = Transaction.Current;

            if (transaction == null)
            {
                Diagnostics.Current.Inform("{0}", "No ambient transaction exists");
            }
            else
            {
                Diagnostics.Current.Inform("{0} => {1}", transaction.IsolationLevel, transaction.TransactionInformation.Stringify());
            }
        }
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
ErrorHandlerAttribute.cs
2215
using System;
using System.Collections.ObjectModel;
using System.Collections.Generic;
using System.Collections;
using System.Configuration;
using System.Linq;
using System.Web;
using System.ServiceModel;
using System.ServiceModel.Dispatcher;
using System.ServiceModel.Channels;
using System.ServiceModel.Description;
using Microsoft.Practices.EnterpriseLibrary.ExceptionHandling;

namespace SAPServer.Core
{
    [AttributeUsage(AttributeTargets.Class)]
    public class ErrorHandlerBehavior : Attribute, IServiceBehavior
    {
        public void AddBindingParameters(ServiceDescription serviceDescription, ServiceHostBase serviceHostBase, System.Collections.ObjectModel.Collection<ServiceEndpoint> endpoints, BindingParameterCollection bindingParameters)
        {
        } 

        public void ApplyDispatchBehavior(ServiceDescription serviceDescription, ServiceHostBase serviceHostBase)
        {
            IErrorHandler errorHandler;

            errorHandler = new ErrorHandler();

            foreach (ChannelDispatcherBase channelDispatcherBase in serviceHostBase.ChannelDispatchers)
            {
                ChannelDispatcher channelDispatcher = channelDispatcherBase as ChannelDispatcher;

                channelDispatcher.ErrorHandlers.Add(errorHandler);

            }
        }

        public void Validate(ServiceDescription serviceDescription, ServiceHostBase serviceHostBase)
        { 
        }
    }

    public class ErrorHandler : IErrorHandler
    {
        public void ProvideFault(Exception error, MessageVersion version, ref Message fault)
        {
            var faultException = new FaultException<ApplicationException>(new ApplicationException(error.Message), error.Message);
            fault = Message.CreateMessage(version, faultException.CreateMessageFault(), faultException.Action);
        }

        public bool HandleError(Exception error)
        {
            try
            {
                ExceptionPolicy.HandleException(error, "Global Policy");
            }
            catch (Exception)
            {
                // swallow error
            }

            return true;
        }
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
SAPConfiguration.cs
9439
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;

namespace SAPServer.Core
{
    public interface ISAPConfiguration
    {
        string GetApplicationSetting(string key);
        T Setting<T>(string key) where T : IConvertible;
        string Setting(string key);
        string ConnectionString(string key = null);
        RfcConfigParameters GetRfcConfigParameters();
    }

    public class SAPConfiguration : ISAPConfiguration
    {
        #region Purchase order fields

        public const string SAP_PO_FIELD_POHEADER_COMP_CODE = "COMP_CODE";
        public const string SAP_PO_FIELD_POHEADER_DOC_TYPE = "DOC_TYPE";
        public const string SAP_PO_FIELD_POHEADER_PMNTTRMS = "PMNTTRMS";
        public const string SAP_PO_FIELD_POHEADER_PUR_GROUP = "PUR_GROUP";
        public const string SAP_PO_FIELD_POHEADER_PURCH_ORG = "PURCH_ORG";

        public const string SAP_PO_FIELD_POITEM_ACCTASSCAT = "ACCTASSCAT";
        public const string SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_NORMALVAL = "ACCTASSCAT_NORMALVAL";
        public const string SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_COMPLETEDVAL = "ACCTASSCAT_COMPLETEDVAL";
        public const string SAP_PO_FIELD_POITEM_DISTRIB = "DISTRIB";
        public const string SAP_PO_FIELD_POITEM_MATL_GROUP = "MATL_GROUP";
        public const string SAP_PO_FIELD_POITEM_PART_INV = "PART_INV";
        public const string SAP_PO_FIELD_POITEM_PLANT = "PLANT";
        public const string SAP_PO_FIELD_POITEM_PO_UNIT = "PO_UNIT";
        public const string SAP_PO_FIELD_POITEM_NET_PRICE = "NET_PRICE";
        public const string SAP_PO_FIELD_POITEM_PRICE_UNIT = "PRICE_UNIT";
        public const string SAP_PO_FIELD_POITEM_TAX_CODE = "TAX_CODE";
        
        #endregion

        #region Project system fields

        public const string PS_PROJECT_PROFILE = "PS.PROJECT_PROFILE";
        public const string PS_COMPANY_CODE = "PS.COMPANY_CODE";
        public const string PS_CONTROLLING_AREA = "PS.CONTROLLING_AREA";
        public const string PS_CURRENCY = "PS.CURRENCY";
        public const string PS_PLANT = "PS.PLANT";

        #endregion

        #region Vendor fields

        public const string SAP_VENDOR_COMPANYCODE = "VENDOR.COMPANYCODE";
        public const string SAP_VENDOR_PURCH_ORG = "VENDOR.PURCH_ORG";
        
        #endregion

        #region GL Account fields

        public const string SAP_GL_ACCOUNT = "GLACCT";
        public const string SAP_GL_COMPANYCODE = "COMPANYCODE";

        #endregion
                
        #region Accrual system fields

        public const string ACCRUAL_COMPANY_CODE = "ACCRUAL.COMP_CODE";
        public const string ACCRUAL_OBJ_SYS = "ACCRUAL.OBJ_SYS";
        public const string ACCRUAL_OBJ_TYPE = "ACCRUAL.OBJ_TYPE";
        public const string ACCRUAL_DOC_TYPE_AC = "ACCRUAL.DOC_TYPE_AC";
        public const string ACCRUAL_DOC_TYPE_AR = "ACCRUAL.DOC_TYPE_AR";
        public const string ACCRUAL_GL_ACCOUNT_PREPAYMENT = "ACCRUAL.GL_ACCOUNT.PREPAYMENT";
        public const string ACCRUAL_GL_ACCOUNT_PROGRESSIVE = "ACCRUAL.GL_ACCOUNT.PROGRESSIVE";
        public const string ACCRUAL_ITEM_TEXT = "ACCRUAL.ITEM_TEXT";
        public const string ACCRUAL_CURR_TYPE = "ACCRUAL.CURR_TYPE";
        public const string ACCRUAL_REC_TYPE = "ACCRUAL.REC_TYPE";
        
        #endregion

        #region OASIS Journal system fields

        public const string OASIS_COMPANY_CODE = "OASIS.COMP_CODE";
        public const string OASIS_OBJ_SYS = "OASIS.OBJ_SYS";
        public const string OASIS_OBJ_TYPE = "OASIS.OBJ_TYPE";
        public const string OASIS_DOC_TYPE = "OASIS.DOC_TYPE";
        public const string OASIS_ITEM_TEXT = "OASIS.ITEM_TEXT";
        public const string OASIS_CURR_TYPE = "OASIS.CURR_TYPE";
        public const string OASIS_REC_TYPE = "OASIS.REC_TYPE";

        #endregion

        #region CO_DOCUMENT

        public const string CO_DOCUMENT_PARKED_DOCUMENT_INDICATOR_VALUE = "PARKED_DOCUMENT_INDICATOR_VALUE";
 
        #endregion

        Dictionary<string, object> settings = new Dictionary<string, object>
        {
            // Purchase Order Settings
            { SAP_PO_FIELD_POHEADER_COMP_CODE, "2000" },
            { SAP_PO_FIELD_POHEADER_DOC_TYPE, "AID" },
            { SAP_PO_FIELD_POHEADER_PMNTTRMS, "0030" },
            { SAP_PO_FIELD_POHEADER_PUR_GROUP, "AID" },
            { SAP_PO_FIELD_POHEADER_PURCH_ORG, "2000" },
            { SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_NORMALVAL, "P" },
            { SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_COMPLETEDVAL, "Z" },
            { SAP_PO_FIELD_POITEM_DISTRIB, "3" },  // 2 - percentage distrib, 3 - distribution by amount 
            { SAP_PO_FIELD_POITEM_MATL_GROUP, "CONSULT" },
            { SAP_PO_FIELD_POITEM_PART_INV, "2" },   // 2 - proportional distribution for partial invoice
            { SAP_PO_FIELD_POITEM_PLANT, "2000" },
            { SAP_PO_FIELD_POITEM_PO_UNIT, "EA" },
            { SAP_PO_FIELD_POITEM_NET_PRICE, "1" },
            { SAP_PO_FIELD_POITEM_PRICE_UNIT, "1" },
            { SAP_PO_FIELD_POITEM_TAX_CODE, "AZ" },
            
            // Project settings
            { PS_PROJECT_PROFILE, "DFAT005" },
            { PS_COMPANY_CODE, "2000" },
            { PS_CONTROLLING_AREA, "0001" },
            { PS_CURRENCY, "AUD" },
            { PS_PLANT, "2000" },        
    
            // Vendor settings
            { SAP_VENDOR_COMPANYCODE, "2000"},
            { SAP_VENDOR_PURCH_ORG, "2000"},

            //GL settings
            {SAP_GL_COMPANYCODE, "2000"},

            //Accrual settings
            { ACCRUAL_COMPANY_CODE, "2000" },
            { ACCRUAL_OBJ_SYS, "AIDWORKS" },
            { ACCRUAL_OBJ_TYPE, "ZAWAC" },
            { ACCRUAL_DOC_TYPE_AC, "AC" },
            { ACCRUAL_DOC_TYPE_AR, "AR" },
            { ACCRUAL_GL_ACCOUNT_PREPAYMENT, "0000056146" },
            { ACCRUAL_GL_ACCOUNT_PROGRESSIVE, "0000032310" },
            { ACCRUAL_ITEM_TEXT, "AidWorks Monthly Accrual" },
            { ACCRUAL_CURR_TYPE, "00" },
            { ACCRUAL_REC_TYPE, "BKPF" },

            //OASIS Journal settings
            { OASIS_COMPANY_CODE, "2000" },
            { OASIS_OBJ_SYS, "OASIS" },
            { OASIS_OBJ_TYPE, "ZOAI" },
            { OASIS_DOC_TYPE, "SA" },
            { OASIS_ITEM_TEXT, "OASIS Adjustment" },
            { OASIS_CURR_TYPE, "00" },
            { OASIS_REC_TYPE, "BKPF" },

            // CO Document settings
            { CO_DOCUMENT_PARKED_DOCUMENT_INDICATOR_VALUE, "V" }
        };

        public string GetApplicationSetting(string key)
        {
            return System.Configuration.ConfigurationManager.AppSettings[key]; 
        }

        public T Setting<T>(string key) where T : IConvertible
        {
            return (T)settings[key.ToUpperInvariant()];
        }

        public string Setting(string key)
        {
            return this.settings.ContainsKey(key) ? this.settings[key].ToString() : null;
        }

        public string ConnectionString(string key = null)
        {
            throw new NotImplementedException();
        }

        public RfcConfigParameters GetRfcConfigParameters()
        {
            Dictionary<string, string> destinationParameters = (Dictionary<string, string>)new NameValueCommaSeparatedTextTypeConverter().ConvertFromString(GetApplicationSetting("SAPConfiguration"));

            string missingParameters = FindMissingParameters(destinationParameters,
                                            RfcConfigParameters.Name,
                                            RfcConfigParameters.User,
                                            RfcConfigParameters.Password,
                                            RfcConfigParameters.Client,
                                            RfcConfigParameters.AppServerHost);

            if (!string.IsNullOrWhiteSpace(missingParameters))
            {
                throw new ArgumentException("The following parameters must be supplied for RfcDestination: {0}", missingParameters);
            }

            return CreateRfcConfigParameters(destinationParameters);
        }

        public RfcConfigParameters CreateRfcConfigParameters(Dictionary<string, string> destinationParameters)
        {
            if (destinationParameters == null)
            {
                throw new ArgumentException("destinationParameters");
            }
            
            RfcConfigParameters rfcConfigParameters = new RfcConfigParameters();

            foreach (string key in destinationParameters.Keys)
            {
                rfcConfigParameters.Add(key, destinationParameters[key]);
            }

            return rfcConfigParameters;
        }

        public string FindMissingParameters(Dictionary<string, string> destinationParameters, params string[] keys)
        {
            if (destinationParameters == null)
            {
                throw new ArgumentException("destinationParameters");
            }

            if (keys == null)
            {
                throw new ArgumentException("keys");
            }

            return string.Join(",", keys.Where(x => !destinationParameters.ContainsKey(x)));
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
SAPServer.Core.csproj
8931
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProjectGuid>{7BC07E5B-7E00-4CE2-9344-0E62822BCD23}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>SAPServer.Core</RootNamespace>
    <AssemblyName>SAPServer.Core</AssemblyName>
    <TargetFrameworkVersion>v4.5.1</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <SccProjectName>SAK</SccProjectName>
    <SccLocalPath>SAK</SccLocalPath>
    <SccAuxPath>SAK</SccAuxPath>
    <SccProvider>SAK</SccProvider>
    <TargetFrameworkProfile />
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>x64</PlatformTarget>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>x64</PlatformTarget>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x86'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\x86\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x86'">
    <OutputPath>bin\x86\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x64'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\x64\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x64'">
    <OutputPath>bin\x64\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="ApplicationManagement.Contract">
      <HintPath>..\ThirdPartyComponents\ApplicationManagement.Contract.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Common, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Common.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging, Version=5.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Logging, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.ServiceLocation, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.ServiceLocation.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity, Version=3.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Configuration, Version=2.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Configuration.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Interception, Version=3.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Interception.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.Smo, Version=10.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.Smo.dll</HintPath>
    </Reference>
    <Reference Include="sapnco">
      <HintPath>..\ThirdPartyComponents\sapnco.dll</HintPath>
    </Reference>
    <Reference Include="sapnco_utils">
      <HintPath>..\ThirdPartyComponents\sapnco_utils.dll</HintPath>
    </Reference>
    <Reference Include="ServiceBus.Contract">
      <HintPath>..\ThirdPartyComponents\ServiceBus.Contract.dll</HintPath>
    </Reference>
    <Reference Include="System" />
    <Reference Include="System.configuration" />
    <Reference Include="System.Core" />
    <Reference Include="System.Runtime.Serialization" />
    <Reference Include="System.ServiceModel" />
    <Reference Include="System.Transactions" />
    <Reference Include="System.Xml.Linq" />
    <Reference Include="System.Data.DataSetExtensions" />
    <Reference Include="Microsoft.CSharp" />
    <Reference Include="System.Data" />
    <Reference Include="System.Xml" />
  </ItemGroup>
  <ItemGroup>
    <Compile Include="ClassFactory.cs" />
    <Compile Include="Diagnostics.cs" />
    <Compile Include="ErrorHandlerAttribute.cs" />
    <Compile Include="Extensions\DateTimeExtensions.cs" />
    <Compile Include="Extensions\EnumerableExtensions.cs" />
    <Compile Include="Extensions\SAPExtensions.cs" />
    <Compile Include="SAPDataTypeMapping\DataTypeCollection.cs" />
    <Compile Include="SAPDataTypeMapping\DataTypeElement.cs" />
    <Compile Include="SAPDataTypeMapping\SAPDataTypeConfiguration.cs" />
    <Compile Include="SAPUtils.cs" />
    <Compile Include="ServiceModelUtils.cs" />
    <Compile Include="Extensions\SystemExtensions.cs" />
    <Compile Include="Properties\AssemblyInfo.cs" />
    <Compile Include="SAPConfiguration.cs" />
    <Compile Include="TextExceptionFormatter.cs" />
    <Compile Include="TransactionScopeFactory.cs" />
    <Compile Include="TypeConverters.cs" />
    <Compile Include="WCFLogListener.cs" />
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <!-- To modify your build process, add your task inside one of the targets below and uncomment it. 
       Other similar extension points exist, see Microsoft.Common.targets.
  <Target Name="BeforeBuild">
  </Target>
  <Target Name="AfterBuild">
  </Target>
  -->
</Project>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
SAPUtils.cs
1341
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.Linq;
using System.Reflection;
using System.Web;
using Microsoft.SqlServer.Management.Smo;
using SAP.Middleware.Connector;

namespace SAPServer.Core
{
    public class SAPUtils
    {
        public static RfcDataType GetRfcDataType(string dataType)
        {
            string rfcDataType = dataType;

            if (!Enum.IsDefined(typeof(RfcDataType), dataType))
            {
                DataTypeElement dt = SAPDataTypeConfiguration.SAPDataTypes.DataTypes
                    .Cast<DataTypeElement>()
                    .FirstOrDefault(x => x.Name.Equals(dataType, StringComparison.InvariantCultureIgnoreCase));

                if (dt == null)
                {
                    throw new InvalidOperationException(string.Format("No mapping found for Rfc data type '{0}'", dataType));
                }

                rfcDataType = dt.MapTo;
            }

            RfcDataType result;

            if (!Enum.TryParse<RfcDataType>(rfcDataType, true, out result))
            {
                throw new InvalidOperationException(string.Format("Rfc data type '{0}' is not a valid RfcDataType", rfcDataType));
            }

            return result;
        }

    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
ServiceModelUtils.cs
1077
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.ServiceModel;

namespace SAPServer.Core
{
    public class ServiceModelUtils
    {
        public static void ReleaseCommunicationObjects(params ICommunicationObject[] communicationObjects)
        {
            if (communicationObjects == null)
            {
                return;
            }

            foreach (ICommunicationObject communicationObject in communicationObjects)
            {
                if (communicationObject == null)
                {
                    continue;
                }

                switch (communicationObject.State)
                {
                    case CommunicationState.Faulted:
                        communicationObject.Abort();
                        break;

                    case CommunicationState.Opened:
                        communicationObject.Close();
                        break;
                }
            }
        }
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
TextExceptionFormatter.cs
8472
using System;
using System.Collections.Specialized;
using System.IO;
using System.Reflection;
using System.Security.Principal;
using System.Threading;

namespace SAPServer.Core
{
    public class TextExceptionFormatter
        : Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.TextExceptionFormatter
    {
        #regionFields

        int exceptionCounter = 0;

        #endregionFields

        #regionConstructors

        public TextExceptionFormatter(TextWriter writer, Exception exception, Guid handlingInstanceId)
            : base(writer, exception, handlingInstanceId)
        {
        }

        public TextExceptionFormatter(TextWriter writer, Exception exception)
            : base(writer, exception, Guid.Empty)
        {
        }

        #endregionConstructors

        #region Public Methods

        public static string GetInnerMostExceptionMessage(string formattedFullMessage)
        {
            StringReader reader = new StringReader(formattedFullMessage);
            string innerException = string.Empty;
            string exceptionText;

            while ((exceptionText = reader.ReadLine()) != null)
            {
                if (!string.IsNullOrEmpty(exceptionText) && exceptionText.ToLower().Equals("message"))
                {
                    exceptionText = reader.ReadLine();
                    if (!string.IsNullOrWhiteSpace(exceptionText))
                        innerException = exceptionText.Replace("\t", "");
                    break;
                }
            }

            return innerException;
        }

        #endregion

        #regionProtectedMethods

        protected override void WriteDateTime(DateTime dateTime)
        {
            Writer.WriteLine(string.Format("EXACT TIME: {0:d-MMM-yyyy HH:mm:ss.ffffff}",
                dateTime.ToLocalTime()));
        }

        protected override void WriteException(Exception exception, Exception outerException)
        {
            if (exception == null)
            {
                WriteSection("WriteException(Exception exception, Exception outerException)", "exception is null");
            }
            else
            {
                if (outerException == null)
                {
                    WriteSectionEssentials();

                    if (exception.InnerException == null)
                    {
                        exceptionCounter = 0;
                    }
                    else
                    {
                        exceptionCounter = 1;

                        Writer.WriteLine("EXCEPTION TREE (starting with the most inner exception):");
                    }

                    WriteException(exception);
                }
                else
                {
                    WriteException(exception);
                }
            }
        }

        protected override void WriteFieldInfo(FieldInfo fieldInfo, object value)
        {
            if (fieldInfo == null)
            {
                return;
            }

            WriteNameValue(fieldInfo.Name, value);
        }

        protected override void WritePropertyInfo(PropertyInfo propertyInfo, object value)
        {
            if (propertyInfo == null)
            {
                return;
            }

            WriteNameValue(propertyInfo.Name, value);
        }

        #endregionProtectedMethods

        #regionPrivateMethods

        void WriteException(Exception exception)
        {
            if (exception == null)
            {
                WriteSection("WriteException(Exception exception)", "exception is null");
            }
            else
            {
                Exception inner = exception.InnerException;

                if (inner != null)
                {
                    WriteException(inner, exception);

                    Writer.WriteLine();
                }

                WriteSection("EXCEPTION " + (exceptionCounter == 0 ?
                    string.Empty :
                    string.Format("#{0}", exceptionCounter++)), GetExceptionTypeName(exception));
                WriteSection("MESSAGE", exception.Message);
                WriteSection("STACK TRACE", exception.StackTrace);
                WriteSection("SOURCE", exception.Source);
                WriteSection("HELP LINK", exception.HelpLink);
                WriteSectionOtherPropertiesAndFileds(exception);
            }
        }

        void WriteNameValue(string name, object value)
        {
            string text = null;

            if (value == null)
            {
                text = "< null >";
            }
            else
            {
                text = value.ToString();

                if (string.IsNullOrWhiteSpace(text))
                {
                    text = "< empty >";
                }
            }

            Writer.WriteLine(string.Format("\t{0} = {1}", name, text));
        }

        void WriteSection(string sectionName, string sectionText)
        {
            Writer.WriteLine(sectionName);
            Writer.WriteLine(string.Format("\t{0}",
                string.IsNullOrWhiteSpace(sectionText) ? "< none provided >" : sectionText));
            Writer.WriteLine();
        }

        void WriteSectionEssentials()
        {
            Writer.WriteLine(string.Format("EXECUTING ASSEMBLY: {0}", GetExecutingAssemblyName()));
            Writer.WriteLine(string.Format("THREAD IDENTITY: {0}", GetThreadIdentity()));
            Writer.WriteLine(string.Format("PROCESS IDENTITY: {0}", GetWindowsIdentity()));
            Writer.WriteLine();
        }

        void WriteSectionOtherPropertiesAndFileds(Exception exception)
        {
            Writer.WriteLine("OTHER PUBLIC PROPERTIES AND FIELDS:");
            WriteReflectionInfo(exception);
        }

        #endregionPrivateMethods

        #regionPrivateStaticMethods

        static string GetExceptionTypeName(Exception exception)
        {
            if (exception == null)
            {
                return "< null >";
            }

            try
            {
                return exception.GetType().AssemblyQualifiedName;
            }
            catch (Exception ex)
            {
                return string.Format("Unaccessible exception.GetType().AssemblyQualifiedName: {0}",
                    ex.Message);
            }
        }

        static string GetExecutingAssemblyName()
        {
            try
            {
                return Assembly.GetExecutingAssembly().FullName;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible Assembly.GetExecutingAssembly().FullName: {0}",
                    exception.Message);
            }
        }

        static string GetMachineName()
        {
            try
            {
                return Environment.MachineName;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible Environment.MachineName: {0}",
                    exception.Message);
            }
        }

        static string GetThreadIdentity()
        {
            try
            {
                if (Thread.CurrentPrincipal == null)
                {
                    return "<Thread.CurrentPrincipal: null>";
                }

                if (Thread.CurrentPrincipal.Identity == null)
                {
                    return "<Thread.CurrentPrincipal.Identity: null>";
                }

                return Thread.CurrentPrincipal.Identity.Name;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible Thread.CurrentPrincipal.Identity: {0}",
                    exception.Message);
            }
        }

        static string GetWindowsIdentity()
        {
            try
            {
                return WindowsIdentity.GetCurrent().Name;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible WindowsIdentity.GetCurrent().Name: {0}",
                    exception.Message);
            }
        }

        #endregionPrivateStaticMethods
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
TransactionScopeFactory.cs
2724
using System;
using System.Transactions;

namespace SAPServer.Core
{
    public interface ITransactionScopeFactory
    {
        IDisposable CreateEnterprise();
        IDisposable CreateDefault();
        IDisposable CreateSuppress();
        IDisposable CreateNew();
        void Complete(IDisposable transactionScope);
    }

    public class TransactionScopeFactory : ITransactionScopeFactory
    {
        public virtual IDisposable CreateEnterprise()
        {
            return new TransactionScope(
                TransactionScopeOption.RequiresNew,
                new TransactionOptions
                {
                    IsolationLevel = Transaction.Current == null ? IsolationLevel.ReadCommitted : Transaction.Current.IsolationLevel,
                    Timeout = TimeSpan.FromMinutes(30)
                },
                EnterpriseServicesInteropOption.Full);
        }

        public virtual IDisposable CreateDefault()
        {
            return new TransactionScope(
                TransactionScopeOption.Required,
                new TransactionOptions
                {
                    IsolationLevel = Transaction.Current == null ? IsolationLevel.ReadCommitted : Transaction.Current.IsolationLevel,
                    Timeout = TimeSpan.FromMinutes(30)
                });
        }

        public virtual IDisposable CreateSuppress()
        {
            return new TransactionScope(
                TransactionScopeOption.Suppress,
                new TransactionOptions
                {
                    IsolationLevel = Transaction.Current == null ? IsolationLevel.ReadCommitted : Transaction.Current.IsolationLevel,
                    Timeout = TimeSpan.FromMinutes(30)
                });
        }

        public virtual IDisposable CreateNew()
        {
            return new TransactionScope(
                TransactionScopeOption.RequiresNew,
                new TransactionOptions
                {
                    IsolationLevel = Transaction.Current == null ? IsolationLevel.ReadCommitted : Transaction.Current.IsolationLevel,
                    Timeout = TimeSpan.FromMinutes(30)
                });
        }

        public virtual void Complete(IDisposable transactionScope)
        {
            if (transactionScope == null)
            {
                throw new ArgumentNullException("transactionScope");
            }

            if (!(transactionScope is TransactionScope))
            {
                throw new InvalidCastException("transactionScope is not TransactionScope");
            }

            ((TransactionScope)transactionScope).Complete();
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
TypeConverters.cs
3441
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Globalization;

namespace SAPServer.Core
{
    /// <summary>
    /// Converts text to Dictionary<string, string> instance. Text format: key=value,key=value,key=value
    /// </summary>
    public class NameValueCommaSeparatedTextTypeConverter : TypeConverter
    {
        public override object ConvertFrom(ITypeDescriptorContext context, CultureInfo culture, object value)
        {
            Dictionary<string, string> dictionary = new Dictionary<string, string>();

            string[] nameValues = value.ToString().Split(',');

            foreach (string nameValue in nameValues)
            {
                if (!string.IsNullOrWhiteSpace(nameValue))
                {
                    int positionOfFirstEqualitySign = nameValue.IndexOf('=');

                    if (positionOfFirstEqualitySign < 0)
                    {
                        throw new InvalidOperationException(string.Format("Value does not conform to pattern \"key1=value1,key2=value2,key3=value3 ..., keyN=valueN\". {0}", value));
                    }

                    string n = nameValue.Substring(0, positionOfFirstEqualitySign);

                    if (string.IsNullOrWhiteSpace(n))
                    {
                        throw new InvalidOperationException(string.Format("Value has an empty name {0}", nameValue));
                    }

                    string v = nameValue.Substring(positionOfFirstEqualitySign + 1);

                    dictionary.Add(n, v);
                }
            }

            return dictionary;
        }
    }

    /// <summary>
    /// Converts type name into System.Type
    /// </summary>
    public class FullyQualifiedTypeStringTypeConverter : TypeConverter
    {
        public override object ConvertFrom(ITypeDescriptorContext context, CultureInfo culture, object value)
        {
            if (value == null)
            {
                throw new ArgumentNullException("Unable to convert NULL into type");
            }

            string typeName = value.ToString();

            if (string.IsNullOrWhiteSpace(typeName))
            {
                throw new ArgumentNullException("Unable to convert EMPTY or WHITE SPACE into type");
            }

            Type type = Type.GetType(typeName, false, true);

            if (type == null)
            {
                throw new NullReferenceException(string.Format("Unable to create type from string \"{0}\"", value));
            }

            return type;
        }
    }

    /// <summary>
    /// Converts text to Dictionary<string, IDataProcessor> instance. Text format: key=value,key=value,key=value
    /// </summary>
    //public class StringDataProcessorTypeConverter : TypeConverter
    //{
    //    public override object ConvertFrom(ITypeDescriptorContext context, CultureInfo culture, object value)
    //    {
    //        if(value.ToString().IndexOf(',') < 0)
    //        {
    //            throw new InvalidOperationException(string.Format("Value does not conform to pattern \"key=value\". {0}", value));
    //        }
            
    //        string[] nameValue = value.ToString().Split(',');
            
    //        return new KeyValuePair<string, IDataProcessor>(nameValue[0], nameValue[1]);
    //    }
    //}
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core
WCFLogListener.cs
5029
using System;
using System.Collections;
using System.Collections.Specialized;
using System.Diagnostics;
using System.IO;
using System.Text;
using System.ServiceModel;
using System.Runtime.InteropServices;
using Microsoft.Practices.EnterpriseLibrary.Common.Configuration;
using Microsoft.Practices.EnterpriseLibrary.Logging;
using Microsoft.Practices.EnterpriseLibrary.Logging.Formatters;

using System.Collections.Generic;
using System.Linq;
using System.Configuration;
using System.ServiceModel.Configuration;
using System.Xml;

using ApplicationManagement.Contract.Services;
using ApplicationManagement.Contract.Client;

namespace SAPServer.Core
{
    [ConfigurationElementType(typeof(WCFLogListenerData))]
    public class WCFLogListener : Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.CustomTraceListener
    {
        public WCFLogListener()
        {
        }
        public WCFLogListener(string endPointName, ILogFormatter formatter)
        {
        }

        public override bool IsThreadSafe
        {
            get { return true; }
        }

        public override string Name
        {
            get;
            set;
        }

        public override void Close()
        {
            base.Close();
        }

        protected override void Dispose(bool disposing)
        {
            base.Dispose();
        }

        public override void Fail(string message)
        {
            base.Fail(message);
        }

        public override void Fail(string message, string detailMessage)
        {
            base.Fail(message, detailMessage);
        }

        public override void Flush()
        {
            base.Flush();
        }

        protected override string[] GetSupportedAttributes()
        {
            return new string[] { };
        }

        [ComVisible(false)]
        public override void TraceData(TraceEventCache eventCache, string source, TraceEventType eventType, int id, object data)
        {
            WriteLog(eventType.ToString(), id.ToString(), data.ToString());
        }

        [ComVisible(false)]
        public override void TraceData(TraceEventCache eventCache, string source, TraceEventType eventType, int id, params object[] data)
        {
            StringBuilder builder = new StringBuilder();

            foreach (object item in data)
                builder.Append(item.ToString());

            WriteLog(eventType.ToString(), id.ToString(), builder.ToString());
        }

        public override void Write(object o)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void Write(string message)
        {
            WriteLog("Error", "", message);
        }

        public override void Write(object o, string category)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void Write(string message, string category)
        {
            WriteLog("Error", "", message);
        }

        protected override void WriteIndent()
        {
        }

        public override void WriteLine(object o)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void WriteLine(string message)
        {
            WriteLog("Error", "", message);
        }

        public override void WriteLine(object o, string category)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void WriteLine(string message, string category)
        {
            WriteLog("Error", "", message);
        }

        #region Private Method

        private void WriteLog(string logType, string priority, string exceptionDetail)
        {
            try
            {
                // ASSUMPTION: We are using the TextExceptionFormatter as the formatter for errors
                ErrorLoggerClient.WriteLog(Attributes["serviceAddress"], Attributes["logName"], logType, priority,
                                            TextExceptionFormatter.GetInnerMostExceptionMessage(exceptionDetail),
                                            exceptionDetail);
            }
            catch (Exception)
            {
                // swallow
            }
        }

        private Exception InnermostException(Exception exception)
        {
            if (exception.InnerException != null)
                return InnermostException(exception.InnerException);
            else
                return exception;
        }

        #endregion
    }

    public class WCFLogListenerData
        : Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.CustomTraceListenerData
    {
        #region Constructors

        public WCFLogListenerData()
        {
        }

        public WCFLogListenerData(string serviceAddress, string logName, string formatter)
        {
        }

        #endregion
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\Extensions
DateTimeExtensions.cs
2523
namespace System
{
    public static class DateTimeExtensions
    {
        public static DateTime GetFinancialYearEndDate(int financialYearEnd)
        {
            return new DateTime(financialYearEnd, 6, 30);
        }

        public static string GetFinancialYearString(this DateTime currentDate)
        {
            return string.Format("{0}/{1}", currentDate.AddMonths(-6).Year, currentDate.AddMonths(-6).Year + 1);
        }

        public static string GetFinancialYearString(int financialYearEnd)
        {
            return string.Format("{0}/{1}", financialYearEnd - 1, financialYearEnd);
        }

        public static int GetFinancialYearEndFromDate(this DateTime dateTime)
        {
            return dateTime.Month <= 6 ? dateTime.Year : dateTime.AddYears(1).Year;
        }

        public static DateTime Min(DateTime dateTime, DateTime comparisonDateTime)
        {
            if (dateTime <= comparisonDateTime)
                return dateTime;
            else
                return comparisonDateTime;
        }

        public static DateTime Max(DateTime dateTime, DateTime comparisonDateTime)
        {
            if (dateTime >= comparisonDateTime)
                return dateTime;
            else
                return comparisonDateTime;
        }

        public static int GetFinancialYearMonthFromDate(this DateTime dateTime)
        {
            int month = dateTime.Month;

            if (month > 6)
                return month - 6;
            else
                return month + 6;
        }

        public static double GetDifferenceInMonths(this DateTime finish, DateTime start)
        {
            double months = 0;

            DateTime current = start.Date;

            while (true)
            {
                DateTime nextMonthStartDate = current.AddMonths(1);

                DateTime prevMonthEndDate = nextMonthStartDate.AddDays(-1);

                if (prevMonthEndDate == finish.Date)
                {
                    months += 1;
                    break;
                }

                if (prevMonthEndDate > finish.Date)
                {
                    months += (double)((finish - current).Days + 1) / DateTime.DaysInMonth(current.Year, current.Month);
                    break;
                }

                months += 1;

                current = nextMonthStartDate;
            }

            return Math.Round(months, 4);
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\Extensions
EnumerableExtensions.cs
278
using System.Collections.Generic;

namespace System.Linq
{
    public static class EnumerableExtensions
    {
        public static bool IsNullOrEmpty<T>(this IEnumerable<T> sequence)
        {
            return sequence == null || !sequence.Any();
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\Extensions
SAPExtensions.cs
27867
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Reflection;
using Microsoft.SqlServer.Management.Smo;
using SAPServer.Core;

namespace SAP.Middleware.Connector
{
    public static class SAPExtensions
    {
        #regionFields

        static readonly string[] RfcErrorTypes = { "E", "A", "X" };
        public const string RfcExceptionType = "ERROR";
        public const string RfcExeptionKey = "SYSTEM_FAILURE";

        #endregionFields

        #regionPublicStaticMethods

        public static void Commit(this RfcDestination destination)
        {
            if (destination == null)
            {
                throw new ArgumentNullException("destination");
            }

            IRfcFunction function = destination.Repository.CreateFunction("BAPI_TRANSACTION_COMMIT");
            function.SetValue("WAIT", "X");
            function.InvokeAndThrowOnAnyException(destination);
        }

        /// <summary>
        /// Search function for parameters of type table or structure with names "E_RESULT", "ET_RETURN" or "RETURN" and return first found or empty enumerable
        /// </summary>
        /// <param name="function"></param>
        /// <returns></returns>
        public static IEnumerable<IRfcStructure> FindReturnMessages(this IRfcFunction function)
        {
            if (function == null)
            {
                throw new ArgumentNullException("function");
            }

            List<IRfcStructure> messages = new List<IRfcStructure>();

            string[] names = { "E_RESULT", "ET_RETURN", "RETURN" };

            IRfcParameter parameter;

            foreach (string name in names)
            {
                parameter = function.FirstOrDefault(x => x.Metadata.DataType == RfcDataType.TABLE && x.Metadata.Name.Equals(name, StringComparison.InvariantCultureIgnoreCase));

                if (parameter != null)
                {
                    messages.AddRange(function.GetTable(name));
                }

                parameter = function.FirstOrDefault(x => x.Metadata.DataType == RfcDataType.STRUCTURE && x.Metadata.Name.Equals(name, StringComparison.InvariantCultureIgnoreCase));

                if (parameter != null)
                {
                    messages.Add(function.GetStructure(name));
                }
            }

            return messages;
        }

        public static int FirstIndexOf(this RfcStructureMetadata metadata, params string[] fieldNames)
        {
            if (fieldNames == null)
            {
                throw new ArgumentNullException("fieldNames");
            }

            int index = -1;

            for (int i = 0; (i < fieldNames.Length) && (index == -1); i++)
            {
                index = metadata.TryNameToIndex(fieldNames[i]);
            }

            return index;
        }

        public static IEnumerable<IRfcStructure> GetAllColumns(this IRfcTable rfcTable, string field, params string[] excludeFields)
        {
            if (rfcTable == null)
            {
                throw new ArgumentNullException("rfcTable");
            }

            return rfcTable.Cast<IRfcStructure>().Select(x => x).Where(x => excludeFields == null || !excludeFields.Contains(x.GetString(field), StringComparer.InvariantCultureIgnoreCase));
        }

        public static IEnumerable<RfcElementMetadata> GetAllElementMetadata(this IRfcTable rfcTable, params string[] excludeFields)
        {
            if (rfcTable == null)
            {
                throw new ArgumentNullException("rfcTable");
            }

            return Enumerable.Range(0, rfcTable.ElementCount)
                .Select(x => rfcTable.GetElementMetadata(x))
                .Where(x => excludeFields == null || !excludeFields.Contains(x.Name, StringComparer.InvariantCultureIgnoreCase));
        }

        public static DataType GetMatchingSQLType(this RfcElementMetadata metadata)
        {
            if (metadata == null)
            {
                throw new ArgumentNullException("metadata");
            }

            switch (metadata.DataType)
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                    {
                        int precision = metadata.NucLength * 2 + metadata.Decimals;
                        if (precision > 38)
                        {
                            return DataType.VarChar(precision);
                        }
                        return DataType.Decimal(metadata.Decimals, precision);
                    }

                case RfcDataType.BYTE:
                    return DataType.VarBinary(metadata.NucLength);

                case RfcDataType.CDAY:
                    return DataType.Date;

                case RfcDataType.CHAR:
                    return DataType.Char(metadata.NucLength);

                case RfcDataType.DATE:
                    return DataType.DateTime;

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return DataType.Int;

                case RfcDataType.FLOAT:
                    return DataType.Float;

                case RfcDataType.INT1:
                    return DataType.TinyInt;

                case RfcDataType.INT2:
                    return DataType.SmallInt;

                case RfcDataType.INT8:
                    return DataType.BigInt;

                case RfcDataType.NUM:
                    {
                        int precision = metadata.NucLength * 2 + metadata.Decimals;
                        if (precision > 38)
                        {
                            return DataType.VarChar(precision);
                        }
                        return DataType.Numeric(metadata.Decimals, precision);
                    }

                case RfcDataType.STRING:
                    return DataType.VarChar(metadata.NucLength);

                case RfcDataType.TIME:
                    return DataType.Time(0);

                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return DataType.VarBinary(metadata.NucLength);

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable RfcField type", metadata.DataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown RfcField type: {0}", metadata.DataType));
            }
        }

        public static Type GetMatchingType(this RfcElementMetadata metadata)
        {
            if (metadata == null)
            {
                throw new ArgumentNullException("metadata");
            }

            switch (metadata.DataType)
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                case RfcDataType.NUM:
                    return typeof(decimal);

                case RfcDataType.BYTE:
                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return typeof(byte[]);

                case RfcDataType.CDAY:
                case RfcDataType.DATE:
                    return typeof(DateTime);

                case RfcDataType.CHAR:
                    return typeof(char[]);

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return typeof(int);

                case RfcDataType.FLOAT:
                    return typeof(double);

                case RfcDataType.INT1:
                    return typeof(byte);

                case RfcDataType.INT2:
                    return typeof(short);

                case RfcDataType.INT8:
                    return typeof(long);

                case RfcDataType.STRING:
                    return typeof(String);

                case RfcDataType.TIME:
                    return typeof(TimeSpan);

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable RfcField type", metadata.DataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown RfcField type: {0}", metadata.DataType));
            }
        }

        /// <summary>
        /// This hack enforces parameterName into table's metadata Name that is declared as "public readonly string Name;" in RfcTableMetadata
        /// and comes out empty by default
        /// </summary>
        /// <param name="function"></param>
        /// <param name="parameterName"></param>
        /// <returns></returns>
        public static IRfcTable GetNamedTable(this IRfcFunction function, string parameterName)
        {
            IRfcTable rfcTable = function.GetTable(parameterName);

            FieldInfo nameFieldInfo = rfcTable.Metadata.GetType().GetField("Name");
            nameFieldInfo.SetValue(rfcTable.Metadata, parameterName);

            return rfcTable;
        }

        /// <summary>
        /// This hack enforces parameterName into table's metadata Name that is declared as "public readonly string Name;" in RfcTableMetadata
        /// and comes out empty by default
        /// </summary>
        /// <param name="function"></param>
        /// <param name="parameterName"></param>
        /// <returns></returns>
        public static IRfcTable GetNamedTable(this IRfcFunction function, string parameterName, string tableName)
        {
            IRfcTable rfcTable = function.GetTable(parameterName);

            FieldInfo nameFieldInfo = rfcTable.Metadata.GetType().GetField("Name");
            nameFieldInfo.SetValue(rfcTable.Metadata, tableName);

            return rfcTable;
        }

        public static object GetSafeValue(this IRfcField field)
        {
            if (field == null)
            {
                throw new ArgumentNullException("field");
            }

            switch (field.Metadata.DataType)
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                case RfcDataType.NUM:
                    {
                        int precision = field.Metadata.NucLength * 2 + field.Metadata.Decimals;
                        if (precision > 38)
                        {
                            return field.GetString();
                        }
                        return field.GetDecimal();
                    }

                case RfcDataType.BYTE:
                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return field.GetByteArray();

                case RfcDataType.CDAY:
                case RfcDataType.DATE:
                    {
                        string text = field.GetString();
                        return text == "0000-00-00" ? DBNull.Value : (object)DateTime.Parse(text);
                    }

                case RfcDataType.TIME:
                    {
                        string text = field.GetString();
                        return text == "00:00:00" ? DBNull.Value : (object)TimeSpan.Parse(text);
                    }

                case RfcDataType.CHAR:
                    return field.GetCharArray();

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return field.GetInt();

                case RfcDataType.FLOAT:
                    return field.GetDouble();

                case RfcDataType.INT1:
                    return field.GetByte();

                case RfcDataType.INT2:
                    return field.GetShort();

                case RfcDataType.INT8:
                    return field.GetLong();

                case RfcDataType.STRING:
                    return field.GetString();

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable RfcField type", field.Metadata.DataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown RfcField type: {0}", field.Metadata.DataType));
            }
        }

        public static bool HasRfcError(this IRfcFunction function, out string errorMessage)
        {
            return function.FindReturnMessages().HasRfcError(out errorMessage);
        }

        public static bool HasRfcError(this IEnumerable<IRfcStructure> structures, out string errorMessage)
        {
            if (structures == null)
            {
                throw new ArgumentNullException("structures");
            }

            IEnumerable<string> messages = structures
                .Where(x =>
                {
                    int index = x.Metadata.FirstIndexOf("TYPE", "MESSAGE_TYPE");

                    if (index == -1)
                    {
                        throw new InvalidOperationException("Unable to find message type field");
                    }

                    return RfcErrorTypes.Contains(x.GetString(index));
                })
                .Select(x =>
                {
                    int index = x.Metadata.FirstIndexOf("MESSAGE", "MESSAGE_TEXT");

                    if (index == -1)
                    {
                        throw new InvalidOperationException("Unable to find message text");
                    }

                    return x.GetString(index);
                });

            errorMessage = string.Join("; ", messages);

            return !string.IsNullOrWhiteSpace(errorMessage);
        }

        public static bool HasRfcErrorNumber(this IEnumerable<IRfcStructure> structures, params int[] errorNumbers)
        {
            if (structures == null)
            {
                throw new ArgumentNullException("structures");
            }

            if (errorNumbers == null)
            {
                throw new ArgumentNullException("errorNumbers");
            }

            return structures.Any(x =>
            {
                int index = x.Metadata.FirstIndexOf("TYPE", "MESSAGE_TYPE");

                if (index == -1)
                {
                    throw new InvalidOperationException("Unable to find message type field");
                }

                string messageType = x.GetString(index);

                index = x.Metadata.FirstIndexOf("NUMBER", "MESSAGE_NUMBER");

                if (index == -1)
                {
                    throw new InvalidOperationException("Unable to find message number field");
                }

                int messageNumber = x.GetInt(index);

                return RfcErrorTypes.Contains(messageType) && errorNumbers.Contains(messageNumber);
            });
        }

        public static void Initialise(this RfcDestination destination)
        {
            if (destination == null)
            {
                throw new ArgumentNullException("destination");
            }

            destination.Repository.CreateFunction("BAPI_PS_INITIALIZATION").InvokeAndThrowOnAnyException(destination);
        }

        public static void InvokeAndThrowOnAnyException(this IRfcFunction function, RfcDestination destination)
        {
            if (function == null)
            {
                throw new ArgumentNullException("function");
            }

            if (destination == null)
            {
                throw new ArgumentNullException("destination");
            }

            function.Invoke(destination);

            Diagnostics.Current.Inform("{0}", function);

            string errorMessage;

            if (function.HasRfcError(out errorMessage))
            {
                throw new ApplicationException(errorMessage);
            }
        }

        public static bool IsTrue(string indicator)
        {
            return string.Equals(indicator, "X", StringComparison.InvariantCultureIgnoreCase);
        }

        public static void PreCommit(this RfcDestination destination)
        {
            if (destination == null)
            {
                throw new ArgumentNullException("destination");
            }

            destination.Repository.CreateFunction("BAPI_PS_PRECOMMIT").InvokeAndThrowOnAnyException(destination);
        }

        public static void PreCommitAndCommit(this RfcDestination destination)
        {
            if (destination == null)
            {
                throw new ArgumentNullException("destination");
            }

            destination.PreCommit();

            destination.Commit();
        }

        public static void Rollback(this RfcDestination destination)
        {
            if (destination == null)
            {
                throw new ArgumentNullException("destination");
            }

            destination.Repository.CreateFunction("BAPI_TRANSACTION_ROLLBACK").InvokeAndThrowOnAnyException(destination);
        }

        public static void SetValue(this IRfcStructure row, IRfcStructure xRow, string colName, object value, bool useActualValueForX = false)
        {
            string val = value == null ? "" : value.ToString();

            row.SetValue(colName, val);

            if (xRow != null)
                xRow.SetValue(colName, useActualValueForX ? val : "X");
        }

        public static void SetValueIfDifferent(this IRfcStructure row, IRfcStructure sourceRowToCompare, IRfcStructure xRow, string colName, object value, bool useActualValueForX = false)
        {
            string val = value == null ? "" : value.ToString();
            bool isNewOrDifferent = sourceRowToCompare == null || sourceRowToCompare.GetValue(colName).ToString() != val;

            row.SetValue(isNewOrDifferent ? xRow : null, colName, value, useActualValueForX);
        }

        public static Dictionary<string, object>[] ToArrayOfDictionaries(this IRfcTable table)
        {
            return table.Select(row => row.ToDictionary(field => field.Metadata.Name, field => field.GetValue())).ToArray();
        }

        #region SAP FSR Extensions

        public static Type GetMatchingType(this IRfcStructure structure, string dataType)
        {
            switch (SAPUtils.GetRfcDataType(dataType))
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                case RfcDataType.NUM:
                    return typeof(decimal);

                case RfcDataType.BYTE:
                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return typeof(byte[]);

                case RfcDataType.CDAY:
                case RfcDataType.DATE:
                    return typeof(DateTime);

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return typeof(int);

                case RfcDataType.FLOAT:
                    return typeof(double);

                case RfcDataType.INT1:
                    return typeof(byte);

                case RfcDataType.INT2:
                    return typeof(short);

                case RfcDataType.INT8:
                    return typeof(long);

                case RfcDataType.CHAR:
                case RfcDataType.STRING:
                    return typeof(String);

                case RfcDataType.TIME:
                    return typeof(TimeSpan);

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable Rfc data type", dataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown Rfc data type: {0}", dataType));
            }
        }

        public static DataType GetMatchingSQLType(this IRfcStructure structure, string dataType, int length, int decimals)
        {
            switch (SAPUtils.GetRfcDataType(dataType))
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                    {
                        int precision = length * 2 + decimals;
                        if (precision > 38)
                        {
                            return DataType.VarChar(precision);
                        }
                        return DataType.Decimal(decimals, precision);
                    }

                case RfcDataType.BYTE:
                    return DataType.VarBinary(length);

                case RfcDataType.CDAY:
                    return DataType.Date;

                case RfcDataType.DATE:
                    return DataType.DateTime2(0);

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return DataType.Int;

                case RfcDataType.FLOAT:
                    return DataType.Float;

                case RfcDataType.INT1:
                    return DataType.TinyInt;

                case RfcDataType.INT2:
                    return DataType.SmallInt;

                case RfcDataType.INT8:
                    return DataType.BigInt;

                case RfcDataType.NUM:
                    {
                        int precision = length * 2 + decimals;
                        if (precision > 38)
                        {
                            return DataType.VarChar(precision);
                        }
                        return DataType.Numeric(decimals, precision);
                    }

                case RfcDataType.CHAR:
                case RfcDataType.STRING:
                    return DataType.VarChar(length);

                case RfcDataType.TIME:
                    return DataType.Time(0);

                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return DataType.VarBinary(length);

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable Rfc data type", dataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown Rfc data type: {0}", dataType));
            }
        }

        public static object GetSafeValue(this IRfcStructure structure, string field, string dataType, int length, int decimals)
        {
            if (structure == null)
            {
                throw new ArgumentNullException("structure");
            }

            switch (SAPUtils.GetRfcDataType(dataType))
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                case RfcDataType.NUM:
                    {
                        int precision = length * 2 + decimals;
                        if (precision > 38)
                        {
                            return structure.GetString(field);
                        }
                        return structure.GetDecimal(field);
                    }

                case RfcDataType.BYTE:
                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return structure.GetByteArray(field);

                case RfcDataType.CDAY:
                case RfcDataType.DATE:
                    {
                        string text = structure.GetString(field);
                        return text == "00.00.0000" ? DBNull.Value : (object)DateTime.Parse(text); //(object)DateTime.ParseExact(text, "yyyymmdd", CultureInfo.InvariantCulture);
                    }

                case RfcDataType.TIME:
                    {
                        string text = structure.GetString(field);
                        return text == "00:00:00" ? DBNull.Value : (object)TimeSpan.Parse(text);
                    }

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return structure.GetInt(field);

                case RfcDataType.FLOAT:
                    return structure.GetDouble(field);

                case RfcDataType.INT1:
                    return structure.GetByte(field);

                case RfcDataType.INT2:
                    return structure.GetShort(field);

                case RfcDataType.INT8:
                    return structure.GetLong(field);

                case RfcDataType.CHAR:
                case RfcDataType.STRING:
                    return structure.GetString(field);

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable Rfc data type", dataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown Rfc data type: {0}", dataType));
            }
        }

        #endregion

        #endregionPublicStaticMethods
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\Extensions
SystemExtensions.cs
14056
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Reflection;

namespace System
{
    public static class ObjectExtensions
    {
        #regionPublicStaticMethods

        public static T As<T>(this object instance)
        {
            return (T)(instance.As(typeof(T)) ?? default(T));
        }

        public static object As(this object instance, Type destinationType)
        {
            if (instance == null)
            {
                return null;
            }

            Type sourceType = instance.GetType();

            // return instance right away if we can assign from source type to destination
            if (destinationType.IsAssignableFrom(sourceType))
            {
                return instance;
            }

            // if we can't assign and the instance is an empty string - return null
            if (sourceType == typeof(string) && string.IsNullOrWhiteSpace((string)instance))
            {
                return null;
            }

            // if we deal with convertible try to convert instance to destination
            // type using Convert.ChangeType
            if (instance is IConvertible)
            {
                try
                {
                    return Convert.ChangeType(instance, destinationType);
                }
                catch (Exception)
                {
                    // swallow
                    // for some reason we failed, check if destination type is Nullable and
                    // try to call "As" with Nullable underlying type as destinationType
                    try
                    {
                        Type t = Nullable.GetUnderlyingType(destinationType);

                        if (t != null)
                        {
                            return instance.As(t);
                        }
                    }
                    catch (Exception)
                    {
                        //swallow
                    }
                }
            }

            // try to convert instance using instance and destinationType converters
            TypeConverter converter = TypeDescriptor.GetConverter(instance);

            if (converter.CanConvertTo(destinationType))
            {
                return converter.ConvertTo(instance, destinationType);
            }

            converter = TypeDescriptor.GetConverter(destinationType);

            if (converter.CanConvertFrom(sourceType))
            {
                return converter.ConvertFrom(instance);
            }

            return null;
        }

        /// <summary>
        /// Copies property values from source to target where property names are the same.
        /// Copying is shallow.
        /// </summary>
        /// <param name="target"></param>
        /// <param name="source"></param>
        public static void CopyShallow(this object target, object source, Dictionary<string, string> sourcetoTargetPropertyMap = null)
        {
            if (target == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (source == null)
            {
                throw new ArgumentNullException("instance");
            }

            // find common properties in target and source and try to set target property values
            // from the source
            TypeDescriptor.GetProperties(target).Cast<PropertyDescriptor>()
                .Where(x => !x.IsReadOnly)
                .Join(TypeDescriptor.GetProperties(source).Cast<PropertyDescriptor>(),
                    targetProperty =>
                        targetProperty.Name,
                    sourceProperty =>
                    {
                        if (sourcetoTargetPropertyMap != null && sourcetoTargetPropertyMap.ContainsKey(sourceProperty.Name))
                        {
                            return sourcetoTargetPropertyMap[sourceProperty.Name];
                        }
                        return sourceProperty.Name;
                    },
                    (targetProperty, sourceProperty) => new
                    {
                        property = targetProperty,
                        value = sourceProperty.GetValue(source)
                    })
                .ToList()
                .ForEach(x =>
                {
                    try
                    {
                        x.property.SetValue(target, x.value.As(x.property.PropertyType));
                    }
                    catch (Exception)
                    {
                        //swallow
                    }
                });
        }

        public static T CreateAndCopyShallow<T>(this object target, Dictionary<string, string> sourcetoTargetPropertyMap = null) where T : new()
        {
            T instance = new T();

            instance.CopyShallow(target, sourcetoTargetPropertyMap);

            return instance;
        }

        public static int GetFinancialYear(this DateTime dateTime)
        {
            return dateTime.Date.AddMonths(6).Year;
        }

        public static object GetPropertyValue(this object instance, string property)
        {
            if (instance == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (string.IsNullOrWhiteSpace(property))
            {
                throw new ArgumentException("property is empty");
            }

            object value;

            if (!instance.TryGetPropertyValue(property, out value))
            {
                throw new NullReferenceException(string.Format("Property \"{0}\" is not found on \"{1}\"",
                    property,
                    instance.GetType()));
            }

            return value;
        }

        public static T GetPropertyValue<T>(this object instance, string property)
        {
            if (instance == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (string.IsNullOrWhiteSpace(property))
            {
                throw new ArgumentException("property is empty");
            }

            T value;

            if (!instance.TryGetPropertyValue<T>(property, out value))
            {
                throw new NullReferenceException(string.Format("Property \"{0}\" is not found on \"{1}\"",
                    property,
                    instance.GetType()));
            }

            return value;
        }

        public static object InvokeMethod(this object instance, string method, params object[] args)
        {
            if (instance == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (string.IsNullOrWhiteSpace(method))
            {
                throw new ArgumentException("property is empty");
            }

            MethodInfo methodInfo = instance.GetType().GetMethod(
                method,
                BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public);

            if (methodInfo == null)
            {
                throw new ArgumentException(string.Format(
                    "The method \"{0}\" is not found on the type \"{1}\"",
                    methodInfo,
                    instance.GetType().FullName));
            }

            return methodInfo.Invoke(instance, args);
        }

        public static void SetPropertyValue(this object instance, string property, object value)
        {
            if (instance == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (string.IsNullOrWhiteSpace(property))
            {
                throw new ArgumentException("property is empty");
            }

            if (!TrySetPropertyValue(instance, property, value))
            {
                throw new ApplicationException(string.Format(
                    "Unable to set \"{0}\" to \"{1}\" on \"{2}\"",
                    property,
                    value,
                    instance.GetType().Name));
            }
        }

        public static string Stringify(this object instance)
        {
            if (instance == null)
            {
                return "< null >";
            }

            // produces the following line: 
            // PropertyName="{PropertyValue}" PropertyName="{PropertyValue}" ...
            IEnumerable<string> sequence = TypeDescriptor.GetProperties(instance)
                .Cast<PropertyDescriptor>()
                .Select(x =>
                {
                    object value = null;

                    try
                    {
                        value = x.GetValue(instance);
                    }
                    catch (Exception exception)
                    {
                        value = string.Format("Unaccessible {0}: \"{1}\"", x.Name, exception);
                    }

                    if (value == null)
                    {
                        return string.Format("{0}=\"< null >\"", x.Name);
                    }

                    if (x.PropertyType == typeof(string) || !typeof(IEnumerable).IsAssignableFrom(x.PropertyType))
                    {
                        return string.Format("{0}=\"{1}\"", x.Name, value);
                    }

                    value = ((IEnumerable)value).Cast<dynamic>().Count();

                    return string.Format("{0}=\"{1} items\"", x.Name, value);
                });

            string text = "< no public properties >";

            if (sequence.Any())
            {
                text = sequence.Aggregate((x, y) => string.Format("{0} {1}", x, y));
            }

            // the following formatted string is returned:
            // [TypeName PropertyName="{PropertyValue}" PropertyName="{PropertyValue}" ...]
            return string.Format("[{0} {1}]", instance.GetType().Name, text);
        }

        public static bool TryGetPropertyValue(this object instance, string property, out object value)
        {
            if (instance == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (string.IsNullOrWhiteSpace(property))
            {
                throw new ArgumentException("property is empty");
            }

            PropertyDescriptor descriptor = TypeDescriptor.GetProperties(instance).Find(property, true);

            bool found = descriptor != null;

            value = found ? descriptor.GetValue(instance) : null;

            return descriptor != null;
        }

        public static bool TrySetPropertyValue(this object instance, string property, object value)
        {
            if (instance == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (string.IsNullOrWhiteSpace(property))
            {
                throw new ArgumentException("property is empty");
            }

            PropertyDescriptor descriptor = TypeDescriptor.GetProperties(instance).Find(property, true);

            bool found = descriptor != null;

            if (found)
            {
                try
                {
                    descriptor.SetValue(instance, value);
                }
                catch (Exception)
                {
                    found = false;
                }
            }

            return found;
        }

        public static bool TryGetPropertyValue<T>(this object instance, string property, out T value, T defaultValue = default(T))
        {
            if (instance == null)
            {
                throw new ArgumentNullException("instance");
            }

            if (string.IsNullOrWhiteSpace(property))
            {
                throw new ArgumentException("property is empty");
            }

            object o;

            bool found = instance.TryGetPropertyValue(property, out o);

            value = found ? o.As<T>() : defaultValue;

            return found;
        }

        #endregionPublicStaticMethods

        #regionPrivateStaticMethods

        static TypeDescriptionProvider EnsureTypeConverterAttribute(Type componentType, Type converterType)
        {
            if (componentType == null)
            {
                throw new ArgumentNullException("componentType");
            }

            if (converterType == null)
            {
                throw new ArgumentNullException("componentType");
            }

            if (!typeof(TypeConverter).IsAssignableFrom(converterType))
            {
                throw new ArgumentException(string.Format("converterType {0} is not derived from {1}",
                    converterType,
                    typeof(TypeConverter)));
            }

            TypeConverterAttribute attribute = TypeDescriptor.GetAttributes(componentType)
                .OfType<TypeConverterAttribute>()
                .FirstOrDefault();

            if (attribute == null)
            {
                return TypeDescriptor.AddAttributes(componentType, new TypeConverterAttribute(converterType));
            }

            if (attribute.ConverterTypeName != converterType.FullName)
            {
                throw new InvalidOperationException(string.Format(
                    "Unable to use converter \"{0}\" as the type already uses another converter \"{1}\"",
                    converterType,
                    attribute.ConverterTypeName));
            }

            return null;
        }

        #endregionPrivateStaticMethods
    }     
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\Properties
AssemblyInfo.cs
1436
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;

// General Information about an assembly is controlled through the following 
// set of attributes. Change these attribute values to modify the information
// associated with an assembly.
[assembly: AssemblyTitle("SAPServer.Core")]
[assembly: AssemblyDescription("")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyCompany("")]
[assembly: AssemblyProduct("SAPServer.Core")]
[assembly: AssemblyCopyright("Copyright   2015")]
[assembly: AssemblyTrademark("")]
[assembly: AssemblyCulture("")]

// Setting ComVisible to false makes the types in this assembly not visible 
// to COM components.  If you need to access a type in this assembly from 
// COM, set the ComVisible attribute to true on that type.
[assembly: ComVisible(false)]

// The following GUID is for the ID of the typelib if this project is exposed to COM
[assembly: Guid("87e8ef14-6c16-402f-9c09-2dda82ed1b2d")]

// Version information for an assembly consists of the following four values:
//
//      Major Version
//      Minor Version 
//      Build Number
//      Revision
//
// You can specify all the values or you can default the Build and Revision Numbers 
// by using the '*' as shown below:
// [assembly: AssemblyVersion("1.0.*")]
[assembly: AssemblyVersion("1.0.0.0")]
[assembly: AssemblyFileVersion("1.0.0.0")]

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\SAPDataTypeMapping
DataTypeCollection.cs
1309
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Web;

namespace SAPServer.Core
{
    [ConfigurationCollection(typeof(DataTypeElement))]
    public class DataTypeCollection : ConfigurationElementCollection
    {
        protected override ConfigurationElement CreateNewElement()
        {
            return new DataTypeElement();
        }

        protected override object GetElementKey(ConfigurationElement element)
        {
            return ((DataTypeElement)element).Name;
        }

        protected override string ElementName
        {
            get
            {
                return "dataType";
            }
        }

        protected override bool IsElementName(string elementName)
        {
            return !String.IsNullOrEmpty(elementName) && elementName == "dataType";
        }

        public override ConfigurationElementCollectionType CollectionType
        {
            get
            {
                return ConfigurationElementCollectionType.BasicMap;
            }
        }


        public DataTypeElement this[int index]
        {
            get
            {
                return base.BaseGet(index) as DataTypeElement;
            }
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\SAPDataTypeMapping
DataTypeElement.cs
670
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Web;

namespace SAPServer.Core
{
    public class DataTypeElement : ConfigurationElement
    {
        [ConfigurationProperty("name", IsKey = true, IsRequired = true)]
        public string Name
        {
            get { return (string)this["name"]; }
            set { this["name"] = value; }
        }

        [ConfigurationProperty("mapTo", IsRequired = true, DefaultValue = "char")]
        public string MapTo
        {
            get { return (string)this["mapTo"]; }
            set { this["mapTo"] = value; }
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Core\SAPDataTypeMapping
SAPDataTypeConfiguration.cs
636
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Web;

namespace SAPServer.Core
{
    public class SAPDataTypeConfiguration : ConfigurationSection
    {
        public static SAPDataTypeConfiguration SAPDataTypes = ConfigurationManager.GetSection("sapDataTypeMapping") as SAPDataTypeConfiguration;

        [ConfigurationProperty("dataTypes", IsDefaultCollection = true)]

        public DataTypeCollection DataTypes
        {
            get { return (DataTypeCollection)this["dataTypes"]; }
            set { this["dataTypes"] = value; }
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService
App.config
13161
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <configSections>
    <section name="loggingConfiguration" type="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.LoggingSettings, Microsoft.Practices.EnterpriseLibrary.Logging" requirePermission="true" />
    <section name="exceptionHandling" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Configuration.ExceptionHandlingSettings, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling" requirePermission="true" />
    <section name="unity" type="Microsoft.Practices.Unity.Configuration.UnityConfigurationSection, Microsoft.Practices.Unity.Configuration" requirePermission="true" />
  </configSections>
  <exceptionHandling>
    <exceptionPolicies>
      <add name="Global Policy">
        <exceptionTypes>
          <add name="All Exceptions" type="System.Exception, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" postHandlingAction="None">
            <exceptionHandlers>
              <add name="Logging Handler" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.LoggingExceptionHandler, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging" logCategory="Default Category" eventId="100" severity="Error"
                   title="Enterprise Library Exception Handling for the SAP RFC Service" priority="0"
                   formatterType="SAPServer.Core.TextExceptionFormatter, SAPServer.Core"/>
            </exceptionHandlers>
          </add>
        </exceptionTypes>
      </add>
    </exceptionPolicies>
  </exceptionHandling>
  <loggingConfiguration defaultCategory="Default Category" tracingEnabled="true">
    <logFilters>
      <add name="Category" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.CategoryFilter, Microsoft.Practices.EnterpriseLibrary.Logging" categoryFilterMode="AllowAllExceptDenied"/>
      <add name="Priority" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.PriorityFilter, Microsoft.Practices.EnterpriseLibrary.Logging" minimumPriority="0"/>
    </logFilters>
    <categorySources>
      <add name="Default Category" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </add>
      <add name="Diagnostics" switchValue="All">
        <listeners>
          <add name="Diagnostics" />
        </listeners>
      </add>
      <add name="AppSupport" switchValue="All">
        <listeners>
          <add name="WCF Log"/>
        </listeners>
      </add>
      <add name="Error" switchValue="All">
        <listeners>
          <add name="Event Log"/>
        </listeners>
      </add>
    </categorySources>
    <specialSources>
      <errors name="errors" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </errors>
    </specialSources>
    <listeners>
      <add name="Event Log" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.FormattedEventLogTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging" listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.FormattedEventLogTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           log="SAPInterface" machineName="." source="SAPInterface Service" formatter="Default Formatter"/>
      <add name="WCF Log" type="SAPServer.Core.WCFLogListener, SAPServer.Core" formatter="Default Formatter" listenerDataType="SAPServer.Core.WCFLogListenerData, SAPServer.Core"
           logName="SAPInterface" serviceAddress="http://localhost:105/Services/ErrorLoggerService.svc"/>
      <add name="Diagnostics" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.RollingFlatFileTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging"
           listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.RollingFlatFileTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           fileName="diagnostics.log" footer="----------------" formatter="MessageOnlyTextFormatter" header="" rollFileExistsBehavior="Increment"
           rollInterval="Day" maxArchivedFiles="30" />
    </listeners>
    <formatters>
      <add name="Default Formatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="Timestamp: {timestamp} Message: {message} Category: {category} Priority: {priority} EventId: {eventid} Severity: {severity} Title:{title} Machine: {machine} Application Domain: {appDomain} Process Id: {processId} Process Name: {processName} Win32 Thread Id: {win32ThreadId} Thread Name: {threadName} Extended Properties: {dictionary({key} - {value})}"/>
      <add name="MessageOnlyTextFormatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="{timestamp(local:dd/MM/yyyy H:mm:ss.fff)}: {message}" />
    </formatters>
  </loggingConfiguration>
  <unity xmlns="http://schemas.microsoft.com/practices/2010/unity">
    <alias type="SAPServer.Core.IClassFactory, SAPServer.Core" alias="IClassFactory" />
    <alias type="SAPServer.Core.ClassFactory, SAPServer.Core" alias="ClassFactory" />
    <alias type="SAPServer.Core.ISAPConfiguration, SAPServer.Core" alias="ISAPConfiguration" />
    <alias type="SAPServer.Core.SAPConfiguration, SAPServer.Core" alias="SAPConfiguration" />
    <alias type="SAPServer.Core.ITransactionScopeFactory, SAPServer.Core" alias="ITransactionScopeFactory" />
    <alias type="SAPServer.Core.TransactionScopeFactory, SAPServer.Core" alias="TransactionScopeFactory" />

    <alias type="SAPServer.RFCService.RfcServerHosting.IRfcServerHost, SAPServer.RFCService" alias="IRfcServerHost" />
    <alias type="SAPServer.RFCService.RfcServerHosting.RfcServerHost, SAPServer.RFCService" alias="RfcServerHost" />
    <alias type="SAPServer.RFCService.RfcServerHosting.IRfcServerHostFactory, SAPServer.RFCService" alias="IRfcServerHostFactory" />
    <alias type="SAPServer.RFCService.RfcServerHosting.RfcServerHostFactory, SAPServer.RFCService" alias="RfcServerHostFactory" />
    <alias type="SAPServer.RFCService.UnitIDHandlers.FMISInterfaceEventUnitIDHandler, SAPServer.RFCService" alias="FMISInterfaceEventUnitIDHandler" />
    <alias type="SAPServer.RFCService.UnitIDHandlers.EDWEventUnitIDHandler, SAPServer.RFCService" alias="EDWEventUnitIDHandler" />
    <alias type="SAPServer.RFCService.FMISInterface.IFMISInterfaceSAPServerService, SAPServer.RFCService" alias="IFMISInterfaceSAPServerService" />
    <alias type="SAPServer.RFCService.FMISInterface.FMISInterfaceSAPServerService, SAPServer.RFCService" alias="FMISInterfaceSAPServerService" />
    <alias type="SAPServer.RFCService.Replication.ITableReplicator, SAPServer.RFCService" alias="ITableReplicator" />
    <alias type="SAPServer.RFCService.Replication.TableReplicator, SAPServer.RFCService" alias="TableReplicator" />

    <alias type="SAP.Middleware.Connector.IUnitIDHandler, sapnco" alias="IUnitIDHandler" />
    <alias type="System.Collections.Generic.Dictionary`2[[System.String, mscorlib], [System.String, mscorlib]], mscorlib" alias="DictionaryStringString" />
    <container>
      <instance name="RfcServerGatewayFMIS" value="NAME=FMIS_EVENT_GATEWAY,GWHOST=deva-ap00263L,GWSERV=sapgw00,PROGRAM_ID=FMIS_RFC_PROGRAM" type="DictionaryStringString" typeConverter="SAPServer.Core.NameValueCommaSeparatedTextTypeConverter, SAPServer.Core"/>
      <instance name="RfcServerGatewayEDW" value="NAME=EDW_EVENT_GATEWAY,GWHOST=deva-ap00263L,GWSERV=sapgw00,PROGRAM_ID=EDW_RFC_PROGRAM" type="DictionaryStringString" typeConverter="SAPServer.Core.NameValueCommaSeparatedTextTypeConverter, SAPServer.Core"/>
      <instance name="RfcDestination" value="NAME=DEFAULT_DESTINATION,ASHOST=deva-ap00263L,USER=AID_MGMNT,PASSWD=@id_mgmnt,CLIENT=100" type="DictionaryStringString" typeConverter="SAPServer.Core.NameValueCommaSeparatedTextTypeConverter, SAPServer.Core"/>
      <instance name="ConnectionStringSAPADM" value="data Source=DEVA-DB00126L,31000;Initial Catalog=Audit_SAPADM;Integrated Security=SSPI;"/>
      <register type="IClassFactory" mapTo="ClassFactory" />
      <register type="ISAPConfiguration" mapTo="SAPConfiguration" name="SAPConfiguration" />
      <register type="ITransactionScopeFactory" mapTo="TransactionScopeFactory" />
      <register type="IUnitIDHandler" mapTo="FMISInterfaceEventUnitIDHandler" name="FMISInterfaceEventUnitIDHandler" />
      <register type="IUnitIDHandler" mapTo="EDWEventUnitIDHandler" name="EDWEventUnitIDHandler" />
      <register type="IRfcServerHostFactory" mapTo="RfcServerHostFactory">
        <lifetime type="singleton" />
        <constructor>
          <param name="nameRegistrations">
            <array>
              <value value="FMISInterfaceEvent"/>
              <value value="EDWEvent"/>
            </array>
          </param>
        </constructor>
      </register>
      <register type="IRfcServerHost" mapTo="RfcServerHost" name="FMISInterfaceEvent">
        <constructor>
          <param name="gatewayParameters" dependencyName="RfcServerGatewayFMIS" />
          <param name="destinationParameters" dependencyName="RfcDestination" />
          <param name="unitIDHandler" dependencyName="FMISInterfaceEventUnitIDHandler" />
          <param name="functionHandlerTypes">
            <array>
              <value value="SAPServer.RFCService.RfcFunctionHandlers.FMISInterfaceEventRfcFunctionHandler, SAPServer.RFCService" typeConverter="SAPServer.Core.FullyQualifiedTypeStringTypeConverter, SAPServer.Core" />
            </array>
          </param>
        </constructor>
      </register>
      <register type="IRfcServerHost" mapTo="RfcServerHost" name="EDWEvent">
        <constructor>
          <param name="gatewayParameters" dependencyName="RfcServerGatewayEDW" />
          <param name="destinationParameters" dependencyName="RfcDestination" />
          <param name="unitIDHandler" dependencyName="EDWEventUnitIDHandler" />
          <param name="functionHandlerTypes">
            <array>
              <value value="SAPServer.RFCService.RfcFunctionHandlers.EDWEventRfcFunctionHandler, SAPServer.RFCService" typeConverter="SAPServer.Core.FullyQualifiedTypeStringTypeConverter, SAPServer.Core" />
            </array>
          </param>
        </constructor>
      </register>
      <register type="IFMISInterfaceSAPServerService" mapTo="FMISInterfaceSAPServerService">
        <constructor>
          <param name="sapEndPointName" value="FMISInterfaceServiceBlack" />
          <param name="adminEndPointName" value="AdministrationServiceBlack" />
        </constructor>
      </register>
      <register type="ITableReplicator" mapTo="TableReplicator">
        <constructor>
          <param name="connectionString" dependencyName="ConnectionStringSAPADM" />
        </constructor>
      </register>
    </container>
  </unity>
  <system.serviceModel>
    <serviceHostingEnvironment multipleSiteBindingsEnabled="true" />
    <bindings>
      <basicHttpBinding>
        <binding name="BasicHttpBinding_Windows" openTimeout="00:15:00" closeTimeout="00:15:00" receiveTimeout="00:15:00" sendTimeout="00:15:00" maxReceivedMessageSize="4194304">
          <security mode="TransportCredentialOnly">
            <transport clientCredentialType="Windows" proxyCredentialType="None" realm="" />
          </security>
        </binding>
      </basicHttpBinding>
      <wsHttpBinding>
        <binding name="WSHttpBinding_Transactional" transactionFlow="true" openTimeout="00:15:00" closeTimeout="00:15:00" receiveTimeout="00:15:00" sendTimeout="00:15:00" maxReceivedMessageSize="2147483647">
          <readerQuotas maxDepth="2147483647" maxStringContentLength="2147483647" maxArrayLength="2147483647" maxBytesPerRead="2147483647" maxNameTableCharCount="2147483647" />
        </binding>
      </wsHttpBinding>
    </bindings>
    <client>
      <endpoint address="http://localhost:85/Services/SAPServiceProxy.svc"
                     binding="wsHttpBinding" bindingConfiguration="WSHttpBinding_Transactional"
                     contract="ServiceBus.Contract.Service.ISAPServiceProxy" name="FMISInterfaceServiceBlack" />
      <endpoint address="http://localhost:85/Services/AdministrationService.svc"
                     binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows"
                     contract="ServiceBus.Contract.Service.IAdministrationService" name="AdministrationServiceBlack" />
    </client>
    <behaviors>
      <serviceBehaviors>
        <behavior name="">
          <serviceMetadata httpGetEnabled="true" />
          <serviceDebug includeExceptionDetailInFaults="false" />
          <serviceAuthorization principalPermissionMode="UseAspNetRoles" roleProviderName="AspNetSqlRoleProvider" />
        </behavior>
      </serviceBehaviors>
    </behaviors>
  </system.serviceModel>
</configuration>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService
App.Release.config
2268
<?xml version="1.0"?>
<configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform">
  <loggingConfiguration defaultCategory="Default Category" tracingEnabled="true" xdt:Locator="Match(defaultCategory)" xdt:Transform="SetAttributes">
    <listeners>
      <add name="WCF Log" serviceAddress="http://__AppSupportDNS__/Services/ErrorLoggerService.svc"  xdt:Locator="Match(name)" xdt:Transform="SetAttributes"/>
    </listeners>
  </loggingConfiguration>
  <unity xmlns="http://schemas.microsoft.com/practices/2010/unity">
    <container>
      <instance name="RfcServerGatewayFMIS"
                value="NAME=FMIS_EVENT_GATEWAY,GWHOST=__SAPDNS__,GWSERV=sapgw00,PROGRAM_ID=FMIS_RFC_PROGRAM"
                xdt:Transform="SetAttributes"
                xdt:Locator="Match(name)" />
      <instance name="RfcServerGatewayEDW"
                value="NAME=EDW_EVENT_GATEWAY,GWHOST=__SAPDNS__,GWSERV=sapgw00,PROGRAM_ID=EDW_RFC_PROGRAM"
                xdt:Transform="SetAttributes"
                xdt:Locator="Match(name)" />
      <instance name="RfcDestination"
                value="NAME=DEFAULT_DESTINATION,ASHOST=__SAPDNS__,USER=AID_MGMNT,PASSWD=__SAPPwd__,CLIENT=100"
                xdt:Transform="SetAttributes"
                xdt:Locator="Match(name)" />
      <instance name="ConnectionStringSAPADM"
                value="data Source=__SAPADMDataSource__;Initial Catalog=Audit_SAPADM;Integrated Security=SSPI;"
                xdt:Transform="SetAttributes"
                xdt:Locator="Match(name)"/>
    </container>
  </unity>
  <system.serviceModel>
    <client>
      <endpoint name="FMISInterfaceServiceBlack"
                address="http://__ServiceBusDNS__/Services/SAPServiceProxy.svc"
                xdt:Locator="Match(name)"
                xdt:Transform="SetAttributes" >
        <identity xdt:Transform="Insert">
          <userPrincipalName value="__ServiceBusSvcAct__" />
        </identity>
      </endpoint>
      <endpoint name="AdministrationServiceBlack"
				        address="http://__ServiceBusDNS__/Services/AdministrationService.svc"
                xdt:Locator="Match(name)"
				        xdt:Transform="SetAttributes" />
    </client>
  </system.serviceModel>
</configuration>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService
Program.cs
1420
using System;
using System.Diagnostics;
using System.ServiceProcess;
using SAPServer.Core;
using SAPServer.RFCService.RfcServerHosting;
using Microsoft.Practices.EnterpriseLibrary.ExceptionHandling;

namespace SAPServer.RFCService
{
    static class Program
    {
        /// <summary>
        /// The main entry point for the application.
        /// </summary>
        static void Main()
        {
            try
            {
                IRfcServerHostFactory serverHostFactory = Class.New<IRfcServerHostFactory>();

                IRfcServerHost[] serverHosts = serverHostFactory.Create();

                if (Debugger.IsAttached)
                {
                    WindowsService windowsService = new WindowsService(serverHosts);
                    windowsService.EnsureHostsStarted();

                    while (true)
                    {
                        // indefinite loop left on purpose to work with debugger
                    };
                }
                else
                {
                    WindowsService windowsService = new WindowsService(serverHosts);
                    ServiceBase.Run(windowsService);
                }
            }
            catch(Exception exception)
            {
                ExceptionPolicy.HandleException(exception, "Global Policy");

                throw;
            }
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService
SAPServer.RFCService.csproj
14029
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProjectGuid>{CB4D8799-0380-4E22-A168-8F8062FCDB2D}</ProjectGuid>
    <OutputType>WinExe</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>SAPServer.RFCService</RootNamespace>
    <AssemblyName>SAPServer.RFCService</AssemblyName>
    <TargetFrameworkVersion>v4.5.1</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <SccProjectName>SAK</SccProjectName>
    <SccLocalPath>SAK</SccLocalPath>
    <SccAuxPath>SAK</SccAuxPath>
    <SccProvider>SAK</SccProvider>
    <TargetFrameworkProfile />
    <IsWebBootstrapper>false</IsWebBootstrapper>
    <PublishUrl>..\publish\Service_App\</PublishUrl>
    <Install>true</Install>
    <InstallFrom>Disk</InstallFrom>
    <UpdateEnabled>false</UpdateEnabled>
    <UpdateMode>Foreground</UpdateMode>
    <UpdateInterval>7</UpdateInterval>
    <UpdateIntervalUnits>Days</UpdateIntervalUnits>
    <UpdatePeriodically>false</UpdatePeriodically>
    <UpdateRequired>false</UpdateRequired>
    <MapFileExtensions>true</MapFileExtensions>
    <ApplicationRevision>1</ApplicationRevision>
    <ApplicationVersion>1.0.0.%2a</ApplicationVersion>
    <UseApplicationTrust>false</UseApplicationTrust>
    <PublishWizardCompleted>true</PublishWizardCompleted>
    <BootstrapperEnabled>true</BootstrapperEnabled>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <PlatformTarget>x64</PlatformTarget>
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <PlatformTarget>x64</PlatformTarget>
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup>
    <ManifestCertificateThumbprint>69CF4A3EC65F10557C65184329669C635E904C29</ManifestCertificateThumbprint>
  </PropertyGroup>
  <PropertyGroup>
    <ManifestKeyFile>SAPServer.RFCService_TemporaryKey.pfx</ManifestKeyFile>
  </PropertyGroup>
  <PropertyGroup>
    <GenerateManifests>true</GenerateManifests>
  </PropertyGroup>
  <PropertyGroup>
    <SignManifests>false</SignManifests>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x86'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\x86\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x86'">
    <OutputPath>bin\x86\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x64'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\x64\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x64'">
    <OutputPath>bin\x64\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="ApplicationManagement.Contract">
      <HintPath>..\ThirdPartyComponents\ApplicationManagement.Contract.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Common, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Common.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling, Version=5.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging, Version=5.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Logging, Version=5.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.ServiceLocation, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.ServiceLocation.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity, Version=2.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Configuration, Version=2.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Configuration.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Interception, Version=2.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Interception.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.ConnectionInfo, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.ConnectionInfo.dll</HintPath>
      <Private>True</Private>
    </Reference>
    <Reference Include="Microsoft.SqlServer.Management.Sdk.Sfc, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.Management.Sdk.Sfc.dll</HintPath>
      <Private>True</Private>
    </Reference>
    <Reference Include="Microsoft.SqlServer.Smo, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.Smo.dll</HintPath>
      <Private>True</Private>
    </Reference>
    <Reference Include="Microsoft.SqlServer.SqlClrProvider, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.SqlClrProvider.dll</HintPath>
      <Private>True</Private>
    </Reference>
    <Reference Include="Microsoft.SqlServer.SqlEnum, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.SqlEnum.dll</HintPath>
      <Private>True</Private>
    </Reference>
    <Reference Include="sapnco">
      <HintPath>..\ThirdPartyComponents\sapnco.dll</HintPath>
    </Reference>
    <Reference Include="sapnco_utils">
      <HintPath>..\ThirdPartyComponents\sapnco_utils.dll</HintPath>
    </Reference>
    <Reference Include="ServiceBus.Contract">
      <HintPath>..\ThirdPartyComponents\ServiceBus.Contract.dll</HintPath>
    </Reference>
    <Reference Include="System" />
    <Reference Include="System.configuration" />
    <Reference Include="System.Core" />
    <Reference Include="System.EnterpriseServices" />
    <Reference Include="System.ServiceModel" />
    <Reference Include="System.Transactions" />
    <Reference Include="System.Xml.Linq" />
    <Reference Include="System.Data.DataSetExtensions" />
    <Reference Include="Microsoft.CSharp" />
    <Reference Include="System.Data" />
    <Reference Include="System.ServiceProcess" />
    <Reference Include="System.Xml" />
  </ItemGroup>
  <ItemGroup>
    <Compile Include="FMISInterface\FMISInterfaceSAPServerService.cs" />
    <Compile Include="Replication\ITableReplicator.cs" />
    <Compile Include="RfcFunctionHandlers\EDWEventRfcFunctionHandler.cs" />
    <Compile Include="RfcFunctionHandlers\FMISInterfaceEventRfcFunctionHandler.cs" />
    <Compile Include="UnitIDHandlers\FMISInterfaceEventUnitIDHandler.cs" />
    <Compile Include="RfcServerHosting\IRfcServerHost.cs" />
    <Compile Include="RfcServerHosting\IRfcServerHostFactory.cs" />
    <Compile Include="RfcServerHosting\RfcServerHostFactory.cs" />
    <Compile Include="Replication\TableReplicator.cs" />
    <Compile Include="RfcFunctionHandlers\IRfcFunctionHandler.cs" />
    <Compile Include="UnitIDHandlers\EDWEventUnitIDHandler.cs" />
    <Compile Include="RfcServerHosting\RfcServerHost.cs" />
    <Compile Include="WindowsService.cs">
      <SubType>Component</SubType>
    </Compile>
    <Compile Include="Program.cs" />
    <Compile Include="Properties\AssemblyInfo.cs" />
  </ItemGroup>
  <ItemGroup>
    <Content Include="App.config" />
    <Content Include="App.Release.config">
      <DependentUpon>App.config</DependentUpon>
    </Content>
    <Content Include="Publish\environment.xml" />
  </ItemGroup>
  <ItemGroup>
    <BootstrapperPackage Include=".NETFramework,Version=v4.5.1">
      <Visible>False</Visible>
      <ProductName>Microsoft .NET Framework 4.5.1 %28x86 and x64%29</ProductName>
      <Install>true</Install>
    </BootstrapperPackage>
    <BootstrapperPackage Include="Microsoft.Net.Client.3.5">
      <Visible>False</Visible>
      <ProductName>.NET Framework 3.5 SP1 Client Profile</ProductName>
      <Install>false</Install>
    </BootstrapperPackage>
    <BootstrapperPackage Include="Microsoft.Net.Framework.3.5.SP1">
      <Visible>False</Visible>
      <ProductName>.NET Framework 3.5 SP1</ProductName>
      <Install>false</Install>
    </BootstrapperPackage>
  </ItemGroup>
  <ItemGroup>
    <None Include="Publish\Cleanup.msbuild" />
    <None Include="Publish\install.ps1" />
    <None Include="Publish\PostBuild.msbuild" />
    <None Include="Publish\PreBuild.msbuild" />
    <None Include="SAPServer.RFCService_TemporaryKey.pfx" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\SAPServer.Core\SAPServer.Core.csproj">
      <Project>{7bc07e5b-7e00-4ce2-9344-0e62822bcd23}</Project>
      <Name>SAPServer.Core</Name>
    </ProjectReference>
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <!-- To modify your build process, add your task inside one of the targets below and uncomment it. 
       Other similar extension points exist, see Microsoft.Common.targets.
  <Target Name="BeforeBuild">
  </Target>
  <Target Name="AfterBuild">
  </Target>
  -->
  <UsingTask TaskName="TransformXml" AssemblyFile="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v$(VisualStudioVersion)\Web\Microsoft.Web.Publishing.Tasks.dll" />
  <Target Name="AfterCompile" Condition="exists('app.$(Configuration).config')">
    <!-- Generate transformed app config in the intermediate directory -->
    <TransformXml Source="app.config" Destination="$(IntermediateOutputPath)$(TargetFileName).config" Transform="app.$(Configuration).config" />
    <!-- Force build process to use the transformed configuration file from now on. -->
    <ItemGroup>
      <AppConfigWithTargetPath Remove="app.config" />
      <AppConfigWithTargetPath Include="$(IntermediateOutputPath)$(TargetFileName).config">
        <TargetPath>$(TargetFileName).config</TargetPath>
      </AppConfigWithTargetPath>
    </ItemGroup>
  </Target>
</Project>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService
WindowsService.cs
4401
using System;
using System.Linq;
using System.ServiceProcess;
using SAPServer.Core;
using SAPServer.RFCService.RfcServerHosting;
using Microsoft.Practices.EnterpriseLibrary.ExceptionHandling;

namespace SAPServer.RFCService
{
    public class WindowsService : ServiceBase
    {
        public const string serviceName = "SAPServer.RFCService";

        readonly IRfcServerHost[] serverHosts;

        readonly bool[] started;

        public WindowsService(params IRfcServerHost[] serverHosts)
        {
            if (serverHosts == null)
            {
                throw new ArgumentNullException("serverHosts");
            }

            if (serverHosts.Length == 0)
            {
                throw new ArgumentException("No server host provided");
            }

            this.serverHosts = serverHosts;
            this.started = new bool[serverHosts.Length];

            CanPauseAndContinue = false;
            ServiceName = serviceName;
        }

        #region ServiceBase implementation

        protected override void OnStart(string[] args)
        {
            Diagnostics.Current.Inform("Starting service.");

            AppDomain.CurrentDomain.UnhandledException += HandleUnhandledException;

            base.OnStart(args);

            EnsureHostsStarted();
        }

        protected override void OnStop()
        {
            // Send this email before stopping.
            Diagnostics.Current.Inform("Stopping service.");

            try
            {
                EnsureHostsStopped();
            }
            finally
            {
                base.OnStop();

                AppDomain.CurrentDomain.UnhandledException -= HandleUnhandledException;
            }
        }

        protected override void OnShutdown()
        {
            // Send this email before shutting.
            Diagnostics.Current.Inform("Shutting down service.");

            try
            {
                EnsureHostsStopped();
            }
            finally
            {
                base.OnShutdown();

                AppDomain.CurrentDomain.UnhandledException -= HandleUnhandledException;
            }
        }

        protected override void Dispose(bool disposing)
        {
            Diagnostics.Current.Inform("Disposing of service (disposing = {0}).", disposing);

            if (disposing)
            {
                EnsureHostsStopped();
            }

            base.Dispose(disposing);
        }

        #endregion

        #region Private members

        static void HandleUnhandledException(object sender, UnhandledExceptionEventArgs e)
        {
            if (e.ExceptionObject is Exception)
            {
                ExceptionPolicy.HandleException((Exception)e.ExceptionObject, "Global Policy");
            }
            else
            {
                Diagnostics.Current.Inform("Unknown and unhandled exception occured.{0}{1}", Environment.NewLine, e.ExceptionObject);
            }
        }

        internal void EnsureHostsStarted()
        {
            Diagnostics.Current.Inform("Starting server hosts.");

            for (int i = 0; i < serverHosts.Length; i++)
            {
                if (!started[i])
                {
                    try
                    {
                        serverHosts[i].Start();
                        started[i] = true;
                    }
                    catch (Exception exception)
                    {
                        ExceptionPolicy.HandleException(exception, "Global Policy");
                    }
                }
            }
        }

        internal void EnsureHostsStopped()
        {
            Diagnostics.Current.Inform("Stopping server hosts.");

            for (int i = 0; i < serverHosts.Length; i++)
            {
                if (started[i])
                {
                    try
                    {
                        serverHosts[i].Stop();
                        started[i] = false;
                    }
                    catch (Exception exception)
                    {
                        ExceptionPolicy.HandleException(exception, "Global Policy");
                    }
                }
            }
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\bin\Debug
SAPServer.RFCService.exe.config
13161
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <configSections>
    <section name="loggingConfiguration" type="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.LoggingSettings, Microsoft.Practices.EnterpriseLibrary.Logging" requirePermission="true" />
    <section name="exceptionHandling" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Configuration.ExceptionHandlingSettings, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling" requirePermission="true" />
    <section name="unity" type="Microsoft.Practices.Unity.Configuration.UnityConfigurationSection, Microsoft.Practices.Unity.Configuration" requirePermission="true" />
  </configSections>
  <exceptionHandling>
    <exceptionPolicies>
      <add name="Global Policy">
        <exceptionTypes>
          <add name="All Exceptions" type="System.Exception, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" postHandlingAction="None">
            <exceptionHandlers>
              <add name="Logging Handler" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.LoggingExceptionHandler, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging" logCategory="Default Category" eventId="100" severity="Error"
                   title="Enterprise Library Exception Handling for the SAP RFC Service" priority="0"
                   formatterType="SAPServer.Core.TextExceptionFormatter, SAPServer.Core"/>
            </exceptionHandlers>
          </add>
        </exceptionTypes>
      </add>
    </exceptionPolicies>
  </exceptionHandling>
  <loggingConfiguration defaultCategory="Default Category" tracingEnabled="true">
    <logFilters>
      <add name="Category" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.CategoryFilter, Microsoft.Practices.EnterpriseLibrary.Logging" categoryFilterMode="AllowAllExceptDenied"/>
      <add name="Priority" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.PriorityFilter, Microsoft.Practices.EnterpriseLibrary.Logging" minimumPriority="0"/>
    </logFilters>
    <categorySources>
      <add name="Default Category" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </add>
      <add name="Diagnostics" switchValue="All">
        <listeners>
          <add name="Diagnostics" />
        </listeners>
      </add>
      <add name="AppSupport" switchValue="All">
        <listeners>
          <add name="WCF Log"/>
        </listeners>
      </add>
      <add name="Error" switchValue="All">
        <listeners>
          <add name="Event Log"/>
        </listeners>
      </add>
    </categorySources>
    <specialSources>
      <errors name="errors" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </errors>
    </specialSources>
    <listeners>
      <add name="Event Log" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.FormattedEventLogTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging" listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.FormattedEventLogTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           log="SAPInterface" machineName="." source="SAPInterface Service" formatter="Default Formatter"/>
      <add name="WCF Log" type="SAPServer.Core.WCFLogListener, SAPServer.Core" formatter="Default Formatter" listenerDataType="SAPServer.Core.WCFLogListenerData, SAPServer.Core"
           logName="SAPInterface" serviceAddress="http://localhost:105/Services/ErrorLoggerService.svc"/>
      <add name="Diagnostics" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.RollingFlatFileTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging"
           listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.RollingFlatFileTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           fileName="diagnostics.log" footer="----------------" formatter="MessageOnlyTextFormatter" header="" rollFileExistsBehavior="Increment"
           rollInterval="Day" maxArchivedFiles="30" />
    </listeners>
    <formatters>
      <add name="Default Formatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="Timestamp: {timestamp} Message: {message} Category: {category} Priority: {priority} EventId: {eventid} Severity: {severity} Title:{title} Machine: {machine} Application Domain: {appDomain} Process Id: {processId} Process Name: {processName} Win32 Thread Id: {win32ThreadId} Thread Name: {threadName} Extended Properties: {dictionary({key} - {value})}"/>
      <add name="MessageOnlyTextFormatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="{timestamp(local:dd/MM/yyyy H:mm:ss.fff)}: {message}" />
    </formatters>
  </loggingConfiguration>
  <unity xmlns="http://schemas.microsoft.com/practices/2010/unity">
    <alias type="SAPServer.Core.IClassFactory, SAPServer.Core" alias="IClassFactory" />
    <alias type="SAPServer.Core.ClassFactory, SAPServer.Core" alias="ClassFactory" />
    <alias type="SAPServer.Core.ISAPConfiguration, SAPServer.Core" alias="ISAPConfiguration" />
    <alias type="SAPServer.Core.SAPConfiguration, SAPServer.Core" alias="SAPConfiguration" />
    <alias type="SAPServer.Core.ITransactionScopeFactory, SAPServer.Core" alias="ITransactionScopeFactory" />
    <alias type="SAPServer.Core.TransactionScopeFactory, SAPServer.Core" alias="TransactionScopeFactory" />

    <alias type="SAPServer.RFCService.RfcServerHosting.IRfcServerHost, SAPServer.RFCService" alias="IRfcServerHost" />
    <alias type="SAPServer.RFCService.RfcServerHosting.RfcServerHost, SAPServer.RFCService" alias="RfcServerHost" />
    <alias type="SAPServer.RFCService.RfcServerHosting.IRfcServerHostFactory, SAPServer.RFCService" alias="IRfcServerHostFactory" />
    <alias type="SAPServer.RFCService.RfcServerHosting.RfcServerHostFactory, SAPServer.RFCService" alias="RfcServerHostFactory" />
    <alias type="SAPServer.RFCService.UnitIDHandlers.FMISInterfaceEventUnitIDHandler, SAPServer.RFCService" alias="FMISInterfaceEventUnitIDHandler" />
    <alias type="SAPServer.RFCService.UnitIDHandlers.EDWEventUnitIDHandler, SAPServer.RFCService" alias="EDWEventUnitIDHandler" />
    <alias type="SAPServer.RFCService.FMISInterface.IFMISInterfaceSAPServerService, SAPServer.RFCService" alias="IFMISInterfaceSAPServerService" />
    <alias type="SAPServer.RFCService.FMISInterface.FMISInterfaceSAPServerService, SAPServer.RFCService" alias="FMISInterfaceSAPServerService" />
    <alias type="SAPServer.RFCService.Replication.ITableReplicator, SAPServer.RFCService" alias="ITableReplicator" />
    <alias type="SAPServer.RFCService.Replication.TableReplicator, SAPServer.RFCService" alias="TableReplicator" />

    <alias type="SAP.Middleware.Connector.IUnitIDHandler, sapnco" alias="IUnitIDHandler" />
    <alias type="System.Collections.Generic.Dictionary`2[[System.String, mscorlib], [System.String, mscorlib]], mscorlib" alias="DictionaryStringString" />
    <container>
      <instance name="RfcServerGatewayFMIS" value="NAME=FMIS_EVENT_GATEWAY,GWHOST=deva-ap00263L,GWSERV=sapgw00,PROGRAM_ID=FMIS_RFC_PROGRAM" type="DictionaryStringString" typeConverter="SAPServer.Core.NameValueCommaSeparatedTextTypeConverter, SAPServer.Core"/>
      <instance name="RfcServerGatewayEDW" value="NAME=EDW_EVENT_GATEWAY,GWHOST=deva-ap00263L,GWSERV=sapgw00,PROGRAM_ID=EDW_RFC_PROGRAM" type="DictionaryStringString" typeConverter="SAPServer.Core.NameValueCommaSeparatedTextTypeConverter, SAPServer.Core"/>
      <instance name="RfcDestination" value="NAME=DEFAULT_DESTINATION,ASHOST=deva-ap00263L,USER=AID_MGMNT,PASSWD=@id_mgmnt,CLIENT=100" type="DictionaryStringString" typeConverter="SAPServer.Core.NameValueCommaSeparatedTextTypeConverter, SAPServer.Core"/>
      <instance name="ConnectionStringSAPADM" value="data Source=DEVA-DB00126L,31000;Initial Catalog=Audit_SAPADM;Integrated Security=SSPI;"/>
      <register type="IClassFactory" mapTo="ClassFactory" />
      <register type="ISAPConfiguration" mapTo="SAPConfiguration" name="SAPConfiguration" />
      <register type="ITransactionScopeFactory" mapTo="TransactionScopeFactory" />
      <register type="IUnitIDHandler" mapTo="FMISInterfaceEventUnitIDHandler" name="FMISInterfaceEventUnitIDHandler" />
      <register type="IUnitIDHandler" mapTo="EDWEventUnitIDHandler" name="EDWEventUnitIDHandler" />
      <register type="IRfcServerHostFactory" mapTo="RfcServerHostFactory">
        <lifetime type="singleton" />
        <constructor>
          <param name="nameRegistrations">
            <array>
              <value value="FMISInterfaceEvent"/>
              <value value="EDWEvent"/>
            </array>
          </param>
        </constructor>
      </register>
      <register type="IRfcServerHost" mapTo="RfcServerHost" name="FMISInterfaceEvent">
        <constructor>
          <param name="gatewayParameters" dependencyName="RfcServerGatewayFMIS" />
          <param name="destinationParameters" dependencyName="RfcDestination" />
          <param name="unitIDHandler" dependencyName="FMISInterfaceEventUnitIDHandler" />
          <param name="functionHandlerTypes">
            <array>
              <value value="SAPServer.RFCService.RfcFunctionHandlers.FMISInterfaceEventRfcFunctionHandler, SAPServer.RFCService" typeConverter="SAPServer.Core.FullyQualifiedTypeStringTypeConverter, SAPServer.Core" />
            </array>
          </param>
        </constructor>
      </register>
      <register type="IRfcServerHost" mapTo="RfcServerHost" name="EDWEvent">
        <constructor>
          <param name="gatewayParameters" dependencyName="RfcServerGatewayEDW" />
          <param name="destinationParameters" dependencyName="RfcDestination" />
          <param name="unitIDHandler" dependencyName="EDWEventUnitIDHandler" />
          <param name="functionHandlerTypes">
            <array>
              <value value="SAPServer.RFCService.RfcFunctionHandlers.EDWEventRfcFunctionHandler, SAPServer.RFCService" typeConverter="SAPServer.Core.FullyQualifiedTypeStringTypeConverter, SAPServer.Core" />
            </array>
          </param>
        </constructor>
      </register>
      <register type="IFMISInterfaceSAPServerService" mapTo="FMISInterfaceSAPServerService">
        <constructor>
          <param name="sapEndPointName" value="FMISInterfaceServiceBlack" />
          <param name="adminEndPointName" value="AdministrationServiceBlack" />
        </constructor>
      </register>
      <register type="ITableReplicator" mapTo="TableReplicator">
        <constructor>
          <param name="connectionString" dependencyName="ConnectionStringSAPADM" />
        </constructor>
      </register>
    </container>
  </unity>
  <system.serviceModel>
    <serviceHostingEnvironment multipleSiteBindingsEnabled="true" />
    <bindings>
      <basicHttpBinding>
        <binding name="BasicHttpBinding_Windows" openTimeout="00:15:00" closeTimeout="00:15:00" receiveTimeout="00:15:00" sendTimeout="00:15:00" maxReceivedMessageSize="4194304">
          <security mode="TransportCredentialOnly">
            <transport clientCredentialType="Windows" proxyCredentialType="None" realm="" />
          </security>
        </binding>
      </basicHttpBinding>
      <wsHttpBinding>
        <binding name="WSHttpBinding_Transactional" transactionFlow="true" openTimeout="00:15:00" closeTimeout="00:15:00" receiveTimeout="00:15:00" sendTimeout="00:15:00" maxReceivedMessageSize="2147483647">
          <readerQuotas maxDepth="2147483647" maxStringContentLength="2147483647" maxArrayLength="2147483647" maxBytesPerRead="2147483647" maxNameTableCharCount="2147483647" />
        </binding>
      </wsHttpBinding>
    </bindings>
    <client>
      <endpoint address="http://localhost:85/Services/SAPServiceProxy.svc"
                     binding="wsHttpBinding" bindingConfiguration="WSHttpBinding_Transactional"
                     contract="ServiceBus.Contract.Service.ISAPServiceProxy" name="FMISInterfaceServiceBlack" />
      <endpoint address="http://localhost:85/Services/AdministrationService.svc"
                     binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows"
                     contract="ServiceBus.Contract.Service.IAdministrationService" name="AdministrationServiceBlack" />
    </client>
    <behaviors>
      <serviceBehaviors>
        <behavior name="">
          <serviceMetadata httpGetEnabled="true" />
          <serviceDebug includeExceptionDetailInFaults="false" />
          <serviceAuthorization principalPermissionMode="UseAspNetRoles" roleProviderName="AspNetSqlRoleProvider" />
        </behavior>
      </serviceBehaviors>
    </behaviors>
  </system.serviceModel>
</configuration>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\FMISInterface
FMISInterfaceSAPServerService.cs
2694
using System;
using System.ServiceModel;
using ServiceBus.Contract.Model;
using ServiceBus.Contract.Service;
using SAPServer.Core;

namespace SAPServer.RFCService.FMISInterface
{
    public interface IFMISInterfaceSAPServerService
    {
        bool FMISEventTransactionExists(Guid transactionID);
        void CreateFMISEventTransaction(Guid transactionID, string userID, SAPEvent e);
    }

    public class FMISInterfaceSAPServerService : IFMISInterfaceSAPServerService
    {
        #region Fields

        readonly string sapEndPointName;
        readonly string adminEndPointName;

        #endregion

        #region Construtors

        public FMISInterfaceSAPServerService(string sapEndPointName, string adminEndPointName)
        {
            if (string.IsNullOrWhiteSpace(sapEndPointName))
                throw new ArgumentException("sapEndPointName is null or white space");
            if (string.IsNullOrWhiteSpace(adminEndPointName))
                throw new ArgumentException("adminEndPointName is null or white space");

            this.sapEndPointName = sapEndPointName;
            this.adminEndPointName = adminEndPointName;
        }

        #endregion

        #region IFMISInterfaceService implementation

        public virtual bool FMISEventTransactionExists(Guid transactionID)
        {
            ChannelFactory<IAdministrationService> channelFactory = null;
            IAdministrationService service = null;

            try
            {
                channelFactory = new ChannelFactory<IAdministrationService>(adminEndPointName);
                service = channelFactory.CreateChannel();
                return service.TransactionExists(transactionID);
            }
            finally
            {
                ServiceModelUtils.ReleaseCommunicationObjects(service as ICommunicationObject, channelFactory);
            }
        }

        public virtual void CreateFMISEventTransaction(Guid transactionID, string userID, SAPEvent e)
        {
            ChannelFactory<ISAPServiceProxy> channelFactory = null;
            ISAPServiceProxy service = null;

            try
            {
                channelFactory = new ChannelFactory<ISAPServiceProxy>(sapEndPointName);
                service = channelFactory.CreateChannel();
                service.ProcessSAPEventRequest(e, new CallerInfo { From = ServiceEnum.SAP, UserID = userID }, transactionID);
            }
            finally
            {
                ServiceModelUtils.ReleaseCommunicationObjects(service as ICommunicationObject, channelFactory);
            }
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
ClassFactory.cs
14693
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;
using Microsoft.Practices.Unity;
using Microsoft.Practices.Unity.Configuration;

namespace SAPServer.RFCService.Infrastructure
{
    public interface IClassFactory : IDisposable
    {
        T Create<T>() where T : class;
        T Create<T>(object arguments) where T : class;
        T Create<T>(string key) where T : class;
        T Create<T>(string key, object arguments) where T : class;
        object Create(Type type);
        object Create(Type type, object arguments);
        object Create(Type type, string key, object arguments);
        bool IsRegistered<T>(string key);
        bool IsRegistered(Type type, string key);
    }

    public sealed class ClassFactory : IClassFactory, IDisposable
    {
        #region Fields

        readonly IUnityContainer unityContainer;

        bool disposed = false;

        #endregion

        #region Constructor

        public ClassFactory(IUnityContainer unityContainer)
        {
            if (unityContainer == null)
            {
                throw new ArgumentNullException("unityContainer");
            }

            this.unityContainer = unityContainer;

            this.unityContainer.RegisterInstance<IClassFactory>(this, new ExternallyControlledLifetimeManager());

            Class.RegisterClassFactory(this);
        }

        ~ClassFactory()
        {
            if (!disposed)
            {
                Dispose();
            }
        }

        #endregion

        #region IClassFactory implementation

        public T Create<T>() where T : class
        {
            return (T)Create(typeof(T));
        }

        public T Create<T>(object arguments) where T : class
        {
            return (T)Create(typeof(T), arguments);
        }

        public T Create<T>(string key) where T : class
        {
            return (T)Create(typeof(T), key, null);
        }

        public T Create<T>(string key, object arguments) where T : class
        {
            return (T)Create(typeof(T), key, arguments);
        }

        public object Create(Type type)
        {
            return Create(type, null);
        }

        public object Create(Type type, object arguments)
        {
            return Create(type, null, arguments);
        }

        public object Create(Type type, string key)
        {
            return Create(type, key, null);
        }

        public object Create(Type type, string key, object arguments)
        {
            if (type == null)
            {
                throw new ArgumentNullException("type");
            }

            ResolverOverride[] resolverOverrides = ClassFactoryStatics.MakeResolverOverrides(arguments);

            return unityContainer.Resolve(type, key, resolverOverrides);
        }

        public bool IsRegistered<T>(string key)
        {
            return unityContainer.IsRegistered<T>(key);
        }

        public bool IsRegistered(Type type, string key)
        {
            return unityContainer.IsRegistered(type, key);
        }

        #endregion

        #region IDisposable implementation

        public void Dispose()
        {
            Dispose(true);
        }

        #endregion

        #region Private members

        void Dispose(bool suppressFinalize = false)
        {
            if (disposed)
            {
                throw new ObjectDisposedException(GetType().ToString());
            }

            disposed = true;

            unityContainer.Dispose();

            if (suppressFinalize)
            {
                GC.SuppressFinalize(this);
            }

            Class.factory = null;
        }

        #endregion
    }

    public sealed class DynamicClassFactory : IClassFactory
    {
        #region Fields

        static readonly IUnityContainer container = new UnityContainer();

        #endregion

        #region IClassFactory implementation

        public T Create<T>() where T : class
        {
            return Create<T>(null);
        }

        public T Create<T>(object arguments) where T : class
        {
            if (!container.IsRegistered<T>())
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(typeof(T), dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", typeof(T)));
                }

                container.RegisterType(typeof(T), t, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve<T>(ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public T Create<T>(string key) where T : class
        {
            return Create<T>(key, null);
        }

        public T Create<T>(string key, object arguments) where T : class
        {
            if (!container.IsRegistered<T>(key))
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(typeof(T), dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", typeof(T)));
                }

                container.RegisterType(typeof(T), t, key, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve<T>(key, ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public object Create(Type type)
        {
            return Create(type, null);
        }

        public object Create(Type type, object arguments)
        {
            if (!container.IsRegistered(type))
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(type, dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", type));
                }

                container.RegisterType(type, t, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve(type, ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public object Create(Type type, string key, object arguments)
        {
            if (!container.IsRegistered(type, key))
            {
                Dictionary<string, Type> dictionary = ClassFactoryStatics.MakeConstructionArguments(arguments);

                Type t = ClassFactoryStatics.FindImplementationOf(type, dictionary);

                if (t == null)
                {
                    throw new NullReferenceException(string.Format("Unable to find implementation of {0}", type));
                }

                container.RegisterType(type, t, key, new InjectionConstructor(dictionary.Values.ToArray()));
            }

            return container.Resolve(type, key, ClassFactoryStatics.MakeResolverOverrides(arguments));
        }

        public bool IsRegistered<T>(string key)
        {
            return container.IsRegistered<T>(key);
        }

        public bool IsRegistered(Type type, string key)
        {
            return container.IsRegistered(type, key);
        }

        #endregion

        #region IDisposable implementation

        public void Dispose()
        {
            container.Dispose();
        }

        #endregion
    }

    public static class ClassFactoryStatics
    {
        #region Public methods

        public static ResolverOverride[] MakeResolverOverrides(object anonymous)
        {
            ParameterOverrides parameterOverrides = new ParameterOverrides();

            if (anonymous != null)
            {
                TypeDescriptor.GetProperties(anonymous)
                    .Cast<PropertyDescriptor>()
                    .Select(x => new { name = x.Name, value = x.GetValue(anonymous) })
                    .Where(x => x.value != null)
                    .ToList()
                    .ForEach(x => parameterOverrides.Add(x.name, x.value));
            }

            return parameterOverrides.ToArray();
        }

        public static Dictionary<string, Type> MakeConstructionArguments(object anonymous)
        {
            if (anonymous == null)
            {
                return new Dictionary<string, Type>();
            }

            return TypeDescriptor.GetProperties(anonymous)
                .Cast<PropertyDescriptor>()
                .ToDictionary(x => x.Name, x => x.PropertyType);
        }

        public static Type FindImplementationOf(Type type, Dictionary<string, Type> constructorArguments)
        {
            Func<Type, bool> inheritanceTest;
            if (type.IsInterface)
            {
                inheritanceTest = t => t.GetInterfaces().Contains(type);
            }
            else
            {
                inheritanceTest = t => t.IsSubclassOf(type);
            }

            Func<Type, bool> constructionTest;
            if (constructorArguments == null || constructorArguments.Count == 0)
            {
                constructionTest = t => true;
            }
            else
            {
                constructionTest = t => t.GetConstructors().Any(c => AreSame(
                    c.GetParameters().ToDictionary(p => p.Name, parameter => parameter.ParameterType),
                    constructorArguments));
            }

            // Find a type that is not an interface or abstract, inherits from the given "type" and
            // has a constructor matching dictionary of construction arguments
            return AppDomain.CurrentDomain.GetAssemblies()
                .SelectMany(assembly => assembly.GetTypes())
                .FirstOrDefault(t =>
                    !(t.IsInterface || t.IsAbstract) &&
                    inheritanceTest(t) &&
                    constructionTest(t));
        }

        public static string GenerateRegistrationKey(object anonymous)
        {
            return MakeConstructionArguments(anonymous)
                .Select(x => string.Format("{0} {1}", x.Value, x.Key))
                .Aggregate((x, y) => string.Format("{0}, {1}", x, y));
        }

        #endregion

        #region Private members

        static bool AreSame(Dictionary<string, Type> first, Dictionary<string, Type> second)
        {
            if (first == null)
            {
                throw new ArgumentNullException("first");
            }

            if (second == null)
            {
                throw new ArgumentNullException("second");
            }

            return first.Keys.All(x => second.ContainsKey(x) && second[x] == first[x]);
        }

        #endregion
    }

    public static class Class
    {
        #region Fields

        internal static IClassFactory factory = null;

        #endregion

        #region Public methods

        [MethodImpl(MethodImplOptions.Synchronized)]
        internal static void RegisterClassFactory(IClassFactory factory)
        {
            // We may face racing condition when the factory gets registered
            // possibly from multiple threads.

            // At any one time only one factory class manages instance creations thus
            // when different threads are trying to register factory allow the winner
            // to register and ignore registration requests from loosers if their factories
            // are of the same type, otherwise throw exception.

            if (factory == null)
            {
                throw new ArgumentNullException("factory");
            }

            if (Class.factory == null)
            {
                Class.factory = factory;
            }
            else if (Class.factory.GetType() != factory.GetType())
            {
                throw new InvalidOperationException("factory has already been registered");
            }
        }

        public static T New<T>() where T : class
        {
            EnsureFactory();

            return factory.Create<T>();
        }

        public static T New<T>(object arguments) where T : class
        {
            EnsureFactory();

            return factory.Create<T>(arguments);
        }

        public static T New<T>(string key) where T : class
        {
            EnsureFactory();

            return factory.Create<T>(key, null);
        }

        public static T New<T>(string key, object arguments) where T : class
        {
            EnsureFactory();

            return factory.Create<T>(key, arguments);
        }

        public static object New(this Type type)
        {
            EnsureFactory();

            return factory.Create(type);
        }

        public static object New(this Type type, object arguments)
        {
            EnsureFactory();

            return factory.Create(type, arguments);
        }

        public static object New(this Type type, string key, object arguments)
        {
            EnsureFactory();

            return factory.Create(type, key, arguments);
        }

        public static bool IsRegistered(Type type, string key)
        {
            EnsureFactory();

            return factory.IsRegistered(type, key);
        }

        public static bool IsRegistered<T>(string key)
        {
            EnsureFactory();

            return factory.IsRegistered<T>(key);
        }

        #endregion

        #region Private members

        static void EnsureFactory()
        {
            if (factory != null)
            {
                return;
            }

            IUnityContainer container = new UnityContainer().LoadConfiguration();

            IClassFactory classFactory = container.Resolve<IClassFactory>(new ParameterOverride("container", container));

            RegisterClassFactory(classFactory);
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
Configuration.cs
1177
using System;
using System.Configuration;
using System.ComponentModel;

namespace SAPServer.RFCService.Infrastructure
{
    public interface IConfiguration
    {
        string Setting(string key);
        string ConnectionString(string key = null);
    }

    public class Configuration
        : IConfiguration
    {
        #region Fields

        const string DefaultConnectionStringKey = "Application";

        #endregion

        #region IConfiguration implementation

        public virtual string Setting(string key)
        {
            return ConfigurationManager.AppSettings[key];
        }

        public virtual string ConnectionString(string key = null)
        {
            ConnectionStringSettings settings = ConfigurationManager.ConnectionStrings[key ?? DefaultConnectionStringKey];

            if (settings == null || string.IsNullOrEmpty(settings.ConnectionString))
            {
                throw new ApplicationException(string.Format("Connection string setting is missing {0}",
                    key));
            }

            return settings.ConnectionString;
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
Diagnostics.cs
11197
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;
using System.Reflection;
using System.Threading;
using Microsoft.Practices.EnterpriseLibrary.Common.Configuration;
using Microsoft.Practices.EnterpriseLibrary.ExceptionHandling;
using Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging;
using Microsoft.Practices.EnterpriseLibrary.Logging;
using System.Security.Principal;
using System.Threading.Tasks;
using System.Transactions;

namespace SAPServer.RFCService.Infrastructure
{
    public interface IDiagnostics
    {
        void Debug(string format, params object[] args);
        void Trace(string format, params object[] args);
        void Email(bool asynchronous, string format, params object[] args);
        void Error(string format, params object[] args);
        void Inform(string format, params object[] args);
        bool Handle(Exception exception, out Exception rethrow, string policy = null);
        bool Handle(Exception exception, string policy = null);
    }

    public class EnterpriseLibraryDiagnostics : IDiagnostics
    {
        #region Fields

        public const string coreExceptionPolicy = "Global Policy";

        public const string logError = "Error";
        public const string logDiagnostics = "Diagnostics";
        public const string logEmail = "Email";

        static readonly object[] noFormatArgs = { };

        readonly LogWriter logWriter;
        readonly ExceptionManager exceptionManager;

        #endregion

        #region Constructors

        internal EnterpriseLibraryDiagnostics(LogWriter logWriter, ExceptionManager exceptionManager)
        {
            if (logWriter == null)
            {
                throw new ArgumentNullException("logWriter");
            }

            if (exceptionManager == null)
            {
                throw new ArgumentNullException("exceptionManager");
            }

            this.logWriter = logWriter;

            this.exceptionManager = exceptionManager;
        }

        #endregion

        #region IDiagnostics implementation

        public void Debug(string format, params object[] args)
        {
            System.Diagnostics.Debug.Write(Format(format, args ?? noFormatArgs));
        }

        public void Trace(string format, params object[] args)
        {
            Log(TraceLogEntry(Format(format, args ?? noFormatArgs)));
        }

        public void Email(bool asynchronous, string format, params object[] args)
        {
            LogEntry logEntry = EmailLogEntry(Format(format, args ?? noFormatArgs));

            if (asynchronous)
            {
                Task.Factory.StartNew(() => Log(logEntry));
            }
            else
            {
                Log(logEntry);
            }
        }

        public void Error(string format, params object[] args)
        {
            Log(ErrorLogEntry(string.Format(format, args ?? noFormatArgs)));
        }

        public void Inform(string format, params object[] args)
        {
            Debug(format, args);

            if (logWriter.IsTracingEnabled())
            {
                Trace(format, args);
            }
        }

        /// <summary>
        /// Outputs given exception description to Debug or Trace log and handles it as per given 
        /// exception policy. If policy is not provided, the default policy is used.
        /// If returns true, caller should do "throw rethrow"
        /// </summary>
        public bool Handle(Exception exception, out Exception rethrow, string policy = null)
        {
            rethrow = null;

            if (exception == null)
            {
                exception = new ArgumentNullException("exception");
            }

            Inform("{0}", exception);

            if (exceptionManager.HandleException(
                exception,
                string.IsNullOrWhiteSpace(policy) ? coreExceptionPolicy : policy,
                out rethrow) && rethrow == null)
            {
                rethrow = exception;
            }

            return rethrow != null;
        }

        /// <summary>
        /// Outputs given exception description to Debug or Trace log and handles it as per given 
        /// exception policy. If policy is not provided, the default policy is used.
        /// If returns true, caller should do "throw"
        /// </summary>
        public bool Handle(Exception exception, string policy = null)
        {
            if (exception == null)
            {
                exception = new ArgumentNullException("exception");
            }

            Inform("{0}", exception);

            return exceptionManager.HandleException(exception, string.IsNullOrWhiteSpace(policy) ? coreExceptionPolicy : policy);
        }

        #endregion

        #region Private members

        LogEntry TraceLogEntry(string message)
        {
            return new LogEntry(message, logDiagnostics, 0, 400, TraceEventType.Verbose,
                logDiagnostics, null);
        }

        LogEntry EmailLogEntry(string message)
        {
            return new LogEntry(message, logEmail, 0, 300, TraceEventType.Information,
                TraceEventType.Information.ToString(), null);
        }

        LogEntry ErrorLogEntry(string message)
        {
            return new LogEntry(message, logError, 0, 200, TraceEventType.Error,
                TraceEventType.Error.ToString(), null);
        }

        void Log(LogEntry logEntry)
        {
            logWriter.Write(logEntry);
        }

        static string Format(string format, params object[] args)
        {
            MethodBase method = GetCallingMethod();

            return string.Format("{0}# {1}.{2}. ManagedThreadId=\"{3}\" Credentials=\"{4}\"{0} {5}{0}",
                Environment.NewLine,
                method.DeclaringType.Name,
                method.Name,
                Thread.CurrentThread.ManagedThreadId,
                Who(),
                string.Format(format, args ?? noFormatArgs));
        }

        static MethodBase GetCallingMethod()
        {
            StackFrame stackFrame = null;

            MethodBase method = null;

            int frame = 0;

            while (method == null || method.DeclaringType == typeof(EnterpriseLibraryDiagnostics))
            {
                stackFrame = new StackFrame(++frame);

                method = stackFrame.GetMethod();
            }

            return method;
        }

        static string Who()
        {
            return string.Format("{0} (thread), {1} (process)",
                Thread.CurrentPrincipal == null ?
                    "< Principal: null>" :
                    GetIdentityName(Thread.CurrentPrincipal.Identity),
                GetIdentityName(WindowsIdentity.GetCurrent()));
        }

        static string GetIdentityName(IIdentity identity)
        {
            if (identity == null)
            {
                return "< Identity: null >";
            }

            try
            {
                string text = identity.Name;

                if (string.IsNullOrEmpty(text))
                {
                    return string.Format("{0} has an empty name", identity.GetType().Name);
                }

                return text;
            }
            catch (Exception e)
            {
                return string.Format("[{0}.Name. Exception is thrown {1}]",
                    identity.GetType().Name,
                    e.Message);
            }
        }

        #endregion
    }

    public static class Diagnostics
    {
        public static readonly IDiagnostics Current = new EnterpriseLibraryDiagnostics(
            EnterpriseLibraryContainer.Current.GetInstance<LogWriter>(),
            EnterpriseLibraryContainer.Current.GetInstance<ExceptionManager>());

        public static T Exception<T>(string format, params object[] args) where T : Exception
        {
            return Exception<T>(null, format, args);
        }

        public static T Exception<T>(Exception inner, string format, params object[] args) where T : Exception
        {
            return (T)typeof(T).GetConstructor(new Type[]
            {
                typeof(string), 
                typeof(Exception)
            })
            .Invoke(new object[]
            { 
                args == null ? format : string.Format(format, args), 
                inner
            });
        }

        public static void InformTransaction()
        {
            Transaction transaction = Transaction.Current;

            if (transaction == null)
            {
                Diagnostics.Current.Inform("{0}", "No ambient transaction exists");
            }
            else
            {
                Diagnostics.Current.Inform("{0} => {1}", transaction.IsolationLevel, transaction.TransactionInformation.Stringify());
            }
        }
    }
}

namespace System
{
    public static class ObjectExtensions
    {
        public static string Stringify(this object instance)
        {
            if (instance == null)
            {
                return "< null >";
            }

            // produces the following line: 
            // PropertyName="{PropertyValue}" PropertyName="{PropertyValue}" ...
            IEnumerable<string> sequence = TypeDescriptor.GetProperties(instance)
                .Cast<PropertyDescriptor>()
                .Select(x =>
                {
                    object value = null;

                    try
                    {
                        value = x.GetValue(instance);
                    }
                    catch (Exception exception)
                    {
                        value = string.Format("Unaccessible {0}: \"{1}\"", x.Name, exception);
                    }

                    if (value == null)
                    {
                        return string.Format("{0}=\"< null >\"", x.Name);
                    }

                    if (x.PropertyType == typeof(string) || !typeof(IEnumerable).IsAssignableFrom(x.PropertyType))
                    {
                        return string.Format("{0}=\"{1}\"", x.Name, value);
                    }

                    value = ((IEnumerable)value).Cast<dynamic>().Count();

                    return string.Format("{0}=\"{1} items\"", x.Name, value);
                });

            string text = "< no public properties >";

            if (sequence.Any())
            {
                text = sequence.Aggregate((x, y) => string.Format("{0} {1}", x, y));
            }

            // the following formatted string is returned:
            // [TypeName PropertyName="{PropertyValue}" PropertyName="{PropertyValue}" ...]
            return string.Format("[{0} {1}]", instance.GetType().Name, text);
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
ServiceModelStatics.cs
988
namespace SAPServer.RFCService.Infrastructure
{
    using System.ServiceModel;

    public static class ServiceModelStatics
    {
        public static void ReleaseCommunicationObjects(params ICommunicationObject[] communicationObjects)
        {
            if (communicationObjects == null)
            {
                return;
            }

            foreach (ICommunicationObject communicationObject in communicationObjects)
            {
                if (communicationObject == null)
                {
                    continue;
                }

                switch (communicationObject.State)
                {
                    case CommunicationState.Faulted:
                        communicationObject.Abort();
                        break;

                    case CommunicationState.Opened:
                        communicationObject.Close();
                        break;
                }
            }
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
TextExceptionFormatter.cs
8493
using System;
using System.Collections.Specialized;
using System.IO;
using System.Reflection;
using System.Security.Principal;
using System.Threading;

namespace SAPServer.RFCService.Infrastructure
{
    public class TextExceptionFormatter
        : Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.TextExceptionFormatter
    {
        #regionFields

        int exceptionCounter = 0;

        #endregionFields

        #regionConstructors

        public TextExceptionFormatter(TextWriter writer, Exception exception, Guid handlingInstanceId)
            : base(writer, exception, handlingInstanceId)
        {
        }

        public TextExceptionFormatter(TextWriter writer, Exception exception)
            : base(writer, exception, Guid.Empty)
        {
        }

        #endregionConstructors

        #region Public Methods

        public static string GetInnerMostExceptionMessage(string formattedFullMessage)
        {
            StringReader reader = new StringReader(formattedFullMessage);
            string innerException = string.Empty;
            string exceptionText;

            while ((exceptionText = reader.ReadLine()) != null)
            {
                if (!string.IsNullOrEmpty(exceptionText) && exceptionText.ToLower().Equals("message"))
                {
                    exceptionText = reader.ReadLine();
                    if (!string.IsNullOrWhiteSpace(exceptionText))
                        innerException = exceptionText.Replace("\t", "");
                    break;
                }
            }

            return innerException;
        }

        #endregion

        #regionProtectedMethods

        protected override void WriteDateTime(DateTime dateTime)
        {
            Writer.WriteLine(string.Format("EXACT TIME: {0:d-MMM-yyyy HH:mm:ss.ffffff}",
                dateTime.ToLocalTime()));
        }

        protected override void WriteException(Exception exception, Exception outerException)
        {
            if (exception == null)
            {
                WriteSection("WriteException(Exception exception, Exception outerException)", "exception is null");
            }
            else
            {
                if (outerException == null)
                {
                    WriteSectionEssentials();

                    if (exception.InnerException == null)
                    {
                        exceptionCounter = 0;
                    }
                    else
                    {
                        exceptionCounter = 1;

                        Writer.WriteLine("EXCEPTION TREE (starting with the most inner exception):");
                    }

                    WriteException(exception);
                }
                else
                {
                    WriteException(exception);
                }
            }
        }

        protected override void WriteFieldInfo(FieldInfo fieldInfo, object value)
        {
            if (fieldInfo == null)
            {
                return;
            }

            WriteNameValue(fieldInfo.Name, value);
        }

        protected override void WritePropertyInfo(PropertyInfo propertyInfo, object value)
        {
            if (propertyInfo == null)
            {
                return;
            }

            WriteNameValue(propertyInfo.Name, value);
        }

        #endregionProtectedMethods

        #regionPrivateMethods

        void WriteException(Exception exception)
        {
            if (exception == null)
            {
                WriteSection("WriteException(Exception exception)", "exception is null");
            }
            else
            {
                Exception inner = exception.InnerException;

                if (inner != null)
                {
                    WriteException(inner, exception);

                    Writer.WriteLine();
                }

                WriteSection("EXCEPTION " + (exceptionCounter == 0 ?
                    string.Empty :
                    string.Format("#{0}", exceptionCounter++)), GetExceptionTypeName(exception));
                WriteSection("MESSAGE", exception.Message);
                WriteSection("STACK TRACE", exception.StackTrace);
                WriteSection("SOURCE", exception.Source);
                WriteSection("HELP LINK", exception.HelpLink);
                WriteSectionOtherPropertiesAndFileds(exception);
            }
        }

        void WriteNameValue(string name, object value)
        {
            string text = null;

            if (value == null)
            {
                text = "< null >";
            }
            else
            {
                text = value.ToString();

                if (string.IsNullOrWhiteSpace(text))
                {
                    text = "< empty >";
                }
            }

            Writer.WriteLine(string.Format("\t{0} = {1}", name, text));
        }

        void WriteSection(string sectionName, string sectionText)
        {
            Writer.WriteLine(sectionName);
            Writer.WriteLine(string.Format("\t{0}",
                string.IsNullOrWhiteSpace(sectionText) ? "< none provided >" : sectionText));
            Writer.WriteLine();
        }

        void WriteSectionEssentials()
        {
            Writer.WriteLine(string.Format("EXECUTING ASSEMBLY: {0}", GetExecutingAssemblyName()));
            Writer.WriteLine(string.Format("THREAD IDENTITY: {0}", GetThreadIdentity()));
            Writer.WriteLine(string.Format("PROCESS IDENTITY: {0}", GetWindowsIdentity()));
            Writer.WriteLine();
        }

        void WriteSectionOtherPropertiesAndFileds(Exception exception)
        {
            Writer.WriteLine("OTHER PUBLIC PROPERTIES AND FIELDS:");
            WriteReflectionInfo(exception);
        }

        #endregionPrivateMethods

        #regionPrivateStaticMethods

        static string GetExceptionTypeName(Exception exception)
        {
            if (exception == null)
            {
                return "< null >";
            }

            try
            {
                return exception.GetType().AssemblyQualifiedName;
            }
            catch (Exception ex)
            {
                return string.Format("Unaccessible exception.GetType().AssemblyQualifiedName: {0}",
                    ex.Message);
            }
        }

        static string GetExecutingAssemblyName()
        {
            try
            {
                return Assembly.GetExecutingAssembly().FullName;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible Assembly.GetExecutingAssembly().FullName: {0}",
                    exception.Message);
            }
        }

        static string GetMachineName()
        {
            try
            {
                return Environment.MachineName;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible Environment.MachineName: {0}",
                    exception.Message);
            }
        }

        static string GetThreadIdentity()
        {
            try
            {
                if (Thread.CurrentPrincipal == null)
                {
                    return "<Thread.CurrentPrincipal: null>";
                }

                if (Thread.CurrentPrincipal.Identity == null)
                {
                    return "<Thread.CurrentPrincipal.Identity: null>";
                }

                return Thread.CurrentPrincipal.Identity.Name;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible Thread.CurrentPrincipal.Identity: {0}",
                    exception.Message);
            }
        }

        static string GetWindowsIdentity()
        {
            try
            {
                return WindowsIdentity.GetCurrent().Name;
            }
            catch (Exception exception)
            {
                return string.Format("Unaccessible WindowsIdentity.GetCurrent().Name: {0}",
                    exception.Message);
            }
        }

        #endregionPrivateStaticMethods
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
TransactionScopeFactory.cs
1802
namespace SAPServer.RFCService.Infrastructure
{
    using System;
    using System.Transactions;

    public interface ITransactionScopeFactory
    {
        IDisposable CreateEnterprise();
        IDisposable CreateDefault();
        void Complete(IDisposable transactionScope);
    }

    public class TransactionScopeFactory : ITransactionScopeFactory
    {
        public virtual IDisposable CreateEnterprise()
        {
            return new TransactionScope(
                TransactionScopeOption.RequiresNew,
                new TransactionOptions
                {
                    IsolationLevel = Transaction.Current == null ? IsolationLevel.ReadCommitted : Transaction.Current.IsolationLevel,
                    Timeout = TimeSpan.FromMinutes(30)
                },
                EnterpriseServicesInteropOption.Full);
        }

        public virtual IDisposable CreateDefault()
        {
            return new TransactionScope(
                TransactionScopeOption.Required,
                new TransactionOptions
                {
                    IsolationLevel = Transaction.Current == null ? IsolationLevel.ReadCommitted : Transaction.Current.IsolationLevel,
                    Timeout = TimeSpan.FromMinutes(30)
                });
        }

        public virtual void Complete(IDisposable transactionScope)
        {
            if (transactionScope == null)
            {
                throw new ArgumentNullException("transactionScope");
            }

            if (!(transactionScope is TransactionScope))
            {
                throw new InvalidCastException("transactionScope is not TransactionScope");
            }

            ((TransactionScope)transactionScope).Complete();
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
TypeConverters.cs
2690
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Globalization;

namespace SAPServer.RFCService.Infrastructure.TypeConverters
{
    /// <summary>
    /// Converts text to Dictionary<string, string> instance. Text format: key=value,key=value,key=value
    /// </summary>
    public class NameValueCommaSeparatedTextTypeConverter : TypeConverter
    {
        public override object ConvertFrom(ITypeDescriptorContext context, CultureInfo culture, object value)
        {
            Dictionary<string, string> dictionary = new Dictionary<string, string>();

            string[] nameValues = value.ToString().Split(',');

            foreach (string nameValue in nameValues)
            {
                if (!string.IsNullOrWhiteSpace(nameValue))
                {
                    int positionOfFirstEqualitySign = nameValue.IndexOf('=');

                    if (positionOfFirstEqualitySign < 0)
                    {
                        throw new InvalidOperationException(string.Format("Value does not conform to pattern \"key1=value1,key2=value2,key3=value3 ..., keyN=valueN\". {0}", value));
                    }

                    string n = nameValue.Substring(0, positionOfFirstEqualitySign);

                    if (string.IsNullOrWhiteSpace(n))
                    {
                        throw new InvalidOperationException(string.Format("Value has an empty name {0}", nameValue));
                    }

                    string v = nameValue.Substring(positionOfFirstEqualitySign + 1);

                    dictionary.Add(n, v);
                }
            }

            return dictionary;
        }
    }

    /// <summary>
    /// Converts type name into System.Type
    /// </summary>
    public class FullyQualifiedTypeStringTypeConverter : TypeConverter
    {
        public override object ConvertFrom(ITypeDescriptorContext context, CultureInfo culture, object value)
        {
            if (value == null)
            {
                throw new ArgumentNullException("Unable to convert NULL into type");
            }

            string typeName = value.ToString();

            if (string.IsNullOrWhiteSpace(typeName))
            {
                throw new ArgumentNullException("Unable to convert EMPTY or WHITE SPACE into type");
            }

            Type type = Type.GetType(typeName, false, true);

            if (type == null)
            {
                throw new NullReferenceException(string.Format("Unable to create type from string \"{0}\"", value));
            }

            return type;
        }
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Infrastructure
WCFLogListener.cs
5050
using System;
using System.Collections;
using System.Collections.Specialized;
using System.Diagnostics;
using System.IO;
using System.Text;
using System.ServiceModel;
using System.Runtime.InteropServices;
using Microsoft.Practices.EnterpriseLibrary.Common.Configuration;
using Microsoft.Practices.EnterpriseLibrary.Logging;
using Microsoft.Practices.EnterpriseLibrary.Logging.Formatters;

using System.Collections.Generic;
using System.Linq;
using System.Configuration;
using System.ServiceModel.Configuration;
using System.Xml;

using ApplicationManagement.Contract.Services;
using ApplicationManagement.Contract.Client;

namespace SAPServer.RFCService.Infrastructure
{
    [ConfigurationElementType(typeof(WCFLogListenerData))]
    public class WCFLogListener : Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.CustomTraceListener
    {
        public WCFLogListener()
        {
        }
        public WCFLogListener(string endPointName, ILogFormatter formatter)
        {
        }

        public override bool IsThreadSafe
        {
            get { return true; }
        }

        public override string Name
        {
            get;
            set;
        }

        public override void Close()
        {
            base.Close();
        }

        protected override void Dispose(bool disposing)
        {
            base.Dispose();
        }

        public override void Fail(string message)
        {
            base.Fail(message);
        }

        public override void Fail(string message, string detailMessage)
        {
            base.Fail(message, detailMessage);
        }

        public override void Flush()
        {
            base.Flush();
        }

        protected override string[] GetSupportedAttributes()
        {
            return new string[] { };
        }

        [ComVisible(false)]
        public override void TraceData(TraceEventCache eventCache, string source, TraceEventType eventType, int id, object data)
        {
            WriteLog(eventType.ToString(), id.ToString(), data.ToString());
        }

        [ComVisible(false)]
        public override void TraceData(TraceEventCache eventCache, string source, TraceEventType eventType, int id, params object[] data)
        {
            StringBuilder builder = new StringBuilder();

            foreach (object item in data)
                builder.Append(item.ToString());

            WriteLog(eventType.ToString(), id.ToString(), builder.ToString());
        }

        public override void Write(object o)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void Write(string message)
        {
            WriteLog("Error", "", message);
        }

        public override void Write(object o, string category)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void Write(string message, string category)
        {
            WriteLog("Error", "", message);
        }

        protected override void WriteIndent()
        {
        }

        public override void WriteLine(object o)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void WriteLine(string message)
        {
            WriteLog("Error", "", message);
        }

        public override void WriteLine(object o, string category)
        {
            WriteLog("Error", "", o.ToString());
        }

        public override void WriteLine(string message, string category)
        {
            WriteLog("Error", "", message);
        }

        #region Private Method

        private void WriteLog(string logType, string priority, string exceptionDetail)
        {
            try
            {
                // ASSUMPTION: We are using the TextExceptionFormatter as the formatter for errors
                ErrorLoggerClient.WriteLog(Attributes["serviceAddress"], Attributes["logName"], logType, priority,
                                            TextExceptionFormatter.GetInnerMostExceptionMessage(exceptionDetail),
                                            exceptionDetail);
            }
            catch (Exception)
            {
                // swallow
            }
        }

        private Exception InnermostException(Exception exception)
        {
            if (exception.InnerException != null)
                return InnermostException(exception.InnerException);
            else
                return exception;
        }

        #endregion
    }

    public class WCFLogListenerData
        : Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.CustomTraceListenerData
    {
        #region Constructors

        public WCFLogListenerData()
        {
        }

        public WCFLogListenerData(string serviceAddress, string logName, string formatter)
        {
        }

        #endregion
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Properties
AssemblyInfo.cs
1448
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;

// General Information about an assembly is controlled through the following 
// set of attributes. Change these attribute values to modify the information
// associated with an assembly.
[assembly: AssemblyTitle("SAPServer.RFCService")]
[assembly: AssemblyDescription("")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyCompany("")]
[assembly: AssemblyProduct("SAPServer.RFCService")]
[assembly: AssemblyCopyright("Copyright   2014")]
[assembly: AssemblyTrademark("")]
[assembly: AssemblyCulture("")]

// Setting ComVisible to false makes the types in this assembly not visible 
// to COM components.  If you need to access a type in this assembly from 
// COM, set the ComVisible attribute to true on that type.
[assembly: ComVisible(false)]

// The following GUID is for the ID of the typelib if this project is exposed to COM
[assembly: Guid("3f27df1c-366a-40dc-973a-fd8fd28eef6e")]

// Version information for an assembly consists of the following four values:
//
//      Major Version
//      Minor Version 
//      Build Number
//      Revision
//
// You can specify all the values or you can default the Build and Revision Numbers 
// by using the '*' as shown below:
// [assembly: AssemblyVersion("1.0.*")]
[assembly: AssemblyVersion("1.0.0.0")]
[assembly: AssemblyFileVersion("1.0.0.0")]

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Publish
environment.xml
7420
<?xml version="1.0"?>
<Environments>
  <Environment>
    <Name>Dev-ATLAS</Name>
    <Server>deva-db00119l</Server>
    <InstallPath>D:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Development"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ATLAS\svc-devappser"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>Dev-ATLAS</Name>
    <Server>deva-dv12013l</Server>
    <InstallPath>D:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Development"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ATLAS\svc-devappser"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>Dev-ATLAS</Name>
    <Server>deva-ap00205l</Server>
    <InstallPath>D:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Development"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ATLAS\svc-devappser"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>Test-JANUS</Name>
    <Server>test-ap00205l</Server>
    <InstallPath>D:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Development"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="JANUS\svc-aidSAPInt-00205"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>  
  <Environment>
    <Name>PreProd-TITAN</Name>
    <Server>core-ap20205l</Server>
    <InstallPath>D:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Development"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="TITAN\svc-A2SAPInt-20205"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>Production-TITAN</Name>
    <Server>core-ap00205l</Server>
    <InstallPath>D:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Development"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="TITAN\svc-A0SAPInt-00205"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>Test</Name>
    <Server>CBR8T055V</Server>
    <InstallPath>E:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Test"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ausaidnb\fmisappsvc_tst_dn2"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>Test2</Name>
    <Server>CBR8T056V</Server>
    <InstallPath>E:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service Test2"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ausaidnb\fmisapsvc_tst2_dn2"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>CITest</Name>
    <Server>CBR8D167V</Server>
    <InstallPath>E:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service CITest"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ausaidnb\devappser"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>PreProduction</Name>
    <Server>CBR8G055V</Server>
    <InstallPath>E:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service PreProduction"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ausaidnb\fmisappsvc_gld_dn2"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
  <Environment>
    <Name>Production</Name>
    <Server>CBR8P055V</Server>
    <InstallPath>E:\Applications</InstallPath>
    <MSDTC enabled="True" />
    <Service name="SAPServer.RFCService"
             display="SAP RFC Service"
             description="SAP RFC Service"
             executable="SAPServer.RFCService.exe"
             account="ausaidnb\fmisapps"/>
    <EventLog name="SAP RFC Service"
              source="SAP RFC Service" />
    <portServices>
      <portService service-name="sapgw00" port-number-and-protocol-name="3300/tcp" alias-name="" comment="#.NET Connector for SAP" />
    </portServices>
  </Environment>
</Environments>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Publish
install.ps1
19672
# --------------------------------------------------------------------------------------------------------------------
# --- Scheduler Service deployment script ---
# --------------------------------------------------------------------------------------------------------------------

[string]$Script:environment | Out-Null
[string]$Script:userName | Out-Null
[string]$Script:applicationsRoot | Out-Null
[string]$Script:service_Name | Out-Null
[string]$Script:service_DisplayName | Out-Null
[string]$Script:service_Description | Out-Null
[string]$Script:service_Executable | Out-Null
[string]$Script:service_EventSource | Out-Null
[string]$Script:eventLog_Name | Out-Null
[string]$Script:applicationRootFolder | Out-Null

[bool]$Script:enabledMSDTC | Out-Null
[string]$Script:portServicesContent | Out-Null
[string]$Script:portServicesPath | Out-Null
[string[]]$Script:hostNames | Out-Null

function InitialiseEnvironmentalVariables ([System.Xml.XmlElement]$environmentXml) {
	$Script:environment = $environmentXml.Name
    $Script:userName = $environmentXml.Service.account
    $Script:applicationsRoot = $environmentXml.InstallPath    
    $Script:service_Name = $environmentXml.Service.name
    $Script:service_DisplayName = $environmentXml.Service.display
    $Script:service_Description = $environmentXml.Service.description
    $Script:service_Executable = $environmentXml.Service.executable
    $Script:service_EventSource = $environmentXml.EventLog.source
    $Script:eventLog_Name = $environmentXml.EventLog.name
	$Script:applicationRootFolder = "$Script:applicationsRoot"

	if ($environmentXml.MSDTC) {
		$Script:enabledMSDTC = [System.Convert]::ToBoolean($environmentXml.MSDTC.enabled)
	}
	else {
		$Script:enabledMSDTC = $false
	}
	if ($environmentXml.portServices) {
        $Script:portServicesPath = "$env:SystemRoot\system32\drivers\etc\services"
		[System.Text.StringBuilder] $stringBuilder = New-Object -TypeName "System.Text.StringBuilder"
		foreach($portService in $environmentXml.portServices.SelectNodes("portService")) {
			# pattern to find all attributes on the same line
			$pattern = [string]::Format("^(?=.*?\b{0}\b)(?=.*?\b{1}\b).*$", 
				$portService.GetAttribute("service-name"), `
				$portService.GetAttribute("port-number-and-protocol-name"))
			if (!(Select-String $Script:portServicesPath -pattern $pattern)) {
				$line = [string]::Format("{0} {1} {2} {3}", `
					$portService.GetAttribute("service-name"), `
					$portService.GetAttribute("port-number-and-protocol-name"), `
					$portService.GetAttribute("alias-name"), `
					$portService.GetAttribute("comment"))								
				$stringBuilder.AppendLine($line)
			}
		}

		if ($stringBuilder.Length) {
			$stringBuilder.AppendLine()
			$Script:portServicesContent = $stringBuilder.ToString()
		}
        else {
            $Script:portServicesContent = $null
        }
	}
	$Script:hostNames = $null
}

function RemoveApplicationPool ([string]$appPool) {

	if(Test-Path "IIS:\AppPools\$appPool") {
        if ((Get-WebAppPoolState "$appPool").Value -eq "Started") {
            Stop-WebAppPool -Name $appPool
        }

	    Remove-WebAppPool $appPool
    }
}

function RemoveWebsite ([string]$siteName) {

	$site = Get-Website | Where-Object { $_.name -eq $siteName }

	if($site) {
        if (($site.applicationPool -ne "DefaultAppPool") -and ((Get-WebAppPoolState -Name $site.applicationPool).Value -ne "Stopped")) {
            Stop-WebAppPool -Name $site.applicationPool -ErrorAction SilentlyContinue
        }
        if ((Get-WebsiteState -Name $site.name).Value -ne "Stopped") {
            Stop-Website -Name $site.name -ErrorAction SilentlyContinue
        }
        foreach($x in $site.bindings.Collection) {
            if ($x.protocol.ToLower() -eq "https") {
                $parts = $x.bindingInformation.Split(':')
                if ($parts.Length -gt 1) {
                    $path = "IIS:\SslBindings\{0}!{1}" -f $parts[0], $parts[1]
                    if (Test-Path $path) {
                        Remove-Item $path
                    }
                }
            }
        }
    	Remove-Website -Name $siteName -ErrorAction SilentlyContinue
        if(Test-Path -Path $site.physicalPath) {
            Start-Sleep -Seconds 3
            Remove-Item -Path $site.physicalPath -Recurse -Force -ErrorAction SilentlyContinue
        }
    }    
}

function SetSiteBining([string]$siteName, [bool]$secure, [string]$ip, [string]$port) {
    $protocol = "http"    
    if ($secure) {
        $protocol += "s"
    }
    $filter = "/system.applicationHost/sites/site[@name=`"{0}`"]/bindings/binding[@protocol=`"{1}`"]" -f $siteName, $protocol    
    $bindingInformation = "{0}:{1}:" -f $ip, $port
    Set-WebConfigurationProperty -Filter $filter -Name bindingInformation -Value $bindingInformation
}

function RunSiteDown ([bool]$siteDown) {
    
    if ($siteDown) {
		Write-Host "Stopping $Script:uiWeb_Name ..."
		Stop-Website -Name $Script:uiWeb_Name -ErrorAction SilentlyContinue
		Write-Host " ... OK"        
    } else {
        Write-Host "Starting $Script:uiWeb_Name ..."    
		Start-Website -Name $Script:uiWeb_Name
		Write-Host " ... OK"
    }
}

function Unzip ([string] $path) {
    $zipFiles = Get-ChildItem $path/*.zip -ErrorAction SilentlyContinue
    if (!$zipFiles) {
        throw "No zip files found at '$path'"
    }
    $unzipfolder = [System.IO.Path]::Combine($path, "package")
    if (!(Test-Path -Path $unzipfolder)){
        New-Item -path $unzipfolder -ItemType directory | Out-Null
    }
    $shell = new-object -com shell.application
    $location = $shell.namespace($unzipfolder)
    foreach ($zipFile in $zipFiles)
    {        
        $zipFolder = $shell.namespace($zipFile.fullname)
		$result = $zipFolder.items() | foreach { [string]$_.Name } | foreach {$var = $_; get-childitem -path $path | Where-Object { $_.name -eq $var } } -ErrorAction SilentlyContinue        
        # the 0x14 argumenmt overwrites and ignores dialog prompts.
        $location.Copyhere($zipFolder.items(), 0x14)        
    }
}

function CreateApplicationPool ([string]$name, [string]$pipelineMode, [string]$runtimeVersion, [string]$userName, [string]$password, [int]$identityType) {
        
    $appPool = New-WebAppPool $name -Force

    $appPool.managedRuntimeVersion = $runtimeVersion

    $appPool.managedPipelineMode = $pipelineMode

    if ($identityType -eq 3) {
        $appPool.processModel.userName = $userName
        $appPool.processModel.Password = $password    
    }

    $appPool.ProcessModel.IdentityType = $identityType

    $appPool | Set-Item | Out-Null    
}


function ReplaceConfig ([string]$environment, [string]$applicationRootPath, [string]$applicationType, [string]$applicationConfigName) {
        
    $config = Get-Item -Path $applicationRootPath\_deployment\$applicationType.$environment.config -ErrorAction "SilentlyContinue"

    if (!$config) {
        throw "Environment config file '$applicationRootPath\_deployment\$applicationType.$environment.config' not found"
    }

	if($applicationConfigName -and $applicationConfigName -ne $null) {
		Remove-Item -Path "$applicationRootPath\$applicationConfigName.config"
	    $config.MoveTo("$applicationRootPath\$applicationConfigName.config")
    }
    else {
		Remove-Item -Path "$applicationRootPath\$applicationType.config"
        $config.MoveTo("$applicationRootPath\$applicationType.config")
	}
}

function GetServiceAccountCcredential ([string]$username, [string]$message) {

	$credential = $null

	do {

		$credential = $host.ui.PromptForCredential("", $message, $username, "")
    
		if ($credential -eq $null) {			
			break
		}
		else {
			$name = $credential.username
			$password = $credential.GetNetworkCredential().password
			$currentDomain = "LDAP://" + ([ADSI] "" ).distinguishedName
			$domain = New-Object System.DirectoryServices.DirectoryEntry($currentDomain, $name, $password)
			if ($domain.name -eq $null) {
				[System.Windows.Forms.MessageBox]::Show("Authentication failed", "Error", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error) | Out-Null
			}
			else {
				break
			}
		}
	} while ($true)

    return $credential
}

function ReadEnvironmentConfiguration ([string]$path, [string]$computerName) {    
    $xml = New-Object -TypeName XML    
    $xml.Load($path)    
    return $Xml.Environments.Environment | Where-Object { $_.Server.ToUpper() -eq $computerName.ToUpper() }
}

function CheckPSVersion() {
    
	if ([int]::Parse(($PSVersionTable).PSVersion.Major) -lt 3) {
		return [string]::Format("Powershell version 3 or higher is required. Current version is {0}", ($PSVersionTable).PSVersion)
	}

    return $null
}

function CheckWindowsFeatures() {

	$requiredFeatures = 
				"AS-WAS-Support",  "AS-TCP-Activation", "AS-Named-Pipes", "Web-Common-Http", "Web-Static-Content", "Web-Default-Doc", `
				"Web-Dir-Browsing", "Web-Http-Errors", "Web-Http-Redirect", "Web-App-Dev", "Web-Asp-Net", "Web-Net-Ext", "Web-ISAPI-Ext", `
				"Web-ISAPI-Filter", "Web-Health", "Web-Http-Logging", "Web-Request-Monitor", "Web-Security", "Web-Basic-Auth", "Web-Windows-Auth", `
				"Web-Filtering", "Web-Performance", "Web-Stat-Compression", "Web-Mgmt-Tools", "Web-Mgmt-Console", "Web-Ftp-Server", "Web-Ftp-Service", `
				"Web-Ftp-Ext", "NET-Framework", "NET-Framework-Core", "NET-Win-CFAC", "NET-HTTP-Activation", "NET-Non-HTTP-Activ", "WAS", `
				"WAS-Process-Model", "WAS-NET-Environment", "WAS-Config-APIs"

    if ($Script:enabledMSDTC) {
        $requiredfeatures += "AS-Dist-Transaction, AS-Incoming-Trans", "AS-Outgoing-Trans"
    }

	$requiredFeatures = (Get-WindowsFeature $requiredFeatures | Where-Object { !($_.Installed) }).Name

	if ($requiredFeatures) {
		$question = [string]::Format(
		    "The following server features are not installed: {0}. Would you like to add the features by powershell now? (Y - `"Yes`" and read the output of the command to see if reboot is required. ANY OTHER KEY - Terminate script now)", 
		    [string]::Join(", ", $requiredFeatures))        
	    $answer = read-host $question
        if ($answer -eq "y") {
            Add-WindowsFeature $requiredFeatures            
            return $true
        } 
        else {
            return $false
        }
	}

    return $true
}

function AddUserToGroup($userName, $groupName) {
	
	# array of domain and user name
	$userNameParts = $userName.Split('\\', [System.StringSplitOptions]::RemoveEmptyEntries);

	if ($userNameParts.Length -eq 2) {
		# Active directory entry corresponding to $userName
		$user = New-Object System.DirectoryServices.DirectoryEntry([string]::Format("WinNT://{0}/{1}", $userNameParts[0], $userNameParts[1]))
		
		# Group to which $userName is added
		$group = ([ADSI]"WinNT://./$groupName,group")

		$found = $false

		foreach ($member in $group.Invoke("Members", $null)) 
		{ 
			$directoryEntry = New-Object System.DirectoryServices.DirectoryEntry($member) 
    
			if ($user.path -eq $directoryEntry.path) {
				$found = $true;
				break;
			}    
		}

		if ($found -eq $false){
			$group.psbase.Invoke("Add", $user.path)
		}
	}
}

function EnableMSDTC ([bool]$enabled) {

	[string]$registryKeyMSDTC = "Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\MSDTC"
	[string[]]$msdtcProperties = "NetworkDTCAccess", "NetworkDTCAccessInbound", "NetworkDTCAccessOutbound", "NetworkDTCAccessTransactions"
    
    if ($enabled) {
        $oldFlag = 0
        $newFlag = 1
    }
    else {
        $oldFlag = 1
        $newFlag = 0
    }

	foreach($property in $msdtcProperties) {
		if ((Get-ItemProperty -path ($registryKeyMSDTC + "\Security") -Name $property).$property -eq $oldFlag) {
			Set-ItemProperty -path ($registryKeyMSDTC + "\Security") -name $property -value $newFlag
		}
	}

    $property = "TurnOffRpcSecurity"
    if ((Get-ItemProperty -path $registryKeyMSDTC -Name $property).$property -eq $oldFlag) {
		Set-ItemProperty -path $registryKeyMSDTC -name $property -value $newFlag
	}

    if ($enabled) {
        $oldFlag = 1
        $newFlag = 0
    }
    else {
        $oldFlag = 0
        $newFlag = 1
    }

    $property = "AllowOnlySecureRpcCalls"
    if ((Get-ItemProperty -path $registryKeyMSDTC -Name $property).$property -eq $oldFlag) {
		Set-ItemProperty -path $registryKeyMSDTC -name $property -value $newFlag
	}
}

function EnableDTCFirewallRules([bool]$enabled) {
	$rulenames = "Distributed Transaction Coordinator (TCP-In)", "Distributed Transaction Coordinator (TCP-Out)"

	$rules = (New-object comObject HNetCfg.FwPolicy2).rules

	foreach($rulename in $rulenames) {
		$rule = $rules | where-object { $_.name like $rulename }
		if ( $rule.Enabled -ne $enabled ) {
			$rule.Enabled = $enabled
		}
	}
}

function SetAccessControl (
    [string] $path, 
    [string] $userName,
    [System.Security.AccessControl.FileSystemRights] $fileSystemRights,
    [System.Security.AccessControl.InheritanceFlags]$inheritanseFlag,
    [System.Security.AccessControl.PropagationFlags]$propagationFlag,
    [System.Security.AccessControl.AccessControlType]$accessControlType
)
{
    if (!($path)) {
        throw "$path is empty"
    }

    if (!(Test-Path -Path $path)) {
        throw "$path does not exist"
    }

    $acl = (Get-Item $path).GetAccessControl("Access")

    if (!($acl.Access | Where-Object { $_.IdentityReference -eq $userName -and $_.FileSystemRights -eq $fileSystemRights -and $_.AccessControlType -eq $accessControlType })) {

        $permission = $userName, $fileSystemRights, $inheritanseFlag, $propagationFlag, $accessControlType
        $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission    
        $acl.SetAccessRule($accessRule)
        Set-Acl $path $acl
    }
}

function SetBackConnectionHostNames($hostNames) {

	[string]$registryKey = "Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"
	[string]$backConnectionHostNameValueName = "BackConnectionHostNames"
	[string[]]$existing = $null

	#do not try to read value if it does not exists - it'll throw an exception
	if (((Get-Item -path $registryKey).Property) -match $backConnectionHostNameValueName) {
		$existing = (Get-ItemProperty -path $registryKey -name $backConnectionHostNameValueName).$backConnectionHostNameValueName
	}

	# looping through requested values 
	[string[]]$missing = $null
	foreach($hostName in $hostNames) {
		if (!($existing -match $hostName)) {
			$missing += $hostName
		}		
	}	

	if ($missing) {
		Set-ItemProperty -path $registryKey -name $backConnectionHostNameValueName -value ($existing + $missing) -type MultiString
	}
}

# --------------------------------------------------------------------------------------------------------------------
# --- Script body ---
# --------------------------------------------------------------------------------------------------------------------

Try {
	$ErrorActionPreference = "Stop"
	$VerbosePreference = "SilentlyContinue"
	$executingDirectory = (New-Object System.IO.FileInfo $MyInvocation.MyCommand.Path).Directory.FullName
	Add-Type AssemblyName System.Windows.Forms

	# Check that powershell version is at least 3.0
    "Checking powershell version ..."
	$message = CheckPSVersion
	if ($message) {
		$message
		return
	}	
    "... OK"

    Write-Host "Reading $executingDirectory\environment.xml ..."
	$computerName = (Get-Content env:computername)
	$environmentXml = ReadEnvironmentConfiguration "$executingDirectory\environment.xml" $computerName
    if(!$environmentXml) {
        throw "Unable to locate an element corresponding to `"$computerName`" in `"$executingDirectory\environment.xml`""
    }    
    InitialiseEnvironmentalVariables $environmentXml
    Write-Host " ... OK"
			
	# MSDTC settings
    "Checking MSDTC is enabled ..."
	EnableMSDTC $Script:enabledMSDTC
    "... OK"

	# Firewall DTC settings
    "Checking DTC firewall rules ..."
	EnableDTCFirewallRules $Script:enabledMSDTC
    "... OK"

    Write-Host "Unzipping`"$executingDirectory`" ..."
    Unzip "$executingDirectory"
    Write-Host " ... OK"

    Write-Host "Collecting application pool service account credentials"
	$authenticated = GetServiceAccountCcredential $Script:userName "Enter application pool service account credentials"
    if($authenticated -eq $null) {
        throw "Authentication cancelled. Installation aborted."
    }
    Write-Host " ... OK"
    
    if (Get-Service "$Script:service_Name" -ErrorAction SilentlyContinue) { 
		Write-Host "Uninstalling service '$Script:service_Name' ..."
        $serviceToRemove = Get-WmiObject -Class Win32_Service -Filter "name='$Script:service_Name'"
        $serviceToRemove | Stop-Service
        $serviceToRemove.delete() | Out-Null		
        Write-Host " ... OK"
    }

    if(Test-Path -path "$Script:applicationRootFolder\$Script:service_Name") {
        Write-Host "Removing files `"$Script:applicationRootFolder\$Script:service_Name`"..."
		Remove-Item -Path "$Script:applicationRootFolder\$Script:service_Name" -Recurse -Force
        Write-Host " ... OK"
	}
    
    Write-Host "Installing service '$Script:service_Name'..."
	Copy-Item -Path "$executingDirectory\package\$Script:service_Name" -Destination "$Script:applicationRootFolder\$Script:service_Name" -Recurse
	ReplaceConfig $Script:environment "$Script:applicationRootFolder\$Script:service_Name" "App" "$Script:service_Executable"
    New-Service -Name $Script:service_Name -BinaryPathName "$Script:applicationRootFolder\$Script:service_Name\$Script:service_Executable" -DisplayName $Script:service_DisplayName -Description $Script:service_Description -StartupType Automatic -Credential $authenticated | Out-Null
	Remove-Item -Path "$Script:applicationRootFolder\$Script:service_Name\_deployment" -Recurse
    Write-Host " ... OK"
		
	# Remove old logs
    Write-Host "Removing old log SAP Server Service ..."
    Remove-EventLog -LogName "SAP Server Service" -ErrorAction "SilentlyContinue"
    Write-Host " ... OK"

    Write-Host "Creating event log `"$Script:eventLog_Name`" with source `"$Script:service_EventSource`" ..."
    New-EventLog -LogName $Script:eventLog_Name -Source $Script:service_EventSource -ErrorAction "SilentlyContinue"
    Write-Host " ... OK"
    
    Write-Host "Setting folder permissions..."
	& icacls "$Script:applicationRootFolder\$Script:service_Name" /grant "$($Script:userName):(OI)(CI)M" | Out-Null        
    Write-Host " ... OK"

	# Ensure host names for the "loopback address" are registered
	if ($Script:hostNames) {
		SetBackConnectionHostNames $Script:hostNames
	}
		
	#Ensuring portServices content is added
	if ($Script:portServicesContent) {
		Add-Content $Script:portServicesPath $Script:portServicesContent
	}

	Write-Host "Starting service $Script:service_Name..."
	Start-Service -Name $Script:service_Name
	Write-Host " ... OK"

	Write-Host ""
	Write-Host "Installation script in $Script:environment environment has finished successfully."
}
Catch {
    foreach($e in $error) {
        Write-Host "Exception:" -ForegroundColor Red
        Write-Host $e -ForegroundColor Red
		Write-Host ""
    }
}
Finally {		
    Remove-Item -Path "$executingDirectory\package" -Recurse -Force | Out-Null
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Publish
update.ps1
18064
# --------------------------------------------------------------------------------------------------------------------
# --- Scheduler Service deployment script ---
# --------------------------------------------------------------------------------------------------------------------

[string]$Script:environment | Out-Null
[string]$Script:userName | Out-Null
[string]$Script:applicationsRoot | Out-Null
[string]$Script:service_Name | Out-Null
[string]$Script:service_DisplayName | Out-Null
[string]$Script:service_Description | Out-Null
[string]$Script:service_Executable | Out-Null
[string]$Script:service_EventSource | Out-Null
[string]$Script:eventLog_Name | Out-Null
[string]$Script:applicationRootFolder | Out-Null

[bool]$Script:enabledMSDTC | Out-Null
[string]$Script:portServicesContent | Out-Null
[string]$Script:portServicesPath | Out-Null
[string[]]$Script:hostNames | Out-Null

function InitialiseEnvironmentalVariables ([System.Xml.XmlElement]$environmentXml) {
	$Script:environment = $environmentXml.Name
    $Script:userName = $environmentXml.Service.account
    $Script:applicationsRoot = $environmentXml.InstallPath    
    $Script:service_Name = $environmentXml.Service.name
    $Script:service_DisplayName = $environmentXml.Service.display
    $Script:service_Description = $environmentXml.Service.description
    $Script:service_Executable = $environmentXml.Service.executable
    $Script:service_EventSource = $environmentXml.EventLog.source
    $Script:eventLog_Name = $environmentXml.EventLog.name
	$Script:applicationRootFolder = "$Script:applicationsRoot"

	if ($environmentXml.MSDTC) {
		$Script:enabledMSDTC = [System.Convert]::ToBoolean($environmentXml.MSDTC.enabled)
	}
	else {
		$Script:enabledMSDTC = $false
	}
	if ($environmentXml.portServices) {
        $Script:portServicesPath = "$env:SystemRoot\system32\drivers\etc\services"
		[System.Text.StringBuilder] $stringBuilder = New-Object -TypeName "System.Text.StringBuilder"
		foreach($portService in $environmentXml.portServices.SelectNodes("portService")) {
			# pattern to find all attributes on the same line
			$pattern = [string]::Format("^(?=.*?\b{0}\b)(?=.*?\b{1}\b).*$", 
				$portService.GetAttribute("service-name"), `
				$portService.GetAttribute("port-number-and-protocol-name"))
			if (!(Select-String $Script:portServicesPath -pattern $pattern)) {
				$line = [string]::Format("{0} {1} {2} {3}", `
					$portService.GetAttribute("service-name"), `
					$portService.GetAttribute("port-number-and-protocol-name"), `
					$portService.GetAttribute("alias-name"), `
					$portService.GetAttribute("comment"))								
				$stringBuilder.AppendLine($line)
			}
		}

		if ($stringBuilder.Length) {
			$stringBuilder.AppendLine()
			$Script:portServicesContent = $stringBuilder.ToString()
		}
        else {
            $Script:portServicesContent = $null
        }
	}
	$Script:hostNames = $null
}

function RemoveApplicationPool ([string]$appPool) {

	if(Test-Path "IIS:\AppPools\$appPool") {
        if ((Get-WebAppPoolState "$appPool").Value -eq "Started") {
            Stop-WebAppPool -Name $appPool
        }

	    Remove-WebAppPool $appPool
    }
}

function RemoveWebsite ([string]$siteName) {

	$site = Get-Website | Where-Object { $_.name -eq $siteName }

	if($site) {
        if (($site.applicationPool -ne "DefaultAppPool") -and ((Get-WebAppPoolState -Name $site.applicationPool).Value -ne "Stopped")) {
            Stop-WebAppPool -Name $site.applicationPool -ErrorAction SilentlyContinue
        }
        if ((Get-WebsiteState -Name $site.name).Value -ne "Stopped") {
            Stop-Website -Name $site.name -ErrorAction SilentlyContinue
        }
        foreach($x in $site.bindings.Collection) {
            if ($x.protocol.ToLower() -eq "https") {
                $parts = $x.bindingInformation.Split(':')
                if ($parts.Length -gt 1) {
                    $path = "IIS:\SslBindings\{0}!{1}" -f $parts[0], $parts[1]
                    if (Test-Path $path) {
                        Remove-Item $path
                    }
                }
            }
        }
    	Remove-Website -Name $siteName -ErrorAction SilentlyContinue
        if(Test-Path -Path $site.physicalPath) {
            Start-Sleep -Seconds 3
            Remove-Item -Path $site.physicalPath -Recurse -Force -ErrorAction SilentlyContinue
        }
    }    
}

function SetSiteBining([string]$siteName, [bool]$secure, [string]$ip, [string]$port) {
    $protocol = "http"    
    if ($secure) {
        $protocol += "s"
    }
    $filter = "/system.applicationHost/sites/site[@name=`"{0}`"]/bindings/binding[@protocol=`"{1}`"]" -f $siteName, $protocol    
    $bindingInformation = "{0}:{1}:" -f $ip, $port
    Set-WebConfigurationProperty -Filter $filter -Name bindingInformation -Value $bindingInformation
}

function RunSiteDown ([bool]$siteDown) {
    
    if ($siteDown) {
		Write-Host "Stopping $Script:uiWeb_Name ..."
		Stop-Website -Name $Script:uiWeb_Name -ErrorAction SilentlyContinue
		Write-Host " ... OK"        
    } else {
        Write-Host "Starting $Script:uiWeb_Name ..."    
		Start-Website -Name $Script:uiWeb_Name
		Write-Host " ... OK"
    }
}

function Unzip ([string] $path) {
    $zipFiles = Get-ChildItem $path/*.zip -ErrorAction SilentlyContinue
    if (!$zipFiles) {
        throw "No zip files found at '$path'"
    }
    $unzipfolder = [System.IO.Path]::Combine($path, "package")
    if (!(Test-Path -Path $unzipfolder)){
        New-Item -path $unzipfolder -ItemType directory | Out-Null
    }
    $shell = new-object -com shell.application
    $location = $shell.namespace($unzipfolder)
    foreach ($zipFile in $zipFiles)
    {        
        $zipFolder = $shell.namespace($zipFile.fullname)
		$result = $zipFolder.items() | foreach { [string]$_.Name } | foreach {$var = $_; get-childitem -path $path | Where-Object { $_.name -eq $var } } -ErrorAction SilentlyContinue        
        # the 0x14 argumenmt overwrites and ignores dialog prompts.
        $location.Copyhere($zipFolder.items(), 0x14)        
    }
}

function CreateApplicationPool ([string]$name, [string]$pipelineMode, [string]$runtimeVersion, [string]$userName, [string]$password, [int]$identityType) {
        
    $appPool = New-WebAppPool $name -Force

    $appPool.managedRuntimeVersion = $runtimeVersion

    $appPool.managedPipelineMode = $pipelineMode

    if ($identityType -eq 3) {
        $appPool.processModel.userName = $userName
        $appPool.processModel.Password = $password    
    }

    $appPool.ProcessModel.IdentityType = $identityType

    $appPool | Set-Item | Out-Null    
}


function ReplaceConfig ([string]$environment, [string]$applicationRootPath, [string]$applicationType, [string]$applicationConfigName) {
        
    $config = Get-Item -Path $applicationRootPath\_deployment\$applicationType.$environment.config -ErrorAction "SilentlyContinue"

    if (!$config) {
        throw "Environment config file '$applicationRootPath\_deployment\$applicationType.$environment.config' not found"
    }

	if($applicationConfigName -and $applicationConfigName -ne $null) {
		Remove-Item -Path "$applicationRootPath\$applicationConfigName.config"
	    $config.MoveTo("$applicationRootPath\$applicationConfigName.config")
    }
    else {
		Remove-Item -Path "$applicationRootPath\$applicationType.config"
        $config.MoveTo("$applicationRootPath\$applicationType.config")
	}
}

function GetServiceAccountCcredential ([string]$username, [string]$message) {

	$credential = $null

	do {

		$credential = $host.ui.PromptForCredential("", $message, $username, "")
    
		if ($credential -eq $null) {			
			break
		}
		else {
			$name = $credential.username
			$password = $credential.GetNetworkCredential().password
			$currentDomain = "LDAP://" + ([ADSI] "" ).distinguishedName
			$domain = New-Object System.DirectoryServices.DirectoryEntry($currentDomain, $name, $password)
			if ($domain.name -eq $null) {
				[System.Windows.Forms.MessageBox]::Show("Authentication failed", "Error", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error) | Out-Null
			}
			else {
				break
			}
		}
	} while ($true)

    return $credential
}

function ReadEnvironmentConfiguration ([string]$path, [string]$computerName) {    
    $xml = New-Object -TypeName XML    
    $xml.Load($path)    
    return $Xml.Environments.Environment | Where-Object { $_.Server.ToUpper() -eq $computerName.ToUpper() }
}

function CheckPSVersion() {
    
	if ([int]::Parse(($PSVersionTable).PSVersion.Major) -lt 3) {
		return [string]::Format("Powershell version 3 or higher is required. Current version is {0}", ($PSVersionTable).PSVersion)
	}

    return $null
}

function CheckWindowsFeatures() {

	$requiredFeatures = 
				"AS-WAS-Support",  "AS-TCP-Activation", "AS-Named-Pipes", "Web-Common-Http", "Web-Static-Content", "Web-Default-Doc", `
				"Web-Dir-Browsing", "Web-Http-Errors", "Web-Http-Redirect", "Web-App-Dev", "Web-Asp-Net", "Web-Net-Ext", "Web-ISAPI-Ext", `
				"Web-ISAPI-Filter", "Web-Health", "Web-Http-Logging", "Web-Request-Monitor", "Web-Security", "Web-Basic-Auth", "Web-Windows-Auth", `
				"Web-Filtering", "Web-Performance", "Web-Stat-Compression", "Web-Mgmt-Tools", "Web-Mgmt-Console", "Web-Ftp-Server", "Web-Ftp-Service", `
				"Web-Ftp-Ext", "NET-Framework", "NET-Framework-Core", "NET-Win-CFAC", "NET-HTTP-Activation", "NET-Non-HTTP-Activ", "WAS", `
				"WAS-Process-Model", "WAS-NET-Environment", "WAS-Config-APIs"

    if ($Script:enabledMSDTC) {
        $requiredfeatures += "AS-Dist-Transaction, AS-Incoming-Trans", "AS-Outgoing-Trans"
    }

	$requiredFeatures = (Get-WindowsFeature $requiredFeatures | Where-Object { !($_.Installed) }).Name

	if ($requiredFeatures) {
		$question = [string]::Format(
		    "The following server features are not installed: {0}. Would you like to add the features by powershell now? (Y - `"Yes`" and read the output of the command to see if reboot is required. ANY OTHER KEY - Terminate script now)", 
		    [string]::Join(", ", $requiredFeatures))        
	    $answer = read-host $question
        if ($answer -eq "y") {
            Add-WindowsFeature $requiredFeatures            
            return $true
        } 
        else {
            return $false
        }
	}

    return $true
}

function AddUserToGroup($userName, $groupName) {
	
	# array of domain and user name
	$userNameParts = $userName.Split('\\', [System.StringSplitOptions]::RemoveEmptyEntries);

	if ($userNameParts.Length -eq 2) {
		# Active directory entry corresponding to $userName
		$user = New-Object System.DirectoryServices.DirectoryEntry([string]::Format("WinNT://{0}/{1}", $userNameParts[0], $userNameParts[1]))
		
		# Group to which $userName is added
		$group = ([ADSI]"WinNT://./$groupName,group")

		$found = $false

		foreach ($member in $group.Invoke("Members", $null)) 
		{ 
			$directoryEntry = New-Object System.DirectoryServices.DirectoryEntry($member) 
    
			if ($user.path -eq $directoryEntry.path) {
				$found = $true;
				break;
			}    
		}

		if ($found -eq $false){
			$group.psbase.Invoke("Add", $user.path)
		}
	}
}

function EnableMSDTC ([bool]$enabled) {

	[string]$registryKeyMSDTC = "Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\MSDTC"
	[string[]]$msdtcProperties = "NetworkDTCAccess", "NetworkDTCAccessInbound", "NetworkDTCAccessOutbound", "NetworkDTCAccessTransactions"
    
    if ($enabled) {
        $oldFlag = 0
        $newFlag = 1
    }
    else {
        $oldFlag = 1
        $newFlag = 0
    }

	foreach($property in $msdtcProperties) {
		if ((Get-ItemProperty -path ($registryKeyMSDTC + "\Security") -Name $property).$property -eq $oldFlag) {
			Set-ItemProperty -path ($registryKeyMSDTC + "\Security") -name $property -value $newFlag
		}
	}

    $property = "TurnOffRpcSecurity"
    if ((Get-ItemProperty -path $registryKeyMSDTC -Name $property).$property -eq $oldFlag) {
		Set-ItemProperty -path $registryKeyMSDTC -name $property -value $newFlag
	}

    if ($enabled) {
        $oldFlag = 1
        $newFlag = 0
    }
    else {
        $oldFlag = 0
        $newFlag = 1
    }

    $property = "AllowOnlySecureRpcCalls"
    if ((Get-ItemProperty -path $registryKeyMSDTC -Name $property).$property -eq $oldFlag) {
		Set-ItemProperty -path $registryKeyMSDTC -name $property -value $newFlag
	}
}

function EnableDTCFirewallRules([bool]$enabled) {
	$rulenames = "Distributed Transaction Coordinator (TCP-In)", "Distributed Transaction Coordinator (TCP-Out)"

	$rules = (New-object comObject HNetCfg.FwPolicy2).rules

	foreach($rulename in $rulenames) {
		$rule = $rules | where-object { $_.name like $rulename }
		if ( $rule.Enabled -ne $enabled ) {
			$rule.Enabled = $enabled
		}
	}
}

function SetAccessControl (
    [string] $path, 
    [string] $userName,
    [System.Security.AccessControl.FileSystemRights] $fileSystemRights,
    [System.Security.AccessControl.InheritanceFlags]$inheritanseFlag,
    [System.Security.AccessControl.PropagationFlags]$propagationFlag,
    [System.Security.AccessControl.AccessControlType]$accessControlType
)
{
    if (!($path)) {
        throw "$path is empty"
    }

    if (!(Test-Path -Path $path)) {
        throw "$path does not exist"
    }

    $acl = (Get-Item $path).GetAccessControl("Access")

    if (!($acl.Access | Where-Object { $_.IdentityReference -eq $userName -and $_.FileSystemRights -eq $fileSystemRights -and $_.AccessControlType -eq $accessControlType })) {

        $permission = $userName, $fileSystemRights, $inheritanseFlag, $propagationFlag, $accessControlType
        $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission    
        $acl.SetAccessRule($accessRule)
        Set-Acl $path $acl
    }
}

function SetBackConnectionHostNames($hostNames) {

	[string]$registryKey = "Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"
	[string]$backConnectionHostNameValueName = "BackConnectionHostNames"
	[string[]]$existing = $null

	#do not try to read value if it does not exists - it'll throw an exception
	if (((Get-Item -path $registryKey).Property) -match $backConnectionHostNameValueName) {
		$existing = (Get-ItemProperty -path $registryKey -name $backConnectionHostNameValueName).$backConnectionHostNameValueName
	}

	# looping through requested values 
	[string[]]$missing = $null
	foreach($hostName in $hostNames) {
		if (!($existing -match $hostName)) {
			$missing += $hostName
		}		
	}	

	if ($missing) {
		Set-ItemProperty -path $registryKey -name $backConnectionHostNameValueName -value ($existing + $missing) -type MultiString
	}
}

# --------------------------------------------------------------------------------------------------------------------
# --- Script body ---
# --------------------------------------------------------------------------------------------------------------------

Try {
	$ErrorActionPreference = "Stop"
	$VerbosePreference = "SilentlyContinue"
	$executingDirectory = (New-Object System.IO.FileInfo $MyInvocation.MyCommand.Path).Directory.FullName
	Add-Type AssemblyName System.Windows.Forms

	# Check that powershell version is at least 3.0
    "Checking powershell version ..."
	$message = CheckPSVersion
	if ($message) {
		$message
		return
	}	
    "... OK"

    Write-Host "Reading $executingDirectory\environment.xml ..."
	$computerName = (Get-Content env:computername)
	$environmentXml = ReadEnvironmentConfiguration "$executingDirectory\environment.xml" $computerName
    if(!$environmentXml) {
        throw "Unable to locate an element corresponding to `"$computerName`" in `"$executingDirectory\environment.xml`""
    }    
    InitialiseEnvironmentalVariables $environmentXml
    Write-Host " ... OK"
			
	# MSDTC settings
    "Checking MSDTC is enabled ..."
	EnableMSDTC $Script:enabledMSDTC
    "... OK"

	# Firewall DTC settings
    "Checking DTC firewall rules ..."
	EnableDTCFirewallRules $Script:enabledMSDTC
    "... OK"

    Write-Host "Unzipping`"$executingDirectory`" ..."
    Unzip "$executingDirectory"
    Write-Host " ... OK"
    
    if (Get-Service "$Script:service_Name" -ErrorAction SilentlyContinue) { 
		Write-Host "Stopping service '$Script:service_Name' ..."
        $serviceToRemove = Get-WmiObject -Class Win32_Service -Filter "name='$Script:service_Name'"
        $serviceToRemove | Stop-Service
        Write-Host " ... OK"
    }

    if(Test-Path -path "$Script:applicationRootFolder\$Script:service_Name") {
        Write-Host "Removing files `"$Script:applicationRootFolder\$Script:service_Name`"..."
		Remove-Item -Path "$Script:applicationRootFolder\$Script:service_Name" -Recurse -Force
        Write-Host " ... OK"
	}
    
    Write-Host "Updating service files '$Script:service_Name'..."
	Copy-Item -Path "$executingDirectory\package\$Script:service_Name" -Destination "$Script:applicationRootFolder\$Script:service_Name" -Recurse
	ReplaceConfig $Script:environment "$Script:applicationRootFolder\$Script:service_Name" "App" "$Script:service_Executable"
	Remove-Item -Path "$Script:applicationRootFolder\$Script:service_Name\_deployment" -Recurse
    Write-Host " ... OK"

	Write-Host "Starting service $Script:service_Name..."
	Start-Service -Name $Script:service_Name
	Write-Host " ... OK"

	Write-Host ""
	Write-Host "Installation script in $Script:environment environment has finished successfully."
}
Catch {
    foreach($e in $error) {
        Write-Host "Exception:" -ForegroundColor Red
        Write-Host $e -ForegroundColor Red
		Write-Host ""
    }
}
Finally {		
    Remove-Item -Path "$executingDirectory\package" -Recurse -Force | Out-Null
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Replication
ITableReplicator.cs
216
using System;
using SAP.Middleware.Connector;

namespace SAPServer.RFCService.Replication
{
    public interface ITableReplicator
    {
        void Replicate(IRfcTable rfcTable, Guid transactionID);
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\Replication
TableReplicator.cs
11539
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading;
using SAPServer.Core;
using Microsoft.SqlServer.Management.Common;
using Microsoft.SqlServer.Management.Smo;
using SAP.Middleware.Connector;

namespace SAPServer.RFCService.Replication
{
    public class TableReplicator : ITableReplicator
    {
        #region Fields

        const string rfcfield_MirroredAction = "KZ";

        const string sqlcolumn_DateMirrored = "DateMirrored";
        const string sqlcolumn_MirroredAction = "MirroredAction";
        const string sqlcolumn_TransactionID = "TransactionID";

        readonly string connectionString;

        static readonly ConcurrentDictionary<string, object> tableLocks = new ConcurrentDictionary<string, object>();

        #endregion

        #region Constructors

        public TableReplicator(string connectionString)
        {
            if (string.IsNullOrWhiteSpace(connectionString))
            {
                throw new ArgumentException("connectionString is empty");
            }

            this.connectionString = connectionString;
        }

        #endregion

        #region ITableReplicator implementation

        public virtual void Replicate(IRfcTable rfcTable, Guid transactionID)
        {
            ValidatePrerequisites(rfcTable);

            // Now that we ensured all prerequisites are met, make sure there are modified rows in the source table to replicate
            IEnumerable<IRfcStructure> structures = GetModifiedRows(rfcTable);
            if (structures.Any())
            {
                string tableName = rfcTable.Metadata.Name;

                // CRLF concatenated lines of table's rows with fields names, types and values
                string traceData = string.Join(Environment.NewLine, structures.Select(x => string.Format("[{0}]", string.Join(" ", x.Select(y => string.Format("{0}={1}", y.Metadata, y.GetValue()))))));
                Diagnostics.Current.Inform("Replicating transaction {0}, table {1} containing:{2}{3}", transactionID, tableName, Environment.NewLine, traceData);

                bool acquired = false;

                object tableLock = tableLocks.GetOrAdd(tableName, x => new object());

                try
                {
                    Monitor.Enter(tableLock, ref acquired);

                    if (acquired)
                    {
                        Diagnostics.Current.Inform("Replicate lock acquired for \"{0}\" at {1:dd/MM/yyyy HH:mm:ss.fff} on thread {2}", tableName, DateTime.Now, Thread.CurrentThread.ManagedThreadId);

                        EnsureDestinationSchema(rfcTable);

                        UpdateDestination(rfcTable, transactionID);
                    }
                    else
                    {
                        Diagnostics.Current.Inform("Replicate lock NOT acquired for \"{0}\" at {1:dd/MM/yyyy HH:mm:ss.fff} on thread {2}", tableName, DateTime.Now, Thread.CurrentThread.ManagedThreadId);
                    }
                }
                finally
                {
                    if (acquired)
                    {
                        Monitor.Exit(tableLock);

                        ((IDictionary<string, object>)tableLocks).Remove(tableName);

                        Diagnostics.Current.Inform("Replicate lock released for \"{0}\" at {1:dd/MM/yyyy HH:mm:ss.fff} on thread {2}", tableName, DateTime.Now, Thread.CurrentThread.ManagedThreadId);
                    }
                }
            }
        }

        #endregion

        #region Private members

        static void ValidatePrerequisites(IRfcTable rfcTable)
        {
            if (rfcTable == null)
            {
                throw new ArgumentNullException("rfcTable");
            }

            if (rfcTable.Count == 0)
            {
                throw new ArgumentException(string.Format("Table \"{0}\" contains no rows.", rfcTable.Metadata.Name));
            }

            int rfcfieldMirroredActionIndex = rfcTable.Metadata.TryNameToIndex(rfcfield_MirroredAction);

            if (rfcfieldMirroredActionIndex == -1)
            {
                throw new ArgumentException(string.Format("Table \"{0}\" does not have an action indicator field {0}.", rfcfield_MirroredAction));
            }
        }

        void EnsureDestinationSchema(IRfcTable rfcTable)
        {
            string tableName = rfcTable.Metadata.Name;

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                Server server = new Server(new ServerConnection(connection));

                Database database = server.Databases[connection.Database];

                Table sqlTable = database.Tables[tableName];

                Action applyChanges;

                if (sqlTable == null)
                {
                    sqlTable = new Table(database, rfcTable.Metadata.Name);

                    // add known columns
                    sqlTable.Columns.Add(new Column(sqlTable, sqlcolumn_DateMirrored, DataType.DateTime));
                    sqlTable.Columns.Add(new Column(sqlTable, sqlcolumn_MirroredAction, DataType.Char(1)));
                    sqlTable.Columns.Add(new Column(sqlTable, sqlcolumn_TransactionID, DataType.UniqueIdentifier));

                    // method to use to apply schema changes for a new table
                    applyChanges = () => sqlTable.Create();
                }
                else
                {
                    // method to use to apply schema changes for an existing table
                    applyChanges = () => sqlTable.Alter();
                }

                // add all missing columns in the destination table and if any apply schema changes
                if (EnsureVariableDestinationColumns(rfcTable, sqlTable))
                {
                    applyChanges();
                }
            }
        }

        void UpdateDestination(IRfcTable rfcTable, Guid transactionID)
        {
            SqlConnection connection = null;

            SqlBulkCopy bulkCopy = null;

            try
            {
                connection = new SqlConnection(connectionString);
                connection.Open();

                bulkCopy = new SqlBulkCopy(connection);
                bulkCopy.DestinationTableName = rfcTable.Metadata.Name;

                // add column mappings
                CreateSqlBulkCopyColumnMapping(rfcTable).ToList().ForEach(x => bulkCopy.ColumnMappings.Add(x));

                // create and fill in the destination table from the source table and execute update
                DataTable dataTable = CreateDataTable(rfcTable, transactionID);
                bulkCopy.WriteToServer(dataTable);
            }
            finally
            {
                if (bulkCopy != null)
                {
                    bulkCopy.Close();
                }

                if (connection != null && (connection.State & ConnectionState.Open) == ConnectionState.Open)
                {
                    connection.Close();
                }
            }
        }

        static bool EnsureVariableDestinationColumns(IRfcTable rfcTable, Table sqlTable)
        {
            if (rfcTable == null)
            {
                throw new ArgumentNullException("rfcTable");
            }

            if (sqlTable == null)
            {
                throw new ArgumentNullException("sqlTable");
            }

            // all existing column names and rfcfield for MirroredAction should not be added
            string[] excludeFields = sqlTable.Columns.Cast<Column>().Select(x => x.Name).Concat(new string[] { rfcfield_MirroredAction }).ToArray();

            // create a sequence of new columns
            IEnumerable<Column> columns = rfcTable.GetAllElementMetadata(excludeFields).Select(x => new Column(sqlTable, x.Name, x.GetMatchingSQLType()));

            // add new columns if any and return TRUE to indicate the change has occured
            if (columns.Any())
            {
                columns.ToList().ForEach(x => sqlTable.Columns.Add(x));
                return true;
            }

            return false;
        }

        static IEnumerable<SqlBulkCopyColumnMapping> CreateSqlBulkCopyColumnMapping(IRfcTable rfcTable)
        {
            // column mappings for all variable columns
            IEnumerable<SqlBulkCopyColumnMapping> variableColumnMapping = rfcTable.GetAllElementMetadata(rfcfield_MirroredAction)
                .Select(x => new SqlBulkCopyColumnMapping(x.Name, x.Name));

            // column mappings for all known columns
            SqlBulkCopyColumnMapping[] knownColumnMapping = new SqlBulkCopyColumnMapping[] 
            { 
                new SqlBulkCopyColumnMapping(sqlcolumn_DateMirrored, sqlcolumn_DateMirrored), 
                new SqlBulkCopyColumnMapping(sqlcolumn_MirroredAction, sqlcolumn_MirroredAction),
                new SqlBulkCopyColumnMapping(sqlcolumn_TransactionID, sqlcolumn_TransactionID) 
            };

            return variableColumnMapping.Concat(knownColumnMapping);
        }

        static DataTable CreateDataTable(IRfcTable rfcTable, Guid transactionID)
        {
            DataTable dataTable = new DataTable(rfcTable.Metadata.Name);

            // add known columns
            dataTable.Columns.Add(sqlcolumn_DateMirrored, typeof(DateTime));
            dataTable.Columns.Add(sqlcolumn_MirroredAction, rfcTable.Metadata[rfcfield_MirroredAction].GetMatchingType());
            dataTable.Columns.Add(sqlcolumn_TransactionID, typeof(Guid));

            // add variable columns
            DataColumn[] dataColumns = rfcTable.GetAllElementMetadata(rfcfield_MirroredAction).Select(x => new DataColumn(x.Name, x.GetMatchingType())).ToArray();
            dataTable.Columns.AddRange(dataColumns);

            DataRow dataRow = null;
            foreach (IRfcStructure rfcStructure in GetModifiedRows(rfcTable))
            {
                dataRow = dataTable.NewRow();

                // update all existing column values
                foreach (IRfcField rfcField in rfcStructure)
                {
                    if (dataTable.Columns.Contains(rfcField.Metadata.Name))
                    {
                        dataRow[rfcField.Metadata.Name] = rfcField.GetSafeValue();
                    }
                }

                // update all known column values
                dataRow[sqlcolumn_DateMirrored] = DateTime.Now;
                dataRow[sqlcolumn_MirroredAction] = rfcStructure[rfcfield_MirroredAction].GetSafeValue();
                dataRow[sqlcolumn_TransactionID] = transactionID;

                dataRow.EndEdit();

                dataTable.Rows.Add(dataRow);
            }

            dataTable.AcceptChanges();

            return dataTable;
        }

        static IEnumerable<IRfcStructure> GetModifiedRows(IRfcTable rfcTable)
        {
            if (rfcTable == null)
            {
                throw new ArgumentNullException("rfcTable");
            }

            return rfcTable.Where(x => !string.IsNullOrWhiteSpace(x[rfcfield_MirroredAction].GetString()));
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\RfcFunctionHandlers
EDWEventRfcFunctionHandler.cs
3517
using System;
using System.Collections.Generic;
using System.Linq;
using SAPServer.Core;
using SAPServer.RFCService.Replication;
using SAP.Middleware.Connector;

namespace SAPServer.RFCService.RfcFunctionHandlers
{
    public static class EDWEventRfcFunctionHandler
    {
        #region Public members

        [RfcServerFunction(Default = true)]
        public static void Handle(RfcServerContext context, IRfcFunction function)
        {
            if (context == null)
            {
                throw new RfcAbapMessageException("RfcServerContext is null", SAPExtensions.RfcExceptionType);
            }

            if (function == null)
            {
                throw new RfcAbapMessageException("function is null", SAPExtensions.RfcExceptionType);
            }

            Diagnostics.Current.Inform("\"{0}\". Context {1}", function.Metadata.Name, context);

            // a sequence of tables to replicate
            IEnumerable<IRfcTable> rfcTables = function
                .Where(x => x.Metadata.DataType == RfcDataType.TABLE)
                .Select(x => function.GetNamedTable(x.Metadata.Name))
                .Where(x => x.Count > 0);

            Diagnostics.Current.Inform("Tables  found for replication: \"{0}\"", string.Join(", ", rfcTables.Select(x => x.Metadata.Name)));

            ITransactionScopeFactory transactionScopeFactory = Class.New<ITransactionScopeFactory>();

            IDisposable transactionScope = null;

            // Establish TransactionID by looking either at UnitID or TransactionID. If both are null generate a new one
            Guid transactionID = context.UnitID == null ? 
                (context.TransactionID == null ? Guid.NewGuid() : context.TransactionID.GUID) : 
                context.UnitID.Uuid;

            try
            {
                transactionScope = transactionScopeFactory.CreateDefault();

                rfcTables.ToList().ForEach(x => ReplicateTable(x, transactionID));

                transactionScopeFactory.Complete(transactionScope);
            }
            catch (Exception exception)
            {
                Diagnostics.Current.Handle(exception);

                throw new RfcAbapMessageException(exception.ToString(), SAPExtensions.RfcExceptionType);
            }
            finally
            {
                transactionScope.Dispose();
            }

        }

        #endregion

        #region Private members

        static void ReplicateTable(IRfcTable rfcTable, Guid transactionID)
        {
            if (rfcTable == null)
            {
                throw new ArgumentNullException("rfcTable");
            }

            Diagnostics.Current.Inform("Replication is about to begin for: \"{0}\"", rfcTable.Metadata.Name);

            if (rfcTable.Count == 0)
            {
                Diagnostics.Current.Inform("Table \"{0}\" contains no rows.", rfcTable.Metadata.Name);
                return;
            }

            DateTime dateTime = DateTime.Now;

            try
            {
                ITableReplicator tableReplicator = Class.New<ITableReplicator>();

                tableReplicator.Replicate(rfcTable, transactionID);
            }
            finally
            {
                Diagnostics.Current.Inform("Replication has finished for: \"{0}\" in {1}", rfcTable.Metadata.Name, DateTime.Now - dateTime);
            }
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\RfcFunctionHandlers
FMISInterfaceEventRfcFunctionHandler.cs
3225
using System;
using System.Collections.Generic;
using System.Linq;
using SAPServer.Core;
using ServiceBus.Contract.Model;
using SAP.Middleware.Connector;

namespace SAPServer.RFCService.RfcFunctionHandlers
{
    public class FMISInterfaceEventRfcFunctionHandler : IRfcFunctionHandler
    {
        #region Fields

        const string RfcFunctionName = "Z_BTE_ERP_EVENT";
        const string RfcFunctionParameterType = "I_EVENT_ID";
        const string RfcFunctionParameterArgs = "T_PARAMETERS";
        const string RfcFunctionParameterArgsName = "NAME";
        const string RfcFunctionParameterArgsValue = "VALUE";

        #endregion

        #region IRfcFunctionHandler implementation

        /// <summary>
        /// This method listens for "Z_BTE_ERP_EVENT" SAP server function call. Expected function IMPORT parameters: I_EVENT_ID (string) and T_PARAMETERS (table)
        /// with two fields NAME and VALUE
        /// </summary>
        /// <param name="context"></param>
        /// <param name="function"></param>
        [RfcServerFunction(Name = RfcFunctionName, Default = false)]
        public void Handle(RfcServerContext context, IRfcFunction function)
        {
            if (context == null)
            {
                throw new RfcAbapMessageException("RfcServerContext is null", SAPExtensions.RfcExceptionType);
            }

            if (function == null)
            {
                throw new RfcAbapMessageException("function is null", SAPExtensions.RfcExceptionType);
            }

            Diagnostics.Current.Inform("\"{0}\". Context {1}", function.Metadata.Name, context);

            string type = function.GetString(RfcFunctionParameterType);

            Dictionary<string, object> arguments = function.GetTable(RfcFunctionParameterArgs).ToDictionary(
                x => x.GetString(RfcFunctionParameterArgsName).Trim(),
                x => x.GetValue(RfcFunctionParameterArgsValue));

            string text = string.Join(", ", arguments.Select(x => string.Format("{0}={1}", x.Key, x.Value)));
            Diagnostics.Current.Inform("Event type: \"{0}\", arguments: \"{1}\".", type, text);

            if (string.IsNullOrWhiteSpace(type))
            {
                throw new RfcAbapMessageException(string.Format("{0} is null or empty", RfcFunctionParameterType), SAPExtensions.RfcExceptionType);
            }

            Guid transactionID = context.TransactionID == null ? Guid.NewGuid() : context.TransactionID.GUID;
            string userID = GetType().Name;
            SAPEvent fmisEvent = new SAPEvent { Type = type, Arguments = arguments };

            try
            {
                SAPServer.RFCService.FMISInterface.IFMISInterfaceSAPServerService fmisInterfaceService = Class.New<SAPServer.RFCService.FMISInterface.IFMISInterfaceSAPServerService>();
                fmisInterfaceService.CreateFMISEventTransaction(transactionID, userID, fmisEvent);
            }
            catch (Exception exception)
            {
                throw new RfcAbapMessageException(exception.Message, SAPExtensions.RfcExceptionType);
            }
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\RfcFunctionHandlers
IRfcFunctionHandler.cs
218
using SAP.Middleware.Connector;

namespace SAPServer.RFCService.RfcFunctionHandlers
{
    public interface IRfcFunctionHandler
    {
        void Handle(RfcServerContext context, IRfcFunction function);
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\RfcServerHosting
IRfcServerHost.cs
149
namespace SAPServer.RFCService.RfcServerHosting
{
    public interface IRfcServerHost
    {
        void Start();
        void Stop();
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\RfcServerHosting
IRfcServerHostFactory.cs
147
namespace SAPServer.RFCService.RfcServerHosting
{
    public interface IRfcServerHostFactory
    {
        IRfcServerHost[] Create();
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\RfcServerHosting
RfcServerHost.cs
5911
using System;
using System.Collections.Generic;
using System.Linq;
using SAPServer.Core;
using SAP.Middleware.Connector;

namespace SAPServer.RFCService.RfcServerHosting
{
    public class RfcServerHost : IRfcServerHost
    {
        #region Fields

        readonly RfcConfigParameters gatewayParameters;
        readonly RfcConfigParameters destinationParameters;
        readonly IUnitIDHandler unitIDHandler;
        readonly Type[] functionHandlerTypes;

        RfcServer rfcServer;

        #endregion

        #region Constructors

        public RfcServerHost(Dictionary<string, string> gatewayParameters, Dictionary<string, string> destinationParameters, IUnitIDHandler unitIDHandler, Type[] functionHandlerTypes)
        {
            string missingParameters = FindMissingParameters(gatewayParameters,
                RfcConfigParameters.Name,
                RfcConfigParameters.GatewayHost,
                RfcConfigParameters.GatewayService,
                RfcConfigParameters.ProgramID);

            if (!string.IsNullOrWhiteSpace(missingParameters))
            {
                throw new ArgumentException("The following parameters must be supplied for RfcServer: {0}", missingParameters);
            }

            missingParameters = FindMissingParameters(destinationParameters,
                RfcConfigParameters.Name,
                RfcConfigParameters.User,
                RfcConfigParameters.Password,
                RfcConfigParameters.Client,
                RfcConfigParameters.AppServerHost);

            if (!string.IsNullOrWhiteSpace(missingParameters))
            {
                throw new ArgumentException("The following parameters must be supplied for RfcDestination: {0}", missingParameters);
            }

            if (unitIDHandler == null)
            {
                throw new ArgumentNullException("unitIDHandler");
            }

            if (functionHandlerTypes == null || functionHandlerTypes.Length == 0)
            {
                throw new ArgumentException("functionHandlerTypes either null or empty array");
            }

            this.gatewayParameters = CreateRfcConfigParameters(gatewayParameters);
            this.destinationParameters = CreateRfcConfigParameters(destinationParameters);
            this.unitIDHandler = unitIDHandler;
            this.functionHandlerTypes = functionHandlerTypes;
        }

        #endregion

        #region IRfcServerHost implementation

        public virtual void Start()
        {
            EnsureServerCreated();

            rfcServer.Start();
        }

        public virtual void Stop()
        {
            rfcServer.Shutdown(true);

            EnsureServerDestroyed();
        }

        #endregion

        #region Private members

        void EnsureServerCreated()
        {
            if (rfcServer != null)
            {
                return;
            }

            try
            {
                rfcServer = RfcServerManager.GetServer(gatewayParameters, functionHandlerTypes, RfcDestinationManager.GetDestination(destinationParameters).Repository);
                rfcServer.RfcServerError += HandleRfcError;
                rfcServer.RfcServerApplicationError += HandleRfcError;
                rfcServer.UnitIDHandler = unitIDHandler;
                rfcServer.RfcServerStateChanged += HandleRfcServerStateChanged;
            }
            catch (Exception exception)
            {
                throw new ApplicationException("Unable to create a RfcServer. Review gateway and destination parameters", exception);
            }
        }

        void EnsureServerDestroyed()
        {
            if (rfcServer == null)
            {
                return;
            }

            rfcServer.RfcServerError -= HandleRfcError;
            rfcServer.RfcServerApplicationError -= HandleRfcError;
            rfcServer.RfcServerStateChanged -= HandleRfcServerStateChanged;
            rfcServer.UnitIDHandler = null;
            rfcServer = null;
        }

        void HandleRfcError(object sender, RfcServerErrorEventArgs e)
        {
            Diagnostics.Current.Handle(e.Error);

            Diagnostics.Current.Inform("{0} {1} {2}", sender, e.ServerContextInfo, e.Error);
        }

        void HandleRfcServerStateChanged(object server, RfcServerStateChangedEventArgs stateEventData)
        {
            //TODO: Keep monitoring and add reconciliation code as required - no reliable unit test can be built 20/03/2014.

            string text = string.Format("RfcServer {2} state changed from {0} to {1}.", stateEventData.OldState, stateEventData.NewState, ((RfcServer)server).Name);
            Diagnostics.Current.Email(true, text);
            Diagnostics.Current.Inform(text);
        }

        static RfcConfigParameters CreateRfcConfigParameters(Dictionary<string, string> parameters)
        {
            if (parameters == null)
            {
                throw new ArgumentException("parameters");
            }

            RfcConfigParameters rfcConfigParameters = new RfcConfigParameters();

            foreach (string key in parameters.Keys)
            {
                rfcConfigParameters.Add(key, parameters[key]);
            }

            return rfcConfigParameters;
        }

        static string FindMissingParameters(Dictionary<string, string> parameters, params string[] keys)
        {
            if (parameters == null)
            {
                throw new ArgumentException("parameters");
            }

            if (keys == null)
            {
                throw new ArgumentException("keys");
            }

            return string.Join(",", keys.Where(x => !parameters.ContainsKey(x)));
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\RfcServerHosting
RfcServerHostFactory.cs
1030
using System;
using System.Linq;
using SAPServer.Core;

namespace SAPServer.RFCService.RfcServerHosting
{
    public class RfcServerHostFactory : IRfcServerHostFactory
    {
        #region Fields

        readonly string[] nameRegistrations;

        #endregion

        #region Constructor

        public RfcServerHostFactory(string[] nameRegistrations)
        {
            if (nameRegistrations == null)
            {
                throw new ArgumentNullException("nameRegistrations");
            }

            if (nameRegistrations.Length == 0)
            {
                throw new ArgumentException("nameRegistrations is empty.");
            }

            this.nameRegistrations = nameRegistrations;
        }

        #endregion

        #region IRfcServerHostFactory implementation

        public virtual IRfcServerHost[] Create()
        {
            return nameRegistrations.Select(x => Class.New<IRfcServerHost>(x)).ToArray();
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\SAP.Middleware.Connector
RfcExtensions.cs
10027
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using Microsoft.SqlServer.Management.Smo;

namespace SAP.Middleware.Connector
{
    static class RfcExtensions
    {
        #region Fields

        public const string RfcExeptionKey = "SYSTEM_FAILURE";
        public const string RfcExceptionType = "ERROR";

        #endregion

        #region Public members

        public static object GetSafeValue(this IRfcField field)
        {
            if (field == null)
            {
                throw new ArgumentNullException("field");
            }

            switch (field.Metadata.DataType)
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                case RfcDataType.NUM:
                    {
                        int precision = field.Metadata.NucLength * 2 + field.Metadata.Decimals;
                        if (precision > 38)
                        {
                            return field.GetString();
                        }
                        return field.GetDecimal();
                    }                    

                case RfcDataType.BYTE:
                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return field.GetByteArray();

                case RfcDataType.CDAY:
                case RfcDataType.DATE:
                    {
                        string text = field.GetString();
                        return text == "0000-00-00" ? DBNull.Value : (object)DateTime.Parse(text);
                    }

                case RfcDataType.TIME:
                    {
                        string text = field.GetString();
                        return text == "00:00:00" ? DBNull.Value : (object)TimeSpan.Parse(text);
                    }

                case RfcDataType.CHAR:
                    return field.GetCharArray();

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return field.GetInt();

                case RfcDataType.FLOAT:
                    return field.GetDouble();

                case RfcDataType.INT1:
                    return field.GetByte();

                case RfcDataType.INT2:
                    return field.GetShort();

                case RfcDataType.INT8:
                    return field.GetLong();

                case RfcDataType.STRING:
                    return field.GetString();

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable RfcField type", field.Metadata.DataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown RfcField type: {0}", field.Metadata.DataType));
            }
        }

        public static DataType GetMatchingSQLType(this RfcElementMetadata metadata)
        {
            if (metadata == null)
            {
                throw new ArgumentNullException("metadata");
            }

            switch (metadata.DataType)
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                    {
                        int precision = metadata.NucLength * 2 + metadata.Decimals;
                        if (precision > 38)
                        {
                            return DataType.VarChar(precision);
                        }
                        return DataType.Decimal(metadata.Decimals, precision);
                    }

                case RfcDataType.BYTE:
                    return DataType.VarBinary(metadata.NucLength);

                case RfcDataType.CDAY:
                    return DataType.Date;

                case RfcDataType.CHAR:
                    return DataType.Char(metadata.NucLength);

                case RfcDataType.DATE:
                    return DataType.DateTime;

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return DataType.Int;

                case RfcDataType.FLOAT:
                    return DataType.Float;

                case RfcDataType.INT1:
                    return DataType.TinyInt;

                case RfcDataType.INT2:
                    return DataType.SmallInt;

                case RfcDataType.INT8:
                    return DataType.BigInt;

                case RfcDataType.NUM:
                    {
                        int precision = metadata.NucLength * 2 + metadata.Decimals;
                        if (precision > 38)
                        {
                            return DataType.VarChar(precision);
                        }
                        return DataType.Numeric(metadata.Decimals, precision);
                    }

                case RfcDataType.STRING:
                    return DataType.VarChar(metadata.NucLength);

                case RfcDataType.TIME:
                    return DataType.Time(0);

                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return DataType.VarBinary(metadata.NucLength);

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable RfcField type", metadata.DataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown RfcField type: {0}", metadata.DataType));
            }
        }

        public static Type GetMatchingType(this RfcElementMetadata metadata)
        {
            if (metadata == null)
            {
                throw new ArgumentNullException("metadata");
            }

            switch (metadata.DataType)
            {
                case RfcDataType.BCD:
                case RfcDataType.DECF16:
                case RfcDataType.DECF34:
                case RfcDataType.NUM:
                    return typeof(decimal);

                case RfcDataType.BYTE:
                case RfcDataType.UTCLONG:
                case RfcDataType.XSTRING:
                    return typeof(byte[]);

                case RfcDataType.CDAY:
                case RfcDataType.DATE:
                    return typeof(DateTime);

                case RfcDataType.CHAR:
                    return typeof(char[]);

                case RfcDataType.DTDAY:
                case RfcDataType.DTMONTH:
                case RfcDataType.DTWEEK:
                case RfcDataType.INT4:
                case RfcDataType.TMINUTE:
                case RfcDataType.TSECOND:
                case RfcDataType.UTCMINUTE:
                case RfcDataType.UTCSECOND:
                    return typeof(int);

                case RfcDataType.FLOAT:
                    return typeof(double);

                case RfcDataType.INT1:
                    return typeof(byte);

                case RfcDataType.INT2:
                    return typeof(short);

                case RfcDataType.INT8:
                    return typeof(long);

                case RfcDataType.STRING:
                    return typeof(String);

                case RfcDataType.TIME:
                    return typeof(TimeSpan);

                case RfcDataType.CLASS:
                case RfcDataType.STRUCTURE:
                case RfcDataType.TABLE:
                    throw new InvalidOperationException(string.Format("Unacceptable RfcField type", metadata.DataType));

                case RfcDataType.UNKNOWN:
                default:
                    throw new InvalidOperationException(string.Format("Unknown RfcField type: {0}", metadata.DataType));
            }
        }

        public static IEnumerable<RfcElementMetadata> GetAllElementMetadata(this IRfcTable rfcTable, params string[] excludeFields)
        {
            if (rfcTable == null)
            {
                throw new ArgumentNullException("rfcTable");
            }

            return Enumerable.Range(0, rfcTable.ElementCount)
                .Select(x => rfcTable.GetElementMetadata(x))
                .Where(x => excludeFields == null || !excludeFields.Contains(x.Name, StringComparer.InvariantCultureIgnoreCase));
        }

        /// <summary>
        /// This hack enforces parameterName into table's metadata Name that is declared as "public readonly string Name;" in RfcTableMetadata
        /// and comes out empty by default
        /// </summary>
        /// <param name="function"></param>
        /// <param name="parameterName"></param>
        /// <returns></returns>
        public static IRfcTable GetNamedTable(this IRfcFunction function, string parameterName)
        {
            IRfcTable rfcTable = function.GetTable(parameterName);

            FieldInfo nameFieldInfo = rfcTable.Metadata.GetType().GetField("Name");
            nameFieldInfo.SetValue(rfcTable.Metadata, parameterName);

            return rfcTable;
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\UnitIDHandlers
EDWEventUnitIDHandler.cs
1535
using System;
using System.Collections.Generic;
using SAPServer.Core;
using SAP.Middleware.Connector;

namespace SAPServer.RFCService.UnitIDHandlers
{
    //TODO: proper implementation pending
    public class EDWEventUnitIDHandler : IUnitIDHandler
    {
        #region Fields

        List<Guid> transactions = new List<Guid>();

        #endregion

        #region IUnitIDHandler implementation

        public bool CheckUnitID(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            return !transactions.Contains(uid.Uuid);
        }

        public void Commit(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            // left empty on purpose - no transaction log management
        }

        public void ConfirmUnitID(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            transactions.Remove(uid.Uuid);
        }

        public RfcUnitState GetUnitState(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            if (!CheckUnitID(ctx, uid))
            {
                return RfcUnitState.IN_PROCESS;
            }

            return RfcUnitState.CONFIRMED;
        }

        public void Rollback(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            // No action required, just notify about the rollback
            string text = string.Format("Transaction {0} rolled back. Context {1}.", uid, ctx);
            Diagnostics.Current.Email(true, text);
            Diagnostics.Current.Inform(text);
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.RFCService\UnitIDHandlers
FMISInterfaceEventUnitIDHandler.cs
2000
using System;
using SAPServer.Core;
using ServiceBus.Contract.Model;
using SAP.Middleware.Connector;
using SAPServer.RFCService.FMISInterface;

namespace SAPServer.RFCService.UnitIDHandlers
{
    public class FMISInterfaceEventUnitIDHandler : IUnitIDHandler
    {
        #region Fields

        readonly IFMISInterfaceSAPServerService fmisInterfaceService;

        #endregion

        #region Constructors

        public FMISInterfaceEventUnitIDHandler(IFMISInterfaceSAPServerService fmisInterfaceService)
        {
            if (fmisInterfaceService == null)
            {
                throw new ArgumentNullException("fmisInterfaceService");
            }

            this.fmisInterfaceService = fmisInterfaceService;
        }

        #endregion

        #region IUnitIDHandler implementation

        public bool CheckUnitID(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            return !fmisInterfaceService.FMISEventTransactionExists(uid.Uuid);
        }

        public void Commit(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            // left empty on purpose - no transaction log management
        }

        public void ConfirmUnitID(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            // left empty on purpose - no transaction log management
        }

        public RfcUnitState GetUnitState(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            if (!CheckUnitID(ctx, uid))
            {
                return RfcUnitState.CONFIRMED;
            }

            return RfcUnitState.IN_PROCESS;
        }

        public void Rollback(RfcServerContextInfo ctx, RfcUnitID uid)
        {
            // No action required, just log the rollback
            string text = string.Format("Transaction {0} rolled back. Context {1}.", uid, ctx);
            Diagnostics.Current.Email(true, text);
            Diagnostics.Current.Inform(text);
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPActualExpenseJournal.cs
22509
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public interface IActualExpenseJournalBuilder
    {
        ActualExpenseJournal[] Build();
    }

    public class ActualExpenseJournalBuilder : SAPObject, IActualExpenseJournalBuilder
    {
        #region Fields

        // function and return table
        public const string SAP_FUNC_DOCUMENT_FIND = "ZBAPI_ACC_CO_DOCUMENT_FIND";
        public const string SAP_FUNC_GOODS_RECEIPT = "BAPI_GOODSMVT_GETDETAIL";
        public const string SAP_FUNC_PO_GETDETAIL = "BAPI_PO_GETDETAIL1";
        public const string SAP_FUNC_RETURNTABLE = "RETURN";

        // input params
        public const string SAP_FIELD_DOCUMENT = "DOCUMENT";
        public const string SAP_FIELD_DOCUMENT_CO_AREA = "CO_AREA";
        public const string SAP_FIELD_DOCUMENT_DOC_NO = "DOC_NO";
        public const string SAP_FIELD_RETURN_ITEMS = "RETURN_ITEMS";
        public const string SAP_FIELD_RETURN_COSTS = "RETURN_COSTS";
        public const string SAP_FIELD_RETURN_QTY = "RETURN_QTY";

        // return params
        public const string SAP_FIELD_LINE_ITEMS = "LINE_ITEMS";
        public const string SAP_FIELD_LINE_ITEMS_ACTIVITY = "LINE_ITEMS_ACTIVITY";
        public const string SAP_FIELD_LINE_ITEMS_STAT_KEY_FIG = "LINE_ITEMS_STAT_KEY_FIG";

        // goods receipt params
        public const string SAP_FIELD_HEADER_MATERIALDOCUMENT = "MATERIALDOCUMENT";
        public const string SAP_FIELD_HEADER_MATDOCUMENTYEAR = "MATDOCUMENTYEAR";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM = "GOODSMVT_ITEMS";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM_MATDOC_ITM = "MATDOC_ITM";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM_MOVE_TYPE = "MOVE_TYPE";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM_PO_NUMBER = "PO_NUMBER";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM_PO_ITEM = "PO_ITEM";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM_WBS_ELEM = "WBS_ELEM";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM_VENDOR = "VENDOR";
        public const string SAP_FIELD_GOODS_RECEIPT_ITEM_ENTRY_QNT = "ENTRY_QNT";

        // header params
        public const string SAP_FIELD_HEADER = "DOC_HEADERS";
        public const string SAP_FIELD_HEADER_POSTGDATE = "POSTGDATE";
        public const string SAP_FIELD_HEADER_FISC_YEAR = "FISC_YEAR";
        public const string SAP_FIELD_HEADER_DOC_HDR_TX = "DOC_HDR_TX";
        public const string SAP_FIELD_HEADER_OBJ_TYPE = "OBJ_TYPE";
        public const string SAP_FIELD_HEADER_OBJ_KEY = "OBJ_KEY";
        public const string SAP_FIELD_HEADER_CO_TRANSAC = "CO_TRANSAC";
        public const string SAP_FIELD_HEADER_REVERSED = "REVERSED";
        public const string SAP_FIELD_HEADER_DOC_STATUS = "DOC_STATUS";
        public const string SAP_FIELD_HEADER_REF_DOC_NO = "REF_DOC_NO";

        // line item params
        public const string SAP_FIELD_LINE_ITEM_WBS_ELEM = "WBS_ELEM";
        public const string SAP_FIELD_LINE_ITEM_COST_ELEM = "COST_ELEM";
        public const string SAP_FIELD_LINE_ITEM_VALUE_TCUR = "VALUE_TCUR";
        public const string SAP_FIELD_LINE_ITEM_VALUE_OCUR = "VALUE_OCUR";
        public const string SAP_FIELD_LINE_ITEM_TRANS_CURR = "TRANS_CURR";
        public const string SAP_FIELD_LINE_ITEM_TRANS_CURR_ISO = "TRANS_CURR_ISO";
        public const string SAP_FIELD_LINE_ITEM_OBJ_CURR_ISO = "OBJ_CURR_ISO";
        public const string SAP_FIELD_LINE_ITEM_VALUE_COCUR = "VALUE_COCUR";
        public const string SAP_FIELD_LINE_ITEM_QUANTITY = "QUANTITY";
        public const string SAP_FIELD_LINE_ITEM_DR_CR_IND = "DR_CR_IND";
        public const string SAP_FIELD_LINE_ITEM_SEG_TEXT = "SEG_TEXT";
        public const string SAP_FIELD_LINE_ITEM_DOC_ITEM = "DOC_ITEM";
        public const string SAP_FIELD_LINE_ITEM_PO_NUMBER = "PO_NUMBER";
        public const string SAP_FIELD_LINE_ITEM_PO_ITEM = "PO_ITEM";
        public const string SAP_FIELD_LINE_ITEM_TRACKINGNO = "TRACKINGNO";
        public const string SAP_FIELD_LINE_ITEM_VALUE_TYPE = "VALUE_TYPE";

        // purchase order BAPI params
        public const string SAP_PO_PARAM_PURCHASEORDER = "PURCHASEORDER";
        public const string SAP_PO_PARAM_ACCOUNT_ASSIGNMENT = "ACCOUNT_ASSIGNMENT";
        public const string SAP_PO_PARAM_POHEADER = "POHEADER";

        // purchase order header BAPI fields
        public const string SAP_PO_FIELD_POHEADER_VENDOR = "VENDOR";

        public const string SAP_JOURNALTYPE_GOODSRECEIPT = "MKPF";
        public const string SAP_JOURNAL_VALID_VALUE_TYPE = "04";
        public const string SAP_JOURNAL_CO_TRANSACION_SETTLEMENT = "KOAO";

        readonly protected string documentType;
        readonly protected IRfcStructure documentHeader;
        readonly protected IEnumerable<IRfcStructure> documentLines;

        string purchaseOrderNumber = null;

        #endregion

        #region Constructor

        public ActualExpenseJournalBuilder(RfcDestination destination, ISAPConfiguration configuration, string documentType, IRfcStructure documentHeader, IEnumerable<IRfcStructure> documentLines)
            : base(destination, configuration)
        {
            this.documentType = documentType;
            this.documentHeader = documentHeader;
            this.documentLines = documentLines;
        }

        #endregion

        #region IActualExpenseJournalBuilder implementation

        public ActualExpenseJournal[] Build()
        {
            List<ActualExpenseJournal> journals = new List<ActualExpenseJournal>();

            // Include only those lines where:
            //  1. VALUE_TYPE = 04 
            //  2. Have a WBS code that start with "I."
            //  3. Have a CO Transaction that is not a Settlement tx, i.e. KOAO

            string coTransaction = documentHeader.GetString(SAP_FIELD_HEADER_CO_TRANSAC);

            if (string.IsNullOrEmpty(coTransaction) || 
                !string.Equals(coTransaction, SAP_JOURNAL_CO_TRANSACION_SETTLEMENT, StringComparison.InvariantCultureIgnoreCase))
            {
                foreach (IRfcStructure documentLine in documentLines)
                {
                    string valueType = documentLine.GetString(SAP_FIELD_LINE_ITEM_VALUE_TYPE) ?? string.Empty;
                    string wbsCode = documentLine.GetString(SAP_FIELD_LINE_ITEM_WBS_ELEM) ?? string.Empty;

                    if (valueType.Equals(SAP_JOURNAL_VALID_VALUE_TYPE, StringComparison.InvariantCultureIgnoreCase) &&
                        wbsCode.StartsWith("I.", StringComparison.InvariantCultureIgnoreCase))
                    {
                        journals.Add(Create(documentLine));
                    }
                    else
                    {
                        Diagnostics.Current.Inform("Expense journal not replicated. Document line:{0}", documentLine);
                    }
                }
            }

            return journals.ToArray();
        }

        #endregion

        #region Virtual members

        protected virtual string FindVendorNumber()
        {
            if (string.IsNullOrWhiteSpace(purchaseOrderNumber))
            {
                return null;
            }

            IRfcFunction getPurchaseOrder = Destination.Repository.CreateFunction(SAP_FUNC_PO_GETDETAIL);
            getPurchaseOrder.SetValue(SAP_PO_PARAM_PURCHASEORDER, purchaseOrderNumber);
            getPurchaseOrder.SetValue(SAP_PO_PARAM_ACCOUNT_ASSIGNMENT, "X");
            getPurchaseOrder.InvokeAndThrowOnAnyException(Destination);
            return getPurchaseOrder.GetStructure(SAP_PO_PARAM_POHEADER).GetString(SAP_PO_FIELD_POHEADER_VENDOR);
        }

        protected virtual ActualExpenseJournal Create(IRfcStructure lineItem)
        {
            purchaseOrderNumber = lineItem.GetString(SAP_FIELD_LINE_ITEM_PO_NUMBER);

            return new ActualExpenseJournal
            {
                DocumentType = documentType,
                DocumentNumber = documentHeader.GetString(SAP_FIELD_DOCUMENT_DOC_NO),
                TransactionDate = documentHeader.GetValue(SAP_FIELD_HEADER_POSTGDATE).As<DateTime>(),
                ActivityAppropriationSourceWBSElementCode = lineItem.GetString(SAP_FIELD_LINE_ITEM_WBS_ELEM),
                CurrencyAmount = lineItem.GetDecimal(SAP_FIELD_LINE_ITEM_VALUE_TCUR),
                AUDAmount = lineItem.GetDecimal(SAP_FIELD_LINE_ITEM_VALUE_OCUR),
                LineItemNumber = lineItem.GetString(SAP_FIELD_LINE_ITEM_DOC_ITEM),
                Description = lineItem.GetString(SAP_FIELD_LINE_ITEM_SEG_TEXT),
                GLCode = lineItem.GetString(SAP_FIELD_LINE_ITEM_COST_ELEM),
                CurrencyCode = lineItem.GetString(SAP_FIELD_LINE_ITEM_TRANS_CURR_ISO),
                PurchaseOrderNumber = lineItem.GetString(SAP_FIELD_LINE_ITEM_PO_NUMBER),
                POLineReferenceNumber = lineItem.GetString(SAP_FIELD_LINE_ITEM_TRACKINGNO),
                VendorNumber = FindVendorNumber(),
                PaymentEventCertificationID = documentHeader.GetValue(SAP_FIELD_HEADER_REF_DOC_NO).As<int>()
            };
        }

        #endregion
    }

    class NullActualExpenseJournalBuilder : IActualExpenseJournalBuilder
    {
        #region Fields

        static readonly ActualExpenseJournal[] nojournals = new ActualExpenseJournal[0];

        #endregion

        #region IActualExpenseJournalBuilder implementation

        public ActualExpenseJournal[] Build()
        {
            return nojournals;
        }

        #endregion
    }

    class AdjustmentActualExpenseJournalBuilder : ActualExpenseJournalBuilder
    {
        #region Fields

        const string text = "OASIS Adjustment";

        string objectKey = null;

        #endregion

        #region Constructor

        public AdjustmentActualExpenseJournalBuilder(RfcDestination destination, ISAPConfiguration configuration, string documentType, IRfcStructure documentHeader, IEnumerable<IRfcStructure> documentLines)
            : base(destination, configuration, documentType, documentHeader, documentLines)
        {
        }

        #endregion

        #region ActualExpenseJournalBuilder implementation

        protected override string FindVendorNumber()
        {
            if (string.IsNullOrWhiteSpace(objectKey))
            {
                throw new InvalidOperationException("objectKey is null or white space. It should be defined before call Create is executed.");
            }

            int indexOfP = objectKey.IndexOf('P');

            if (indexOfP < 0)
            {
                throw new InvalidOperationException(string.Format("Unable to identify vendor. Document number {0}, control area: {1}",
                    documentHeader.GetString(SAP_FIELD_DOCUMENT_DOC_NO),
                    documentHeader.GetString(SAP_FIELD_DOCUMENT_CO_AREA)));
            }

            return objectKey.Substring(0, indexOfP);
        }

        protected override ActualExpenseJournal Create(IRfcStructure lineItem)
        {
            objectKey = documentHeader.GetString(SAP_FIELD_HEADER_OBJ_KEY);

            ActualExpenseJournal actualExpenseJournal = base.Create(lineItem);
            actualExpenseJournal.POLineReferenceNumber = lineItem.GetString(SAP_FIELD_LINE_ITEM_SEG_TEXT).Replace(text, string.Empty).Trim();
            return actualExpenseJournal;
        }

        #endregion
    }

    class GoodsReceiptActualExpenseJournalBuilder : ActualExpenseJournalBuilder
    {
        #region Fields

        readonly Tuple<string, string, string, IEnumerable<IRfcStructure>> goodsReceiptData;

        #endregion

        #region Constructor

        public GoodsReceiptActualExpenseJournalBuilder(RfcDestination destination, ISAPConfiguration configuration, string documentType, IRfcStructure documentHeader, IEnumerable<IRfcStructure> documentLines)
            : base(destination, configuration, documentType, documentHeader, documentLines)
        {
            goodsReceiptData = InitialiseGoodsReceiptData();
        }

        #endregion

        #region ActualExpenseJournalBuilder implementation

        protected override string FindVendorNumber()
        {
            if (goodsReceiptData == null)
            {
                throw new NullReferenceException("goodsReceiptData is null. It should be defined before call Create is executed.");
            }

            return goodsReceiptData.Item3;
        }

        protected override ActualExpenseJournal Create(IRfcStructure lineItem)
        {
            if (lineItem == null)
            {
                throw new ArgumentNullException("lineItem");
            }

            ActualExpenseJournal actualExpenseJournal = base.Create(lineItem);
            actualExpenseJournal.GoodsReceiptNumber = goodsReceiptData.Item1;
            actualExpenseJournal.PurchaseOrderNumber = goodsReceiptData.Item2;
            actualExpenseJournal.POLineReferenceNumber = ValidatePOLineReferenceNumber(lineItem, goodsReceiptData.Item4);
            return actualExpenseJournal;
        }

        #endregion

        #region Private members

        void ValidateGoodsReceiptData(string objectKey, out string purchaseOrderNumber, out string vendorNumber)
        {
            int financialYear = objectKey.Length == 14 ? objectKey.Substring(10).As<int>() : documentHeader.GetInt(SAP_FIELD_HEADER_FISC_YEAR);

            IRfcFunction function = Destination.Repository.CreateFunction(SAP_FUNC_GOODS_RECEIPT);
            function.SetValue(SAP_FIELD_HEADER_MATERIALDOCUMENT, objectKey);
            function.SetValue(SAP_FIELD_HEADER_MATDOCUMENTYEAR, financialYear);
            function.InvokeAndThrowOnAnyException(Destination);

            IRfcTable goodsReceiptItems = function.GetTable(SAP_FIELD_GOODS_RECEIPT_ITEM);

            if (goodsReceiptItems == null || !goodsReceiptItems.Any())
            {
                throw new InvalidOperationException(string.Format("No goods receipt found for material document number {0} and financial year {1}",
                    objectKey,
                    financialYear));
            }

            purchaseOrderNumber = goodsReceiptItems[0].GetString(SAP_FIELD_GOODS_RECEIPT_ITEM_PO_NUMBER);

            if (string.IsNullOrWhiteSpace(purchaseOrderNumber))
            {
                throw new InvalidOperationException("Purchase order number is null or white space");
            }

            vendorNumber = goodsReceiptItems[0].GetString(SAP_FIELD_GOODS_RECEIPT_ITEM_VENDOR);

            if (string.IsNullOrWhiteSpace(vendorNumber))
            {
                throw new InvalidOperationException("Vendor number is null or white space");
            }
        }

        IEnumerable<IRfcStructure> ValidatePurchaseOrderItems(string purchaseOrderNumber)
        {
            IRfcFunction function = Destination.Repository.CreateFunction(SAPPurchaseOrder.SAP_PO_FUNC_GETDETAIL);
            function.SetValue(SAPPurchaseOrder.SAP_PO_PARAM_PURCHASEORDER, purchaseOrderNumber);
            function.SetValue(SAPPurchaseOrder.SAP_PO_PARAM_ACCOUNT_ASSIGNMENT, "X");
            function.InvokeAndThrowOnAnyException(Destination);

            IEnumerable<IRfcStructure> purchaseOrderItems = function.GetTable(SAPPurchaseOrder.SAP_PO_PARAM_POITEM);

            if (purchaseOrderItems == null || !purchaseOrderItems.Any())
            {
                throw new InvalidOperationException(string.Format("No purchase order items found for purchase order number \"{0}\"", purchaseOrderNumber));
            }
            return purchaseOrderItems;
        }

        string ValidatePOLineReferenceNumber(IRfcStructure lineItem, IEnumerable<IRfcStructure> purchaseOrderItems)
        {
            if (lineItem == null)
            {
                throw new ArgumentNullException("lineItem");
            }

            if (purchaseOrderItems == null)
            {
                throw new ArgumentNullException("purchaseOrderItems");
            }

            string purchaseOrderIdentifier = lineItem.GetString(SAP_FIELD_LINE_ITEM_PO_ITEM);

            // Item4 is purchase order lines
            IRfcStructure purchaseOrderItem = purchaseOrderItems.FirstOrDefault(x => purchaseOrderIdentifier.TrimStart('0') == x.GetString(SAPPurchaseOrder.SAP_PO_FIELD_POITEM_PO_ITEM).TrimStart('0'));

            if (purchaseOrderItem == null)
            {
                throw new NullReferenceException(string.Format("Purchase order item is not found for \"{0}\"", purchaseOrderIdentifier));
            }

            string polineReferenceNumber = purchaseOrderItem.GetString(SAPPurchaseOrder.SAP_PO_FIELD_POITEM_TRACKINGNO);

            if (string.IsNullOrWhiteSpace(polineReferenceNumber))
            {
                throw new InvalidOperationException(string.Format("{0} is null or whitespace on the found purchase porder item corresponding to \"{1}\"",
                    SAPPurchaseOrder.SAP_PO_FIELD_POITEM_TRACKINGNO,
                    purchaseOrderIdentifier));
            }

            return polineReferenceNumber;
        }

        Tuple<string, string, string, IEnumerable<IRfcStructure>> InitialiseGoodsReceiptData()
        {
            string objectKey = documentHeader.GetString(SAP_FIELD_HEADER_OBJ_KEY);

            string goodsReceiptNumber = objectKey.Substring(objectKey.Length - 4);

            string purchaseOrderNumber, vendorNumber;
            ValidateGoodsReceiptData(objectKey, out purchaseOrderNumber, out vendorNumber);

            IEnumerable<IRfcStructure> purchaseOrderItems = ValidatePurchaseOrderItems(purchaseOrderNumber);

            return new Tuple<string, string, string, IEnumerable<IRfcStructure>>(goodsReceiptNumber, purchaseOrderNumber, vendorNumber, purchaseOrderItems);
        }

        #endregion
    }

    public class ActualExpenseJournalBuilderFactory
    {
        #region Fields

        readonly RfcDestination destination;
        readonly ISAPConfiguration configuration;

        #endregion

        #region Constructor

        public ActualExpenseJournalBuilderFactory(RfcDestination destination, ISAPConfiguration configuration)
        {
            this.destination = destination;
            this.configuration = configuration;
        }

        #endregion

        #region Public members

        public IActualExpenseJournalBuilder CreateActualExpenseJournalBuilder(string documentType, string documentNumber, string controlArea)
        {
            IRfcFunction findDocument = CreateFindDocumentFunction(documentNumber, controlArea);
            findDocument.InvokeAndThrowOnAnyException(destination);

            IRfcTable lineItems = findDocument.GetTable(ActualExpenseJournalBuilder.SAP_FIELD_LINE_ITEMS);

            if (!lineItems.Any())
            {
                throw new InvalidOperationException(string.Format("No rows found in {0}", ActualExpenseJournalBuilder.SAP_FIELD_LINE_ITEMS));
            }

            IEnumerable<IRfcStructure> documentHeaders = findDocument.GetTable(ActualExpenseJournalBuilder.SAP_FIELD_HEADER);

            if (!documentHeaders.Any())
            {
                throw new InvalidOperationException(string.Format("No rows found in {0}", ActualExpenseJournalBuilder.SAP_FIELD_HEADER));
            }

            // make sure that no journals are replicated for parked documents
            string documentStatus = documentHeaders.First().GetString(ActualExpenseJournalBuilder.SAP_FIELD_HEADER_DOC_STATUS);

            if (string.Equals(documentStatus, configuration.Setting<string>(SAPConfiguration.CO_DOCUMENT_PARKED_DOCUMENT_INDICATOR_VALUE), StringComparison.InvariantCultureIgnoreCase))
            {
                return new NullActualExpenseJournalBuilder();
            }

            string objectType = documentHeaders.First().GetString(ActualExpenseJournalBuilder.SAP_FIELD_HEADER_OBJ_TYPE);

            if (string.Equals(objectType, configuration.Setting<string>(SAPConfiguration.OASIS_OBJ_TYPE), StringComparison.InvariantCultureIgnoreCase))
            {
                return new AdjustmentActualExpenseJournalBuilder(destination, configuration, documentType, documentHeaders.First(), lineItems);
            }

            if (string.Equals(objectType, ActualExpenseJournalBuilder.SAP_JOURNALTYPE_GOODSRECEIPT, StringComparison.InvariantCultureIgnoreCase))
            {
                return new GoodsReceiptActualExpenseJournalBuilder(destination, configuration, documentType, documentHeaders.First(), lineItems);
            }

            return new ActualExpenseJournalBuilder(destination, configuration, documentType, documentHeaders.First(), lineItems);
        }

        #endregion

        #region Private members

        IRfcFunction CreateFindDocumentFunction(string documentNumber, string controlArea)
        {
            if (string.IsNullOrWhiteSpace(documentNumber))
            {
                throw new ArgumentException("documentNumber is null or whitesapce");
            }

            IRfcFunction function = destination.Repository.CreateFunction(ActualExpenseJournalBuilder.SAP_FUNC_DOCUMENT_FIND);
            function.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_RETURN_ITEMS, "X");
            function.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_RETURN_COSTS, "X");
            function.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_RETURN_QTY, "X");

            IRfcStructure documentStructure = function.GetStructure(ActualExpenseJournalBuilder.SAP_FIELD_DOCUMENT);
            documentStructure.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_DOCUMENT_DOC_NO, documentNumber);
            if (!string.IsNullOrEmpty(controlArea))
            {
                documentStructure.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_DOCUMENT_CO_AREA, controlArea);
            }

            return function;
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPExchangeRate.cs
3195
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public class SAPExchangeRate : SAPObject
    {
        #regionFields

        const string SAP_FUNC_GETEXCHANGERATES = "BAPI_EXCHRATE_GETCURRENTRATES";
        const string SAP_FUNC_IMPORT_DATE = "DATE";
        const string SAP_FUNC_IMPORT_FROM_CURR_RANGE = "FROM_CURR_RANGE";
        const string SAP_FUNC_EXPORT_RETURNTABLE = "RETURN";
        const string SAP_FUNC_EXPORT_EXCHRATELIST = "EXCH_RATE_LIST";

        const string SAP_FUNC_IMPORT_PARAM_SIGN = "SIGN";
        const string SAP_FUNC_IMPORT_PARAM_OPTION = "OPTION";
        const string SAP_FUNC_IMPORT_PARAM_LOW = "LOW";

        const string SAP_FUNC_IMPORT_VALUE_SIGN = "I";
        const string SAP_FUNC_IMPORT_VALUE_OPTION = "EQ";
        const string SAP_FUNC_IMPORT_VALUE_LOW = "AUD";

        const string SAP_FUNC_EXPORT_PARAM_CURRENCYCODE = "TO_CURRNCY";
        const string SAP_FUNC_EXPORT_PARAM_EFFECTIVEDATE = "VALID_FROM";
        const string SAP_FUNC_EXPORT_PARAM_EXCHANGERATE = "EXCH_RATE";
        const string SAP_FUNC_EXPORT_PARAM_FROMFACTOR = "FROM_FACTOR";
        const string SAP_FUNC_EXPORT_PARAM_TOFACTOR = "TO_FACTOR";

        #endregionFields

        #region Constructors

        public SAPExchangeRate(RfcDestination destination, ISAPConfiguration configuration)
            : base(destination, configuration)
        {
        }

        #endregion

        #regionPublicMethods

        public List<ExchangeRate> GetExchangeRatesForDate(DateTime date)
        {
            // Call the SAP function that returns all exchange rates
            IRfcFunction function = Destination.Repository.CreateFunction(SAP_FUNC_GETEXCHANGERATES);
            function.SetValue(SAP_FUNC_IMPORT_DATE, date.Date);

            IRfcTable currencyRange = function.GetTable(SAP_FUNC_IMPORT_FROM_CURR_RANGE);
            currencyRange.Append();
            currencyRange.SetValue(SAP_FUNC_IMPORT_PARAM_SIGN, SAP_FUNC_IMPORT_VALUE_SIGN);
            currencyRange.SetValue(SAP_FUNC_IMPORT_PARAM_OPTION, SAP_FUNC_IMPORT_VALUE_OPTION);
            currencyRange.SetValue(SAP_FUNC_IMPORT_PARAM_LOW, SAP_FUNC_IMPORT_VALUE_LOW);

            function.InvokeAndThrowOnAnyException(Destination);

            return function.GetTable(SAP_FUNC_EXPORT_EXCHRATELIST)
                    .Select(x => new ExchangeRate
                    {
                        CurrencyCode = x.GetString(SAP_FUNC_EXPORT_PARAM_CURRENCYCODE),
                        EffectiveDate = x.GetValue(SAP_FUNC_EXPORT_PARAM_EFFECTIVEDATE).As<DateTime>(),
                        Value = x.GetDecimal(SAP_FUNC_EXPORT_PARAM_EXCHANGERATE) * x.GetInt(SAP_FUNC_EXPORT_PARAM_TOFACTOR) / x.GetInt(SAP_FUNC_EXPORT_PARAM_FROMFACTOR)
                    }).ToList();
        }

        public List<ExchangeRate> GetExchangeRates()
        {
            return GetExchangeRatesForDate(DateTime.Now);
        }

        #endregionPublicMethods
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPGLAccounts.cs
3464
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public class SAPGLAccounts : SAPObject
    {
        #regionFields

        #endregionFields

        #region Constructors

        public SAPGLAccounts(RfcDestination destination, ISAPConfiguration configuration)
            : base(destination, configuration)
        {
        }

        #endregion

        #regionPublicMethods

        public SAPGLAccount GetGLAccount(string account)
        {

            // SAP stores all GL numbers as char(10), even though the SAP interface hides any leading zeros from users.
            // e.g. a GL account with number 20050 (*displayed* in SAP) is actually *stored* in SAP as 0000020050 (note the zeros "padding" the number)
            if (account.Length != 10)
            {
                throw new InvalidOperationException(string.Format("GL Account '{0}' is invalid: it must be 10 characters in length.", account));
            }

            IRfcFunction function = Destination.Repository.CreateFunction("Z_BAPI_GL_ACC_GETDETAIL");
            function.SetValue(SAPConfiguration.SAP_GL_ACCOUNT, account);
            function.SetValue(SAPConfiguration.SAP_GL_COMPANYCODE, "2000");
            function.InvokeAndThrowOnAnyException(Destination);

            IRfcStructure accountDetail = function.GetStructure("ACCOUNT_DETAIL");
            IRfcTable fieldStatus = function.GetTable("FIELDSTATUS");

            //If its not company code 2000 or its not a P/L GL account then it is not required in AidWorks
            if (accountDetail.GetString("COMP_CODE") != "2000" || !SAPExtensions.IsTrue(accountDetail.GetString("PL_ACCOUNT")))
            {
                return null;
            }

            if (fieldStatus.RowCount == 0)
            {
                throw new InvalidOperationException(string.Format("No rows found in FIELDSTATUS. GL: {0}", account));
            }

            // convert these loose SAP structures into a more solid object (SAPGLAccount)
            return new SAPGLAccount
            {
                Account = accountDetail.GetString("GL_ACCOUNT"),
                ShortText = accountDetail.GetString("SHORT_TEXT"),
                LongText = accountDetail.GetString("LONG_TEXT"),
                CompanyCode = accountDetail.GetString("COMP_CODE"),
                PostingBlock = !SAPExtensions.IsTrue(accountDetail.GetString("POSTING_PERMITTED")),
                DeletionFlag = false,
                Currency = accountDetail.GetString("ACCT_CURR"),
                TaxCategory = accountDetail.GetString("TAX_CODE"),
                PersonnelNumberRequired = (fieldStatus.Cast<IRfcStructure>().Where(x => x.GetString("FIELD_NAME") == "BSEG-PERNR").Select(x => x.GetString("FIELD_STATUS")).FirstOrDefault() ?? string.Empty) == "R" ? true : false,
                WBSElementAllowedForInput = (fieldStatus.Cast<IRfcStructure>().Where(x => x.GetString("FIELD_NAME") == "BSEG-PROJK").Select(x => x.GetString("FIELD_STATUS")).FirstOrDefault() ?? string.Empty) == "S" ? false : true,
                GroupName = accountDetail.GetString("GROUPNAME"),
                GroupNameDescription = accountDetail.GetString("GROUPNAME_DESC")
            };
        }

        #endregion

    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPGoodsReceipt.cs
6249
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public class SAPGoodsReceipt : SAPObject
    {
        #region Constructors

        public SAPGoodsReceipt(RfcDestination destination, ISAPConfiguration Configuration)
            : base(destination, Configuration)
        {
        }

        #endregion

        public ReplicateGoodsReceiptNumber CreateGoodsReceipt(GoodsReceiptInfo goodsReceiptInfo)
        {
            RfcSessionManager.BeginContext(Destination);

            string purchaseOrderNumber = goodsReceiptInfo.PurchaseOrderNo.PadLeft(10, '0');

            try
            {
                Destination.Initialise();

                IRfcFunction function = Destination.Repository.CreateFunction("BAPI_GOODSMVT_CREATE");

                IRfcStructure header = function.GetStructure("GOODSMVT_HEADER");
                header.SetValue("PSTNG_DATE", goodsReceiptInfo.PostingDate);

                // when created by AidWorks, goodsReceiptInfo will have exactly one item
                if (goodsReceiptInfo.GoodsReceiptType == GoodsReceiptType.AidWorks
                    && goodsReceiptInfo.Items.Length > 0)
                {
                    header.SetValue("REF_DOC_NO", goodsReceiptInfo.Items[0].PaymentEventCertificationID);
                }

                IRfcStructure code = function.GetStructure("GOODSMVT_CODE");
                code.SetValue("GM_CODE", "01");

                foreach (GoodsReceiptItemInfo goodsReceiptItem in goodsReceiptInfo.Items)
                {
                    // the PO line could have either a payment event number for AidWorks purchase orders OR an agreement number for OASIS purchase orders
                    IRfcStructure purchaseOrderItem = new SAPPurchaseOrder(Destination, Configuration).GetPurchaseOrderItem(purchaseOrderNumber,
                            goodsReceiptInfo.GoodsReceiptType == GoodsReceiptType.AidWorks ?
                            goodsReceiptItem.PaymentEventNumber : goodsReceiptItem.AgreementNumber);

                    string purchaseOrderItemNumber = purchaseOrderItem.GetString("PO_ITEM");

                    IRfcTable item = function.GetTable("GOODSMVT_ITEM");
                    item.Append();
                    item.SetValue("MOVE_TYPE", "101");
                    item.SetValue("ENTRY_UOM", "EA");
                    item.SetValue("MVT_IND", "B");
                    item.SetValue("PO_NUMBER", purchaseOrderNumber);
                    item.SetValue("PO_ITEM", purchaseOrderItemNumber);
                    item.SetValue("ENTRY_QNT", goodsReceiptItem.Amount);
                }

                function.InvokeAndThrowOnAnyException(Destination);

                IRfcStructure returnHeader = function.GetStructure("GOODSMVT_HEADRET");
                string materialDocument = returnHeader.GetString("MAT_DOC");

                Destination.PreCommitAndCommit();

                return new ReplicateGoodsReceiptNumber { GoodsReceiptNumber = materialDocument, Items = goodsReceiptInfo.Items };
            }
            catch (Exception)
            {
                Destination.Rollback();
                throw;
            }
            finally
            {
                RfcSessionManager.EndContext(Destination);
            }

        }

        public PurchaseOrderLines GetGoodsReceiptAccountAssignmentAmounts(AccountAssignmentAmountRequest request)
        {
            IRfcFunction getGoodsReceipt = Destination.Repository.CreateFunction(ActualExpenseJournalBuilder.SAP_FUNC_GOODS_RECEIPT);
            IRfcFunction getPurchaseOrder = Destination.Repository.CreateFunction(SAPPurchaseOrder.SAP_PO_FUNC_GETDETAIL);
            List<PurchaseOrderLineInfo> poLines = new List<PurchaseOrderLineInfo>();

            getGoodsReceipt.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_HEADER_MATERIALDOCUMENT, request.GoodsReceiptNumber);
            getGoodsReceipt.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_HEADER_MATDOCUMENTYEAR, request.Year);
            getGoodsReceipt.InvokeAndThrowOnAnyException(Destination);

            List<IRfcStructure> goodsReceiptItems = getGoodsReceipt.GetTable(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM).ToList();

            getPurchaseOrder.SetValue(SAPPurchaseOrder.SAP_PO_PARAM_PURCHASEORDER, request.PurchaseOrderNumber);
            getPurchaseOrder.SetValue(SAPPurchaseOrder.SAP_PO_PARAM_ACCOUNT_ASSIGNMENT, "X");
            getPurchaseOrder.InvokeAndThrowOnAnyException(Destination);

            List<IRfcStructure> existingPOItems = getPurchaseOrder.GetTable(SAPPurchaseOrder.SAP_PO_PARAM_POITEM).ToList();

            foreach (IRfcStructure poLine in existingPOItems)
            {
                PurchaseOrderLineInfo line = new PurchaseOrderLineInfo();
                List<AccountAssignmentInfo> accAssignments = new List<AccountAssignmentInfo>();
                List<IRfcStructure> poLineGoodsReceiptItems = goodsReceiptItems.Where(x => x.GetString(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM_PO_ITEM) == poLine.GetString(SAPPurchaseOrder.SAP_PO_FIELD_POITEM_PO_ITEM)).ToList();

                foreach (IRfcStructure poLineGoodsReceiptItem in poLineGoodsReceiptItems)
                {
                    AccountAssignmentInfo ass = new AccountAssignmentInfo();
                    ass.WBSNumber = poLineGoodsReceiptItem.GetString(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM_WBS_ELEM);
                    ass.CurrencyAmount = decimal.Parse(poLineGoodsReceiptItem.GetString(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM_ENTRY_QNT));
                    accAssignments.Add(ass);
                }

                line.Number = poLine.GetString(SAPPurchaseOrder.SAP_PO_FIELD_POITEM_TRACKINGNO);
                line.AccountAssignments = accAssignments.ToArray();

                poLines.Add(line);
            }

            return new PurchaseOrderLines { Lines = poLines.ToArray() };
        }

    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPJournal.cs
35647
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP

{
    public class SAPJournal : SAPObject
    {
		#regionFields

        // purchase order BAPI functions
        const string SAP_FUNC_INITIALIZATION = "BAPI_PS_INITIALIZATION";
        const string SAP_PO_FUNC_CHANGE = "BAPI_PO_CHANGE";
        const string SAP_PO_FUNC_CREATE = "BAPI_PO_CREATE1";
        const string SAP_PO_FUNC_GETDETAIL = "BAPI_PO_GETDETAIL1";
        const string SAP_PO_FUNC_RELEASE = "BAPI_PO_RELEASE";
        const string SAP_PO_FUNC_RETURNTABLE = "RETURN";
        const string SAP_PO_FUNC_PRECOMMIT = "BAPI_PS_PRECOMMIT";
                
        // release constants
        const string SAP_PO_FUNC_RELEASE_RETURN_CODE = "CODE";
        const string SAP_PO_FUNC_RELEASE_RETURN_ERRORCODE_INVALIDRELEASECODE = "ME104";
        const string SAP_PO_FUNC_RELEASE_RETURN_ERRORCODE_INVALIDPO = "06019";
        
        // account item BAPI fields
        const string SAP_PO_FIELD_POACCOUNT_PO_ITEM = "PO_ITEM";
        const string SAP_PO_FIELD_POACCOUNT_PO_ITEMX = "PO_ITEMX";
        const string SAP_PO_FIELD_POACCOUNT_QUANTITY = "QUANTITY";
        const string SAP_PO_FIELD_POACCOUNT_SERIAL_NO = "SERIAL_NO";
        const string SAP_PO_FIELD_POACCOUNT_WBS_ELEMENT = "WBS_ELEMENT";
        const string SAP_PO_FIELD_POACCOUNT_DELETE_IND = "DELETE_IND";
        const string SAP_PO_FIELD_POACCOUNT_GL_ACCOUNT = "GL_ACCOUNT";
        const string SAP_PO_FIELD_POACCOUNT_NET_VALUE = "NET_VALUE";
        
        // purchase order header BAPI fields
        const string SAP_PO_FIELD_POHEADER_CURRENCY = "CURRENCY";
        const string SAP_PO_FIELD_POHEADER_DELETE_IND = "DELETE_IND";
        const string SAP_PO_FIELD_POHEADER_VENDOR = "VENDOR";
        const string SAP_PO_FIELD_POHEADER_REF_1 = "REF_1";
        
        // PO text header
        const string SAP_PO_FIELD_POTEXTHEADER_PO_NUMBER = "PO_NUMBER";
        const string SAP_PO_FIELD_POTEXTHEADER_TEXT_ID = "TEXT_ID";
        const string SAP_PO_FIELD_POTEXTHEADER_TEXT_LINE = "TEXT_LINE";
        const string SAP_PO_FIELD_POTEXTHEADER_TEXT_FORM = "TEXT_FORM";

        // purchase order line item BAPI fields
        const string SAP_PO_FIELD_POITEM_PO_ITEMX = "PO_ITEMX";
        const string SAP_PO_FIELD_POITEM_DELETE_IND = "DELETE_IND";
        const string SAP_PO_FIELD_POITEM_PO_ITEM = "PO_ITEM";
        const string SAP_PO_FIELD_POITEM_PO_UNIT = "PO_UNIT";
        const string SAP_PO_FIELD_POITEM_QUANTITY = "QUANTITY";
        const string SAP_PO_FIELD_POITEM_SHORT_TEXT = "SHORT_TEXT";
        const string SAP_PO_FIELD_POITEM_TRACKINGNO = "TRACKINGNO";
        const string SAP_PO_FIELD_POITEM_DISTR_PERC = "DISTR_PERC";

        // purchase order BAPI params
        const string SAP_PO_PARAM_ACCOUNT_ASSIGNMENT = "ACCOUNT_ASSIGNMENT";
        const string SAP_PO_PARAM_OUT_EXPPURCHASEORDER = "EXPPURCHASEORDER";
        const string SAP_PO_PARAM_POACCOUNT = "POACCOUNT";
        const string SAP_PO_PARAM_POACCOUNTX = "POACCOUNTX";
        const string SAP_PO_PARAM_POHEADER = "POHEADER";
        const string SAP_PO_PARAM_POHEADERX = "POHEADERX";
        const string SAP_PO_PARAM_POTEXTHEADER = "POTEXTHEADER";
        const string SAP_PO_PARAM_POTEXTITEM = "POTEXTITEM";
        const string SAP_PO_PARAM_POITEM = "POITEM";
        const string SAP_PO_PARAM_POITEMX = "POITEMX";
        const string SAP_PO_PARAM_PURCHASEORDER = "PURCHASEORDER";
        const string SAP_PO_PARAM_NO_COMMIT = "NO_COMMIT";

		#endregionFields

        #region Properties

        #endregion
        
        #region Constructors

        public SAPJournal(RfcDestination destination, ISAPConfiguration configuration)
            : base(destination, configuration)
        {
        }

        #endregion

        #regionPublicMethods

        public AccrualJournalResponseInfo CreateAccrualJournal(AccrualJournalInfo accrualJournalInfo)
        {
            string documentNumber;
            string reversalDocumentNumber;
            if (GetAccountDocumentNumber(accrualJournalInfo.ReferenceNumber,
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_TYPE),
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_SYS),
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_REC_TYPE),
                                        out documentNumber,
                                        out reversalDocumentNumber))
            {
                throw new ApplicationException(string.Format("Accrual Journal with reference number {0} already exists. Document number is {1}.", accrualJournalInfo.ReferenceNumber, documentNumber));
            }

            RfcSessionManager.BeginContext(Destination);

            try
            {
                PostJournal(accrualJournalInfo, false, false, accrualJournalInfo.Date);

                PostJournal(accrualJournalInfo, true, false, accrualJournalInfo.ReversalDate);

                //COMMIT
                Destination.Commit();
            }
            catch (Exception)
            {
                Destination.Rollback();

                throw;
            }
            finally
            {
                RfcSessionManager.EndContext(Destination);
            }

            return CreateAccrualJournalResponseInfo(accrualJournalInfo);
        }

        public ReplicateAdjustmentJournal CreateOASISAdjustmentJournal(CreateAdjustmentJournal createAdjustmentJournal)
        {
            string documentNumber;
            string reversalDocumentNumber;

            if (GetAccountDocumentNumber(createAdjustmentJournal.AdjustmentJournalInfo.ReferenceNumber,
                                        Configuration.Setting<string>(SAPConfiguration.OASIS_OBJ_TYPE),
                                        Configuration.Setting<string>(SAPConfiguration.OASIS_OBJ_SYS),
                                        Configuration.Setting<string>(SAPConfiguration.OASIS_REC_TYPE),
                                        out documentNumber,
                                        out reversalDocumentNumber))
            {
                throw new ApplicationException(string.Format("OASIS Journal with reference number {0} already exists. Document number is {1}.", createAdjustmentJournal.AdjustmentJournalInfo.ReferenceNumber, documentNumber));
            }

            RfcSessionManager.BeginContext(Destination);

            try
            {
                // need to get the actual goods receipt amounts for each agreement and appropriation source
                // this gets used to adjust the journal amounts.  The journal amounts are originally set to the PO line account assignment full amount.
                // The difference between the PO line account assignment and what is goods receipted is the amount that needs to be journalled.
                PurchaseOrderLines goodsReceiptAmounts = new SAPGoodsReceipt(Destination, Configuration).GetGoodsReceiptAccountAssignmentAmounts(new AccountAssignmentAmountRequest { GoodsReceiptNumber = createAdjustmentJournal.GoodsReceiptNumber, Year = createAdjustmentJournal.GoodsReceiptInfo.PostingDate.Year.ToString(), PurchaseOrderNumber = createAdjustmentJournal.GoodsReceiptInfo.PurchaseOrderNo });

                foreach (PurchaseOrderLineInfo goodsReceiptLine in goodsReceiptAmounts.Lines)
                {
                    foreach (AccountAssignmentInfo ass in goodsReceiptLine.AccountAssignments)
                    {
                        string text = UnformatWbsElement(ass.WBSNumber);

                        OASISAdjustmenJournalLineInfo journalItemToReduce = createAdjustmentJournal.AdjustmentJournalInfo.Items.FirstOrDefault(x =>
                                x.AgreementNumber == goodsReceiptLine.Number &&
                                string.Equals(UnformatWbsElement(x.SAPWBSElementCode), text, StringComparison.InvariantCultureIgnoreCase) &&
                                x.ReduceAmountByReceiptedAmount);

                        if (journalItemToReduce != null)
                            journalItemToReduce.Amount -= ass.CurrencyAmount;
                    }
                }

                // goods receipt amounts are in 3 decimal places.  Journals have to be 2 decimal places (except for VUV which should be 0 decimal places).  So the strategy is:
                // 1. round everything
                // 2. if the journals don't add to $0 then the rounding has done this, in this situation we need to
                //    subtract the difference from one of the journal items. Presently I'm just picking the first one.
                int placesToRound = GetDecimalPlacesForCurrency(createAdjustmentJournal.AdjustmentJournalInfo.CurrencyCode);
                createAdjustmentJournal.AdjustmentJournalInfo.Items.ToList().ForEach(x => x.Amount = Math.Round(x.Amount, placesToRound));

                if (createAdjustmentJournal.AdjustmentJournalInfo.Items.Sum(x => x.Amount) != 0)
                {
                    decimal difference = createAdjustmentJournal.AdjustmentJournalInfo.Items.Sum(x => x.Amount);
                    OASISAdjustmenJournalLineInfo journalItemToAdjust = createAdjustmentJournal.AdjustmentJournalInfo.Items.FirstOrDefault();
                    journalItemToAdjust.Amount -= difference;

                    if (createAdjustmentJournal.AdjustmentJournalInfo.Items.Sum(x => x.Amount) != 0)
                        throw new ApplicationException("Expected journal amounts to balance to $0");
                }

                PostJournal(createAdjustmentJournal.AdjustmentJournalInfo, createAdjustmentJournal.AdjustmentJournalInfo.Date);

                //COMMIT
                Destination.Commit();
            }
            catch (Exception)
            {
                Destination.Rollback();

                throw;
            }
            finally
            {
                RfcSessionManager.EndContext(Destination);
            }

            return CreateOASISAdjustmentJournalResponseInfo(createAdjustmentJournal.AdjustmentJournalInfo);
        }

        public AccrualJournalResponseInfo CreatePrePaymentJournal(PrePaymentJournalInfo prePaymentJournalInfo)
        {
            string documentNumber;
            string reversalDocumentNumber;
            if (GetAccountDocumentNumber(prePaymentJournalInfo.ReferenceNumber,
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_TYPE),
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_SYS),
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_REC_TYPE),
                                        out documentNumber,
                                        out reversalDocumentNumber))
            {
                throw new ApplicationException(string.Format("PrePayment Journal with reference number {0} already exists. Document number is {1}.", prePaymentJournalInfo.ReferenceNumber, documentNumber));
            }

            RfcSessionManager.BeginContext(Destination);

            try
            {
                PostJournal(prePaymentJournalInfo, false, true, prePaymentJournalInfo.Date);

                //COMMIT
                Destination.Commit();
            }
            catch (Exception)
            {
                Destination.Rollback();

                throw;
            }
            finally
            {
                RfcSessionManager.EndContext(Destination);
            }

            return CreateAccrualJournalResponseInfo(prePaymentJournalInfo, true);
        }

        public void PostJournal(JournalInfo journalInfo, bool reversal, bool prepayment, DateTime transactionDate, out string errorMessage)
        {
            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_ACC_GL_POSTING_POST");

            // Set import parameter DOCUMENTHEADER of type structure
            IRfcStructure documentHeader = function.GetStructure("DOCUMENTHEADER");

            // ++++++ GREG - NEED TO CHANGE THIS
            documentHeader.SetValue("OBJ_TYPE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_TYPE)); //"ZAWAC"
            documentHeader.SetValue("OBJ_KEY", journalInfo.ReferenceNumber);

            // ++++++ GREG - NEED TO CHANGE THIS
            documentHeader.SetValue("OBJ_SYS", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_SYS)); //"AIDWORKS"
            documentHeader.SetValue("USERNAME", Destination.User);

            documentHeader.SetValue("HEADER_TXT", string.Format("AID Accrual {0}", transactionDate.ToString("MM/yyyy")));

            // ++++++ GREG - NEED TO CHANGE THIS
            documentHeader.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_COMPANY_CODE)); //"2000"
            documentHeader.SetValue("FISC_YEAR", transactionDate.GetFinancialYear());
            documentHeader.SetValue("DOC_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("PSTNG_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("TRANS_DATE", transactionDate.ToString("yyyyMMdd"));

            // ++++++ GREG - NEED TO CHANGE THIS
            documentHeader.SetValue("DOC_TYPE", reversal ? Configuration.Setting<string>(SAPConfiguration.ACCRUAL_DOC_TYPE_AR) : Configuration.Setting<string>(SAPConfiguration.ACCRUAL_DOC_TYPE_AC)); //"AR" : "AC"
            
            documentHeader.SetValue("REF_DOC_NO", journalInfo.ReferenceNumber);

            //Set table parameter ACCOUNTGL and CURRENCYAMOUNT
            IRfcTable accountGl = function.GetTable("ACCOUNTGL");
            IRfcTable currencyAmount = function.GetTable("CURRENCYAMOUNT");
            IRfcTable extension = function.GetTable("EXTENSION1");

            int itemNoCounter = 1;
            foreach (AccrualJournalItemInfo accrualItem in journalInfo.Items)
            {
                foreach (PaymentEventVersionAppropriationSourceInfo appropriationItem in accrualItem.AppropriationItems)
                {
                    accountGl.Append();
                    accountGl.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
                    //accountGl.CurrentRow.SetValue("GL_ACCOUNT", accrualItem.SAPGeneralLedgerAccountCode);

                    // ++++++ GREG - NEED TO CHANGE THIS
                    accountGl.CurrentRow.SetValue("GL_ACCOUNT", prepayment ? Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PREPAYMENT) : Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PROGRESSIVE));

                    // ++++++ GREG - NEED TO CHANGE THIS
                    accountGl.CurrentRow.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_COMPANY_CODE)); //"2000"

                    // ++++++ GREG - NEED TO CHANGE THIS
                    accountGl.CurrentRow.SetValue("ALLOC_NMBR", accrualItem.PaymentEventNumber);

                    // ++++++ GREG - NEED TO CHANGE THIS
                    accountGl.CurrentRow.SetValue("ITEM_TEXT", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_ITEM_TEXT)); //"AidWorks Monthly Accrual"

                    accountGl.CurrentRow.SetValue("WBS_ELEMENT", appropriationItem.SAPWBSElementCode);

                    //if (prepayment)
                    //{
                    //    decimal balance;
                    //    GetBalance(SAPExtensions.GetFinancialYear(transactionDate), Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PREPAYMENT), appropriationItem.SAPWBSElementCode, accrualItem.PaymentEventNumber, out balance);
                    //    appropriationItem.Amount = appropriationItem.Amount - balance;
                    //}

                    currencyAmount.Append();
                    currencyAmount.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
                    
                    // ++++++ GREG - NEED TO CHANGE THIS
                    currencyAmount.CurrentRow.SetValue("CURR_TYPE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_CURR_TYPE)); //"00"
                    
                    currencyAmount.CurrentRow.SetValue("CURRENCY", journalInfo.CurrencyCode);
                    currencyAmount.CurrentRow.SetValue("AMT_DOCCUR", (reversal ? -1 : 1) * appropriationItem.Amount);

                    extension.Append();
                    extension.CurrentRow.SetValue("FIELD1", string.Format("{0}AZ", itemNoCounter.ToString("D10").PadRight(18, ' ')));

                    itemNoCounter++;
                }
            }

            accountGl.Append();
            accountGl.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);

            // ++++++ GREG - NEED TO CHANGE THIS
            accountGl.CurrentRow.SetValue("GL_ACCOUNT", prepayment ? Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PREPAYMENT) : Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PROGRESSIVE));

            // ++++++ GREG - NEED TO CHANGE THIS
            accountGl.CurrentRow.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_COMPANY_CODE)); //"2000"
            
            accountGl.CurrentRow.SetValue("ALLOC_NMBR", journalInfo.ReferenceNumber);

            // ++++++ GREG - NEED TO CHANGE THIS
            accountGl.CurrentRow.SetValue("ITEM_TEXT", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_ITEM_TEXT)); //"AidWorks Monthly Accrual"

            currencyAmount.Append();
            currencyAmount.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
            
            // ++++++ GREG - NEED TO CHANGE THIS
            currencyAmount.CurrentRow.SetValue("CURR_TYPE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_CURR_TYPE)); //"00"

            currencyAmount.CurrentRow.SetValue("CURRENCY", journalInfo.CurrencyCode);
            currencyAmount.CurrentRow.SetValue("AMT_DOCCUR", (reversal ? 1 : -1) * journalInfo.Items.Cast<AccrualJournalItemInfo>().Select(x => x.AppropriationItems.Cast<PaymentEventVersionAppropriationSourceInfo>().Sum(y => y.Amount)).Sum());

            extension.Append();
            extension.CurrentRow.SetValue("FIELD1", itemNoCounter.ToString("D10"));

            function.Invoke(Destination);

            //RETURN table            
            if (function.FindReturnMessages().HasRfcError(out errorMessage))
            {
                throw new ApplicationException(errorMessage);
            }
        }

		#endregionPublicMethods

        #region Private Methods

        AccrualJournalResponseInfo CreateAccrualJournalResponseInfo(JournalInfo journalInfo, bool? prepayment = false)
        {
            string documentNumber = null;
            string reversalDocumentNumber = null;

            //Create response
            AccrualJournalResponseInfo responseInfo = new AccrualJournalResponseInfo();

            //Set FMIS TransactionID in the response same as the request
            responseInfo.FMISTransactionID = journalInfo.FMISTransactionID;

            //GET DOCUMENT NUMBER
            if (GetAccountDocumentNumber(journalInfo.ReferenceNumber,
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_TYPE),
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_SYS),
                                        Configuration.Setting<string>(SAPConfiguration.ACCRUAL_REC_TYPE),
                                        out documentNumber,
                                        out reversalDocumentNumber))
            {
                responseInfo.DocumentNumber = documentNumber;
                if (!prepayment.Value)
                {
                    responseInfo.ReversalDocumentNumber = reversalDocumentNumber;
                }
            }
            else
            {
                responseInfo.DocumentNumber = "0000000000"; //Document number to represent either $0 accrual or not found
                if (!prepayment.Value)
                {
                    responseInfo.ReversalDocumentNumber = "0000000000";
                }
            }

            responseInfo.Items = journalInfo.Items.Select(i => new AccrualJournalResponseItemInfo
            {
                AccrualAmount = i.Amount,
                PaymentEventNumber = i.PaymentEventNumber
            }).ToArray();

            return responseInfo;
        }

        ReplicateAdjustmentJournal CreateOASISAdjustmentJournalResponseInfo(OASISAdjustmentJournalInfo journalInfo)
        {
            string documentNumber = null;
            string reversalDocumentNumber = null;
            //Create response
            ReplicateAdjustmentJournal responseInfo = new ReplicateAdjustmentJournal();

            responseInfo.AdjustmentJournalInfo = journalInfo;

            //GET DOCUMENT NUMBER
            if (GetAccountDocumentNumber(journalInfo.ReferenceNumber,
                                        Configuration.Setting<string>(SAPConfiguration.OASIS_OBJ_TYPE),
                                        Configuration.Setting<string>(SAPConfiguration.OASIS_OBJ_SYS),
                                        Configuration.Setting<string>(SAPConfiguration.OASIS_REC_TYPE),
                                        out documentNumber,
                                        out reversalDocumentNumber))
            {
                responseInfo.DocumentNumber = documentNumber;
            }
            else
            {
                responseInfo.DocumentNumber = "0000000000"; //Document number to represent not found
            }

            return responseInfo;
        }

        bool GetAccountDocumentNumber(string objKey, string objType, string objSys, string recType, out string documentNumber, out string reversalDocumentNumber)
        {
            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_ACC_DOCUMENT_RECORD");
            function.SetValue("OBJ_TYPE", objType);
            function.SetValue("OBJ_KEY", objKey);
            function.SetValue("OBJ_SYS", objSys);
            function.InvokeAndThrowOnAnyException(Destination);

            IRfcTable table = function.GetTable("RECEIVER");
#if DEBUG
            table.ToList().ForEach(row => System.Diagnostics.Debug.WriteLine(row.Select(x => string.Format("{0}={1}", x.Metadata.Name, x.GetValue())).Aggregate((x, y) => string.Format("{0}, {1}", x, y))));
#endif
            string docNumber = documentNumber = table.Where(x => string.Equals(x.GetString("REC_TYPE"), recType, StringComparison.InvariantCultureIgnoreCase)) //"BKPF"
                .Select(y => y.GetString("REC_KEY"))
                .OrderBy(z => z)
                .FirstOrDefault();

            reversalDocumentNumber = table
                .Where(x => string.Equals(x.GetString("REC_TYPE"), recType, StringComparison.InvariantCultureIgnoreCase) && !string.Equals(x.GetString("REC_KEY"), docNumber, StringComparison.InvariantCultureIgnoreCase))
                .Select(y => y.GetString("REC_KEY"))
                .OrderBy(z => z)
                .FirstOrDefault();

            return !string.IsNullOrWhiteSpace(documentNumber);
        }

        decimal GetBalance(string companyCode, int fiscalYear, string glAccountCode, string wbsCode, string assignment)
        {
            decimal balance = decimal.Zero;

            IRfcFunction function = Destination.Repository.CreateFunction("Z_GL_ACC_BALANCE");

            // Set import parameters
            function.SetValue("IV_COMPANY_CODE", companyCode);
            function.SetValue("IV_FISCAL_YEAR", fiscalYear);
            function.SetValue("IV_GL_ACCOUNT", glAccountCode);
            function.SetValue("IV_WBS", wbsCode);
            function.SetValue("IV_ASSIGNMENT", assignment);

            try
            {
                function.InvokeAndThrowOnAnyException(Destination);

                balance = function.GetStructure("ES_ACCOUNT_BALANCE").GetDecimal("BALANCE_DOC");
            }
            catch (RfcBaseException e)
            {
                //When no line item is found, BAPI will throw an exception of type as below. Do not re-throw exception in this case, simply return 0
                if (!e.Message.Equals("NO_LINE_ITEMS_FOUND", StringComparison.InvariantCultureIgnoreCase))
                {
                    throw new ApplicationException(string.Format("{0}\n{1}", string.Format("Could not get balance from SAP for FiscalYear: {0}, GLAccountCode: {1}, WBSCode: {2} and Payment Event: {3}", fiscalYear, glAccountCode, wbsCode, assignment), e.Message), e);
                }
            }

            return balance;
        }

        int GetDecimalPlacesForCurrency(string currencyCode)
        {
            string zeroDecimalCurrencies = Class.New<ISAPConfiguration>("SAPConfiguration").GetApplicationSetting("ZeroDecimalPlaceCurrencies");

            if (string.IsNullOrEmpty(zeroDecimalCurrencies))
                return 2;

            return zeroDecimalCurrencies.Split(",".ToCharArray()).ToList().Contains(currencyCode) ?  0 : 2;
        }

        void PostJournal(OASISAdjustmentJournalInfo journalInfo, DateTime transactionDate)
        {
            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_ACC_GL_POSTING_POST");

            // Set import parameter DOCUMENTHEADER of type structure
            IRfcStructure documentHeader = function.GetStructure("DOCUMENTHEADER");
            documentHeader.SetValue("OBJ_TYPE", Configuration.Setting<string>(SAPConfiguration.OASIS_OBJ_TYPE)); //"ZOAI"
            documentHeader.SetValue("OBJ_KEY", journalInfo.ReferenceNumber);
            documentHeader.SetValue("OBJ_SYS", Configuration.Setting<string>(SAPConfiguration.OASIS_OBJ_SYS)); //"OASIS"
            documentHeader.SetValue("USERNAME", Destination.User);

            documentHeader.SetValue("HEADER_TXT", string.Format("OASIS {0} {1}", journalInfo.PaymentBatchNumber, transactionDate.ToString("dd/MM/yyyy")));
            documentHeader.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.OASIS_COMPANY_CODE)); //"2000"
            documentHeader.SetValue("FISC_YEAR", transactionDate.GetFinancialYear());
            documentHeader.SetValue("DOC_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("PSTNG_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("TRANS_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("DOC_TYPE", Configuration.Setting<string>(SAPConfiguration.OASIS_DOC_TYPE)); //"SA"
            documentHeader.SetValue("REF_DOC_NO", journalInfo.ReferenceNumber);

            //Set table parameter ACCOUNTGL and CURRENCYAMOUNT
            IRfcTable accountGl = function.GetTable("ACCOUNTGL");
            IRfcTable currencyAmount = function.GetTable("CURRENCYAMOUNT");
            IRfcTable extension = function.GetTable("EXTENSION1");

            int itemNoCounter = 1;
            foreach (OASISAdjustmenJournalLineInfo journalItem in journalInfo.Items)
            {
                accountGl.Append();
                accountGl.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
                accountGl.CurrentRow.SetValue("GL_ACCOUNT", journalInfo.SAPGeneralLedgerAccountCode);
                accountGl.CurrentRow.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.OASIS_COMPANY_CODE)); //"2000"
                accountGl.CurrentRow.SetValue("ALLOC_NMBR", journalItem.AgreementNumber);
                accountGl.CurrentRow.SetValue("ITEM_TEXT", string.Format("{0} {1}", Configuration.Setting<string>(SAPConfiguration.OASIS_ITEM_TEXT), journalItem.AgreementNumber)); //"OASIS Adjustment <agreement number>"
                accountGl.CurrentRow.SetValue("WBS_ELEMENT", journalItem.SAPWBSElementCode);

                bool isNegative = journalItem.Amount < 0;
                if (isNegative) journalItem.Amount = -1 * journalItem.Amount;

                currencyAmount.Append();
                currencyAmount.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
                currencyAmount.CurrentRow.SetValue("CURR_TYPE", Configuration.Setting<string>(SAPConfiguration.OASIS_CURR_TYPE)); //"00"
                currencyAmount.CurrentRow.SetValue("CURRENCY", journalInfo.CurrencyCode);
                currencyAmount.CurrentRow.SetValue("AMT_DOCCUR", (isNegative ? -1 : 1) * journalItem.Amount);

                extension.Append();
                extension.CurrentRow.SetValue("FIELD1", string.Format("{0}AZ", itemNoCounter.ToString("D10").PadRight(18, ' ')));

                itemNoCounter++;
            }

            function.InvokeAndThrowOnAnyException(Destination);
        }

        private void PostJournal(JournalInfo journalInfo, bool reversal, bool prepayment, DateTime transactionDate)
        {
            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_ACC_GL_POSTING_POST");

            // Set import parameter DOCUMENTHEADER of type structure
            IRfcStructure documentHeader = function.GetStructure("DOCUMENTHEADER");
            documentHeader.SetValue("OBJ_TYPE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_TYPE)); //"ZAWAC"
            documentHeader.SetValue("OBJ_KEY", journalInfo.ReferenceNumber);
            documentHeader.SetValue("OBJ_SYS", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_OBJ_SYS)); //"AIDWORKS"
            documentHeader.SetValue("USERNAME", Destination.User);

            documentHeader.SetValue("HEADER_TXT", reversal ? string.Format("AID Accrual {0}", transactionDate.AddMonths(-1).ToString("MM/yyyy")) : string.Format("AID Accrual {0}", transactionDate.ToString("MM/yyyy")));
            documentHeader.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_COMPANY_CODE)); //"2000"
            documentHeader.SetValue("FISC_YEAR", transactionDate.GetFinancialYear());
            documentHeader.SetValue("DOC_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("PSTNG_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("TRANS_DATE", transactionDate.ToString("yyyyMMdd"));
            documentHeader.SetValue("DOC_TYPE", reversal ? Configuration.Setting<string>(SAPConfiguration.ACCRUAL_DOC_TYPE_AR) : Configuration.Setting<string>(SAPConfiguration.ACCRUAL_DOC_TYPE_AC)); //"AR" : "AC"
            documentHeader.SetValue("REF_DOC_NO", journalInfo.ReferenceNumber);

            //Set table parameter ACCOUNTGL and CURRENCYAMOUNT
            IRfcTable accountGl = function.GetTable("ACCOUNTGL");
            IRfcTable currencyAmount = function.GetTable("CURRENCYAMOUNT");
            IRfcTable extension = function.GetTable("EXTENSION1");

            int itemNoCounter = 1;
            foreach (AccrualJournalItemInfo accrualItem in journalInfo.Items)
            {
                foreach (PaymentEventVersionAppropriationSourceInfo appropriationItem in accrualItem.AppropriationItems)
                {
                    accountGl.Append();
                    accountGl.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
                    accountGl.CurrentRow.SetValue("GL_ACCOUNT", accrualItem.SAPGeneralLedgerAccountCode);
                    accountGl.CurrentRow.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_COMPANY_CODE)); //"2000"
                    accountGl.CurrentRow.SetValue("ALLOC_NMBR", accrualItem.PaymentEventNumber);
                    accountGl.CurrentRow.SetValue("ITEM_TEXT", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_ITEM_TEXT)); //"AidWorks Monthly Accrual"
                    accountGl.CurrentRow.SetValue("WBS_ELEMENT", appropriationItem.SAPWBSElementCode);

                    if (prepayment)
                    {
                        decimal balance = GetBalance(
                            Configuration.Setting<string>(SAPConfiguration.ACCRUAL_COMPANY_CODE) /* 2000 */,
                            transactionDate.GetFinancialYear(),
                            Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PREPAYMENT),
                            appropriationItem.SAPWBSElementCode,
                            accrualItem.PaymentEventNumber);

                        appropriationItem.Amount = appropriationItem.Amount - balance;
                    }

                    currencyAmount.Append();
                    currencyAmount.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
                    currencyAmount.CurrentRow.SetValue("CURR_TYPE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_CURR_TYPE)); //"00"
                    currencyAmount.CurrentRow.SetValue("CURRENCY", journalInfo.CurrencyCode);
                    currencyAmount.CurrentRow.SetValue("AMT_DOCCUR", (reversal ? -1 : 1) * appropriationItem.Amount);

                    extension.Append();
                    extension.CurrentRow.SetValue("FIELD1", string.Format("{0}AZ", itemNoCounter.ToString("D10").PadRight(18, ' ')));

                    itemNoCounter++;
                }
            }

            accountGl.Append();
            accountGl.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
            accountGl.CurrentRow.SetValue("GL_ACCOUNT", prepayment ? Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PREPAYMENT) : Configuration.Setting<string>(SAPConfiguration.ACCRUAL_GL_ACCOUNT_PROGRESSIVE));
            accountGl.CurrentRow.SetValue("COMP_CODE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_COMPANY_CODE)); //"2000"
            accountGl.CurrentRow.SetValue("ALLOC_NMBR", journalInfo.ReferenceNumber);
            accountGl.CurrentRow.SetValue("ITEM_TEXT", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_ITEM_TEXT)); //"AidWorks Monthly Accrual"

            currencyAmount.Append();
            currencyAmount.CurrentRow.SetValue("ITEMNO_ACC", itemNoCounter);
            currencyAmount.CurrentRow.SetValue("CURR_TYPE", Configuration.Setting<string>(SAPConfiguration.ACCRUAL_CURR_TYPE)); //"00"
            currencyAmount.CurrentRow.SetValue("CURRENCY", journalInfo.CurrencyCode);
            currencyAmount.CurrentRow.SetValue("AMT_DOCCUR", (reversal ? 1 : -1) * journalInfo.Items.Cast<AccrualJournalItemInfo>().Select(x => x.AppropriationItems.Cast<PaymentEventVersionAppropriationSourceInfo>().Sum(y => y.Amount)).Sum());

            extension.Append();
            extension.CurrentRow.SetValue("FIELD1", itemNoCounter.ToString("D10"));

            function.InvokeAndThrowOnAnyException(Destination);
        }

        string UnformatWbsElement(string wbsElement)
        {
            return wbsElement.Replace(" ", "").Replace(".", "");
        }

        #endregion
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPObject.cs
865
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Model;
using ServiceBus.Contract;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public abstract class SAPObject
    {
        readonly ISAPConfiguration configuration;
        readonly RfcDestination destination;

        #region Constructors

        public SAPObject(RfcDestination destination, ISAPConfiguration configuration)
        {
            this.destination = destination;
            this.configuration = configuration;
        }

        #endregion

        protected ISAPConfiguration Configuration
        {
            get { return configuration; }
        }

        protected RfcDestination Destination
        {
            get { return destination; }
        }

    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPProgramStructure.cs
9981
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public class SAPProgramStructure : SAPObject
    {
        const int SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_LEVEL_APP_SOURCE_BUDGET = 5;
        const int SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_LEVEL_PROGRAM_FUND = 4;
        const int SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_PROGRAM_FUND_CODE_LENGTH = 3;

        #region Constructors

        public SAPProgramStructure(RfcDestination destination, ISAPConfiguration Configuration)
            : base(destination, Configuration)
        {
        }

        #endregion

        public ProgramFundInfo[] CreateProgramStructure(string program, int approvalYear, string position)
        {
            // only create transaction if the year is this financial year
            if (approvalYear == DateTime.Today.Date.AddMonths(6).Year)
            {
                ProgramStructure programStructure = GetProgramStructure(new ProgramStructureRequest { ProgramName = program, FinancialYear = approvalYear.ToString(), PositionName = position });

                if (programStructure != null)
                {
                    ProgramStructure programStructureBudget = GetProgramStructureBudget(new ProgramStructureRequest { ProgramName = program, FinancialYear = approvalYear.ToString(), PositionName = position });

                    if (programStructureBudget == null)
                    {
                        programStructureBudget = new ProgramStructure { Structure = new Dictionary<string, object>[0] };
                    }

                    return CreateProgramFunds(approvalYear, programStructure.Structure, programStructureBudget.Structure);
                }
                else
                    return null;
            }
            else
                return null;
        }

        /// <summary>
        /// This methods merges two dictionaries of program structure and program structure budget into am array of program fund hierarchies with related
        /// yearly appropriation source budgets.
        /// IMPORTANT: BAPI functions inconsistently return codes (fiedl POSITION). When building the final structure UnMaskPosition is applied before comparing
        /// position values.
        /// </summary>
        /// <param name="programStructureDictionaries"></param>
        /// <param name="programStructureBudgetDictionaries"></param>
        /// <returns></returns>
        ProgramFundInfo[] CreateProgramFunds(int financialYearEnd, Dictionary<string, object>[] programStructureDictionaries, Dictionary<string, object>[] programStructureBudgetDictionaries)
        {
            if (programStructureDictionaries == null)
            {
                throw new ArgumentNullException("programStructure");
            }

            List<ProgramFundInfo> programFunds = new List<ProgramFundInfo>();

            foreach (Dictionary<string, object> programStructureDictionary in programStructureDictionaries)
            {
                switch (programStructureDictionary["LEVEL"].As<int>())
                {
                    case SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_LEVEL_PROGRAM_FUND:
                        programFunds.Add(new ProgramFundInfo
                        {
                            Code = FindRightMostCode(programStructureDictionary["POSITION"].As<string>()),
                            Description = programStructureDictionary["DESCRIPTION"].As<string>(),
                            Position = MaskPosition(programStructureDictionary["POSITION"].As<string>()),
                            AppropriationSources = new AppropriationSourceInfo[0]
                        });
                        break;

                    case SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_LEVEL_APP_SOURCE_BUDGET:
                        AppropriationSourceBudgetInfo[] appropriationSourceBudgets = programStructureBudgetDictionaries
                            .Where(x => x["FISCAL_YEAR"].As<int>() == financialYearEnd && string.Equals(x["POSITION"].ToString().Replace(".", ""), programStructureDictionary["POSITION"].ToString().Replace(".", ""), StringComparison.InvariantCultureIgnoreCase))
                            .Select(x => new AppropriationSourceBudgetInfo { FinancialYear = x["FISCAL_YEAR"].As<int>(), Value = x["VALUE"].As<decimal>() })
                            .ToArray();

                        programFunds.Last().AppropriationSources = programFunds.Last().AppropriationSources.Concat(
                            new AppropriationSourceInfo[]
                            { 
                                new AppropriationSourceInfo
                                {
                                    Code = FindRightMostCode(programStructureDictionary["POSITION"].As<string>()),
                                    Description = programStructureDictionary["DESCRIPTION"].As<string>(),
                                    IsBase = string.Equals(programStructureDictionary["USER10_INDICATOR"].As<string>(), "X", StringComparison.InvariantCultureIgnoreCase),
                                    InvestmentManagementPosition = MaskPosition(programStructureDictionary["POSITION"].As<string>()),
                                    Budgets = appropriationSourceBudgets                       
                                }
                            })
                            .ToArray();
                        break;

                    default:
                        break;
                }
            }

            return programFunds.ToArray();
        }

        /// <summary>
        /// Methods caters for 2 types of position strings that SAP produces for PROGRAM FUND and APPROPRIATION SOURCE as follows
        /// I.XXX and I.XXX.XXX_YYYY respectively. The length of these 2 codes are fixed: 5 and 14. 
        /// NOTE: The position considered masked if it starts with capital I. Method returns appropriation source code if it is in
        /// the position otherwise program fund code
        /// </summary>
        /// <param name="position"></param>
        /// <returns></returns>
        string FindRightMostCode(string position)
        {
            if (!position.StartsWith("I"))
            {
                return position;
            }

            // As we deal with the fixed length strings first remove all the "." characters and then the leading "I"
            string text = position.Replace(".", string.Empty).Substring(1);

            // our remaining text is now either 3 or 11 characters long

            if (text.Length > SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_PROGRAM_FUND_CODE_LENGTH)
            {
                // return an appropriation code
                return text.Substring(SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_PROGRAM_FUND_CODE_LENGTH, text.Length - SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_PROGRAM_FUND_CODE_LENGTH);
            }

            // return a program fund code
            return text;
        }

        private ProgramStructure GetProgramStructure(ProgramStructureRequest request)
        {
            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_EXPENDITUREPROGTREE_GTDTL");
            function.SetValue("PROGRAM", request.ProgramName);
            function.SetValue("APPROVALYEAR", request.FinancialYear);
            function.SetValue("POSITION", request.PositionName);
            function.InvokeAndThrowOnAnyException(Destination);

            IRfcTable table = function.GetTable("PROGTREE");

#if DEBUG
            table.ToList().ForEach(row => System.Diagnostics.Debug.WriteLine(row.Select(x => string.Format("{0}={1}", x.Metadata.Name, x.GetValue())).Aggregate((x, y) => string.Format("{0}, {1}", x, y))));
#endif
            return new ProgramStructure { Structure = table.ToArrayOfDictionaries() };
        }

        private ProgramStructure GetProgramStructureBudget(ProgramStructureRequest request)
        {
            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_EXPENDITUREPROGTREE_GDVAL");
            function.SetValue("PROGRAM", request.ProgramName);
            function.SetValue("APPROVALYEAR", request.FinancialYear);
            function.SetValue("POSITION", request.PositionName);
            function.InvokeAndThrowOnAnyException(Destination);

            IRfcTable table = function.GetTable("PROGTREEVALUESLIST");
#if DEBUG
            table.ToList().ForEach(row => System.Diagnostics.Debug.WriteLine(row.Select(x => string.Format("{0}={1}", x.Metadata.Name, x.GetValue())).Aggregate((x, y) => string.Format("{0}, {1}", x, y))));
#endif
            return new ProgramStructure { Structure = table.ToArrayOfDictionaries() };
        }

        /// <summary>
        /// Methods applies a mask (inserts dots) for 2 types of position strings that SAP produces for PROGRAM FUND and APPROPRIATION SOURCE as follows
        /// I.XXX and I.XXX.XXX_YYYY respectively.
        /// NOTE: The position considered masked if it has '.' character.
        /// </summary>
        /// <param name="position"></param>
        /// <returns></returns>
        string MaskPosition(string position)
        {
            if (string.IsNullOrWhiteSpace(position))
            {
                throw new ArgumentException("position is empty");
            }

            if (position.IndexOf('.') > 0)
            {
                return position;
            }

            if (position.Length > SAP_EVENT_PROGRAM_STRUCTURE_CHANGED_PROGRAM_FUND_CODE_LENGTH + 1)
            {
                return position.Insert(1, ".").Insert(5, ".");
            }

            return position.Insert(1, ".");
        }

    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPProject.cs
39794
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Model;
using ServiceBus.Contract;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public class SAPProject : SAPObject
    {
        #region Fields

        const int PROJECT_CODE_LENGTH = 8;
        const int WBS_CODE_LENGTH = 24;

        const string STATUS_ACTIVE = "REL";
        const string STATUS_CLOSED = "CLSD";
        const string STATUS_LOCKED = "LKD";
        const string STATUS_COMPLETED = "TECO";

        #endregion

        #region Constructors

        public SAPProject(RfcDestination destination, ISAPConfiguration configuration)
            : base(destination, configuration)
        {
        }

        #endregion

        #region ISAPProjectServiceAgent implementation

        public ReplicateProjectInfo CreateOrUpdateProject(ProjectInfo projectInfo)
        {
            if (projectInfo == null)
            {
                throw new ArgumentNullException("projectInfo");
            }

            // method carries out 2 batches of BAPI functions executions, first ensures that the project is created with the status REL,
            // second adjusts statuses of wbs elements as per exlanations below

            bool isnew;

            // this list will be populated with BAPI functions to execute
            List<IRfcFunction> functions = new List<IRfcFunction>();

            // create or update project
            functions.Add(CreateOrUpdateProjectRfcFunction(projectInfo, out isnew));

            // create or update wbs elements
            functions.AddRange(CreateOrUpdateWBSRfcFunctions(projectInfo));

            // make this project active - only when it has just been created
            if (isnew)
            {
                functions.Add(CreateProjectSetStatusRfcFunction(projectInfo.ProjectCode, StatusEnum.Active));
            }

            // execute all functions one by one
            ExecuteProjectRfcFunctions(functions);

            // prepare for the second batch - updating statuses of wbs elements as related activities may have been completed/reactivated 
            // and appropriation sources may have been added/deleted
            functions.Clear();

            /****** Following code will never work because activities and appropriation sources that have been removed from investment is never sent i.e. all activities 
             in projectInfo are always Active. LockWBSCode method is created to locked all WBS code that are not present in projectInfo *******/
            //// set status CLSD on wbs elements corresponding to closed activities as well as on appropriation sources corresponding to those activties - 
            //// a project may be created for an active initiative with one or more completed/terminated activities
            //functions.AddRange((projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()).Where(x => x.Status == StatusEnum.Closed).Select(x => CreateWBSElementSetStatusRfcFunction(x.WBSElementCode, StatusEnum.Closed)));
            //functions.AddRange((projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()).Where(x => x.Status == StatusEnum.Closed).SelectMany(x => x.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>()).Select(x => CreateWBSElementSetStatusRfcFunction(x.WBSElementCode, StatusEnum.Closed)));

            //// set status CLSD on wbs elements corresponding to closed appropriation sources - appropriation sources marked closed if they have been removed
            //// from activities
            //functions.AddRange((projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()).SelectMany(x => x.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>()).Where(x => x.Status == StatusEnum.Closed).Select(x => CreateWBSElementSetStatusRfcFunction(x.WBSElementCode, StatusEnum.Closed)));

            // set status REL on wbs elements corresponding to active appropriation sources - previously removed appropriation sources may re-appear 
            // in an activity as such related wbs elements must exist with status CLSD, to set status REL revoke CLSD and TECO required
            functions.AddRange((projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()).SelectMany(x => x.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>()).Where(x => x.Status == StatusEnum.Active).Select(x => CreateWBSElementRevokeStatusRfcFunction(x.WBSElementCode, StatusEnum.Closed)));
            functions.AddRange((projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()).SelectMany(x => x.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>()).Where(x => x.Status == StatusEnum.Active).Select(x => CreateWBSElementRevokeStatusRfcFunction(x.WBSElementCode, StatusEnum.Completed)));
            functions.AddRange((projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()).SelectMany(x => x.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>()).Where(x => x.Status == StatusEnum.Active).Select(x => CreateWBSElementRevokeStatusRfcFunction(x.WBSElementCode, StatusEnum.Locked)));
            functions.AddRange((projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()).SelectMany(x => x.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>()).Where(x => x.Status == StatusEnum.Active).Select(x => CreateWBSElementSetStatusRfcFunction(x.WBSElementCode, StatusEnum.Active)));

            // execute all functions one by one
            ExecuteProjectRfcFunctions(functions);

            //Lock all WBS codes that donot appear in projectInfo
            LockWBSCode(projectInfo);

            return CreateReplicateProjectInfo(projectInfo);
        }

        private IEnumerable<string> GetAllWBSCodes(string projectCode)
        {
            if (projectCode.Length == PROJECT_CODE_LENGTH)
            {
                IRfcFunction function = Destination.Repository.CreateFunction("BAPI_BUS2054_GETDATA");
                function.SetValue("I_PROJECT_DEFINITION", projectCode);
                function.InvokeAndThrowOnAnyException(Destination);
                IRfcTable wbsCodes = function.GetTable("ET_WBS_ELEMENT");
                return wbsCodes
                        .Where(x =>
                            x.GetString("WBS_ACCOUNT_ASSIGNMENT_ELEMENT").Equals("X", StringComparison.InvariantCultureIgnoreCase) &&
                            x.GetString("WBS_ELEMENT").StartsWith(projectCode, StringComparison.InvariantCultureIgnoreCase))
                        .Select(x => x.GetString("WBS_ELEMENT"));
            }

            return Enumerable.Empty<string>();
        }

        public ReplicateWBSElementStatus LockWBSCode(ProjectInfo projectInfo)
        {
            if (projectInfo == null)
            {
                throw new ArgumentNullException("projectInfo");
            }

            if (projectInfo.ProjectCode.Length == PROJECT_CODE_LENGTH)
            {
                List<string> wbsElementsUpdated = new List<string>();
                IEnumerable<string> elements = GetAllWBSCodes(projectInfo.ProjectCode);
                IEnumerable<string> activeWBSCodes = (projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>())
                    .SelectMany(activity => (activity.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>())
                                                .Where(aps => aps.Status == StatusEnum.Active)
                                                .Select(aps => aps.WBSElementCode));

                foreach (string element in elements.Where(element => !activeWBSCodes.Any(x => x.Equals(element, StringComparison.InvariantCultureIgnoreCase))))
                {
                    ChangeWBSElementStatus(element, StatusEnum.Locked);
                    wbsElementsUpdated.Add(element);
                }

                if (wbsElementsUpdated.Count > 0)
                {
                    return new ReplicateWBSElementStatus
                    {
                        WBSElements = wbsElementsUpdated.ToArray(),
                        Status = StatusEnum.Locked
                    };
                }
            }

            return null;
        }

        public ReplicateWBSElementStatus UpdateWBSCodeStatus(UpdateWBSCodeStatusInfo updateWBSCodeStatusInfo)
        {
            List<string> wbsElementsUpdated = new List<string>();

            if (string.IsNullOrWhiteSpace(updateWBSCodeStatusInfo.ProjectCode))
            {
                throw new ArgumentException("Project code is empty");
            }

            if (!Enum.IsDefined(typeof(StatusEnum), updateWBSCodeStatusInfo.Status))
            {
                throw new ArgumentException(string.Format("Status {0} is not defined", updateWBSCodeStatusInfo.Status));
            }

            if (updateWBSCodeStatusInfo.ProjectCode.Length == PROJECT_CODE_LENGTH)
            {
                IEnumerable<string> elements = GetAllWBSCodes(updateWBSCodeStatusInfo.ProjectCode);

                if ((updateWBSCodeStatusInfo.Activities?.Any()).GetValueOrDefault())
                {
                    elements = elements.Where(x => updateWBSCodeStatusInfo.Activities.Any(y => x.Contains(y)));
                }

                if ((updateWBSCodeStatusInfo.FundingSources?.Any()).GetValueOrDefault())
                {
                    elements = elements.Where(x => updateWBSCodeStatusInfo.FundingSources.Any(y => x.EndsWith(y)));
                }

                foreach (string code in elements)
                {
                    ChangeWBSElementStatus(code, updateWBSCodeStatusInfo.Status);
                    wbsElementsUpdated.Add(code);
                }

                if (wbsElementsUpdated.Count > 0)
                {
                    return new ReplicateWBSElementStatus
                    {
                        WBSElements = wbsElementsUpdated.ToArray(),
                        Status = updateWBSCodeStatusInfo.Status
                    };
                }
            }

            return null;
        }

        public void CreateInvestmentManagementLink(InvestmentManagementLinkInfo investmentManagementLinkInfo)
        {
            if (investmentManagementLinkInfo == null)
            {
                throw new ArgumentNullException("investmentManagementLinkInfo");
            }

            RfcSessionManager.BeginContext(Destination);

            try
            {
                IRfcFunction function = Destination.Repository.CreateFunction("Z_AIPP_ALLOCATE_POSITION_DARK");
                function.SetValue("IV_IM_APPROVALYEAR", investmentManagementLinkInfo.ApprovalYear);
                function.SetValue("IV_IM_POSITION", investmentManagementLinkInfo.InvestmentManagementPosition);
                function.SetValue("IV_WBS", investmentManagementLinkInfo.WBSElementCode);
                function.InvokeAndThrowOnAnyException(Destination);

                if (!function.GetString("EV_SUCCESS").Equals("X", StringComparison.InvariantCultureIgnoreCase))
                {
                    throw new ApplicationException(string.Format("Link to IM was not successful. Unknown reason. {0}", investmentManagementLinkInfo));
                }

                Destination.Commit();
            }
            catch (RfcAbapException exception)
            {
                Destination.Rollback();

                if (exception.Key == "ALLOC_ALREADY_EXISTS")
                {
                    // no need to re-throw - consider this a success
                }
                else if (exception.Key == "WBS_NOT_LOCKED" || exception.Key == "IM_POSITION_NOT_LOCKED")
                {
                    // do not throw exception here - just return FALSE and let caller decide what to do with this fact
                    throw new SAPEntityLockedException(string.Format("Unable to acquire a lock to update investment management link.{0}Original exception: {1}{0}",
                        Environment.NewLine, exception));
                }
                else if (exception.Key == "INV_PROG_DOES_NOT_EXIST")
                {
                    throw new ApplicationException(string.Format("{0} does not exist. Check investment management structure for {1}",
                        investmentManagementLinkInfo.InvestmentManagementPosition, investmentManagementLinkInfo.ApprovalYear));
                }
                else
                {
                    throw;
                }
            }
            finally
            {
                RfcSessionManager.EndContext(Destination);
            }
        }

        public void UpdateForecast(WBSForecastInfo[] forecasts)
        {
            if (forecasts == null)
            {
                throw new ArgumentNullException("forecasts");
            }

            string errorMessage = null;

            List<string> forecastPropertyErrorMessages = new List<string>(); string forecastErrorMessage = null;

            foreach (WBSForecastInfo forecast in forecasts)
            {
                forecastPropertyErrorMessages.Clear();

                if (forecast.FinancialYearEnd <= 0)
                {
                    forecastPropertyErrorMessages.Add("FinancialYearEnd must be a positive number");
                }

                if (string.IsNullOrWhiteSpace(forecast.GLCode))
                {
                    forecastPropertyErrorMessages.Add("GLCode is empty");
                }

                if (string.IsNullOrWhiteSpace(forecast.WBSElementCode))
                {
                    forecastPropertyErrorMessages.Add("WBSElementCode is empty");
                }

                if (forecastPropertyErrorMessages.Count != 0)
                {
                    forecastErrorMessage = string.Format("Forecast structure {0} is invalid due to the following errors: {1}",
                        forecast.Stringify(),
                        string.Join(", ", forecastPropertyErrorMessages));

                    errorMessage = string.IsNullOrWhiteSpace(errorMessage) ? forecastErrorMessage : errorMessage + "; " + forecastErrorMessage;
                }
            }

            if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                throw new ArgumentException(errorMessage);
            }

            RfcSessionManager.BeginContext(Destination);

            try
            {
                foreach (IGrouping<int, WBSForecastInfo> grouping in forecasts.GroupBy(x => x.FinancialYearEnd))
                {
                    IRfcFunction postFunction = Destination.Repository.CreateFunction("BAPI_COSTACTPLN_POSTPRIMCOST");

                    IRfcStructure headerInfo = postFunction.GetStructure("HEADERINFO");
                    headerInfo.SetValue("CO_AREA", Configuration.Setting<string>(SAPConfiguration.PS_CONTROLLING_AREA));
                    headerInfo.SetValue("PERIOD_FROM", 1);
                    headerInfo.SetValue("PERIOD_TO", 12);
                    headerInfo.SetValue("VERSION", "F");
                    headerInfo.SetValue("PLAN_CURRTYPE", "C");
                    headerInfo.SetValue("FISC_YEAR", grouping.Key);
                    headerInfo.SetValue("DOC_HDR_TX", string.Format("AidWorks {0} document", grouping.Key));

                    IRfcTable indexStructure = postFunction.GetTable("INDEXSTRUCTURE");
                    IRfcTable coObject = postFunction.GetTable("COOBJECT");
                    IRfcTable totalValue = postFunction.GetTable("TOTVALUE");

                    int index = 0;

                    foreach (WBSForecastInfo forecast in grouping)
                    {
                        index++;

                        indexStructure.Append();
                        indexStructure.CurrentRow.SetValue("OBJECT_INDEX", index);
                        indexStructure.CurrentRow.SetValue("VALUE_INDEX", index);

                        coObject.Append();
                        coObject.CurrentRow.SetValue("OBJECT_INDEX", index);
                        coObject.CurrentRow.SetValue("WBS_ELEMENT", forecast.WBSElementCode);

                        totalValue.Append();
                        totalValue.CurrentRow.SetValue("VALUE_INDEX", index);
                        totalValue.CurrentRow.SetValue("COST_ELEM", forecast.GLCode);
                        totalValue.CurrentRow.SetValue("FIX_VALUE", forecast.Amount);
                    }

                    postFunction.InvokeAndThrowOnAnyException(Destination);
                }

                Destination.Commit();
            }
            catch (Exception)
            {
                Destination.Rollback();

                throw;
            }
            finally
            {
                RfcSessionManager.EndContext(Destination);
            }
        }

        void ChangeProjectStatus(string code, StatusEnum status)
        {
            if (string.IsNullOrWhiteSpace(code))
            {
                throw new ArgumentException("code is empty");
            }

            if (!Enum.IsDefined(typeof(StatusEnum), status))
            {
                throw new ArgumentException(string.Format("status {0} is not defined", status));
            }

            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_BUS2001_GET_STATUS");
            function.SetValue("PROJECT_DEFINITION", code);
            function.InvokeAndThrowOnAnyException(Destination);

            IRfcTable table = function.GetTable("E_SYSTEM_STATUS");
            if (table.RowCount == 0)
            {
                throw new InvalidOperationException(string.Format("No rows found in E_SYSTEM_STATUS. Project: {0}", code));
            }

            // if we change from "LKD" to "REL" execute revoke "LKD" (this puts status "TECO") and revoke "TECO"
            if (table.Any(x => x.GetString("SYSTEM_STATUS").Equals(STATUS_LOCKED, StringComparison.InvariantCultureIgnoreCase))
                && status == StatusEnum.Active)
            {
                ExecuteProjectRfcFunctions(new IRfcFunction[]
                {
                    CreateProjectRevokeStatusRfcFunction(code, StatusEnum.Closed),
                    CreateProjectRevokeStatusRfcFunction(code, StatusEnum.Completed)
                });
            }

            // in all other cases
            ExecuteProjectRfcFunctions(new IRfcFunction[] { CreateProjectSetStatusRfcFunction(code, status) });
        }

        void ChangeWBSElementStatus(string code, StatusEnum status)
        {
            if (string.IsNullOrWhiteSpace(code))
            {
                throw new ArgumentException("code is empty");
            }

            if (code.Length < WBS_CODE_LENGTH)
            {
                throw new ArgumentException(string.Format("Unexpectedly short wbs element code: {0}", code));
            }

            if (!Enum.IsDefined(typeof(StatusEnum), status))
            {
                throw new ArgumentException(string.Format("status {0} is not defined", status));
            }

            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_BUS2054_GET_STATUS");
            IRfcTable table = function.GetTable("I_WBS_ELEMENTS");
            table.Append();
            table.CurrentRow.SetValue("WBS_ELEMENT", code);
            function.InvokeAndThrowOnAnyException(Destination);

            table = function.GetTable("E_SYSTEM_STATUS");
            if (table.RowCount == 0)
            {
                throw new InvalidOperationException(string.Format("No rows found in E_SYSTEM_STATUS. Project: {0}", code));
            }

            // if we change from "LKD" to "REL" execute revoke "LKD" (this puts status "TECO") and revoke "TECO"
            // on the WBS hierarchy starting with the given "code"
            if (table.Any(x => x.GetString("SYSTEM_STATUS").Equals(STATUS_LOCKED, StringComparison.InvariantCultureIgnoreCase))
                && status == StatusEnum.Active)
            {
                List<IRfcFunction> functions = new List<IRfcFunction>();
                functions.Add(CreateWBSElementRevokeStatusRfcFunction(code, StatusEnum.Closed));
                functions.Add(CreateWBSElementRevokeStatusRfcFunction(code, StatusEnum.Completed));
                functions.Add(CreateWBSElementRevokeStatusRfcFunction(code, StatusEnum.Locked));

                ExecuteProjectRfcFunctions(functions);
            }

            // in all other cases
            ExecuteProjectRfcFunctions(new IRfcFunction[] { CreateWBSElementSetStatusRfcFunction(code, status) });
        }

        #endregion

        #region Private members

        IRfcFunction CreateOrUpdateProjectRfcFunction(ProjectInfo projectInfo, out bool isnew)
        {
            if (projectInfo == null)
            {
                throw new ArgumentNullException("projectInfo");
            }

            IRfcFunction function = null;

            string errorMessage;

            // Prepare project code
            string projectDefinitionCode = string.Format("I.{0}", projectInfo.Number);

            // Find out if the project already exists
            IRfcFunction getdata = Destination.Repository.CreateFunction("BAPI_BUS2001_GETDATA");
            getdata.SetValue("I_PROJECT_DEFINITION", projectDefinitionCode);
            getdata.Invoke(Destination);

            IEnumerable<IRfcStructure> messages = getdata.FindReturnMessages();

            // if ERROR is found with NUMBER = 11 - project does not exists
            isnew = messages.HasRfcErrorNumber(11);

            // ensure there is no other errors
            if (!isnew && messages.HasRfcError(out errorMessage))
            {
                throw new ApplicationException(errorMessage);
            }

            // reference to existing project definition
            IRfcStructure projectDefinitionExisting = getdata.GetStructure("E_PROJECT_DEFINITION");

            // project definition to use in the returned function
            IRfcStructure projectDefinition;

            if (isnew)
            {
                function = Destination.Repository.CreateFunction("BAPI_BUS2001_CREATE");
                projectDefinition = function.GetStructure("I_PROJECT_DEFINITION");
                projectDefinition.SetValue("PROJECT_DEFINITION", projectDefinitionCode);
                projectDefinition.SetValue("PROJECT_PROFILE", Configuration.Setting<string>(SAPConfiguration.PS_PROJECT_PROFILE));
            }
            else
            {
                projectDefinition = Destination.Repository.GetStructureMetadata("BAPI_BUS2001_CHG").CreateStructure();

                // initialise project definition fields to existing values
                projectDefinitionExisting.MoveCorrespondingTo(projectDefinition);
            }

            // modify project definition fields as requested
            projectDefinition.SetValue("DESCRIPTION", projectInfo.Name);
            projectDefinition.SetValue("START", projectInfo.StartDate);
            projectDefinition.SetValue("FINISH", projectInfo.EndDate);

            if (!isnew)
            {
                IRfcStructure updateFieldsStructure = Destination.Repository.GetStructureMetadata("BAPI_BUS2001_UPD").CreateStructure();

                // identify fields that are getting changed
                IEnumerable<IRfcField> updateFields = updateFieldsStructure
                    .Where(x => !object.Equals(projectDefinitionExisting.GetValue(x.Metadata.Name), projectDefinition.GetValue(x.Metadata.Name)));

                if (updateFields.Any())
                {
                    // now we know that project definition is really getting changed
                    function = Destination.Repository.CreateFunction("BAPI_BUS2001_CHANGE");
                    // move project definition values to function import parameter
                    projectDefinition.MoveCorrespondingTo(function.GetStructure("I_PROJECT_DEFINITION"));
                    // mark fields that are getting changed
                    updateFields.ToList().ForEach(x => function.GetStructure("I_PROJECT_DEFINITION_UPD").SetValue(x.Metadata.Name, "X"));
                }
            }

            //ensure to return project definition code back to AidWorks
            if (string.IsNullOrWhiteSpace(projectInfo.ProjectCode))
            {
                projectInfo.ProjectCode = projectDefinitionCode;
            }

            return function;
        }

        IRfcFunction[] CreateOrUpdateWBSRfcFunctions(ProjectInfo projectInfo)
        {
            if (projectInfo == null)
            {
                throw new ArgumentNullException("projectInfo");
            }

            IRfcFunction createFunction = null;
            IRfcFunction updateFunction = null;

            string errorMessage;

            // Get existing WBS structure
            IRfcFunction getdata = Destination.Repository.CreateFunction("BAPI_BUS2054_GETDATA");
            getdata.SetValue("I_PROJECT_DEFINITION", projectInfo.ProjectCode);
            getdata.Invoke(Destination);

            IEnumerable<IRfcStructure> messages = getdata.FindReturnMessages();

            // if ERROR is found with NUMBER = 11 - project does not exists
            bool isnew = messages.HasRfcErrorNumber(11);

            // ensure there is no other errors
            if (!isnew && messages.HasRfcError(out errorMessage))
            {
                throw new ApplicationException(errorMessage);
            }

            IRfcTable etWbsElement = getdata.GetTable("ET_WBS_ELEMENT");

            IRfcStructure etWbsElementItem;

            foreach (ActivityInfo activityInfo in (projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>()))
            {
                activityInfo.WBSElementCode = string.Format("{0}.{1}", projectInfo.ProjectCode, activityInfo.Number);

                etWbsElementItem = etWbsElement
                    .FirstOrDefault(x => x.GetString("WBS_ELEMENT").Equals(activityInfo.WBSElementCode, StringComparison.InvariantCultureIgnoreCase));

                if (etWbsElementItem == null)
                {
                    if (createFunction == null)
                    {
                        createFunction = Destination.Repository.CreateFunction("BAPI_BUS2054_CREATE_MULTI");
                        createFunction.SetValue("I_PROJECT_DEFINITION", projectInfo.ProjectCode);
                    }

                    IRfcTable itWbsElement = createFunction.GetTable("IT_WBS_ELEMENT");
                    itWbsElement.Append();
                    itWbsElement.CurrentRow.SetValue("WBS_ELEMENT", activityInfo.WBSElementCode);
                    itWbsElement.CurrentRow.SetValue("DESCRIPTION", activityInfo.Name);
                    itWbsElement.CurrentRow.SetValue("COMPANY_CODE", Configuration.Setting<string>(SAPConfiguration.PS_COMPANY_CODE));
                    itWbsElement.CurrentRow.SetValue("CONTROLLING_AREA", Configuration.Setting<string>(SAPConfiguration.PS_CONTROLLING_AREA));
                    itWbsElement.CurrentRow.SetValue("CURRENCY", Configuration.Setting<string>(SAPConfiguration.PS_CURRENCY));
                    itWbsElement.CurrentRow.SetValue("PLANT", Configuration.Setting<string>(SAPConfiguration.PS_PLANT));
                }
                else
                {
                    // create new structure and update it to existing content from the found wbs element
                    IRfcStructure itWbsElementItem = Destination.Repository.GetStructureMetadata("BAPI_BUS2054_CHG").CreateStructure();
                    etWbsElementItem.MoveCorrespondingTo(itWbsElementItem);

                    // update fields in the new structure accordingly
                    itWbsElementItem.SetValue("DESCRIPTION", activityInfo.Name);

                    // find fields with non-matching values
                    IEnumerable<IRfcField> updateFields = itWbsElementItem.Where(x => !object.Equals(etWbsElementItem.GetValue(x.Metadata.Name), x.GetValue()));

                    if (updateFields.Any())
                    {
                        // now we know that WBS element is really getting changed
                        if (updateFunction == null)
                        {
                            updateFunction = Destination.Repository.CreateFunction("BAPI_BUS2054_CHANGE_MULTI");
                            updateFunction.SetValue("I_PROJECT_DEFINITION", projectInfo.ProjectCode);
                        }

                        IRfcTable itWbsEmenent = updateFunction.GetTable("IT_WBS_ELEMENT");
                        itWbsEmenent.Append(itWbsElementItem);

                        IRfcTable itUpdateWbsElement = updateFunction.GetTable("IT_UPDATE_WBS_ELEMENT");
                        itUpdateWbsElement.Append();
                        itUpdateWbsElement.CurrentRow.SetValue("WBS_ELEMENT", etWbsElementItem.GetString("WBS_ELEMENT"));
                        updateFields.ToList().ForEach(x => itUpdateWbsElement.CurrentRow.SetValue(x.Metadata.Name, "X"));
                    }
                }

                foreach (ActivityAppropriationSourceInfo appropriationSource in (activityInfo.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>()).Where(x => x.Status == StatusEnum.Active))
                {
                    appropriationSource.WBSElementCode = string.Format("{0}.{1}", activityInfo.WBSElementCode, appropriationSource.Code);

                    etWbsElementItem = etWbsElement
                        .FirstOrDefault(x => x.GetString("WBS_ELEMENT").Equals(appropriationSource.WBSElementCode, StringComparison.InvariantCultureIgnoreCase));

                    if (etWbsElementItem == null)
                    {
                        if (createFunction == null)
                        {
                            createFunction = Destination.Repository.CreateFunction("BAPI_BUS2054_CREATE_MULTI");
                            createFunction.SetValue("I_PROJECT_DEFINITION", projectInfo.ProjectCode);
                        }

                        IRfcTable itWbsElement = createFunction.GetTable("IT_WBS_ELEMENT");
                        itWbsElement.Append();
                        itWbsElement.CurrentRow.SetValue("WBS_ELEMENT", appropriationSource.WBSElementCode);
                        itWbsElement.CurrentRow.SetValue("DESCRIPTION", string.Format("{1} funding for {0}", activityInfo.Number, appropriationSource.Code));
                        itWbsElement.CurrentRow.SetValue("COMPANY_CODE", Configuration.Setting<string>(SAPConfiguration.PS_COMPANY_CODE));
                        itWbsElement.CurrentRow.SetValue("CONTROLLING_AREA", Configuration.Setting<string>(SAPConfiguration.PS_CONTROLLING_AREA));
                        itWbsElement.CurrentRow.SetValue("CURRENCY", Configuration.Setting<string>(SAPConfiguration.PS_CURRENCY));
                        itWbsElement.CurrentRow.SetValue("PLANT", Configuration.Setting<string>(SAPConfiguration.PS_PLANT));
                        itWbsElement.CurrentRow.SetValue("RESPSBL_CCTR_CONTROLLING_AREA", Configuration.Setting<string>(SAPConfiguration.PS_CONTROLLING_AREA));
                        itWbsElement.CurrentRow.SetValue("RESPSBL_CCTR", appropriationSource.Code);
                        itWbsElement.CurrentRow.SetValue("WBS_ACCOUNT_ASSIGNMENT_ELEMENT", "X");
                        itWbsElement.CurrentRow.SetValue("WBS_UP", activityInfo.WBSElementCode);
                    }
                    else
                    {
                        // There are no field values on this level element that may change                        
                    }
                }
            }

            List<IRfcFunction> functions = new List<IRfcFunction>();

            if (createFunction != null)
            {
                functions.Add(createFunction);
            }

            if (updateFunction != null)
            {
                functions.Add(updateFunction);
            }

            return functions.ToArray();
        }

        IRfcFunction CreateProjectSetStatusRfcFunction(string code, StatusEnum status)
        {
            if (string.IsNullOrWhiteSpace(code))
            {
                throw new ArgumentNullException("code");
            }

            if (!Enum.IsDefined(typeof(StatusEnum), status))
            {
                throw new ArgumentException(string.Format("status {0} is not defined", status));
            }

            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_BUS2001_SET_STATUS");
            function.SetValue("PROJECT_DEFINITION", code);
            function.SetValue("SET_SYSTEM_STATUS", TranslateStatus(status));
            return function;
        }

        ReplicateProjectInfo CreateReplicateProjectInfo(ProjectInfo projectInfo)
        {
            return new ReplicateProjectInfo
            {
                ProjectCode = projectInfo.ProjectCode,
                Number = projectInfo.Number,
                Activities = (projectInfo.Activities ?? Enumerable.Empty<ActivityInfo>())
                    .Where(x => x.Status == StatusEnum.Active)
                    .Select(activityInfo => new ActivityInfo
                    {
                        WBSElementCode = activityInfo.WBSElementCode,
                        Number = activityInfo.Number,
                        Status = activityInfo.Status,
                        AppropriationSources = (activityInfo.AppropriationSources ?? Enumerable.Empty<ActivityAppropriationSourceInfo>())
                            .Where(x => x.Status == StatusEnum.Active)
                            .Select(appropriationSourceInfo => new ActivityAppropriationSourceInfo
                            {
                                WBSElementCode = appropriationSourceInfo.WBSElementCode,
                                InvestmentManagementPosition = appropriationSourceInfo.InvestmentManagementPosition,
                                Code = appropriationSourceInfo.Code,
                                Status = appropriationSourceInfo.Status
                            })
                            .ToArray()
                    })
                    .ToArray()
            };
        }

        IRfcFunction CreateProjectRevokeStatusRfcFunction(string code, StatusEnum status)
        {
            if (string.IsNullOrWhiteSpace(code))
            {
                throw new ArgumentNullException("code");
            }

            if (!Enum.IsDefined(typeof(StatusEnum), status))
            {
                throw new ArgumentException(string.Format("status {0} is not defined", status));
            }

            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_BUS2001_SET_STATUS");
            function.SetValue("PROJECT_DEFINITION", code);
            function.SetValue("UNDO_SYSTEM_STATUS", TranslateStatus(status));
            return function;
        }

        IRfcFunction CreateWBSElementSetStatusRfcFunction(string code, StatusEnum status)
        {
            if (string.IsNullOrWhiteSpace(code))
            {
                throw new ArgumentNullException("code");
            }

            if (!Enum.IsDefined(typeof(StatusEnum), status))
            {
                throw new ArgumentException(string.Format("status {0} is not defined", status));
            }

            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_BUS2054_SET_STATUS");

            IRfcTable table = function.GetTable("I_WBS_SYSTEM_STATUS");
            table.Append();
            table.CurrentRow.SetValue("WBS_ELEMENT", code);
            table.CurrentRow.SetValue("SET_SYSTEM_STATUS", TranslateStatus(status));

            return function;
        }

        IRfcFunction CreateWBSElementRevokeStatusRfcFunction(string code, StatusEnum status)
        {
            if (string.IsNullOrWhiteSpace(code))
            {
                throw new ArgumentNullException("code");
            }

            if (!Enum.IsDefined(typeof(StatusEnum), status))
            {
                throw new ArgumentException(string.Format("status {0} is not defined", status));
            }

            IRfcFunction function = Destination.Repository.CreateFunction("BAPI_BUS2054_SET_STATUS");

            IRfcTable table = function.GetTable("I_WBS_SYSTEM_STATUS");
            table.Append();
            table.CurrentRow.SetValue("WBS_ELEMENT", code);
            table.CurrentRow.SetValue("UNDO_SYSTEM_STATUS", TranslateStatus(status));

            return function;
        }

        void ExecuteProjectRfcFunctions(IEnumerable<IRfcFunction> functions)
        {
            if (functions == null)
            {
                throw new ArgumentNullException("functions");
            }

            if (functions.Any())
            {
                string errorMessage;

                RfcSessionManager.BeginContext(Destination);

                try
                {
                    Destination.Initialise();

                    IEnumerable<IRfcStructure> messages;

                    foreach (IRfcFunction function in functions)
                    {
                        if (function != null)
                        {
                            function.Invoke(Destination);

                            messages = function.FindReturnMessages();

                            if (messages.HasRfcError(out errorMessage))
                            {
                                // WBS structure is locked by another user
                                if (messages.HasRfcErrorNumber(806, 601, 4))
                                {
                                    throw new SAPEntityLockedException(errorMessage);
                                }

                                throw new ApplicationException(errorMessage);
                            }
                        }
                    }

                    Destination.PreCommitAndCommit();
                }
                catch (Exception)
                {
                    Destination.Rollback();

                    throw;
                }
                finally
                {
                    RfcSessionManager.EndContext(Destination);
                }
            }
        }

        static string TranslateStatus(StatusEnum status)
        {
            switch (status)
            {
                case StatusEnum.Active:
                    return STATUS_ACTIVE;

                case StatusEnum.Closed:
                    return STATUS_CLOSED;

                case StatusEnum.Completed:
                    return STATUS_COMPLETED;

                case StatusEnum.Locked:
                    return STATUS_LOCKED;

                default:
                    throw new ArgumentException(string.Format("Unknown status {0}", status));
            }
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPPurchaseOrder.cs
41365
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP
{
    public class SAPPurchaseOrder : SAPObject
    {
        #regionFields

        // purchase order BAPI functions
        public const string SAP_FUNC_INITIALIZATION = "BAPI_PS_INITIALIZATION";
        public const string SAP_PO_FUNC_CHANGE = "BAPI_PO_CHANGE";
        public const string SAP_PO_FUNC_CREATE = "BAPI_PO_CREATE1";
        public const string SAP_PO_FUNC_GETDETAIL = "BAPI_PO_GETDETAIL1";
        public const string SAP_PO_FUNC_RELEASE = "BAPI_PO_RELEASE";
        public const string SAP_PO_FUNC_RETURNTABLE = "RETURN";
        public const string SAP_PO_FUNC_PRECOMMIT = "BAPI_PS_PRECOMMIT";

        // release public constants
        public const string SAP_PO_FUNC_RELEASE_RETURN_CODE = "CODE";
        public const string SAP_PO_FUNC_RELEASE_RETURN_ERRORCODE_INVALIDRELEASECODE = "ME104";
        public const string SAP_PO_FUNC_RELEASE_RETURN_ERRORCODE_INVALIDPO = "06019";

        // account item BAPI fields
        public const string SAP_PO_FIELD_POACCOUNT_PO_ITEM = "PO_ITEM";
        public const string SAP_PO_FIELD_POACCOUNT_PO_ITEMX = "PO_ITEMX";
        public const string SAP_PO_FIELD_POACCOUNT_QUANTITY = "QUANTITY";
        public const string SAP_PO_FIELD_POACCOUNT_SERIAL_NO = "SERIAL_NO";
        public const string SAP_PO_FIELD_POACCOUNT_WBS_ELEMENT = "WBS_ELEMENT";
        public const string SAP_PO_FIELD_POACCOUNT_DELETE_IND = "DELETE_IND";
        public const string SAP_PO_FIELD_POACCOUNT_GL_ACCOUNT = "GL_ACCOUNT";
        public const string SAP_PO_FIELD_POACCOUNT_NET_VALUE = "NET_VALUE";
        public const string SAP_PO_FIELD_POACCOUNT_TAX_CODE = "TAX_CODE";

        // purchase order header BAPI fields
        public const string SAP_PO_FIELD_POHEADER_CURRENCY = "CURRENCY";
        public const string SAP_PO_FIELD_POHEADER_DELETE_IND = "DELETE_IND";
        public const string SAP_PO_FIELD_POHEADER_VENDOR = "VENDOR";
        public const string SAP_PO_FIELD_POHEADER_REF_1 = "REF_1";

        // PO text header
        public const string SAP_PO_FIELD_POTEXTHEADER_PO_NUMBER = "PO_NUMBER";
        public const string SAP_PO_FIELD_POTEXTHEADER_TEXT_ID = "TEXT_ID";
        public const string SAP_PO_FIELD_POTEXTHEADER_TEXT_LINE = "TEXT_LINE";
        public const string SAP_PO_FIELD_POTEXTHEADER_TEXT_FORM = "TEXT_FORM";

        // purchase order line item BAPI fields
        public const string SAP_PO_FIELD_POITEM_PO_ITEMX = "PO_ITEMX";
        public const string SAP_PO_FIELD_POITEM_DELETE_IND = "DELETE_IND";
        public const string SAP_PO_FIELD_POITEM_PO_ITEM = "PO_ITEM";
        public const string SAP_PO_FIELD_POITEM_PO_UNIT = "PO_UNIT";
        public const string SAP_PO_FIELD_POITEM_QUANTITY = "QUANTITY";
        public const string SAP_PO_FIELD_POITEM_SHORT_TEXT = "SHORT_TEXT";
        public const string SAP_PO_FIELD_POITEM_TRACKINGNO = "TRACKINGNO";
        public const string SAP_PO_FIELD_POITEM_DISTR_PERC = "DISTR_PERC";

        // purchase order BAPI params
        public const string SAP_PO_PARAM_ACCOUNT_ASSIGNMENT = "ACCOUNT_ASSIGNMENT";
        public const string SAP_PO_PARAM_OUT_EXPPURCHASEORDER = "EXPPURCHASEORDER";
        public const string SAP_PO_PARAM_POACCOUNT = "POACCOUNT";
        public const string SAP_PO_PARAM_POACCOUNTX = "POACCOUNTX";
        public const string SAP_PO_PARAM_POHEADER = "POHEADER";
        public const string SAP_PO_PARAM_POHEADERX = "POHEADERX";
        public const string SAP_PO_PARAM_POTEXTHEADER = "POTEXTHEADER";
        public const string SAP_PO_PARAM_POTEXTITEM = "POTEXTITEM";
        public const string SAP_PO_PARAM_POITEM = "POITEM";
        public const string SAP_PO_PARAM_POITEMX = "POITEMX";
        public const string SAP_PO_PARAM_PURCHASEORDER = "PURCHASEORDER";
        public const string SAP_PO_PARAM_NO_COMMIT = "NO_COMMIT";

        List<IRfcStructure> existingPOAccountAssignments = new List<IRfcStructure>();
        List<IRfcStructure> existingPOItems = new List<IRfcStructure>();
        IRfcFunction function;
        Dictionary<string, List<string>> poAccountAssignmentNumbers = new Dictionary<string, List<string>>();
        IRfcTable poAccountAssignments;
        IRfcTable poAccountAssignmentsX;
        IRfcStructure poHeader;
        IRfcStructure poHeaderX;
        IRfcTable poTextHeader;
        IRfcTable poTextHeaderItems;
        List<string> poItemNumbers = new List<string>();
        IRfcTable poItems;
        IRfcTable poItemsX;
        Dictionary<string, bool> poLineFurtherUpdatingRequired = new Dictionary<string, bool>();
        PurchaseOrderInfo purchaseOrderInfo;

        #endregionFields

        #region Constructors

        public SAPPurchaseOrder(RfcDestination destination, ISAPConfiguration Configuration)
            : base(destination, Configuration)
        {
        }

        #endregion

        #regionPublicMethods

        public ReplicatePurchaseOrderNumber CreatePurchaseOrder(PurchaseOrderInfo purchaseOrderInfo)
        {
            string purchaseOrderNumber = null;

            try
            {
                // if it already exists - update
                if (purchaseOrderInfo.PurchaseOrderNumber != null)
                {
                    UpdatePurchaseOrder(purchaseOrderInfo);
                }
                else
                {
                    // initialise
                    Initialise(purchaseOrderInfo, SAP_PO_FUNC_CREATE);

                    AddPurchaseOrder();

                    if (purchaseOrderInfo.Notes != null && purchaseOrderInfo.Notes.Length > 0)
                        AddHeaderNote();

                    foreach (PurchaseOrderLineInfo purchaseOrderLineInfo in purchaseOrderInfo.PurchaseOrderLines)
                    {
                        AddPOLineItem(purchaseOrderLineInfo);

                        if (!purchaseOrderLineInfo.TreatAsCompleted)
                            for (int i = 0; i < purchaseOrderLineInfo.AccountAssignments.Length; i++)
                                AddAccountLineItem(purchaseOrderLineInfo, purchaseOrderLineInfo.AccountAssignments[i]);
                    }

                    // invoke 
                    function.InvokeAndThrowOnAnyException(Destination);

                    Destination.PreCommitAndCommit();

                    purchaseOrderNumber = function.GetString(SAP_PO_PARAM_OUT_EXPPURCHASEORDER);
                }
            }
            catch (Exception)
            {
                Destination.Rollback();

                throw;
            }
            finally
            {
                CloseSession();
            }
            
            return new ReplicatePurchaseOrderNumber { 
                CurrencyCode = purchaseOrderInfo.CurrencyCode, 
                Notes = purchaseOrderInfo.Notes,
                PurchaseOrderLines = purchaseOrderInfo.PurchaseOrderLines,
                PurchaseOrderNumber = purchaseOrderNumber,
                SourceReferenceDisplayID = purchaseOrderInfo.SourceReferenceDisplayID,
                SourceReferenceID = purchaseOrderInfo.SourceReferenceID,
                SourceReferenceType = purchaseOrderInfo.SourceReferenceType,
                VendorNumber = purchaseOrderInfo.VendorNumber
            };
        }

        public void DeletePurchaseOrder(PurchaseOrderInfo agreementPayee)
        {
            try
            {
                if (agreementPayee.PurchaseOrderNumber == null)
                    throw new ApplicationException("Expecting a purchase order number for purchase order delete");

                UpdatePurchaseOrder(agreementPayee);
            }
            catch (Exception)
            {
                Destination.Rollback();

                throw;
            }
            finally
            {
                CloseSession();
            }
        }

        public IRfcStructure GetPurchaseOrderItem(string purchaseOrderNumber, string trackingNumber)
        {
            IRfcFunction poItemsList = Destination.Repository.CreateFunction("BAPI_PO_GETITEMS");
            poItemsList.SetValue("PURCHASEORDER", purchaseOrderNumber);
            poItemsList.InvokeAndThrowOnAnyException(Destination);

            IRfcStructure poItem = poItemsList.GetTable("PO_ITEMS").FirstOrDefault(x => x.GetString("TRACKINGNO") == trackingNumber);
            if (poItem == null)
            {
                throw new ApplicationException(string.Format("Item {0} was not found within purchase order {1}", trackingNumber, purchaseOrderNumber));
            }

            return poItem;
        }

        public void UpdatePurchaseOrder(PurchaseOrderInfo agreementPayee)
        {
            agreementPayee.PurchaseOrderLines.ToList().ForEach(poLine => poLineFurtherUpdatingRequired.Add(poLine.Number, true));

            // when we are moving from multiple account assignments to 1 on a PO line there is a bug in that it doesn't 
            // let you change the DISTRIB setting on the PO line to 'Single Account Assignment'. The work around requires
            // a 3 step process for each affected PO line:
            //      1. delete the extra account assignments and temporarily delete the PO line
            //      2. set the DISTRIB field to single account assignment
            //      3. undelete the temporarily deleted PO line

            // loop 3 times to cover each step above
            for (int i = 0; i <= 2; i++)
            {
                ProcessUpdate(agreementPayee);

                if (!poLineFurtherUpdatingRequired.Values.Any(updatingRequired => updatingRequired == true)) break;
            }
        }

        #endregionPublicMethods

        #regionPrivateMethods

        void AddHeaderNote()
        {
            for (int i = 0; i < purchaseOrderInfo.Notes.Length; i++)
            {
                poTextHeader.Append();
                poTextHeader.CurrentRow.SetValue(SAP_PO_FIELD_POTEXTHEADER_TEXT_LINE, purchaseOrderInfo.Notes[i]);
                poTextHeader.CurrentRow.SetValue(SAP_PO_FIELD_POTEXTHEADER_TEXT_ID, IntToTextHeaderNumber(1));
                poTextHeader.CurrentRow.SetValue(SAP_PO_FIELD_POTEXTHEADER_TEXT_FORM, "*");
            }
        }

        void AddPOLineItem(PurchaseOrderLineInfo purchaseOrderLineInfo)
        {
            string poLineItemNumber = IntToPOLineItemNumber(poItemNumbers.Count + 1);

            poItems.Append();
            poItemsX.Append();

            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_PLANT, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_PLANT));
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_MATL_GROUP, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_MATL_GROUP));
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_PO_UNIT, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_PO_UNIT));
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_NET_PRICE, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_NET_PRICE));
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_PRICE_UNIT, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_PRICE_UNIT));
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_TAX_CODE, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_TAX_CODE));

            if (purchaseOrderLineInfo.TreatAsCompleted)
                poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_ACCTASSCAT, Configuration.Setting<string>(
                    SAPConfiguration.SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_COMPLETEDVAL));
            else
                poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_ACCTASSCAT, Configuration.Setting<string>(
                    SAPConfiguration.SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_NORMALVAL));

            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_PART_INV, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_PART_INV));

            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_PO_ITEM, poLineItemNumber, true);
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_SHORT_TEXT, string.Format("{0} {1}", purchaseOrderInfo.SourceReferenceType == PurchaseOrderSourceReferenceType.AgreementPayee ? "Payment Event" : "Agreement", purchaseOrderLineInfo.Number));
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_TRACKINGNO, purchaseOrderLineInfo.Number);
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_QUANTITY, purchaseOrderLineInfo.CurrencyAmount.ToString());

            if (purchaseOrderLineInfo.AccountAssignments.Length > 1)
                poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_DISTRIB, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_DISTRIB));

            poItemNumbers.Add(poLineItemNumber);
            poAccountAssignmentNumbers.Add(poLineItemNumber, new List<string>());
        }

        void AddPurchaseOrder()
        {
            poHeader.SetValue(poHeaderX, SAPConfiguration.SAP_PO_FIELD_POHEADER_COMP_CODE, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POHEADER_COMP_CODE));
            poHeader.SetValue(poHeaderX, SAPConfiguration.SAP_PO_FIELD_POHEADER_DOC_TYPE, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POHEADER_DOC_TYPE));
            poHeader.SetValue(poHeaderX, SAPConfiguration.SAP_PO_FIELD_POHEADER_PMNTTRMS, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POHEADER_PMNTTRMS));
            poHeader.SetValue(poHeaderX, SAPConfiguration.SAP_PO_FIELD_POHEADER_PURCH_ORG, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POHEADER_PURCH_ORG));
            poHeader.SetValue(poHeaderX, SAPConfiguration.SAP_PO_FIELD_POHEADER_PUR_GROUP, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POHEADER_PUR_GROUP));

            poHeader.SetValue(poHeaderX, SAP_PO_FIELD_POHEADER_REF_1, purchaseOrderInfo.SourceReferenceDisplayID);
            poHeader.SetValue(poHeaderX, SAP_PO_FIELD_POHEADER_VENDOR, purchaseOrderInfo.VendorNumber);
            poHeader.SetValue(poHeaderX, SAP_PO_FIELD_POHEADER_CURRENCY, purchaseOrderInfo.CurrencyCode);
        }

        void CloseSession()
        {
            RfcSessionManager.EndContext(Destination);
        }

        void DeleteAccountLineItem(IRfcStructure existingAccLineRow)
        {
            poAccountAssignments.Append();
            poAccountAssignmentsX.Append();

            poAccountAssignmentsX.CurrentRow.SetValue(SAP_PO_FIELD_POACCOUNT_PO_ITEMX, "X");
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_PO_ITEM, existingAccLineRow.GetValue(SAP_PO_FIELD_POACCOUNT_PO_ITEM).ToString(), true);
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_SERIAL_NO, existingAccLineRow.GetValue(SAP_PO_FIELD_POACCOUNT_SERIAL_NO).ToString(), true);
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_DELETE_IND, "X");
            existingPOAccountAssignments.Remove(existingAccLineRow);
        }

        void DeletePOLineItem(IRfcStructure existingPoLineRow)
        {
            poItems.Append();
            poItemsX.Append();

            poItemsX.CurrentRow.SetValue(SAP_PO_FIELD_POITEM_PO_ITEMX, "X");
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_PO_ITEM, existingPoLineRow.GetValue(SAP_PO_FIELD_POITEM_PO_ITEM).ToString(), true);
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_DELETE_IND, "X");
        }

        void DeletePurchaseOrder()
        {
            poHeader.SetValue(poHeaderX, SAP_PO_FIELD_POHEADER_DELETE_IND, "X");
        }

        AccountAssignmentInfo FindActivityAppSource(IRfcStructure accountAssignmentItem)
        {
            IRfcStructure existingPOItem = FindExistingPOItem(accountAssignmentItem.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM));
            PurchaseOrderLineInfo purchaseOrderLineInfo = existingPOItem == null ? null : FindPaymentEvent(existingPOItem);

            return purchaseOrderLineInfo == null ? null : purchaseOrderLineInfo.AccountAssignments.FirstOrDefault(r => r.WBSNumber == accountAssignmentItem.GetString(SAP_PO_FIELD_POACCOUNT_WBS_ELEMENT));
        }

        IRfcStructure FindExistingAccountAssignment(PurchaseOrderLineInfo purchaseOrderLineInfo, AccountAssignmentInfo accountAssignmentInfo)
        {
            IRfcStructure existingPOItem = FindExistingPOItem(purchaseOrderLineInfo);

            if (existingPOItem == null)
                return null;

            return existingPOAccountAssignments == null ? null : existingPOAccountAssignments.Cast<IRfcStructure>().FirstOrDefault(r =>
                                        r.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM) == existingPOItem.GetString(SAP_PO_FIELD_POITEM_PO_ITEM) &&
                                        r.GetString(SAP_PO_FIELD_POACCOUNT_WBS_ELEMENT) == accountAssignmentInfo.WBSNumber);
        }

        List<IRfcStructure> FindExistingAccountAssignments(IRfcStructure existingPOItem)
        {
            return existingPOAccountAssignments == null ? null : existingPOAccountAssignments.Cast<IRfcStructure>().Where(r =>
                                        r.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM) == existingPOItem.GetString(SAP_PO_FIELD_POITEM_PO_ITEM)).ToList();
        }

        IRfcStructure FindExistingPOItem(PurchaseOrderLineInfo purchaseOrderLineInfo)
        {
            return existingPOItems == null ? null : existingPOItems.Cast<IRfcStructure>().FirstOrDefault(r =>
                                                        r.GetString(SAP_PO_FIELD_POITEM_TRACKINGNO) == purchaseOrderLineInfo.Number);
        }

        IRfcStructure FindExistingPOItem(string poItemNumber)
        {
            return existingPOItems == null ? null : existingPOItems.Cast<IRfcStructure>().FirstOrDefault(r =>
                                                        r.GetString(SAP_PO_FIELD_POITEM_PO_ITEM) == poItemNumber);
        }

        PurchaseOrderLineInfo FindPaymentEvent(IRfcStructure poItem)
        {
            return purchaseOrderInfo.PurchaseOrderLines.FirstOrDefault(r => r.Number == poItem.GetString(SAP_PO_FIELD_POITEM_TRACKINGNO));
        }

        IRfcStructure FindPOItem(string poItemNumber)
        {
            return poItems.Cast<IRfcStructure>().FirstOrDefault(r => r.GetString(SAP_PO_FIELD_POITEM_TRACKINGNO) == poItemNumber);
        }

        IRfcStructure FindPOItem(PurchaseOrderLineInfo purchaseOrderLineInfo)
        {
            return poItems.Cast<IRfcStructure>().FirstOrDefault(r =>
                                            string.IsNullOrEmpty(r.GetString(SAP_PO_FIELD_POITEM_DELETE_IND)) &&
                                            r.GetString(SAP_PO_FIELD_POITEM_TRACKINGNO) == purchaseOrderLineInfo.Number);
        }

        string GetPOLineItemNumber(PurchaseOrderLineInfo purchaseOrderLineInfo)
        {
            IRfcStructure existingPOItem = FindExistingPOItem(purchaseOrderLineInfo);
            IRfcStructure poItem = FindPOItem(purchaseOrderLineInfo);

            if (existingPOItem == null && poItem == null)
                return null;

            if (poItem != null)
                return poItem.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM);

            return existingPOItem.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM);
        }

        void Initialise(PurchaseOrderInfo PurchaseOrderInfo, string functionName)
        {
            this.purchaseOrderInfo = PurchaseOrderInfo;

            RfcSessionManager.BeginContext(Destination);

            Destination.Repository.CreateFunction(SAP_FUNC_INITIALIZATION).InvokeAndThrowOnAnyException(Destination);

            if (PurchaseOrderInfo.PurchaseOrderNumber != null)
            {
                IRfcFunction getPurchaseOrder = Destination.Repository.CreateFunction(SAP_PO_FUNC_GETDETAIL);

                getPurchaseOrder.SetValue(SAP_PO_PARAM_PURCHASEORDER, PurchaseOrderInfo.PurchaseOrderNumber);
                getPurchaseOrder.SetValue(SAP_PO_PARAM_ACCOUNT_ASSIGNMENT, "X");

                getPurchaseOrder.InvokeAndThrowOnAnyException(Destination);

                LoadExistingSAPStructures(getPurchaseOrder);
            }

            function = Destination.Repository.CreateFunction(functionName);

            LoadSAPStructures(function);
        }

        string IntToAccLineItemNumber(int i)
        {
            return (i).ToString().PadLeft(2, '0');
        }

        string IntToPOLineItemNumber(int i)
        {
            return (i * 10).ToString().PadLeft(5, '0');
        }

        string IntToTextHeaderNumber(int i)
        {
            return "F" + (i).ToString().PadLeft(2, '0');
        }

        void LoadSAPStructures(IRfcFunction function)
        {
            poHeader = function.GetStructure(SAP_PO_PARAM_POHEADER);
            poHeaderX = function.GetStructure(SAP_PO_PARAM_POHEADERX);
            poTextHeader = function.GetTable(SAP_PO_PARAM_POTEXTHEADER);
            poTextHeaderItems = function.GetTable(SAP_PO_PARAM_POTEXTITEM);
            poItems = function.GetTable(SAP_PO_PARAM_POITEM);
            poItemsX = function.GetTable(SAP_PO_PARAM_POITEMX);
            poAccountAssignments = function.GetTable(SAP_PO_PARAM_POACCOUNT);
            poAccountAssignmentsX = function.GetTable(SAP_PO_PARAM_POACCOUNTX);
        }

        void LoadExistingSAPStructures(IRfcFunction function)
        {
            existingPOItems = function.GetTable(SAP_PO_PARAM_POITEM).ToList();
            existingPOAccountAssignments = function.GetTable(SAP_PO_PARAM_POACCOUNT).ToList();

            poAccountAssignmentNumbers = new Dictionary<string, List<string>>();
            poItemNumbers = new List<string>();

            foreach (IRfcStructure existingPOItem in existingPOItems)
            {
                string poLineItemNumber = existingPOItem.GetString(SAP_PO_FIELD_POITEM_PO_ITEM);
                poItemNumbers.Add(poLineItemNumber);

                poAccountAssignmentNumbers.Add(poLineItemNumber, new List<string>());

                foreach (IRfcStructure existingAccountAssignment in existingPOAccountAssignments.Cast<IRfcStructure>().Where(x => x.GetString(SAP_PO_FIELD_POITEM_PO_ITEM).Equals(poLineItemNumber)))
                {
                    poAccountAssignmentNumbers[poLineItemNumber].Add(existingAccountAssignment.GetString(SAP_PO_FIELD_POACCOUNT_SERIAL_NO));
                }
            }
        }

        bool IsPOLineUpdateInProcessForMultiToSingleAccountAssignments(PurchaseOrderLineInfo purchaseOrderLineInfo, IRfcStructure existingPOItem, out bool changingFromMultipleToSingleAssignment, out bool distribNeedsUpdating, out bool poLineNeedsUndeleting)
        {
            changingFromMultipleToSingleAssignment = purchaseOrderLineInfo.AccountAssignments.Length == 1 &&
                                                     FindExistingAccountAssignments(existingPOItem).Count > 1;

            distribNeedsUpdating = existingPOItem.GetString(SAP_PO_FIELD_POITEM_DELETE_IND).Length > 0 &&
                                    purchaseOrderLineInfo.AccountAssignments.Length == 1 &&
                                    existingPOItem.GetString(SAPConfiguration.SAP_PO_FIELD_POITEM_DISTRIB).Length > 0;

            poLineNeedsUndeleting = existingPOItem.GetString(SAP_PO_FIELD_POITEM_DELETE_IND).Length > 0 &&
                                    purchaseOrderLineInfo.AccountAssignments.Length == 1 &&
                                    existingPOItem.GetString(SAPConfiguration.SAP_PO_FIELD_POITEM_DISTRIB).Length == 0;

            return changingFromMultipleToSingleAssignment ||
                    distribNeedsUpdating ||
                    poLineNeedsUndeleting;
        }

        bool IsPOLineUpdateInProcessForMultiToSingleAccountAssignments(PurchaseOrderLineInfo purchaseOrderLineInfo, IRfcStructure existingPOItem)
        {
            bool changingFromMultipleToSingleAssignment;
            bool distribNeedsUpdating;
            bool poLineNeedsUndeleting;

            return IsPOLineUpdateInProcessForMultiToSingleAccountAssignments(purchaseOrderLineInfo, existingPOItem, out changingFromMultipleToSingleAssignment, out distribNeedsUpdating, out poLineNeedsUndeleting);
        }

        void ProcessStandardPOLineUpdate(PurchaseOrderLineInfo purchaseOrderLineInfo, IRfcStructure existingPOItem)
        {
            // standard update
            List<IRfcStructure> existingAssignments = FindExistingAccountAssignments(existingPOItem);

            //Make number of account assignments in SAP equal to the number of account assignments in purchaseOrderLineInfo
            while (purchaseOrderLineInfo.AccountAssignments.Length != existingAssignments.Count)
            {
                if (purchaseOrderLineInfo.AccountAssignments.Length > existingAssignments.Count)
                {
                    AddAccountLineItem(purchaseOrderLineInfo, purchaseOrderLineInfo.AccountAssignments[0]);
                }
                else if (purchaseOrderLineInfo.AccountAssignments.Length < existingAssignments.Count)
                {
                    DeleteAccountLineItem(existingAssignments[existingAssignments.Count - 1]);
                }

                existingAssignments = FindExistingAccountAssignments(existingPOItem);
            }

            //Now since both the counts are same, simply update account assignment with new data in purchaseOrderLineInfo
            for (int i = 0; i < purchaseOrderLineInfo.AccountAssignments.Length; i++)
            {
                UpdateAccountLineItem(purchaseOrderLineInfo, purchaseOrderLineInfo.AccountAssignments[i], existingAssignments[i]);
            }

            UpdatePOLineItem(purchaseOrderLineInfo, existingPOItem);
        }

        void ProcessPOLineUpdateForMultiToSingleAccountAssignments(PurchaseOrderLineInfo purchaseOrderLineInfo, IRfcStructure existingPOItem, out bool furtherProcessingRequired)
        {
            bool changingFromMultipleToSingleAssignment;
            bool distribNeedsUpdating;
            bool poLineNeedsUndeleting;

            // when there are > 1 existing account assignments and we need to delete all except one, there is a bug 
            // where we can't update the Distribution to 'Single Account Assignment'.
            // the workaround is to do it in the following steps which have to be invoked and committed separately, i.e.
            // this method will be called 3 times:

            //      1. delete the extra account assignments and temporarily delete the PO line
            //      2. set the DISTRIB field to single account assignment
            //      3. undelete the temporarily deleted PO line

            furtherProcessingRequired = true;

            IsPOLineUpdateInProcessForMultiToSingleAccountAssignments(purchaseOrderLineInfo, existingPOItem, out changingFromMultipleToSingleAssignment, out distribNeedsUpdating, out poLineNeedsUndeleting);

            if (changingFromMultipleToSingleAssignment)
            {
                // 1. delete the extra account assignments and temporarily delete the PO line
                DeletePOLineItem(existingPOItem);

                List<IRfcStructure> existingAssignments = FindExistingAccountAssignments(existingPOItem);

                // delete all except the first one - regardless of whether this is the one we want to delete
                // SAP expects the first one to stay
                for (int i = 0; i < existingAssignments.Count; i++)
                {
                    if (!existingAssignments[i].GetString(SAP_PO_FIELD_POACCOUNT_SERIAL_NO).EndsWith("01"))
                        DeleteAccountLineItem(existingAssignments[i]);
                }

            }
            else if (distribNeedsUpdating)
            {
                // 2. set the DISTRIB field to single account assignment
                UpdatePOLineItem(purchaseOrderLineInfo, existingPOItem);

                List<IRfcStructure> existingAssignments = FindExistingAccountAssignments(existingPOItem);

                // update the first account assignment (should only be one) with the correct GL, WBS Element etc..
                UpdateAccountLineItem(purchaseOrderLineInfo, purchaseOrderLineInfo.AccountAssignments[0], existingAssignments[0]);
            }
            else if (poLineNeedsUndeleting)
            {
                // 3. last step - undelete the temporarily deleted PO line
                UndeletePOLineItem(existingPOItem);

                furtherProcessingRequired = false;
            }
        }

        void ProcessUpdate(PurchaseOrderInfo agreementPayee)
        {
            try
            {
                if (agreementPayee.PurchaseOrderNumber == null)
                {
                    CreatePurchaseOrder(agreementPayee);
                }
                else
                {
                    // initialise
                    Initialise(agreementPayee, SAP_PO_FUNC_CHANGE);

                    function.SetValue(SAP_PO_PARAM_PURCHASEORDER, agreementPayee.PurchaseOrderNumber);

                    foreach (PurchaseOrderLineInfo purchaseOrderLineInfo in agreementPayee.PurchaseOrderLines)
                    {
                        bool furtherProcessingRequired;

                        // don't process po line if no further updates are required for that po line
                        if (poLineFurtherUpdatingRequired[purchaseOrderLineInfo.Number])
                        {
                            IRfcStructure existingPOItem = FindExistingPOItem(purchaseOrderLineInfo);

                            // doesn't exist - create
                            if (existingPOItem == null)
                            {
                                AddPOLineItem(purchaseOrderLineInfo);

                                for (int i = 0; i < purchaseOrderLineInfo.AccountAssignments.Length; i++)
                                    AddAccountLineItem(purchaseOrderLineInfo, purchaseOrderLineInfo.AccountAssignments[i]);

                                furtherProcessingRequired = false;
                            }
                            else
                            {
                                if (purchaseOrderLineInfo.Delete)
                                {
                                    // delete
                                    DeletePOLineItem(existingPOItem);
                                    furtherProcessingRequired = false;
                                }
                                else if (!string.IsNullOrEmpty(existingPOItem.GetString(SAP_PO_FIELD_POITEM_DELETE_IND)))
                                {
                                    // update for already delete PO line requires the following:
                                    //      1. undelete PO line
                                    //      2. carry out the actual update on the PO line

                                    UndeletePOLineItem(existingPOItem);
                                    furtherProcessingRequired = true;
                                }
                                else
                                {
                                    // standard update
                                    ProcessStandardPOLineUpdate(purchaseOrderLineInfo, existingPOItem);
                                    furtherProcessingRequired = false;
                                }

                                if (!purchaseOrderLineInfo.Delete
                                    && IsPOLineUpdateInProcessForMultiToSingleAccountAssignments(purchaseOrderLineInfo, existingPOItem))
                                {
                                    // multi to single account assignment update 
                                    ProcessPOLineUpdateForMultiToSingleAccountAssignments(purchaseOrderLineInfo, existingPOItem,
                                                    out furtherProcessingRequired);
                                }
                            }

                            poLineFurtherUpdatingRequired[purchaseOrderLineInfo.Number] = furtherProcessingRequired;
                        }
                    }

                    // invoke 
                    function.InvokeAndThrowOnAnyException(Destination);

                    Destination.PreCommitAndCommit();
                }
            }
            catch (Exception)
            {
                Destination.Rollback();

                throw;
            }
            finally
            {
                CloseSession();
            }
        }

        void UndeletePOLineItem(IRfcStructure existingPoLineRow)
        {
            poItems.Append();
            poItemsX.Append();

            poItemsX.CurrentRow.SetValue(SAP_PO_FIELD_POITEM_PO_ITEMX, "X");

            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_PO_ITEM, existingPoLineRow.GetString(SAP_PO_FIELD_POITEM_PO_ITEM), true);
            poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_DELETE_IND, " ");
        }

        void AddAccountLineItem(PurchaseOrderLineInfo purchaseOrderLineInfo, AccountAssignmentInfo activityAppSource)
        {
            string poLineItemNumber = GetPOLineItemNumber(purchaseOrderLineInfo);
            string lastAccountAssignmentNumber = poAccountAssignmentNumbers[poLineItemNumber].LastOrDefault();
            string accountItemNumber = IntToAccLineItemNumber(int.Parse(string.IsNullOrWhiteSpace(lastAccountAssignmentNumber) ? "00" : lastAccountAssignmentNumber) + 1);

            poAccountAssignments.Append();
            poAccountAssignmentsX.Append();

            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_PO_ITEM, poLineItemNumber, true);
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_SERIAL_NO, accountItemNumber, true);
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_GL_ACCOUNT, purchaseOrderLineInfo.GLAccountNumber);
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_WBS_ELEMENT, activityAppSource.WBSNumber);
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_QUANTITY, activityAppSource.CurrencyAmount.ToString());
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_NET_VALUE, activityAppSource.CurrencyAmount.ToString());
            poAccountAssignments.CurrentRow.SetValue(poAccountAssignmentsX.CurrentRow, SAP_PO_FIELD_POACCOUNT_TAX_CODE, "AZ");

            poAccountAssignmentNumbers[poLineItemNumber].Add(poAccountAssignments.CurrentRow.GetString(SAP_PO_FIELD_POACCOUNT_SERIAL_NO));

            existingPOAccountAssignments.Add(poAccountAssignments.CurrentRow);
        }

        void UpdateAccountLineItem(PurchaseOrderLineInfo purchaseOrderLineInfo, AccountAssignmentInfo activityAppSource, IRfcStructure existingAccLineRow)
        {
            string poLineItemNumber = existingAccLineRow.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM);
            string accountItemNumber = existingAccLineRow.GetString(SAP_PO_FIELD_POACCOUNT_SERIAL_NO);

            IRfcStructure poAccountAssRow = poAccountAssignments.FirstOrDefault(r =>
                string.Equals(r.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM), poLineItemNumber, StringComparison.InvariantCultureIgnoreCase) &&
                string.Equals(r.GetString(SAP_PO_FIELD_POACCOUNT_SERIAL_NO), accountItemNumber, StringComparison.InvariantCultureIgnoreCase));

            if (poAccountAssRow == null)
            {
                poAccountAssignments.Append();
                poAccountAssRow = poAccountAssignments.CurrentRow;
            }

            IRfcStructure poAccountAssXRow = poAccountAssignmentsX.FirstOrDefault(r =>
                string.Equals(r.GetString(SAP_PO_FIELD_POACCOUNT_PO_ITEM) == poLineItemNumber, StringComparison.InvariantCultureIgnoreCase) &&
                string.Equals(r.GetString(SAP_PO_FIELD_POACCOUNT_SERIAL_NO) == accountItemNumber, StringComparison.InvariantCultureIgnoreCase));

            if (poAccountAssXRow == null)
            {
                poAccountAssignmentsX.Append();
                poAccountAssXRow = poAccountAssignmentsX.CurrentRow;
            }

            poAccountAssXRow.SetValue(SAP_PO_FIELD_POACCOUNT_PO_ITEMX, "X");

            // these fields are needed because they are keys
            poAccountAssRow.SetValue(poAccountAssXRow, SAP_PO_FIELD_POACCOUNT_PO_ITEM, poLineItemNumber, true);
            poAccountAssRow.SetValue(poAccountAssXRow, SAP_PO_FIELD_POACCOUNT_SERIAL_NO, accountItemNumber, true);

            // these are the fields that can change
            poAccountAssRow.SetValueIfDifferent(existingAccLineRow, poAccountAssXRow, SAP_PO_FIELD_POACCOUNT_QUANTITY, activityAppSource.CurrencyAmount.ToString());
            poAccountAssRow.SetValueIfDifferent(existingAccLineRow, poAccountAssXRow, SAP_PO_FIELD_POACCOUNT_NET_VALUE, activityAppSource.CurrencyAmount.ToString());

            poAccountAssRow.SetValueIfDifferent(existingAccLineRow, poAccountAssXRow, SAP_PO_FIELD_POACCOUNT_GL_ACCOUNT, purchaseOrderLineInfo.GLAccountNumber);
            poAccountAssRow.SetValueIfDifferent(existingAccLineRow, poAccountAssXRow, SAP_PO_FIELD_POACCOUNT_WBS_ELEMENT, activityAppSource.WBSNumber);
        }

        void UpdatePOLineItem(PurchaseOrderLineInfo purchaseOrderLineInfo, IRfcStructure existingPoLineRow)
        {
            string poLineItemNumber = existingPoLineRow.GetString(SAP_PO_FIELD_POITEM_PO_ITEM);

            poItems.Append();
            poItemsX.Append();

            poItemsX.CurrentRow.SetValue(SAP_PO_FIELD_POITEM_PO_ITEMX, "X");

            // this is a key field
            poItems.CurrentRow.SetValue(poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_PO_ITEM, poLineItemNumber, true);

            // quantity can change
            poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAP_PO_FIELD_POITEM_QUANTITY, purchaseOrderLineInfo.CurrencyAmount.ToString());

            if (purchaseOrderLineInfo.TreatAsCompleted)
            {
                poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_ACCTASSCAT, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_COMPLETEDVAL));
            }
            else
            {
                poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_ACCTASSCAT, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_VALUE_ACCTASSCAT_NORMALVAL));
            }

            // the number of account assignments can also change
            if (purchaseOrderLineInfo.AccountAssignments.Length > 1)
            {
                poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_DISTRIB, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_DISTRIB));
                poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_PART_INV, Configuration.Setting<string>(SAPConfiguration.SAP_PO_FIELD_POITEM_PART_INV));
            }
            else if (purchaseOrderLineInfo.AccountAssignments.Length == 1)
            {
                poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_DISTRIB, " ");
                poItems.CurrentRow.SetValueIfDifferent(existingPoLineRow, poItemsX.CurrentRow, SAPConfiguration.SAP_PO_FIELD_POITEM_PART_INV, " ");
            }
        }

        #endregion
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPServer.Service.SAP.csproj
9235
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProjectGuid>{5CC3AB74-43CE-474B-BC73-A37AFA62A9DC}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>SAPServer.Service.SAP</RootNamespace>
    <AssemblyName>SAPServer.Service.SAP</AssemblyName>
    <TargetFrameworkVersion>v4.5.1</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <SccProjectName>SAK</SccProjectName>
    <SccLocalPath>SAK</SccLocalPath>
    <SccAuxPath>SAK</SccAuxPath>
    <SccProvider>SAK</SccProvider>
    <TargetFrameworkProfile />
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>x64</PlatformTarget>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>x64</PlatformTarget>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x86'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\x86\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x86'">
    <OutputPath>bin\x86\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x64'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\x64\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x64'">
    <OutputPath>bin\x64\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="ApplicationManagement.Contract, Version=1.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\ApplicationManagement.Contract.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Common, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Common.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging, Version=5.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Logging, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.ServiceLocation, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.ServiceLocation.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity, Version=3.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Configuration, Version=2.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Configuration.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Interception, Version=3.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Interception.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.ConnectionInfo, Version=10.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.ConnectionInfo.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.Smo, Version=10.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.Smo.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.SqlEnum, Version=10.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.SqlEnum.dll</HintPath>
    </Reference>
    <Reference Include="sapnco">
      <HintPath>..\ThirdPartyComponents\sapnco.dll</HintPath>
    </Reference>
    <Reference Include="sapnco_utils">
      <HintPath>..\ThirdPartyComponents\sapnco_utils.dll</HintPath>
    </Reference>
    <Reference Include="ServiceBus.Contract">
      <HintPath>..\ThirdPartyComponents\ServiceBus.Contract.dll</HintPath>
    </Reference>
    <Reference Include="System" />
    <Reference Include="System.Core" />
    <Reference Include="System.Xml.Linq" />
    <Reference Include="System.Data.DataSetExtensions" />
    <Reference Include="Microsoft.CSharp" />
    <Reference Include="System.Data" />
    <Reference Include="System.Xml" />
  </ItemGroup>
  <ItemGroup>
    <Compile Include="Properties\AssemblyInfo.cs" />
    <Compile Include="SAPActualExpenseJournal.cs" />
    <Compile Include="SAPExchangeRate.cs" />
    <Compile Include="SAPGLAccounts.cs" />
    <Compile Include="SAPGoodsReceipt.cs" />
    <Compile Include="SAPJournal.cs" />
    <Compile Include="SAPObject.cs" />
    <Compile Include="SAPProgramStructure.cs" />
    <Compile Include="SAPProject.cs" />
    <Compile Include="SAPPurchaseOrder.cs" />
    <Compile Include="SAPVendors.cs" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\SAPServer.Core\SAPServer.Core.csproj">
      <Project>{7bc07e5b-7e00-4ce2-9344-0e62822bcd23}</Project>
      <Name>SAPServer.Core</Name>
    </ProjectReference>
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <!-- To modify your build process, add your task inside one of the targets below and uncomment it. 
       Other similar extension points exist, see Microsoft.Common.targets.
  <Target Name="BeforeBuild">
  </Target>
  <Target Name="AfterBuild">
  </Target>
  -->
</Project>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP
SAPVendors.cs
3715
using System;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;
using SAPServer.Core;

namespace SAPServer.Service.SAP

{
    public class SAPVendors : SAPObject
    {
        #regionFields

        #endregionFields

        #region Constructors

        public SAPVendors(RfcDestination destination, ISAPConfiguration configuration)
            : base(destination, configuration)
        {
        }

        #endregion

        #regionPublicMethods

        public SAPVendor GetVendor(string vendorNo)
        {

            // SAP stores all Vendor numbers as char(10), even though the SAP interface hides any leading zeros from users.
            // e.g. a Vendor with number 400392 (*displayed* in SAP) is actually *stored* in SAP as 0000400392 (note the zeros "padding" the number)
            if (vendorNo.Length != 10)
            {
                throw new InvalidOperationException(string.Format("Vendor No '{0}' is invalid: it must be 10 characters in length.", vendorNo));
            }

            // BAPI_VENDOR_GETDETAIL is a standard BAPI function in SAP used to get Vendor details
            // However, this function does not return the "VAT Registration No" (which holds the ABN) or other fields (like blocking codes or Great Plains number)
            // Thus, we have created a custom function called Z_BAPI_VENDOR_GETDETAIL, which
            // wraps the original function and also returns extra fields such as the VAT_REG_NO and blocking codes.
            // Here, we call the custom function:

            IRfcFunction function = Destination.Repository.CreateFunction("Z_BAPI_VENDOR_GETDETAIL");
            function.SetValue("VENDORNO", vendorNo);
            function.SetValue("COMPANYCODE", Configuration.Setting<string>(SAPConfiguration.SAP_VENDOR_COMPANYCODE));
            function.SetValue("PURCH_ORG", Configuration.Setting<string>(SAPConfiguration.SAP_VENDOR_PURCH_ORG));
            function.InvokeAndThrowOnAnyException(Destination);

            IRfcStructure generalDetail = function.GetStructure("GENERALDETAIL");
            IRfcStructure companyDetail = function.GetStructure("COMPANYDETAIL");
            IRfcTable bankDetails = function.GetTable("BANKDETAIL");

            // convert these loose SAP structures into a more solid object (SAPVendor)
            return new SAPVendor
            {
                VendorNo = vendorNo,
                NameLine1 = generalDetail.GetString("NAME"),
                NameLine2 = generalDetail.GetString("NAME_2"),
                NameLine3 = generalDetail.GetString("NAME_3"),
                NameLine4 = generalDetail.GetString("NAME_4"),
                // as explained above, SAP does *not* return these fields through its standard BAPI function, hence the custom function
                VATRegNo = generalDetail.GetString("VAT_REG_NO"),
                PostingBlock = SAPExtensions.IsTrue(generalDetail.GetString("PSTG_BLK_G")),
                PurchasingBlock = SAPExtensions.IsTrue(generalDetail.GetString("PSTG_BLK_P")),
                GreatPlainsVendorNo = companyDetail.GetString("PREVIOUS_NUMBER"),
                BankDetails = bankDetails.Select(x => new SAPVendorBankDetail
                {
                    Key = x.GetString("BANK_KEY"),
                    AccountNo = x.GetString("BANK_ACCT"),
                    ControlKey = x.GetString("CTRL_KEY"),
                    PartnerType = x.GetString("PARTNER_BK"),
                    Reference = x.GetString("BANK_REF"),
                }).ToList(),
            };
        }

        #endregion
    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Service.SAP\Properties
AssemblyInfo.cs
1450
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;

// General Information about an assembly is controlled through the following 
// set of attributes. Change these attribute values to modify the information
// associated with an assembly.
[assembly: AssemblyTitle("SAPServer.Service.SAP")]
[assembly: AssemblyDescription("")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyCompany("")]
[assembly: AssemblyProduct("SAPServer.Service.SAP")]
[assembly: AssemblyCopyright("Copyright   2015")]
[assembly: AssemblyTrademark("")]
[assembly: AssemblyCulture("")]

// Setting ComVisible to false makes the types in this assembly not visible 
// to COM components.  If you need to access a type in this assembly from 
// COM, set the ComVisible attribute to true on that type.
[assembly: ComVisible(false)]

// The following GUID is for the ID of the typelib if this project is exposed to COM
[assembly: Guid("b8610b33-13c8-4008-882e-5f59d3811870")]

// Version information for an assembly consists of the following four values:
//
//      Major Version
//      Minor Version 
//      Build Number
//      Revision
//
// You can specify all the values or you can default the Build and Revision Numbers 
// by using the '*' as shown below:
// [assembly: AssemblyVersion("1.0.*")]
[assembly: AssemblyVersion("1.0.0.0")]
[assembly: AssemblyFileVersion("1.0.0.0")]

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web
SAPGoodsReceipt.cs
5838
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.Model;

namespace SAPServer.Web
{
    public class SAPGoodsReceipt : SAPObject
    {
        #region Constructors

        public SAPGoodsReceipt(RfcDestination destination, ISAPConfiguration Configuration)
            : base(destination, Configuration)
        {
        }

        #endregion

        public ReplicateGoodsReceiptNumber CreateGoodsReceipt(GoodsReceiptInfo goodsReceiptInfo)
        {
            RfcSessionManager.BeginContext(Destination);

            string purchaseOrderNumber = goodsReceiptInfo.PurchaseOrderNo.PadLeft(10, '0');

            try
            {
                Destination.Initialise();

                IRfcFunction function = Destination.Repository.CreateFunction("BAPI_GOODSMVT_CREATE");

                IRfcStructure header = function.GetStructure("GOODSMVT_HEADER");
                header.SetValue("PSTNG_DATE", goodsReceiptInfo.PostingDate);

                IRfcStructure code = function.GetStructure("GOODSMVT_CODE");
                code.SetValue("GM_CODE", "01");

                foreach (GoodsReceiptItemInfo goodsReceiptItem in goodsReceiptInfo.Items)
                {
                    // the PO line could have either a payment event number for AidWorks purchase orders OR an agreement number for OASIS purchase orders
                    IRfcStructure purchaseOrderItem = new SAPPurchaseOrder(Destination, Configuration).GetPurchaseOrderItem(purchaseOrderNumber,
                            goodsReceiptInfo.GoodsReceiptType == GoodsReceiptType.AidWorks ?
                            goodsReceiptItem.PaymentEventNumber : goodsReceiptItem.AgreementNumber);

                    string purchaseOrderItemNumber = purchaseOrderItem.GetString("PO_ITEM");

                    IRfcTable item = function.GetTable("GOODSMVT_ITEM");
                    item.Append();
                    item.SetValue("MOVE_TYPE", "101");
                    item.SetValue("ENTRY_UOM", "EA");
                    item.SetValue("MVT_IND", "B");
                    item.SetValue("PO_NUMBER", purchaseOrderNumber);
                    item.SetValue("PO_ITEM", purchaseOrderItemNumber);
                    item.SetValue("ENTRY_QNT", goodsReceiptItem.Amount);
                }

                function.InvokeAndThrowOnAnyException(Destination);

                IRfcStructure returnHeader = function.GetStructure("GOODSMVT_HEADRET");
                string materialDocument = returnHeader.GetString("MAT_DOC");

                Destination.PreCommitAndCommit();

                return new ReplicateGoodsReceiptNumber { GoodsReceiptNumber = materialDocument, Items = goodsReceiptInfo.Items };
            }
            catch (Exception)
            {
                Destination.Rollback();
                throw;
            }
            finally
            {
                RfcSessionManager.EndContext(Destination);
            }

        }

        public PurchaseOrderLines GetGoodsReceiptAccountAssignmentAmounts(AccountAssignmentAmountRequest request)
        {
            IRfcFunction getGoodsReceipt = Destination.Repository.CreateFunction(ActualExpenseJournalBuilder.SAP_FUNC_GOODS_RECEIPT);
            IRfcFunction getPurchaseOrder = Destination.Repository.CreateFunction(SAPPurchaseOrder.SAP_PO_FUNC_GETDETAIL);
            List<PurchaseOrderLineInfo> poLines = new List<PurchaseOrderLineInfo>();

            getGoodsReceipt.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_HEADER_MATERIALDOCUMENT, request.GoodsReceiptNumber);
            getGoodsReceipt.SetValue(ActualExpenseJournalBuilder.SAP_FIELD_HEADER_MATDOCUMENTYEAR, request.Year);
            getGoodsReceipt.InvokeAndThrowOnAnyException(Destination);

            List<IRfcStructure> goodsReceiptItems = getGoodsReceipt.GetTable(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM).ToList();

            getPurchaseOrder.SetValue(SAPPurchaseOrder.SAP_PO_PARAM_PURCHASEORDER, request.PurchaseOrderNumber);
            getPurchaseOrder.SetValue(SAPPurchaseOrder.SAP_PO_PARAM_ACCOUNT_ASSIGNMENT, "X");
            getPurchaseOrder.InvokeAndThrowOnAnyException(Destination);

            List<IRfcStructure> existingPOItems = getPurchaseOrder.GetTable(SAPPurchaseOrder.SAP_PO_PARAM_POITEM).ToList();

            foreach (IRfcStructure poLine in existingPOItems)
            {
                PurchaseOrderLineInfo line = new PurchaseOrderLineInfo();
                List<AccountAssignmentInfo> accAssignments = new List<AccountAssignmentInfo>();
                List<IRfcStructure> poLineGoodsReceiptItems = goodsReceiptItems.Where(x => x.GetString(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM_PO_ITEM) == poLine.GetString(SAPPurchaseOrder.SAP_PO_FIELD_POITEM_PO_ITEM)).ToList();

                foreach (IRfcStructure poLineGoodsReceiptItem in poLineGoodsReceiptItems)
                {
                    AccountAssignmentInfo ass = new AccountAssignmentInfo();
                    ass.WBSNumber = poLineGoodsReceiptItem.GetString(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM_WBS_ELEM);
                    ass.CurrencyAmount = decimal.Parse(poLineGoodsReceiptItem.GetString(ActualExpenseJournalBuilder.SAP_FIELD_GOODS_RECEIPT_ITEM_ENTRY_QNT));
                    accAssignments.Add(ass);
                }

                line.Number = poLine.GetString(SAPPurchaseOrder.SAP_PO_FIELD_POITEM_TRACKINGNO);
                line.AccountAssignments = accAssignments.ToArray();

                poLines.Add(line);
            }

            return new PurchaseOrderLines { Lines = poLines.ToArray() };
        }

    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web
SAPObject.cs
834
using System;
using System.Collections.Generic;
using System.Linq;
using SAP.Middleware.Connector;
using ServiceBus.Contract.Model;
using ServiceBus.Contract;

namespace SAPServer.Web
{
    public abstract class SAPObject
    {
        readonly ISAPConfiguration configuration;
        readonly RfcDestination destination;

        #region Constructors

        public SAPObject(RfcDestination destination, ISAPConfiguration configuration)
        {
            this.destination = destination;
            this.configuration = configuration;
        }

        #endregion

        protected ISAPConfiguration Configuration
        {
            get { return configuration; }
        }

        protected RfcDestination Destination
        {
            get { return destination; }
        }

    }
}
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web
SAPServer.Web.csproj
14031
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProductVersion>
    </ProductVersion>
    <SchemaVersion>2.0</SchemaVersion>
    <ProjectGuid>{08869686-03B6-46D8-B7A4-F00EED4D849E}</ProjectGuid>
    <ProjectTypeGuids>{349c5851-65df-11da-9384-00065b846f21};{fae04ec0-301f-11d3-bf4b-00c04f79efbc}</ProjectTypeGuids>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>SAPServer.Web</RootNamespace>
    <AssemblyName>SAPServer.Web</AssemblyName>
    <TargetFrameworkVersion>v4.5.1</TargetFrameworkVersion>
    <WcfConfigValidationEnabled>True</WcfConfigValidationEnabled>
    <AutoGenerateBindingRedirects>true</AutoGenerateBindingRedirects>
    <UseIISExpress>true</UseIISExpress>
    <IISExpressSSLPort />
    <IISExpressAnonymousAuthentication>enabled</IISExpressAnonymousAuthentication>
    <IISExpressWindowsAuthentication>enabled</IISExpressWindowsAuthentication>
    <IISExpressUseClassicPipelineMode />
    <SccProjectName>SAK</SccProjectName>
    <SccLocalPath>SAK</SccLocalPath>
    <SccAuxPath>SAK</SccAuxPath>
    <SccProvider>SAK</SccProvider>
    <UseGlobalApplicationHostFile />
    <TargetFrameworkProfile />
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>x64</PlatformTarget>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <PlatformTarget>AnyCPU</PlatformTarget>
    <Prefer32Bit>false</Prefer32Bit>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="ApplicationManagement.Contract">
      <HintPath>..\ThirdPartyComponents\ApplicationManagement.Contract.dll</HintPath>
    </Reference>
    <Reference Include="EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\EntityFramework.dll</HintPath>
    </Reference>
    <Reference Include="EntityFramework.SqlServer">
      <HintPath>..\ThirdPartyComponents\EntityFramework.SqlServer.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.CSharp" />
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Common, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Common.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging, Version=5.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.EnterpriseLibrary.Logging, Version=2.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.EnterpriseLibrary.Logging.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.ServiceLocation, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.ServiceLocation.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity, Version=3.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Configuration, Version=2.0.414.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Configuration.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.Practices.Unity.Interception, Version=3.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.Practices.Unity.Interception.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.ConnectionInfo, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.ConnectionInfo.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.Management.Sdk.Sfc, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.Management.Sdk.Sfc.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.Smo, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.Smo.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.SqlClrProvider, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.SqlClrProvider.dll</HintPath>
    </Reference>
    <Reference Include="Microsoft.SqlServer.SqlEnum, Version=11.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\Microsoft.SqlServer.SqlEnum.dll</HintPath>
    </Reference>
    <Reference Include="sapnco, Version=3.0.0.42, Culture=neutral, PublicKeyToken=50436dca5c7f7d23, processorArchitecture=AMD64">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\sapnco.dll</HintPath>
    </Reference>
    <Reference Include="sapnco_utils, Version=3.0.0.42, Culture=neutral, PublicKeyToken=50436dca5c7f7d23, processorArchitecture=AMD64">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\sapnco_utils.dll</HintPath>
    </Reference>
    <Reference Include="ServiceBus.Contract, Version=1.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>..\ThirdPartyComponents\ServiceBus.Contract.dll</HintPath>
    </Reference>
    <Reference Include="System.Transactions" />
    <Reference Include="System.Web.DynamicData" />
    <Reference Include="System.Web.Entity" />
    <Reference Include="System.Web.ApplicationServices" />
    <Reference Include="System" />
    <Reference Include="System.Configuration" />
    <Reference Include="System.Data" />
    <Reference Include="System.Drawing" />
    <Reference Include="System.EnterpriseServices" />
    <Reference Include="System.Runtime.Serialization" />
    <Reference Include="System.ServiceModel" />
    <Reference Include="System.ServiceModel.Web" />
    <Reference Include="System.Web" />
    <Reference Include="System.Web.Services" />
    <Reference Include="System.Xml" />
  </ItemGroup>
  <ItemGroup>
    <Content Include="Services\SAPFSRService.svc" />
    <Content Include="Services\SAPService.svc" />
    <Content Include="Services\SAPServiceStub.svc" />
    <Content Include="Web.config">
      <SubType>Designer</SubType>
    </Content>
  </ItemGroup>
  <ItemGroup>
    <Compile Include="Services\SAPFSRService.svc.cs">
      <DependentUpon>SAPFSRService.svc</DependentUpon>
    </Compile>
    <Compile Include="Services\SAPService.svc.cs">
      <DependentUpon>SAPService.svc</DependentUpon>
    </Compile>
    <Compile Include="Properties\AssemblyInfo.cs" />
    <Compile Include="Services\SAPServiceStub.svc.cs">
      <DependentUpon>SAPServiceStub.svc</DependentUpon>
    </Compile>
  </ItemGroup>
  <ItemGroup>
    <Folder Include="App_Data\" />
  </ItemGroup>
  <ItemGroup>
    <None Include="Properties\PublishProfiles\TFSBuildPublish.pubxml" />
    <None Include="Web.Release.config">
      <DependentUpon>Web.config</DependentUpon>
    </None>
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\SAPServer.Core\SAPServer.Core.csproj">
      <Project>{7bc07e5b-7e00-4ce2-9344-0e62822bcd23}</Project>
      <Name>SAPServer.Core</Name>
    </ProjectReference>
    <ProjectReference Include="..\SAPServer.Data.FSR\SAPServer.Data.FSR.csproj">
      <Project>{80d1f2de-8c32-46b5-9701-b7e7857ef8de}</Project>
      <Name>SAPServer.Data.FSR</Name>
    </ProjectReference>
    <ProjectReference Include="..\SAPServer.Service.FSR\SAPServer.Service.FSR.csproj">
      <Project>{2a0bf21e-f2fe-4d98-9cbb-5ea73533b327}</Project>
      <Name>SAPServer.Service.FSR</Name>
    </ProjectReference>
    <ProjectReference Include="..\SAPServer.Service.SAP\SAPServer.Service.SAP.csproj">
      <Project>{5cc3ab74-43ce-474b-bc73-a37afa62a9dc}</Project>
      <Name>SAPServer.Service.SAP</Name>
    </ProjectReference>
  </ItemGroup>
  <PropertyGroup>
    <VisualStudioVersion Condition="'$(VisualStudioVersion)' == ''">12.0</VisualStudioVersion>
    <VSToolsPath Condition="'$(VSToolsPath)' == ''">$(MSBuildExtensionsPath32)\Microsoft\VisualStudio\v$(VisualStudioVersion)</VSToolsPath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x86'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x86'">
    <OutputPath>bin\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x86</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Debug|x64'">
    <DebugSymbols>true</DebugSymbols>
    <OutputPath>bin\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <DebugType>full</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)' == 'Release|x64'">
    <OutputPath>bin\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <Optimize>true</Optimize>
    <DebugType>pdbonly</DebugType>
    <PlatformTarget>x64</PlatformTarget>
    <ErrorReport>prompt</ErrorReport>
    <CodeAnalysisRuleSet>MinimumRecommendedRules.ruleset</CodeAnalysisRuleSet>
  </PropertyGroup>
  <Import Project="$(MSBuildBinPath)\Microsoft.CSharp.targets" />
  <Import Project="$(VSToolsPath)\WebApplications\Microsoft.WebApplication.targets" Condition="'$(VSToolsPath)' != ''" />
  <Import Project="$(MSBuildExtensionsPath32)\Microsoft\VisualStudio\v10.0\WebApplications\Microsoft.WebApplication.targets" Condition="false" />
  <ProjectExtensions>
    <VisualStudio>
      <FlavorProperties GUID="{349c5851-65df-11da-9384-00065b846f21}">
        <WebProjectProperties>
          <UseIIS>True</UseIIS>
          <AutoAssignPort>True</AutoAssignPort>
          <DevelopmentServerPort>41240</DevelopmentServerPort>
          <DevelopmentServerVPath>/</DevelopmentServerVPath>
          <IISUrl>http://localhost:41240/</IISUrl>
          <NTLMAuthentication>False</NTLMAuthentication>
          <UseCustomServer>False</UseCustomServer>
          <CustomServerUrl>
          </CustomServerUrl>
          <SaveServerSettingsInUserFile>False</SaveServerSettingsInUserFile>
        </WebProjectProperties>
      </FlavorProperties>
    </VisualStudio>
  </ProjectExtensions>
  <!-- To modify your build process, add your task inside one of the targets below and uncomment it. 
       Other similar extension points exist, see Microsoft.Common.targets.
  <Target Name="BeforeBuild">
  </Target>
  <Target Name="AfterBuild">
  </Target>
  -->
</Project>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web
Web.config
18788
<?xml version="1.0"?>
<configuration>
  <configSections>
    <section name="loggingConfiguration" type="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.LoggingSettings, Microsoft.Practices.EnterpriseLibrary.Logging" requirePermission="true" />
    <section name="exceptionHandling" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Configuration.ExceptionHandlingSettings, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling" requirePermission="true" />
    <section name="unity" type="Microsoft.Practices.Unity.Configuration.UnityConfigurationSection, Microsoft.Practices.Unity.Configuration" requirePermission="true" />
    <section name="sapDataTypeMapping" type="SAPServer.Core.SAPDataTypeConfiguration, SAPServer.Core"/>
	  <section name="instrumentationConfiguration" type="Microsoft.Practices.EnterpriseLibrary.Common.Instrumentation.Configuration.InstrumentationConfigurationSection, Microsoft.Practices.EnterpriseLibrary.Common" requirePermission="true"/>
    <section name="entityFramework" type="System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" requirePermission="false" />
  </configSections>
  <instrumentationConfiguration eventLoggingEnabled="true"/>
  <entityFramework>
    <defaultConnectionFactory type="System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework">
      <parameters>
        <parameter value="v12.0" />
      </parameters>
    </defaultConnectionFactory>
    <providers>
      <provider invariantName="System.Data.SqlClient" type="System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer" />
    </providers>
  </entityFramework>
  <appSettings>
    <add key="aspnet:UseTaskFriendlySynchronizationContext" value="true" />
    <add key="SAPConfiguration" value="NAME=DEFAULT_DESTINATION,ASHOST=deva-ap00263L,USER=AID_MGMNT,PASSWD=@id_mgmnt,CLIENT=100" />
    <add key="BankAccountMaxLength" value="20" />
    <add key="ZeroDecimalPlaceCurrencies" value="VUV" />
    <add key="FSRBatchIncrementInMonths" value="1" />
  </appSettings>
  <connectionStrings>
    <add name="ApplicationServices" connectionString="data Source=DEVA-DB00126L,31000;Initial Catalog=aspnetdb;Integrated Security=SSPI;Application Name=ServiceBus;" providerName="System.Data.SqlClient" />
    <add name="SystemReconciliationContext" connectionString="metadata=res://*/SystemReconciliationModel.csdl|res://*/SystemReconciliationModel.ssdl|res://*/SystemReconciliationModel.msl;provider=System.Data.SqlClient;provider connection string=&quot;data source=DEVA-DB00126L,31000;initial catalog=SystemReconciliation;integrated security=True;MultipleActiveResultSets=True;App=EntityFramework&quot;" providerName="System.Data.EntityClient" />
  </connectionStrings>
  <exceptionHandling>
    <exceptionPolicies>
      <add name="Global Policy">
        <exceptionTypes>
          <add name="All Exceptions" type="System.Exception, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" postHandlingAction="None">
            <exceptionHandlers>
              <add name="Logging Handler" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.LoggingExceptionHandler, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging" logCategory="Default Category" eventId="100" severity="Error"
                   title="Enterprise Library Exception Handling for the Service Bus" priority="0"
                   formatterType="SAPServer.Core.TextExceptionFormatter, SAPServer.Core"/>
            </exceptionHandlers>
          </add>
        </exceptionTypes>
      </add>
    </exceptionPolicies>
  </exceptionHandling>
  <loggingConfiguration defaultCategory="Default Category" tracingEnabled="true">
    <logFilters>
      <add name="Category" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.CategoryFilter, Microsoft.Practices.EnterpriseLibrary.Logging" categoryFilterMode="AllowAllExceptDenied"/>
      <add name="Priority" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.PriorityFilter, Microsoft.Practices.EnterpriseLibrary.Logging" minimumPriority="0"/>
    </logFilters>
    <categorySources>
      <add name="Default Category" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </add>
      <add name="Diagnostics" switchValue="All">
        <listeners>
          <add name="Diagnostics" />
        </listeners>
      </add>
    </categorySources>
    <specialSources>
      <errors name="errors" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </errors>
    </specialSources>
    <listeners>
      <add name="Event Log" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.FormattedEventLogTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging" listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.FormattedEventLogTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           log="SAPInterface" machineName="." source="SAPInterface Web" formatter="Default Formatter"/>
      <add name="WCF Log" type="SAPServer.Core.WCFLogListener, SAPServer.Core" formatter="Default Formatter" listenerDataType="SAPServer.Core.WCFLogListenerData, SAPServer.Core"
           logName="SAPServerWebInterface" serviceAddress="http://appsupport.atlas.satin.lo/Services/ErrorLoggerService.svc"/>
      <add name="Diagnostics" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.RollingFlatFileTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging"
           listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.RollingFlatFileTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           fileName="diagnostics.log" footer="----------------" formatter="MessageOnlyTextFormatter" header="" rollFileExistsBehavior="Increment"
           rollInterval="Day" maxArchivedFiles="30" />
    </listeners>
    <formatters>
      <add name="Default Formatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="Timestamp: {timestamp} Message: {message} Category: {category} Priority: {priority} EventId: {eventid} Severity: {severity} Title:{title} Machine: {machine} Application Domain: {appDomain} Process Id: {processId} Process Name: {processName} Win32 Thread Id: {win32ThreadId} Thread Name: {threadName} Extended Properties: {dictionary({key} - {value})}"/>
      <add name="MessageOnlyTextFormatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="{timestamp(local:dd/MM/yyyy H:mm:ss.fff)}: {message}" />
    </formatters>
  </loggingConfiguration>
  <unity xmlns="http://schemas.microsoft.com/practices/2010/unity">
    <alias type="SAPServer.Core.ISAPConfiguration, SAPServer.Core" alias="ISAPConfiguration" />
    <alias type="SAPServer.Core.SAPConfiguration, SAPServer.Core" alias="SAPConfiguration" />
    <alias type="SAPServer.Core.IClassFactory, SAPServer.Core" alias="IClassFactory" />
    <alias type="SAPServer.Core.ClassFactory, SAPServer.Core" alias="ClassFactory" />
    <alias type="SAPServer.Core.ITransactionScopeFactory, SAPServer.Core" alias="ITransactionScopeFactory" />
    <alias type="SAPServer.Core.TransactionScopeFactory, SAPServer.Core" alias="TransactionScopeFactory" />
    <alias type="SAPServer.Service.FSR.ISAPFSR, SAPServer.Service.FSR" alias="ISAPFSR" />
    <alias type="SAPServer.Service.FSR.SAPFSR, SAPServer.Service.FSR" alias="SAPFSR" />
    <alias type="SAPServer.Service.FSR.IFSRReportConfiguration, SAPServer.Service.FSR" alias="IFSRReportConfiguration" />
    <alias type="SAPServer.Service.FSR.FSRReportConfiguration, SAPServer.Service.FSR" alias="FSRReportConfiguration" />
    <alias type="SAPServer.Data.FSR.ISystemReconciliationDataAccess, SAPServer.Data.FSR" alias="ISystemReconciliationDataAccess" />
    <alias type="SAPServer.Data.FSR.SystemReconciliationDataAccess, SAPServer.Data.FSR" alias="SystemReconciliationDataAccess" />
    <alias type="SAPServer.Service.FSR.Logger.IReportLogger, SAPServer.Service.FSR" alias="IReportLogger" />
    <alias type="SAPServer.Service.FSR.Logger.ReportLogger, SAPServer.Service.FSR" alias="ReportLogger" />
    <alias type="SAPServer.Service.FSR.IFSRReports, SAPServer.Service.FSR" alias="IFSRReports" />
    <alias type="SAPServer.Service.FSR.FSRReports, SAPServer.Service.FSR" alias="FSRReports" />
    <alias type="SAPServer.Service.FSR.Replication.IReportProcessor, SAPServer.Service.FSR" alias="IReportProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.ReportProcessor, SAPServer.Service.FSR" alias="ReportProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" alias="IDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.StringDataProcessor, SAPServer.Service.FSR" alias="StringDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.StreamDataProcessor, SAPServer.Service.FSR" alias="StreamDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.NormDataProcessor, SAPServer.Service.FSR" alias="NormDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.ITableReplicator, SAPServer.Service.FSR" alias="ITableReplicator" />
    <alias type="SAPServer.Service.FSR.Replication.TableReplicator, SAPServer.Service.FSR" alias="TableReplicator" />
    <alias type="SAPServer.Service.FSR.Replication.DataReplicator, SAPServer.Service.FSR" alias="DataReplicator" />
    <alias type="System.Collections.Generic.IDictionary`2[[System.String, mscorlib], [SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR]], mscorlib" alias="IDictionaryDataProcessor" />
    <alias type="System.Collections.Generic.Dictionary`2[[System.String, mscorlib], [SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR]], mscorlib" alias="DictionaryDataProcessor" />
    <container>
      <instance name="ConnectionStringSAPFSR" value="data Source=DEVA-DB00126L,31000;Initial Catalog=SystemReconciliation;Integrated Security=SSPI;"/>
      <instance name="FSRSchema" value="Staging" />
      <register type="IClassFactory" mapTo="ClassFactory" />
      <register type="ISAPConfiguration" mapTo="SAPConfiguration" name="SAPConfiguration" />
      <register type="IFSRReportConfiguration" mapTo="FSRReportConfiguration" name="FSRReportConfiguration"/>
      <register type="ITransactionScopeFactory" mapTo="TransactionScopeFactory" />
      <register type="ISystemReconciliationDataAccess" mapTo="SystemReconciliationDataAccess" name="SystemReconciliationDataAccess" />
      <register type="IReportLogger" mapTo="ReportLogger" name="ReportLogger">
        <constructor>
          <param name="systemReconciliationDataAccess"  dependencyName="SystemReconciliationDataAccess" />
        </constructor>
      </register>
      <register type="IFSRReports" mapTo="FSRReports" name="FSRReports">
        <constructor>
          <param name="systemReconciliationDataAccess"  dependencyName="SystemReconciliationDataAccess" />
        </constructor>
      </register>
      <register type="IDataProcessor" mapTo="StringDataProcessor" name="StringDataProcessor" />
      <register type="IDataProcessor" mapTo="StreamDataProcessor" name="StreamDataProcessor" />
      <register type="IDataProcessor" mapTo="NormDataProcessor" name="NormDataProcessor" />
      <register type="IDictionaryDataProcessor" mapTo="DictionaryDataProcessor" name="DictionaryDataProcessor">
        <constructor />
        <method name="Add">
          <param name="key" value="STRING" type="System.String" />
          <param name="value" type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" dependencyName="StringDataProcessor" />
        </method>
        <method name="Add">
          <param name="key" value="STREAM" type="System.String" />
          <param name="value" type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" dependencyName="StreamDataProcessor" />
        </method>
        <method name="Add">
          <param name="key" value="NORM" type="System.String" />
          <param name="value" type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" dependencyName="NormDataProcessor" />
        </method>
      </register>
      <register type="IReportProcessor" mapTo="ReportProcessor" name="ReportProcessor">
        <constructor>
          <param name="sapConfiguration" dependencyName="SAPConfiguration" />
          <param name="dataProcessors" dependencyName="DictionaryDataProcessor" />
        </constructor>
      </register>
      <register type="ISAPFSR" mapTo="SAPFSR">
        <constructor>
          <param name="reportLogger" dependencyName="ReportLogger" />
          <param name="fsrReports" dependencyName="FSRReports" />
          <param name="reportProcessor" dependencyName="ReportProcessor" />
        </constructor>
      </register>
      <register type="ITableReplicator" mapTo="DataReplicator">
        <constructor>
          <param name="connectionString" dependencyName="ConnectionStringSAPFSR" />
          <param name="fsrSchema" dependencyName="FSRSchema" />
        </constructor>
      </register>
    </container>
  </unity>
  <sapDataTypeMapping>
    <dataTypes>
      <dataType name="DATS" mapTo="DATE" />
      <dataType name="CUKY" mapTo="CHAR" />
      <dataType name="LANG" mapTo="CHAR" />
      <dataType name="NUMC" mapTo="CHAR" />
      <dataType name="QUAN" mapTo="NUM" />
      <dataType name="UNIT" mapTo="CHAR" />
      <dataType name="CURR" mapTo="NUM" />
      <dataType name="DEC" mapTo="NUM" />
      <dataType name="TIMS" mapTo="TIME" />
    </dataTypes>
  </sapDataTypeMapping>
  <system.web>
    <compilation debug="true" targetFramework="4.5.1" />
    <httpRuntime targetFramework="4.5.1" executionTimeout="86400"/>
    <authentication mode="Windows" />
    <identity impersonate="false" />
    <membership defaultProvider="AspNetSqlMembershipProvider">
      <providers>
        <clear />
        <add name="AspNetSqlMembershipProvider" type="System.Web.Security.SqlMembershipProvider, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" connectionStringName="ApplicationServices" applicationName="ServiceBus" requiresQuestionAndAnswer="false" requiresUniqueEmail="false" minRequiredPasswordLength="1" minRequiredNonalphanumericCharacters="0" />
      </providers>
    </membership>
    <roleManager enabled="true" defaultProvider="AspNetSqlRoleProvider">
      <providers>
        <clear />
        <add name="AspNetSqlRoleProvider" type="System.Web.Security.SqlRoleProvider, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" connectionStringName="ApplicationServices" applicationName="ServiceBus" />
        <add name="AspNetWindowsTokenRoleProvider" type="System.Web.Security.WindowsTokenRoleProvider, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" applicationName="ServiceBus" />
      </providers>
    </roleManager>
  </system.web>
  <system.serviceModel>
    <serviceHostingEnvironment aspNetCompatibilityEnabled="true" multipleSiteBindingsEnabled="true"/>
    <bindings>
      <basicHttpBinding>
        <binding name="BasicHttpBinding_Windows" openTimeout="00:15:00" closeTimeout="00:15:00" receiveTimeout="00:15:00" sendTimeout="00:15:00" maxReceivedMessageSize="4194304">
          <security mode="TransportCredentialOnly">
            <transport clientCredentialType="Windows" proxyCredentialType="None" realm=""/>
          </security>
        </binding>
      </basicHttpBinding>
      <wsHttpBinding>
        <binding name="WSHttpBinding" openTimeout="00:15:00" closeTimeout="00:30:00" receiveTimeout="00:30:00" sendTimeout="00:30:00" maxReceivedMessageSize="2147483647">
          <readerQuotas maxDepth="2147483647" maxStringContentLength="2147483647" maxArrayLength="2147483647" maxBytesPerRead="2147483647" maxNameTableCharCount="2147483647"/>
        </binding>
        <binding name="WSHttpBinding_Transactional" transactionFlow="true" openTimeout="03:00:00" closeTimeout="03:00:00" receiveTimeout="03:00:00" sendTimeout="03:00:00" maxReceivedMessageSize="2147483647">
          <readerQuotas maxDepth="2147483647" maxStringContentLength="2147483647" maxArrayLength="2147483647" maxBytesPerRead="2147483647" maxNameTableCharCount="2147483647"/>
        </binding>
      </wsHttpBinding>
    </bindings>
    <services>
      <service name="SAPServer.Web.SAPService">
        <endpoint address="" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows" contract="ServiceBus.Contract.Service.ISAPService" />
        <endpoint address="mex" binding="mexHttpBinding" contract="IMetadataExchange" />
      </service>
      <service name="SAPServer.Web.SAPFSRService">
        <endpoint address="" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows" contract="SAPServer.Web.ISAPFSRService"/>
        <endpoint address="mex" binding="mexHttpBinding" contract="IMetadataExchange"/>
      </service>
    </services>
    <client>
      <endpoint binding="wsHttpBinding" name="WSHttpBinding_ICorporateDirectoryServiceProxy" bindingConfiguration="WSHttpBinding" contract="ServiceBus.Contract.Service.ICorporateDirectoryServiceProxy"
                address="http://localhost:8085/Services/CorporateDirectoryServiceProxy.svc"/>
    </client>
    <behaviors>
      <serviceBehaviors>
        <behavior name="">
          <serviceMetadata httpGetEnabled="true" httpsGetEnabled="true"/>
          <serviceDebug includeExceptionDetailInFaults="true"/>
        </behavior>
      </serviceBehaviors>
    </behaviors>
  </system.serviceModel>
  <system.webServer>
    <modules runAllManagedModulesForAllRequests="true"/>
  </system.webServer>
  <!--<system.diagnostics>
    <sources>
      <source name="System.ServiceModel"
              switchValue="Information, ActivityTracing"
              propagateActivity="true">
        <listeners>
          <add name="traceListener"
              type="System.Diagnostics.XmlWriterTraceListener"
              initializeData= "SAPServer.Web.wcf.svclog" />
        </listeners>
      </source>
    </sources>
  </system.diagnostics>-->
</configuration>

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web
Web.Release.config
3517
<?xml version="1.0" encoding="utf-8" ?>
<configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform">
  <appSettings>
    <add key="SAPConfiguration" value="NAME=DEFAULT_DESTINATION,ASHOST=__SAPDNS__,USER=AID_MGMNT,PASSWD=__SAPPwd__,CLIENT=100"
         xdt:Locator="Match(key)" xdt:Transform="SetAttributes" />
  </appSettings>
  <connectionStrings>
    <add name="ApplicationServices"
         connectionString="data Source=__ASPNetDBDataSource__;Initial Catalog=aspnetdb;Integrated Security=SSPI;Application Name=ServiceBus;"
         xdt:Locator="Match(name)"
         xdt:Transform="SetAttributes" />
    <add name="SystemReconciliationContext"
         connectionString="metadata=res://*/SystemReconciliationModel.csdl|res://*/SystemReconciliationModel.ssdl|res://*/SystemReconciliationModel.msl;provider=System.Data.SqlClient;provider connection string=&quot;data source=__SystemReconciliationDataSource__;initial catalog=SystemReconciliation;integrated security=True;MultipleActiveResultSets=True;App=EntityFramework&quot;"
         xdt:Locator="Match(name)"
         xdt:Transform="SetAttributes" />
  </connectionStrings>
  <loggingConfiguration defaultCategory="Default Category" tracingEnabled="true" xdt:Locator="Match(defaultCategory)" xdt:Transform="SetAttributes">
    <listeners>
      <add name="WCF Log" serviceAddress="http://__AppSupportDNS__/Services/ErrorLoggerService.svc"  xdt:Locator="Match(name)" xdt:Transform="SetAttributes"/>
    </listeners>
  </loggingConfiguration>
  <unity xmlns="http://schemas.microsoft.com/practices/2010/unity">
    <container>
      <instance name="ConnectionStringSAPFSR"
                value="data Source=__SystemReconciliationDataSource__;Initial Catalog=SystemReconciliation;Integrated Security=SSPI;"
                xdt:Locator="Match(name)"
                xdt:Transform="SetAttributes" />
    </container>
  </unity>
  <system.web>
    <compilation debug="false"
                 xdt:Transform="SetAttributes(debug)" />
    <roleManager>
      <providers>
        <add name="AspNetWindowsTokenRoleProvider"
             xdt:Locator="Match(name)"
             xdt:Transform="Remove" />
      </providers>
    </roleManager>
  </system.web>
  <system.serviceModel>
    <services xdt:Transform="Replace">
      <service name="__SapSvcName__">
        <endpoint address="" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows" contract="ServiceBus.Contract.Service.ISAPService" />
        <endpoint address="mex" binding="mexHttpBinding" contract="IMetadataExchange" />
      </service>
      <service name="SAPServer.Web.SAPFSRService">
        <endpoint address="" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows" contract="SAPServer.Web.ISAPFSRService"/>
        <endpoint address="mex" binding="mexHttpBinding" contract="IMetadataExchange"/>
      </service>
    </services>
    <behaviors>
      <serviceBehaviors>
        <behavior>
          <serviceDebug includeExceptionDetailInFaults="true"
                        xdt:Transform="SetAttributes(includeExceptionDetailInFaults)" />
        </behavior>
      </serviceBehaviors>
    </behaviors>
    <client>
      <endpoint name="WSHttpBinding_ICorporateDirectoryServiceProxy" address="http://__ServiceBusDNS__/Services/CorporateDirectoryServiceProxy.svc" xdt:Locator="Match(name)" xdt:Transform="SetAttributes" />
    </client>
  </system.serviceModel>
</configuration>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web\bin
SAPServer.Data.FSR.dll.config
1386
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <configSections>
    <!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 -->
    <section name="entityFramework" type="System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" requirePermission="false" />
  </configSections>
  <connectionStrings><add name="SystemReconciliationContext" connectionString="metadata=res://*/SystemReconciliationModel.csdl|res://*/SystemReconciliationModel.ssdl|res://*/SystemReconciliationModel.msl;provider=System.Data.SqlClient;provider connection string=&quot;data source=DEVA-DB00126L,31000;initial catalog=SystemReconciliation;integrated security=True;multipleactiveresultsets=True;application name=EntityFramework&quot;" providerName="System.Data.EntityClient" /></connectionStrings>
  <entityFramework>
    <defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" />
    <providers>
      <provider invariantName="System.Data.SqlClient" type="System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer" />
    </providers>
  </entityFramework>
  <startup>
    <supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.5.1" />
  </startup>
</configuration>
d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web\bin
SAPServer.Web.dll.config
18788
<?xml version="1.0"?>
<configuration>
  <configSections>
    <section name="loggingConfiguration" type="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.LoggingSettings, Microsoft.Practices.EnterpriseLibrary.Logging" requirePermission="true" />
    <section name="exceptionHandling" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Configuration.ExceptionHandlingSettings, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling" requirePermission="true" />
    <section name="unity" type="Microsoft.Practices.Unity.Configuration.UnityConfigurationSection, Microsoft.Practices.Unity.Configuration" requirePermission="true" />
    <section name="sapDataTypeMapping" type="SAPServer.Core.SAPDataTypeConfiguration, SAPServer.Core"/>
	  <section name="instrumentationConfiguration" type="Microsoft.Practices.EnterpriseLibrary.Common.Instrumentation.Configuration.InstrumentationConfigurationSection, Microsoft.Practices.EnterpriseLibrary.Common" requirePermission="true"/>
    <section name="entityFramework" type="System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" requirePermission="false" />
  </configSections>
  <instrumentationConfiguration eventLoggingEnabled="true"/>
  <entityFramework>
    <defaultConnectionFactory type="System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework">
      <parameters>
        <parameter value="v12.0" />
      </parameters>
    </defaultConnectionFactory>
    <providers>
      <provider invariantName="System.Data.SqlClient" type="System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer" />
    </providers>
  </entityFramework>
  <appSettings>
    <add key="aspnet:UseTaskFriendlySynchronizationContext" value="true" />
    <add key="SAPConfiguration" value="NAME=DEFAULT_DESTINATION,ASHOST=deva-ap00263L,USER=AID_MGMNT,PASSWD=@id_mgmnt,CLIENT=100" />
    <add key="BankAccountMaxLength" value="20" />
    <add key="ZeroDecimalPlaceCurrencies" value="VUV" />
    <add key="FSRBatchIncrementInMonths" value="1" />
  </appSettings>
  <connectionStrings>
    <add name="ApplicationServices" connectionString="data Source=DEVA-DB00126L,31000;Initial Catalog=aspnetdb;Integrated Security=SSPI;Application Name=ServiceBus;" providerName="System.Data.SqlClient" />
    <add name="SystemReconciliationContext" connectionString="metadata=res://*/SystemReconciliationModel.csdl|res://*/SystemReconciliationModel.ssdl|res://*/SystemReconciliationModel.msl;provider=System.Data.SqlClient;provider connection string=&quot;data source=DEVA-DB00126L,31000;initial catalog=SystemReconciliation;integrated security=True;MultipleActiveResultSets=True;App=EntityFramework&quot;" providerName="System.Data.EntityClient" />
  </connectionStrings>
  <exceptionHandling>
    <exceptionPolicies>
      <add name="Global Policy">
        <exceptionTypes>
          <add name="All Exceptions" type="System.Exception, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" postHandlingAction="None">
            <exceptionHandlers>
              <add name="Logging Handler" type="Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging.LoggingExceptionHandler, Microsoft.Practices.EnterpriseLibrary.ExceptionHandling.Logging" logCategory="Default Category" eventId="100" severity="Error"
                   title="Enterprise Library Exception Handling for the Service Bus" priority="0"
                   formatterType="SAPServer.Core.TextExceptionFormatter, SAPServer.Core"/>
            </exceptionHandlers>
          </add>
        </exceptionTypes>
      </add>
    </exceptionPolicies>
  </exceptionHandling>
  <loggingConfiguration defaultCategory="Default Category" tracingEnabled="true">
    <logFilters>
      <add name="Category" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.CategoryFilter, Microsoft.Practices.EnterpriseLibrary.Logging" categoryFilterMode="AllowAllExceptDenied"/>
      <add name="Priority" type="Microsoft.Practices.EnterpriseLibrary.Logging.Filters.PriorityFilter, Microsoft.Practices.EnterpriseLibrary.Logging" minimumPriority="0"/>
    </logFilters>
    <categorySources>
      <add name="Default Category" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </add>
      <add name="Diagnostics" switchValue="All">
        <listeners>
          <add name="Diagnostics" />
        </listeners>
      </add>
    </categorySources>
    <specialSources>
      <errors name="errors" switchValue="All">
        <listeners>
          <add name="Event Log"/>
          <add name="WCF Log"/>
        </listeners>
      </errors>
    </specialSources>
    <listeners>
      <add name="Event Log" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.FormattedEventLogTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging" listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.FormattedEventLogTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           log="SAPInterface" machineName="." source="SAPInterface Web" formatter="Default Formatter"/>
      <add name="WCF Log" type="SAPServer.Core.WCFLogListener, SAPServer.Core" formatter="Default Formatter" listenerDataType="SAPServer.Core.WCFLogListenerData, SAPServer.Core"
           logName="SAPServerWebInterface" serviceAddress="http://appsupport.atlas.satin.lo/Services/ErrorLoggerService.svc"/>
      <add name="Diagnostics" type="Microsoft.Practices.EnterpriseLibrary.Logging.TraceListeners.RollingFlatFileTraceListener, Microsoft.Practices.EnterpriseLibrary.Logging"
           listenerDataType="Microsoft.Practices.EnterpriseLibrary.Logging.Configuration.RollingFlatFileTraceListenerData, Microsoft.Practices.EnterpriseLibrary.Logging"
           fileName="diagnostics.log" footer="----------------" formatter="MessageOnlyTextFormatter" header="" rollFileExistsBehavior="Increment"
           rollInterval="Day" maxArchivedFiles="30" />
    </listeners>
    <formatters>
      <add name="Default Formatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="Timestamp: {timestamp} Message: {message} Category: {category} Priority: {priority} EventId: {eventid} Severity: {severity} Title:{title} Machine: {machine} Application Domain: {appDomain} Process Id: {processId} Process Name: {processName} Win32 Thread Id: {win32ThreadId} Thread Name: {threadName} Extended Properties: {dictionary({key} - {value})}"/>
      <add name="MessageOnlyTextFormatter" type="Microsoft.Practices.EnterpriseLibrary.Logging.Formatters.TextFormatter, Microsoft.Practices.EnterpriseLibrary.Logging" template="{timestamp(local:dd/MM/yyyy H:mm:ss.fff)}: {message}" />
    </formatters>
  </loggingConfiguration>
  <unity xmlns="http://schemas.microsoft.com/practices/2010/unity">
    <alias type="SAPServer.Core.ISAPConfiguration, SAPServer.Core" alias="ISAPConfiguration" />
    <alias type="SAPServer.Core.SAPConfiguration, SAPServer.Core" alias="SAPConfiguration" />
    <alias type="SAPServer.Core.IClassFactory, SAPServer.Core" alias="IClassFactory" />
    <alias type="SAPServer.Core.ClassFactory, SAPServer.Core" alias="ClassFactory" />
    <alias type="SAPServer.Core.ITransactionScopeFactory, SAPServer.Core" alias="ITransactionScopeFactory" />
    <alias type="SAPServer.Core.TransactionScopeFactory, SAPServer.Core" alias="TransactionScopeFactory" />
    <alias type="SAPServer.Service.FSR.ISAPFSR, SAPServer.Service.FSR" alias="ISAPFSR" />
    <alias type="SAPServer.Service.FSR.SAPFSR, SAPServer.Service.FSR" alias="SAPFSR" />
    <alias type="SAPServer.Service.FSR.IFSRReportConfiguration, SAPServer.Service.FSR" alias="IFSRReportConfiguration" />
    <alias type="SAPServer.Service.FSR.FSRReportConfiguration, SAPServer.Service.FSR" alias="FSRReportConfiguration" />
    <alias type="SAPServer.Data.FSR.ISystemReconciliationDataAccess, SAPServer.Data.FSR" alias="ISystemReconciliationDataAccess" />
    <alias type="SAPServer.Data.FSR.SystemReconciliationDataAccess, SAPServer.Data.FSR" alias="SystemReconciliationDataAccess" />
    <alias type="SAPServer.Service.FSR.Logger.IReportLogger, SAPServer.Service.FSR" alias="IReportLogger" />
    <alias type="SAPServer.Service.FSR.Logger.ReportLogger, SAPServer.Service.FSR" alias="ReportLogger" />
    <alias type="SAPServer.Service.FSR.IFSRReports, SAPServer.Service.FSR" alias="IFSRReports" />
    <alias type="SAPServer.Service.FSR.FSRReports, SAPServer.Service.FSR" alias="FSRReports" />
    <alias type="SAPServer.Service.FSR.Replication.IReportProcessor, SAPServer.Service.FSR" alias="IReportProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.ReportProcessor, SAPServer.Service.FSR" alias="ReportProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" alias="IDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.StringDataProcessor, SAPServer.Service.FSR" alias="StringDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.StreamDataProcessor, SAPServer.Service.FSR" alias="StreamDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.NormDataProcessor, SAPServer.Service.FSR" alias="NormDataProcessor" />
    <alias type="SAPServer.Service.FSR.Replication.ITableReplicator, SAPServer.Service.FSR" alias="ITableReplicator" />
    <alias type="SAPServer.Service.FSR.Replication.TableReplicator, SAPServer.Service.FSR" alias="TableReplicator" />
    <alias type="SAPServer.Service.FSR.Replication.DataReplicator, SAPServer.Service.FSR" alias="DataReplicator" />
    <alias type="System.Collections.Generic.IDictionary`2[[System.String, mscorlib], [SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR]], mscorlib" alias="IDictionaryDataProcessor" />
    <alias type="System.Collections.Generic.Dictionary`2[[System.String, mscorlib], [SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR]], mscorlib" alias="DictionaryDataProcessor" />
    <container>
      <instance name="ConnectionStringSAPFSR" value="data Source=DEVA-DB00126L,31000;Initial Catalog=SystemReconciliation;Integrated Security=SSPI;"/>
      <instance name="FSRSchema" value="Staging" />
      <register type="IClassFactory" mapTo="ClassFactory" />
      <register type="ISAPConfiguration" mapTo="SAPConfiguration" name="SAPConfiguration" />
      <register type="IFSRReportConfiguration" mapTo="FSRReportConfiguration" name="FSRReportConfiguration"/>
      <register type="ITransactionScopeFactory" mapTo="TransactionScopeFactory" />
      <register type="ISystemReconciliationDataAccess" mapTo="SystemReconciliationDataAccess" name="SystemReconciliationDataAccess" />
      <register type="IReportLogger" mapTo="ReportLogger" name="ReportLogger">
        <constructor>
          <param name="systemReconciliationDataAccess"  dependencyName="SystemReconciliationDataAccess" />
        </constructor>
      </register>
      <register type="IFSRReports" mapTo="FSRReports" name="FSRReports">
        <constructor>
          <param name="systemReconciliationDataAccess"  dependencyName="SystemReconciliationDataAccess" />
        </constructor>
      </register>
      <register type="IDataProcessor" mapTo="StringDataProcessor" name="StringDataProcessor" />
      <register type="IDataProcessor" mapTo="StreamDataProcessor" name="StreamDataProcessor" />
      <register type="IDataProcessor" mapTo="NormDataProcessor" name="NormDataProcessor" />
      <register type="IDictionaryDataProcessor" mapTo="DictionaryDataProcessor" name="DictionaryDataProcessor">
        <constructor />
        <method name="Add">
          <param name="key" value="STRING" type="System.String" />
          <param name="value" type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" dependencyName="StringDataProcessor" />
        </method>
        <method name="Add">
          <param name="key" value="STREAM" type="System.String" />
          <param name="value" type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" dependencyName="StreamDataProcessor" />
        </method>
        <method name="Add">
          <param name="key" value="NORM" type="System.String" />
          <param name="value" type="SAPServer.Service.FSR.Replication.IDataProcessor, SAPServer.Service.FSR" dependencyName="NormDataProcessor" />
        </method>
      </register>
      <register type="IReportProcessor" mapTo="ReportProcessor" name="ReportProcessor">
        <constructor>
          <param name="sapConfiguration" dependencyName="SAPConfiguration" />
          <param name="dataProcessors" dependencyName="DictionaryDataProcessor" />
        </constructor>
      </register>
      <register type="ISAPFSR" mapTo="SAPFSR">
        <constructor>
          <param name="reportLogger" dependencyName="ReportLogger" />
          <param name="fsrReports" dependencyName="FSRReports" />
          <param name="reportProcessor" dependencyName="ReportProcessor" />
        </constructor>
      </register>
      <register type="ITableReplicator" mapTo="DataReplicator">
        <constructor>
          <param name="connectionString" dependencyName="ConnectionStringSAPFSR" />
          <param name="fsrSchema" dependencyName="FSRSchema" />
        </constructor>
      </register>
    </container>
  </unity>
  <sapDataTypeMapping>
    <dataTypes>
      <dataType name="DATS" mapTo="DATE" />
      <dataType name="CUKY" mapTo="CHAR" />
      <dataType name="LANG" mapTo="CHAR" />
      <dataType name="NUMC" mapTo="CHAR" />
      <dataType name="QUAN" mapTo="NUM" />
      <dataType name="UNIT" mapTo="CHAR" />
      <dataType name="CURR" mapTo="NUM" />
      <dataType name="DEC" mapTo="NUM" />
      <dataType name="TIMS" mapTo="TIME" />
    </dataTypes>
  </sapDataTypeMapping>
  <system.web>
    <compilation debug="true" targetFramework="4.5.1" />
    <httpRuntime targetFramework="4.5.1" executionTimeout="86400"/>
    <authentication mode="Windows" />
    <identity impersonate="false" />
    <membership defaultProvider="AspNetSqlMembershipProvider">
      <providers>
        <clear />
        <add name="AspNetSqlMembershipProvider" type="System.Web.Security.SqlMembershipProvider, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" connectionStringName="ApplicationServices" applicationName="ServiceBus" requiresQuestionAndAnswer="false" requiresUniqueEmail="false" minRequiredPasswordLength="1" minRequiredNonalphanumericCharacters="0" />
      </providers>
    </membership>
    <roleManager enabled="true" defaultProvider="AspNetSqlRoleProvider">
      <providers>
        <clear />
        <add name="AspNetSqlRoleProvider" type="System.Web.Security.SqlRoleProvider, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" connectionStringName="ApplicationServices" applicationName="ServiceBus" />
        <add name="AspNetWindowsTokenRoleProvider" type="System.Web.Security.WindowsTokenRoleProvider, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" applicationName="ServiceBus" />
      </providers>
    </roleManager>
  </system.web>
  <system.serviceModel>
    <serviceHostingEnvironment aspNetCompatibilityEnabled="true" multipleSiteBindingsEnabled="true"/>
    <bindings>
      <basicHttpBinding>
        <binding name="BasicHttpBinding_Windows" openTimeout="00:15:00" closeTimeout="00:15:00" receiveTimeout="00:15:00" sendTimeout="00:15:00" maxReceivedMessageSize="4194304">
          <security mode="TransportCredentialOnly">
            <transport clientCredentialType="Windows" proxyCredentialType="None" realm=""/>
          </security>
        </binding>
      </basicHttpBinding>
      <wsHttpBinding>
        <binding name="WSHttpBinding" openTimeout="00:15:00" closeTimeout="00:30:00" receiveTimeout="00:30:00" sendTimeout="00:30:00" maxReceivedMessageSize="2147483647">
          <readerQuotas maxDepth="2147483647" maxStringContentLength="2147483647" maxArrayLength="2147483647" maxBytesPerRead="2147483647" maxNameTableCharCount="2147483647"/>
        </binding>
        <binding name="WSHttpBinding_Transactional" transactionFlow="true" openTimeout="03:00:00" closeTimeout="03:00:00" receiveTimeout="03:00:00" sendTimeout="03:00:00" maxReceivedMessageSize="2147483647">
          <readerQuotas maxDepth="2147483647" maxStringContentLength="2147483647" maxArrayLength="2147483647" maxBytesPerRead="2147483647" maxNameTableCharCount="2147483647"/>
        </binding>
      </wsHttpBinding>
    </bindings>
    <services>
      <service name="SAPServer.Web.SAPService">
        <endpoint address="" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows" contract="ServiceBus.Contract.Service.ISAPService" />
        <endpoint address="mex" binding="mexHttpBinding" contract="IMetadataExchange" />
      </service>
      <service name="SAPServer.Web.SAPFSRService">
        <endpoint address="" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_Windows" contract="SAPServer.Web.ISAPFSRService"/>
        <endpoint address="mex" binding="mexHttpBinding" contract="IMetadataExchange"/>
      </service>
    </services>
    <client>
      <endpoint binding="wsHttpBinding" name="WSHttpBinding_ICorporateDirectoryServiceProxy" bindingConfiguration="WSHttpBinding" contract="ServiceBus.Contract.Service.ICorporateDirectoryServiceProxy"
                address="http://localhost:8085/Services/CorporateDirectoryServiceProxy.svc"/>
    </client>
    <behaviors>
      <serviceBehaviors>
        <behavior name="">
          <serviceMetadata httpGetEnabled="true" httpsGetEnabled="true"/>
          <serviceDebug includeExceptionDetailInFaults="true"/>
        </behavior>
      </serviceBehaviors>
    </behaviors>
  </system.serviceModel>
  <system.webServer>
    <modules runAllManagedModulesForAllRequests="true"/>
  </system.webServer>
  <!--<system.diagnostics>
    <sources>
      <source name="System.ServiceModel"
              switchValue="Information, ActivityTracing"
              propagateActivity="true">
        <listeners>
          <add name="traceListener"
              type="System.Diagnostics.XmlWriterTraceListener"
              initializeData= "SAPServer.Web.wcf.svclog" />
        </listeners>
      </source>
    </sources>
  </system.diagnostics>-->
</configuration>

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web\Properties
AssemblyInfo.cs
1434
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;

// General Information about an assembly is controlled through the following 
// set of attributes. Change these attribute values to modify the information
// associated with an assembly.
[assembly: AssemblyTitle("SAPServer.Web")]
[assembly: AssemblyDescription("")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyCompany("")]
[assembly: AssemblyProduct("SAPServer.Web")]
[assembly: AssemblyCopyright("Copyright   2014")]
[assembly: AssemblyTrademark("")]
[assembly: AssemblyCulture("")]

// Setting ComVisible to false makes the types in this assembly not visible 
// to COM components.  If you need to access a type in this assembly from 
// COM, set the ComVisible attribute to true on that type.
[assembly: ComVisible(false)]

// The following GUID is for the ID of the typelib if this project is exposed to COM
[assembly: Guid("a5c8220c-075c-4817-93c7-1bcb25893de7")]

// Version information for an assembly consists of the following four values:
//
//      Major Version
//      Minor Version 
//      Build Number
//      Revision
//
// You can specify all the values or you can default the Revision and Build Numbers 
// by using the '*' as shown below:
// [assembly: AssemblyVersion("1.0.*")]
[assembly: AssemblyVersion("1.0.0.0")]
[assembly: AssemblyFileVersion("1.0.0.0")]

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web\Services
SAPFSRService.svc.cs
1426
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.ServiceModel;
using System.Threading;
using SAPServer.Core;
using SAPServer.Service.FSR;

namespace SAPServer.Web
{
    [ServiceContract(Namespace = "http://www.ausaid.gov.au/SAPInterface")]
    public interface ISAPFSRService
    {
        [OperationContract]
        void RunReport(string name);

        [OperationContract]
        void RunReports();
    }

    [ErrorHandlerBehavior]
    public class SAPFSRService : ISAPFSRService
    {
        #regionFields

        string reportName;

        #endregionFields

        #region Constructors

        public SAPFSRService()
        {
        }

        #endregion

        #regionPublicMethods

        public void RunReport(string name)
        {
            this.reportName = name;

            Thread thread = new Thread(ExecuteReports);

            thread.Start();
        }

        public void RunReports()
        {
            this.reportName = null;

            Thread thread = new Thread(ExecuteReports);

            thread.Start();
        }

        #endregion

        #region Private Methods

        private void ExecuteReports()
        {
            ISAPFSR sapFSR = Class.New<ISAPFSR>();

            sapFSR.ExecuteReports(reportName);
        }

        #endregion
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web\Services
SAPService.svc.cs
25080
using System;
using System.Collections.Generic;
using System.Linq;
using System.ServiceModel;
using System.Threading;
using System.Threading.Tasks;
using SAP.Middleware.Connector;
using SAPServer.Core;
using SAPServer.Service.SAP;
using ServiceBus.Contract.Model;
using ServiceBus.Contract.Service;
using ServiceBus.Contract.WebServiceReference.CorporateDirectoryRefreshService;

namespace SAPServer.Web
{
    [ErrorHandlerBehavior]
    public class SAPService : ISAPService
    {
        #regionFields

        static readonly ActionServiceObject[] noActionServiceObjects = new ActionServiceObject[0];

        ISAPConfiguration configuration;
        RfcDestination destination;
        const string SAP_EVENT_CONTROLLINGDOC_CHANGED = "CONTROLLINGDOC_CHANGED";
        const string SAP_EVENT_CONTROLLINGDOC_CHANGED_CONTROL_AREA = "KOKRS";
        const string SAP_EVENT_CONTROLLINGDOC_CHANGED_DOC_NUMBER = "BELNR";
        const string SAP_EVENT_CONTROLLINGDOC_CHANGED_DOC_TYPE = "BLART";
        const string SAP_EVENT_EXCHANGERATE_CHANGED = "EXCHANGERATE_CHANGED";
        const string SAP_EVENT_GL_ACCOUNT_CHANGED = "GL_ACCOUNT_CHANGED";
        const string SAP_EVENT_GL_ACCOUNT_CHANGED_KEY_ACCOUNT_NO = "GLACCT";
        const string SAP_EVENT_PROGRAM_STRUCTURE_CHANGED = "PROGRAM_STRUCTURE_CHANGED";
        const string SAP_EVENT_VENDOR_CHANGED = "VENDOR_CHANGED";
        const string SAP_EVENT_VENDOR_CHANGED_KEY_APPROVAL_YEAR = "APPROVALYEAR";
        const string SAP_EVENT_VENDOR_CHANGED_KEY_POSITION = "POSITION";
        const string SAP_EVENT_VENDOR_CHANGED_KEY_PROGRAM = "PROGRAM";
        const string SAP_EVENT_VENDOR_CHANGED_KEY_VENDOR_NO = "VENDORNO";

        #endregionFields

        #regionConstructors

        public SAPService()
        {
            configuration = Class.New<ISAPConfiguration>("SAPConfiguration");
            destination = RfcDestinationManager.GetDestination(configuration.GetRfcConfigParameters());
        }

        #endregionConstructors

        #regionPublicMethods

        [OperationBehavior(TransactionScopeRequired = false)]
        public ReplicateWBSElementStatus UpdateWBSCodeStatus(UpdateWBSCodeStatusInfo updateWBSCodeStatusInfo)
        {
            return new SAPProject(destination, configuration).UpdateWBSCodeStatus(updateWBSCodeStatusInfo);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public AccrualJournalResponseInfo CreateAccrualJournal(AccrualJournalInfo accrualJournalInfo)
        {
            return new SAPJournal(destination, configuration).CreateAccrualJournal(accrualJournalInfo);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreateAdjustmentJournal(CreateAdjustmentJournal createAdjustmentJournal, CallerInfo callerInfo)
        {
            ReplicateAdjustmentJournal adjustmentJournalResponse = new SAPJournal(destination, configuration).CreateOASISAdjustmentJournal(createAdjustmentJournal);

            return new ActionServiceObject[] 
            { 
                new ActionServiceObject 
                { 
                    ServiceMethod = "ReplicateAdjustmentJournal", 
                    From = ServiceEnum.SAP, 
                    To = callerInfo.From, 
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag { { "replicateAdjustmentJournal", adjustmentJournalResponse} } 
                }   
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ReplicateGoodsReceiptNumber CreateGoodsReceipt(GoodsReceiptInfo goodsReceiptInfo)
        {
            return new SAPGoodsReceipt(destination, configuration).CreateGoodsReceipt(goodsReceiptInfo);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreateGoodsReceiptAndAdjustmentJournal(CreateGoodsReceiptAndAdjustmentJournal createGoodsReceiptAndAdjustmentJournal, CallerInfo callerInfo)
        {
            List<ActionServiceObject> actions = new List<ActionServiceObject>();
            ReplicateGoodsReceiptNumber replicateGoodsReceiptNumber = CreateGoodsReceipt(createGoodsReceiptAndAdjustmentJournal.GoodsReceiptInfo);

            actions.Add(new ActionServiceObject
            {
                ServiceMethod = "ReplicateGoodsReceiptNumber",
                From = ServiceEnum.SAP,
                To = callerInfo.From,
                UserID = GetType().Name,
                MethodArguments = new MethodArgumentBag { { "replicateGoodsReceiptNumber", replicateGoodsReceiptNumber } }
            });

            // only create adjustment journal if there are adjustment items
            if (!createGoodsReceiptAndAdjustmentJournal.AdjustmentJournalInfo.Items.IsNullOrEmpty())
            {
                CreateAdjustmentJournal createAdjustmentJournal = new CreateAdjustmentJournal
                {
                    AdjustmentJournalInfo = createGoodsReceiptAndAdjustmentJournal.AdjustmentJournalInfo,
                    GoodsReceiptInfo = createGoodsReceiptAndAdjustmentJournal.GoodsReceiptInfo,
                    GoodsReceiptNumber = replicateGoodsReceiptNumber.GoodsReceiptNumber
                };

                actions.Add(new ActionServiceObject
                {
                    ServiceMethod = "CreateAdjustmentJournal",
                    From = ServiceEnum.SAP,
                    To = ServiceEnum.SAP,
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag 
                    { 
                        { "createAdjustmentJournal", createAdjustmentJournal },  
                        { "callerInfo", callerInfo },  
                    }
                });
            }

            return actions.ToArray();
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void CreateInvestmentManagementLink(InvestmentManagementLinkInfo[] investmentManagementLinkInfos)
        {
            foreach (InvestmentManagementLinkInfo investmentManagementLinkInfo in investmentManagementLinkInfos)
            {
                new SAPProject(destination, configuration).CreateInvestmentManagementLink(investmentManagementLinkInfo);
            }
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreateOrUpdateProject(ProjectInfo projectInfo, CallerInfo callerInfo)
        {
            ReplicateProjectInfo replicateProjectInfo = new SAPProject(destination, configuration).CreateOrUpdateProject(projectInfo);
            List<ActionServiceObject> actions = new List<ActionServiceObject>();

            // first return transaction is to update WBSElementCode in AidWorks
            actions.Add(new ActionServiceObject
            {
                ServiceMethod = "ReplicateProjectInfo",
                From = ServiceEnum.SAP,
                To = callerInfo.From,
                UserID = GetType().Name,
                MethodArguments = new MethodArgumentBag { { "replicateProjectInfo", replicateProjectInfo } }
            });

            // second return transaction is to link WBSElementCode with its Program position for the current year in SAP Investment management
            InvestmentManagementLinkInfo[] investmentManagementLinkInfos = projectInfo.Activities
                .SelectMany(x => x.AppropriationSources)
                .Select(x => new InvestmentManagementLinkInfo
                {
                    ApprovalYear = DateTime.Today.AddMonths(6).Year,
                    InvestmentManagementPosition = x.InvestmentManagementPosition,
                    WBSElementCode = x.WBSElementCode
                })
                .ToArray();

            actions.Add(new ActionServiceObject
            {
                ServiceMethod = "CreateInvestmentManagementLink",
                From = ServiceEnum.SAP,
                To = ServiceEnum.SAP,
                UserID = GetType().Name,
                MethodArguments = new MethodArgumentBag { { "investmentManagementLinkInfo", investmentManagementLinkInfos } }
            });

            // third action is to replicate any wbs element status updates 
            ReplicateWBSElementStatus wbsElementStatus = new SAPProject(destination, configuration).LockWBSCode(projectInfo);

            if (wbsElementStatus != null && wbsElementStatus.WBSElements.Length > 0)
            {
                actions.Add(new ActionServiceObject
                {
                    ServiceMethod = "ReplicateWBSElementStatus",
                    From = ServiceEnum.SAP,
                    To = callerInfo.From,
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag { { "replicateWBSElementStatus", wbsElementStatus } }
                });
            }

            return actions.ToArray();
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public AccrualJournalResponseInfo CreatePrePaymentJournal(PrePaymentJournalInfo prePaymentJournalInfo)
        {
            return new SAPJournal(destination, configuration).CreatePrePaymentJournal(prePaymentJournalInfo);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ReplicatePurchaseOrderNumber CreatePurchaseOrder(CreatePurchaseOrderInfo createPurchaseOrderInfo)
        {
            return new SAPPurchaseOrder(destination, configuration).CreatePurchaseOrder(createPurchaseOrderInfo);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreatePurchaseOrderAndGoodsReceipt(CreatePurchaseOrderAndGoodsReceiptInfo createPurchaseOrderAndGoodsReceiptInfo, CallerInfo callerInfo)
        {
            ReplicatePurchaseOrderNumber replicatePurchaseOrderNumber = CreatePurchaseOrder(createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo);

            // set the purchase order number on the GoodsReceiptInfo
            createPurchaseOrderAndGoodsReceiptInfo.GoodsReceiptInfo.PurchaseOrderNo = replicatePurchaseOrderNumber.PurchaseOrderNumber;

            // create the goods receipt and adjustment journal transaction
            CreateGoodsReceiptAndAdjustmentJournal createGoodsReceiptAndAdjustmentJournal = new CreateGoodsReceiptAndAdjustmentJournal
            {
                AdjustmentJournalInfo = createPurchaseOrderAndGoodsReceiptInfo.AdjustmentJournalInfo,
                GoodsReceiptInfo = createPurchaseOrderAndGoodsReceiptInfo.GoodsReceiptInfo
            };

            return new ActionServiceObject[] 
            { 
                new ActionServiceObject 
                { 
                    ServiceMethod = "ReplicatePurchaseOrderNumber", 
                    From = ServiceEnum.SAP, 
                    To = callerInfo.From, 
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag 
                    { 
                        { "purchaseOrderNumber", replicatePurchaseOrderNumber } 
                    } 
                },   
                new ActionServiceObject 
                { 
                    ServiceMethod = "CreateGoodsReceiptAndAdjustmentJournal", 
                    From = ServiceEnum.SAP, 
                    To = ServiceEnum.SAP, 
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag 
                    { 
                        { "createGoodsReceiptAndAdjustmentJournal", createGoodsReceiptAndAdjustmentJournal },
                        { "callerInfo", callerInfo }
                    } 
                }   
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void DeletePurchaseOrder(DeletePurchaseOrderInfo deletePurchaseOrderInfo)
        {
            new SAPPurchaseOrder(destination, configuration).DeletePurchaseOrder(deletePurchaseOrderInfo);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public PingInfo Ping(PingInfo pingInfo)
        {
            return new PingInfo { Message = string.Format("Ping successful: {0}", pingInfo.Message) };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void PingCallBack(PingInfo pingInfo)
        {
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] ProcessSAPEvent(SAPEvent sapEvent)
        {
            Dictionary<string, Func<SAPEvent, ActionServiceObject[]>> processingMethods = new Dictionary<string, Func<SAPEvent, ActionServiceObject[]>> 
            {
                { SAP_EVENT_CONTROLLINGDOC_CHANGED, ProcessActualExpenseEvent },
                { SAP_EVENT_PROGRAM_STRUCTURE_CHANGED, ProcessProgramStructureChangedEvent },
                { SAP_EVENT_VENDOR_CHANGED, ProcessVendorChangedEvent },
                { SAP_EVENT_GL_ACCOUNT_CHANGED, ProcessGLAccountChangedEvent },
                { SAP_EVENT_EXCHANGERATE_CHANGED, ProcessExchangeRateChangedEvent }
            };

            Func<SAPEvent, ActionServiceObject[]> processingMethod = processingMethods[sapEvent.Type];

            if (processingMethod == null)
            {
                throw new NullReferenceException(string.Format("No event processing method is available for event type \"{0}\"", sapEvent.Type));
            }

            return processingMethod(sapEvent);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void ReplicateExchangeRates()
        {
            Task.Factory.StartNew(() => ProcessExchangeRateReplication(DateTime.Now, DateTime.Now), TaskCreationOptions.AttachedToParent | TaskCreationOptions.LongRunning);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void ReplicateExchangeRatesForRange(DateTime startDate, DateTime endDate)
        {
            Task.Factory.StartNew(() => ProcessExchangeRateReplication(startDate, endDate), TaskCreationOptions.AttachedToParent | TaskCreationOptions.LongRunning);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void UpdateForecast(WBSForecastInfo[] forecasts)
        {
            new SAPProject(destination, configuration).UpdateForecast(forecasts);
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void UpdatePurchaseOrder(UpdatePurchaseOrderInfo updatePurchaseOrderInfo)
        {
            new SAPPurchaseOrder(destination, configuration).UpdatePurchaseOrder(updatePurchaseOrderInfo);
        }

        #endregionPublicMethods

        #regionPrivateMethods

        private ActionServiceObject[] ProcessActualExpenseEvent(SAPEvent sapEvent)
        {
            string docNumber = sapEvent.Arguments.ContainsKey(SAP_EVENT_CONTROLLINGDOC_CHANGED_DOC_NUMBER) ? sapEvent.Arguments[SAP_EVENT_CONTROLLINGDOC_CHANGED_DOC_NUMBER].As<string>() : null;
            string controlArea = sapEvent.Arguments.ContainsKey(SAP_EVENT_CONTROLLINGDOC_CHANGED_CONTROL_AREA) ? sapEvent.Arguments[SAP_EVENT_CONTROLLINGDOC_CHANGED_CONTROL_AREA].As<string>() : null;
            string docType = sapEvent.Arguments.ContainsKey(SAP_EVENT_CONTROLLINGDOC_CHANGED_DOC_TYPE) ? sapEvent.Arguments[SAP_EVENT_CONTROLLINGDOC_CHANGED_DOC_TYPE].As<string>() : null;

            ActualExpenseJournalBuilderFactory builderFactory = new ActualExpenseJournalBuilderFactory(destination, configuration);
            IActualExpenseJournalBuilder builder = builderFactory.CreateActualExpenseJournalBuilder(docType, docNumber, controlArea);
            ActualExpenseJournal[] journals = builder.Build();

            if (journals.IsNullOrEmpty())
            {
                return noActionServiceObjects;
            }

            return new ActionServiceObject[] 
            { 
                new ActionServiceObject 
                { 
                    ServiceMethod = "ReplicateActualExpenseJournal", 
                    From = ServiceEnum.SAP, 
                    To = ServiceEnum.AidWorks, 
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag 
                    { 
                        { "replicateActualExpenseJournal", new ReplicateActualExpenseJournal { ActualExpenseJournals = journals } }
                    } 
                }   
            };
        }

        private ActionServiceObject[] ProcessExchangeRateChangedEvent(SAPEvent sapEvent)
        {
            return new SAPExchangeRate(destination, configuration).GetExchangeRates().Select(x => new ActionServiceObject
            {
                ServiceMethod = "UpdateCurrencyValue",
                From = ServiceEnum.SAP,
                To = ServiceEnum.CorporateDirectory,
                UserID = GetType().Name,
                MethodArguments = new MethodArgumentBag 
                {
                    { 
                        "request", 
                        new UpdateCurrencyValueRequest (new UpdateCurrencyValueRequestBody 
                        { 
                            currencyCode = x.CurrencyCode, 
                            currencyValue = x.Value, 
                            effectiveDate = x.EffectiveDate 
                        })
                    }
                }
            })
            .ToArray();
        }

        private ActionServiceObject[] ProcessGLAccountChangedEvent(SAPEvent sapEvent)
        {
            // When the user updates or creates a GL account in SAP, SAP gives us the GLAccount number:
            // ....but not always the CompanyCode or Purchasing Organisation (depends on the parameters they entered in the SAP UI)
            string account = sapEvent.Arguments[SAP_EVENT_GL_ACCOUNT_CHANGED_KEY_ACCOUNT_NO].As<string>();

            // get the GL account details from SAP
            SAPGLAccount accountData = new SAPGLAccounts(destination, configuration).GetGLAccount(account);

            if (accountData == null)
            {
                return noActionServiceObjects;
            }

            // convert the SAP GL account details into AidWorks GL account details
            // return one transaction, which is AidWorks-bound, to replicate GL account details            
            ReplicateGLAccountInfoFromSAP replicateGLAccountInfoFromSAP = new ReplicateGLAccountInfoFromSAP
            {
                Account = accountData.Account,
                ShortText = accountData.ShortText,
                LongText = accountData.LongText,
                CompanyCode = accountData.CompanyCode,
                PostingBlock = accountData.PostingBlock,
                DeletionFlag = accountData.DeletionFlag,
                Currency = accountData.Currency,
                TaxCategory = accountData.TaxCategory,
                PersonnelNumberRequired = accountData.PersonnelNumberRequired,
                WBSElementAllowedForInput = accountData.WBSElementAllowedForInput,
                GroupName = accountData.GroupName,
                GroupNameDescription = accountData.GroupNameDescription
            };

            return new ActionServiceObject[]
            { 
                new ActionServiceObject 
                {
                    ServiceMethod = "ReplicateGLAccount", 
                    From = ServiceEnum.SAP, 
                    To = ServiceEnum.AidWorks, 
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag { { "replicateGLAccountInfo", replicateGLAccountInfoFromSAP} } 
                }   
            };
        }

        private void ProcessExchangeRateReplication(DateTime startDate, DateTime endDate)
        {
            DateTime loopDate = startDate.Date;

            while (loopDate <= endDate.Date)
            {
                List<ExchangeRate> rates = new SAPExchangeRate(destination, configuration).GetExchangeRatesForDate(loopDate);
                ChannelFactory<ICorporateDirectoryServiceProxy> channelFactory = null;
                ICorporateDirectoryServiceProxy service = null;

                try
                {
                    channelFactory = new ChannelFactory<ICorporateDirectoryServiceProxy>("WSHttpBinding_ICorporateDirectoryServiceProxy");
                    service = channelFactory.CreateChannel();

                    service.UpdateCurrencyValue(new ReplicateExchangeRates { ExchangeRates = rates.ToArray() }, new CallerInfo { From = ServiceEnum.SAP, UserID = GetType().Name });
                }
                finally
                {
                    ServiceModelUtils.ReleaseCommunicationObjects(service as ICommunicationObject, channelFactory);
                    loopDate = loopDate.AddDays(1).Date;
                }
            }
        }

        private ActionServiceObject[] ProcessProgramStructureChangedEvent(SAPEvent sapEvent)
        {
            string program = sapEvent.Arguments[SAP_EVENT_VENDOR_CHANGED_KEY_PROGRAM].As<string>();
            string approvalYear = sapEvent.Arguments[SAP_EVENT_VENDOR_CHANGED_KEY_APPROVAL_YEAR].As<string>();
            string position = sapEvent.Arguments[SAP_EVENT_VENDOR_CHANGED_KEY_POSITION].As<string>();

            int approvalYearAsInt;
            int.TryParse(approvalYear, out approvalYearAsInt);

            ProgramFundInfo[] programFunds = new SAPProgramStructure(destination, configuration).CreateProgramStructure(program, approvalYearAsInt, position);

            if (programFunds.IsNullOrEmpty())
            {
                return noActionServiceObjects;
            }

            return new ActionServiceObject[] 
            {
                new ActionServiceObject 
                {
                    ServiceMethod = "ReplicateProgramFunds", 
                    From = ServiceEnum.SAP, 
                    To = ServiceEnum.AidWorks, 
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag
                    { 
                        { "replicateProgramFundInfo", new ReplicateProgramFundInfo { FinancialYearEnd = approvalYearAsInt, ProgramFunds = programFunds } }
                    } 
                }   
            };
        }

        private ActionServiceObject[] ProcessVendorChangedEvent(SAPEvent sapEvent)
        {
            // When the user updates or creates a Vendor in SAP, SAP gives us the VendorNo:
            // ....but not always the CompanyCode or Purchasing Organisation (depends on the parameters they entered in the SAP UI)
            string vendorNo = sapEvent.Arguments[SAP_EVENT_VENDOR_CHANGED_KEY_VENDOR_NO].As<string>();

            // get the Vendor's details from SAP
            SAPVendor vendorData = new SAPVendors(destination, configuration).GetVendor(vendorNo);

            if (vendorData.BankDetails.Count > 1)
            {
                throw new ApplicationException(string.Format("Vendor {0} has {1} bank accounts. Expecting no more than one.", vendorNo, vendorData.BankDetails.Count));
            }

            int bankAccountMaxLength = Class.New<ISAPConfiguration>("SAPConfiguration").GetApplicationSetting("BankAccountMaxLength").As<int>();

            ReplicatePayeeInfoFromSAP replicatePayeeInfoFromSAP = new ReplicatePayeeInfoFromSAP
            {
                SAPNumber = vendorData.VendorNo,
                GreatPlainsNumber = vendorData.GreatPlainsVendorNo,
                Name = vendorData.ConcatName(),
                ABN = vendorData.VATRegNo,
                // masking: AidWorks users should only see partial bank accounts
                BankAccountNumber = vendorData.BankDetails.Count == 0 ? null : vendorData.BankDetails[0].ToMaskedString(bankAccountMaxLength),
                PostingBlock = vendorData.PostingBlock,
                PurchasingBlock = vendorData.PurchasingBlock
            };

            // convert the SAP vendor details into AidWorks Payee details
            // return one transaction, which is AidWorks-bound, to replicate Payee details            
            return new ActionServiceObject[]
            { 
                new ActionServiceObject 
                {
                    ServiceMethod = "ReplicatePayee", 
                    From = ServiceEnum.SAP, 
                    To = ServiceEnum.AidWorks, 
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag {{ "replicatePayeeInfo", replicatePayeeInfoFromSAP } } 
                }   
            };
        }

        #endregionPrivateMethods
    }
}

d0c761fd-1acb-4bdb-92a0-348082e22920
TFS\Apps\SAPInterface\Main\Src\SAPServer.Web\Services
SAPServiceStub.svc.cs
16078
using System;
using System.Collections.Generic;
using System.Linq;
using System.ServiceModel;
using SAPServer.Core;
using ServiceBus.Contract.Model;
using ServiceBus.Contract.Service;

namespace SAPServer.Web
{
    [ErrorHandlerBehavior]
    public class SAPServiceStub : ISAPService
    {
        #regionISAPService implementation

        [OperationBehavior(TransactionScopeRequired = false)]
        public ReplicateWBSElementStatus UpdateWBSCodeStatus(UpdateWBSCodeStatusInfo updateWBSCodeStatusInfo)
        {
            return null;
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void ChangeStatus(StatusInfo statusInfo)
        {
            // Left blank on purpose
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void CreateInvestmentManagementLink(InvestmentManagementLinkInfo[] investmentManagementLinkInfos)
        {
            // Left blank on purpose
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreateOrUpdateProject(ProjectInfo projectInfo, CallerInfo callerInfo)
        {
            if (projectInfo == null)
            {
                throw new ArgumentNullException("projectInfo");
            }

            if (string.IsNullOrWhiteSpace(projectInfo.ProjectCode))
            {
                projectInfo.ProjectCode = string.Format("I.{0}", projectInfo.Number);
            }

            foreach (ActivityInfo activityInfo in projectInfo.Activities)
            {
                if (string.IsNullOrWhiteSpace(activityInfo.WBSElementCode))
                {
                    activityInfo.WBSElementCode = string.Format("{0}.{1}", projectInfo.ProjectCode, activityInfo.Number);
                }

                foreach (ActivityAppropriationSourceInfo activityAppropriationSourceInfo in activityInfo.AppropriationSources)
                {
                    if (string.IsNullOrWhiteSpace(activityAppropriationSourceInfo.WBSElementCode))
                    {
                        activityAppropriationSourceInfo.WBSElementCode = string.Format("{0}.{1}", activityInfo.WBSElementCode, activityAppropriationSourceInfo.Code);
                    }
                }
            }

            ReplicateProjectInfo replicateProjectInfo = new ReplicateProjectInfo()
            {
                Activities = projectInfo.Activities,
                EndDate = projectInfo.EndDate,
                Name = projectInfo.Name,
                Number = projectInfo.Number,
                ProjectCode = projectInfo.ProjectCode,
                StartDate = projectInfo.StartDate
            };

            List<ActionServiceObject> actions = new List<ActionServiceObject>();

            // first return transaction is to update WBSElementCode in AidWorks
            actions.Add(new ActionServiceObject
            {
                ServiceMethod = "ReplicateProjectInfo",
                From = ServiceEnum.SAP,
                To = callerInfo.From,
                UserID = GetType().Name,
                MethodArguments = new MethodArgumentBag { { "replicateProjectInfo", replicateProjectInfo } }
            });

            // second return transaction is to link WBSElementCode with its Program position for the current year in SAP Investment management
            InvestmentManagementLinkInfo[] investmentManagementLinkInfos = projectInfo.Activities
                .SelectMany(x => x.AppropriationSources)
                .Select(x => new InvestmentManagementLinkInfo
                {
                    ApprovalYear = DateTime.Today.AddMonths(6).Year,
                    InvestmentManagementPosition = x.InvestmentManagementPosition,
                    WBSElementCode = x.WBSElementCode
                }).ToArray();

            actions.Add(new ActionServiceObject
            {
                ServiceMethod = "CreateInvestmentManagementLink",
                From = ServiceEnum.SAP,
                To = ServiceEnum.SAP,
                UserID = GetType().Name,
                MethodArguments = new MethodArgumentBag { { "investmentManagementLinkInfo", investmentManagementLinkInfos } }
            });

            return actions.ToArray();
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void UpdateForecast(WBSForecastInfo[] forecasts)
        {
            // Left blank on purpose
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public PingInfo Ping(PingInfo pingInfo)
        {
            pingInfo.Message = "Ping successful: " + pingInfo.Message;

            return pingInfo;
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreateAdjustmentJournal(CreateAdjustmentJournal createAdjustmentJournal, CallerInfo callerInfo)
        {
            ReplicateAdjustmentJournal adjustmentJournalResponse = new ReplicateAdjustmentJournal
            {
                DocumentNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                AdjustmentJournalInfo = new OASISAdjustmentJournalInfo
                {
                    CurrencyCode = createAdjustmentJournal.AdjustmentJournalInfo.CurrencyCode,
                    Date = createAdjustmentJournal.AdjustmentJournalInfo.Date,
                    PaymentBatchNumber = createAdjustmentJournal.AdjustmentJournalInfo.PaymentBatchNumber,
                    ReferenceNumber = createAdjustmentJournal.AdjustmentJournalInfo.ReferenceNumber,
                    SAPGeneralLedgerAccountCode = createAdjustmentJournal.AdjustmentJournalInfo.SAPGeneralLedgerAccountCode,
                    Items = createAdjustmentJournal.AdjustmentJournalInfo.Items,
                }
            };

            return new ActionServiceObject[]
            {
                new ActionServiceObject
                {
                    ServiceMethod = "ReplicateAdjustmentJournal",
                    From = ServiceEnum.SAP,
                    To = callerInfo.From,
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag { { "replicateAdjustmentJournal", adjustmentJournalResponse} }
                }
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreateGoodsReceiptAndAdjustmentJournal(CreateGoodsReceiptAndAdjustmentJournal createGoodsReceiptAndAdjustmentJournal, CallerInfo callerInfo)
        {
            List<ActionServiceObject> actions = new List<ActionServiceObject>();

            ReplicateGoodsReceiptNumber replicateGoodsReceiptNumber = new ReplicateGoodsReceiptNumber()
            {
                GoodsReceiptNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                Items = createGoodsReceiptAndAdjustmentJournal.GoodsReceiptInfo.Items
            };

            actions.Add(new ActionServiceObject
            {
                ServiceMethod = "ReplicateGoodsReceiptNumber",
                From = ServiceEnum.SAP,
                To = callerInfo.From,
                UserID = GetType().Name,
                MethodArguments = new MethodArgumentBag { { "replicateGoodsReceiptNumber", replicateGoodsReceiptNumber } }
            });

            // only create adjustment journal if there are adjustment items
            if (createGoodsReceiptAndAdjustmentJournal.AdjustmentJournalInfo.Items != null && createGoodsReceiptAndAdjustmentJournal.AdjustmentJournalInfo.Items.Length > 0)
            {
                CreateAdjustmentJournal createAdjustmentJournal = new CreateAdjustmentJournal
                {
                    AdjustmentJournalInfo = createGoodsReceiptAndAdjustmentJournal.AdjustmentJournalInfo,
                    GoodsReceiptInfo = createGoodsReceiptAndAdjustmentJournal.GoodsReceiptInfo,
                    GoodsReceiptNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0')
                };

                actions.Add(new ActionServiceObject
                {
                    ServiceMethod = "CreateAdjustmentJournal",
                    From = ServiceEnum.SAP,
                    To = ServiceEnum.SAP,
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag
                    {
                        { "createAdjustmentJournal", createAdjustmentJournal },
                        { "callerInfo", callerInfo },
                    }
                });
            }

            return actions.ToArray();
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] CreatePurchaseOrderAndGoodsReceipt(CreatePurchaseOrderAndGoodsReceiptInfo createPurchaseOrderAndGoodsReceiptInfo, CallerInfo callerInfo)
        {
            Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0');

            ReplicatePurchaseOrderNumber replicatePurchaseOrderNumber = new ReplicatePurchaseOrderNumber()
            {
                CurrencyCode = createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo.CurrencyCode,
                Notes = createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo.Notes,
                PurchaseOrderLines = createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo.PurchaseOrderLines,
                PurchaseOrderNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                SourceReferenceDisplayID = createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo.SourceReferenceDisplayID,
                SourceReferenceID = createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo.SourceReferenceID,
                SourceReferenceType = createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo.SourceReferenceType,
                VendorNumber = createPurchaseOrderAndGoodsReceiptInfo.CreatePurchaseOrderInfo.VendorNumber
            };


            // set the purchase order number on the GoodsReceiptInfo
            createPurchaseOrderAndGoodsReceiptInfo.GoodsReceiptInfo.PurchaseOrderNo = replicatePurchaseOrderNumber.PurchaseOrderNumber;

            // create the goods receipt and adjustment journal transaction
            CreateGoodsReceiptAndAdjustmentJournal createGoodsReceiptAndAdjustmentJournal = new CreateGoodsReceiptAndAdjustmentJournal
            {
                AdjustmentJournalInfo = createPurchaseOrderAndGoodsReceiptInfo.AdjustmentJournalInfo,
                GoodsReceiptInfo = createPurchaseOrderAndGoodsReceiptInfo.GoodsReceiptInfo
            };

            return new ActionServiceObject[]
            {
                new ActionServiceObject
                {
                    ServiceMethod = "ReplicatePurchaseOrderNumber",
                    From = ServiceEnum.SAP,
                    To = callerInfo.From,
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag { { "purchaseOrderNumber", replicatePurchaseOrderNumber} }
                },
                new ActionServiceObject
                {
                    ServiceMethod = "CreateGoodsReceiptAndAdjustmentJournal",
                    From = ServiceEnum.SAP,
                    To = ServiceEnum.SAP,
                    UserID = GetType().Name,
                    MethodArguments = new MethodArgumentBag
                    {
                        { "createGoodsReceiptAndAdjustmentJournal", createGoodsReceiptAndAdjustmentJournal},
                        { "callerInfo", callerInfo }
                    }
                }
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ReplicateGoodsReceiptNumber CreateGoodsReceipt(GoodsReceiptInfo goodsReceiptInfo)
        {
            return new ReplicateGoodsReceiptNumber
            {
                GoodsReceiptNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                Items = goodsReceiptInfo.Items
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ReplicatePurchaseOrderNumber CreatePurchaseOrder(CreatePurchaseOrderInfo createPurchaseOrderInfo)
        {
            return new ReplicatePurchaseOrderNumber
            {
                CurrencyCode = createPurchaseOrderInfo.CurrencyCode,
                Notes = createPurchaseOrderInfo.Notes,
                PurchaseOrderLines = createPurchaseOrderInfo.PurchaseOrderLines,
                PurchaseOrderNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                SourceReferenceDisplayID = createPurchaseOrderInfo.SourceReferenceDisplayID,
                SourceReferenceID = createPurchaseOrderInfo.SourceReferenceID,
                SourceReferenceType = createPurchaseOrderInfo.SourceReferenceType,
                VendorNumber = createPurchaseOrderInfo.VendorNumber
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public AccrualJournalResponseInfo CreateAccrualJournal(AccrualJournalInfo accrualJournalInfo)
        {
            return new AccrualJournalResponseInfo
            {
                DocumentNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                FMISTransactionID = accrualJournalInfo.FMISTransactionID,
                ReversalDocumentNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                Items = accrualJournalInfo.Items.Select(x => new AccrualJournalResponseItemInfo
                {
                    AccrualAmount = x.Amount,
                    PaymentEventNumber = x.PaymentEventNumber
                }).ToArray()
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public AccrualJournalResponseInfo CreatePrePaymentJournal(PrePaymentJournalInfo prePaymentJournalInfo)
        {
            return new AccrualJournalResponseInfo
            {
                DocumentNumber = Math.Abs(Guid.NewGuid().GetHashCode()).ToString().PadLeft(10, '0'),
                FMISTransactionID = prePaymentJournalInfo.FMISTransactionID,
                Items = prePaymentJournalInfo.Items.Select(x => new AccrualJournalResponseItemInfo
                {
                    AccrualAmount = x.Amount,
                    PaymentEventNumber = x.PaymentEventNumber
                }).ToArray()
            };
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void DeletePurchaseOrder(DeletePurchaseOrderInfo deletePurchaseOrderInfo)
        {
            // Left blank on purpose
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public Invoice[] GetInvoices(InvoiceLookupCriteria invoiceLookupCriteria)
        {
            return new Invoice[0];
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public void UpdatePurchaseOrder(UpdatePurchaseOrderInfo updatePurchaseOrderInfo)
        {
            // Left blank on purpose
        }

        [OperationBehavior(TransactionScopeRequired = false)]
        public ActionServiceObject[] ProcessSAPEvent(SAPEvent evnt)
        {
            //We will not receive any events from SAP
            return new ActionServiceObject[0];
        }

        public void ReplicateExchangeRates()
        {
            // Left blank on purpose
        }

        public void ReplicateExchangeRatesForRange(DateTime startDate, DateTime endDate)
        {
            // Left blank on purpose
        }

        public void PingCallBack(PingInfo pingInfo)
        {
            // Left blank on purpose
        }

        #endregion
    }
}